
> web-submit-diyaccounting-co-uk@0.0.2-4 test
> vitest --run app/unit-tests/*.test.js web/unit-tests/*.test.js app/integration-tests/*.test.js
 RUN  v3.2.4 /Users/antony/projects/submit.diyaccounting.co.uk
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should log receipt to S3 successfully
{"event":{"body":"{\"formBundleNumber\":\"123456789012\",\"chargeRefNumber\":\"XM002610011594\",\"processingDate\":\"2023-01-01T12:00:00.000Z\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.103Z"}
stdout | app/unit-tests/authUrlHandler.test.js > httpGet > should return auth URL when state is provided
{"event":{"queryStringParameters":{"state":"test-state-123"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.104Z"}
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"authUrl\":\"https://test/oauth/authorize?response_type=code&client_id=test%20client%20id&redirect_uri=http%3A%2F%2Fhmrc.test.redirect%3A3000%2F&scope=write%3Avat%20read%3Avat&state=test-state-123\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.107Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should log receipt to S3 successfully
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"123456789012\",\"chargeRefNumber\":\"XM002610011594\",\"processingDate\":\"2023-01-01T12:00:00.000Z\"},\"key\":\"receipts/123456789012.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.108Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 error
{"event":{"body":"{\"formBundleNumber\":\"123456789012\",\"chargeRefNumber\":\"XM002610011594\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.121Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 error
{"error":{"name":"AccessDenied"},"level":"error","message":"Failed to log receipt to S3","timestamp":"2025-08-01T00:24:59.121Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 error
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Failed to log receipt\",\"details\":\"Failed to log receipt: Access denied\"}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.122Z"}
stdout | app/unit-tests/authUrlHandler.test.js > httpGet > should return 400 when state is missing
{"event":{"queryStringParameters":{}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.122Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing state query parameter from URL\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.122Z"}
stdout | app/unit-tests/authUrlHandler.test.js > httpGet > should return 400 when queryStringParameters is null
{"event":{"queryStringParameters":null},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.123Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing state query parameter from URL\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.123Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle malformed JSON in request body
{"event":{"body":"invalid-json"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.123Z"}
stdout | app/unit-tests/authUrlHandler.test.js > httpGet > should return 400 when state is empty string
{"event":{"queryStringParameters":{"state":""}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.124Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing state query parameter from URL\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.124Z"}
stdout | app/unit-tests/authUrlHandler.test.js > httpGet > should properly encode special characters in state
{"event":{"queryStringParameters":{"state":"test state with spaces & symbols"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.126Z"}
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"authUrl\":\"https://test/oauth/authorize?response_type=code&client_id=test%20client%20id&redirect_uri=http%3A%2F%2Fhmrc.test.redirect%3A3000%2F&scope=write%3Avat%20read%3Avat&state=test%20state%20with%20spaces%20%26%20symbols\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.126Z"}
stdout | app/unit-tests/authUrlHandler.test.js > httpGet > should handle undefined queryStringParameters
{"event":{},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.128Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing state query parameter from URL\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.128Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should submit VAT return successfully
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}","headers":{"Gov-Client-Browser-JS-User-Agent":"test-browser-js-user-agent","Gov-Client-Device-ID":"test-device-id","Gov-Client-Multi-Factor":"test-multi-factor","Gov-Client-Public-IP":"test-public-ip","Gov-Client-Public-IP-Timestamp":"test-public-ip-timestamp","Gov-Client-Public-Port":"test-public-port","Gov-Client-Screens":"test-screens","Gov-Client-Timezone":"test-timezone","Gov-Client-User-IDs":"test-user-ids","Gov-Client-Window-Size":"test-window-size","Gov-Vendor-Forwarded":"test-vendor-forwarded","Gov-Vendor-Public-IP":"test-vendor-public-ip"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.129Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.133Z","timestamp":"2025-08-01T00:24:59.133Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"1000.50","vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Browser-JS-User-Agent":"test-browser-js-user-agent","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Device-ID":"test-device-id","Gov-Client-Multi-Factor":"test-multi-factor","Gov-Client-Public-IP":"test-public-ip","Gov-Client-Public-IP-Timestamp":"test-public-ip-timestamp","Gov-Client-Public-Port":"test-public-port","Gov-Client-Screens":"test-screens","Gov-Client-Timezone":"test-timezone","Gov-Client-User-IDs":"test-user-ids","Gov-Client-Window-Size":"test-window-size","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Public-IP":"test-vendor-public-ip","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.134Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should submit VAT return successfully
{"hmrcRequestBody":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"level":"info","message":"Response from POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.135Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should submit VAT return successfully
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"mock-123456789012\",\"chargeRefNumber\":\"mock-XM002610011594\",\"processingDate\":\"2023-01-01T12:00:00.000Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.136Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when vatNumber is missing
{"event":{"body":"{\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.141Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.141Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.142Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when periodKey is missing
{"event":{"body":"{\"vatNumber\":\"193054661\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.143Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.144Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing periodKey parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.144Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 network timeout error
{"event":{"body":"{\"formBundleNumber\":\"123456789012\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.145Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when vatDue is missing
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.145Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.146Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatDue parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.146Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 network timeout error
{"error":{"name":"TimeoutError"},"level":"error","message":"Failed to log receipt to S3","timestamp":"2025-08-01T00:24:59.146Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 network timeout error
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Failed to log receipt\",\"details\":\"Failed to log receipt: Request timeout\"}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.146Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 bucket not found error
{"event":{"body":"{\"formBundleNumber\":\"123456789012\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.148Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 bucket not found error
{"error":{"name":"NoSuchBucket"},"level":"error","message":"Failed to log receipt to S3","timestamp":"2025-08-01T00:24:59.149Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle S3 bucket not found error
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Failed to log receipt\",\"details\":\"Failed to log receipt: The specified bucket does not exist\"}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.150Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle receipt with special characters in formBundleNumber
{"event":{"body":"{\"formBundleNumber\":\"ABC-123_456.789\",\"chargeRefNumber\":\"XM002610011594\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.151Z"}
stdout | app/unit-tests/logReceiptHandler.test.js > httpPost > should handle receipt with special characters in formBundleNumber
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"ABC-123_456.789\",\"chargeRefNumber\":\"XM002610011594\"},\"key\":\"receipts/ABC-123_456.789.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.151Z"}
 ✓  0  app/unit-tests/logReceiptHandler.test.js (6 tests) 54ms
 ✓  0  app/unit-tests/authUrlHandler.test.js (6 tests) 29ms
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when hmrcAccessToken is missing
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.222Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.222Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.223Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should submit VAT return successfully
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\",\"Gov-Client-Browser-JS-User-Agent\":\"test-browser-js-user-agent\",\"Gov-Client-Device-ID\":\"test-device-id\",\"Gov-Client-Multi-Factor\":\"test-multi-factor\",\"Gov-Client-Public-IP\":\"test-public-ip\",\"Gov-Client-Public-IP-Timestamp\":\"test-public-ip-timestamp\",\"Gov-Client-Public-Port\":\"test-public-port\",\"Gov-Client-Screens\":\"test-screens\",\"Gov-Client-Timezone\":\"test-timezone\",\"Gov-Client-User-IDs\":\"test-user-ids\",\"Gov-Client-Window-Size\":\"test-window-size\",\"Gov-Vendor-Forwarded\":\"test-vendor-forwarded\",\"Gov-Vendor-Public-IP\":\"test-vendor-public-ip\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.140Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.143Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.144Z","timestamp":"2025-08-01T00:24:59.144Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"1000.50","vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"stubbed"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.144Z","url":"https://test/organisations/vat/193054661/returns"}
{"level":"warn","message":"httpPost called in stubbed mode, using test receipt","receipt":{"chargeRefNumber":"local-XM002610011594","formBundleNumber":"local-123456789012","processingDate":"2023-01-01T12:00:00.000Z"},"timestamp":"2025-08-01T00:24:59.144Z"}
{"hmrcRequestBody":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":200,"level":"info","message":"Response from POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.145Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when all parameters are missing
{"event":{"body":"{}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.226Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.226Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.226Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when body is empty
{"event":{"body":""},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.229Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.229Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.229Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should submit VAT return successfully
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"local-123456789012\",\"chargeRefNumber\":\"local-XM002610011594\",\"processingDate\":\"2023-01-01T12:00:00.000Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.225Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when vatNumber is missing
{"event":{"body":"{\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.229Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.229Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.230Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should return 400 when body is null
{"event":{"body":null},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.230Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.231Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.231Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle empty string parameters
{"event":{"body":"{\"vatNumber\":\"\",\"periodKey\":\"\",\"vatDue\":\"\",\"hmrcAccessToken\":\"\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.232Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.232Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.232Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when periodKey is missing
{"event":{"body":"{\"vatNumber\":\"193054661\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.232Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.232Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing periodKey parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.232Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when vatDue is missing
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.233Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.234Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatDue parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.234Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle HMRC API error response
{"event":{"body":"{\"vatNumber\":\"invalid\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.234Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.234Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.234Z","timestamp":"2025-08-01T00:24:59.234Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"1000.50","vatNumber":"invalid"}}
{"body":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/invalid/returns","timestamp":"2025-08-01T00:24:59.234Z","url":"https://test/organisations/vat/invalid/returns"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when hmrcAccessToken is missing
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.257Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.257Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.257Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when all parameters are missing
{"event":{"body":"{}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.259Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.259Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.259Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle HMRC API error response
{"hmrcRequestBody":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":400,"level":"info","message":"Response from POST https://test/organisations/vat/invalid/returns","timestamp":"2025-08-01T00:24:59.234Z","url":"https://test/organisations/vat/invalid/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle HMRC API error response
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"HMRC VAT submission failed\",\"hmrcResponseCode\":400,\"hmrcResponseBody\":{\"error\":\"INVALID_VAT_NUMBER\"}}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.260Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when body is empty
{"event":{"body":""},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.260Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.260Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.260Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should return 400 when body is null
{"event":{"body":null},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.261Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.262Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.262Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should handle empty string parameters
{"event":{"body":"{\"vatNumber\":\"\",\"periodKey\":\"\",\"vatDue\":\"\",\"hmrcAccessToken\":\"\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.263Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.263Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.263Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"invalid-token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.264Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.264Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.264Z","timestamp":"2025-08-01T00:24:59.264Z","tokenValidation":{"accessTokenLength":13,"accessTokenPrefix":"invalid-...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"1000.50","vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer invalid-token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.264Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"hmrcRequestBody":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":401,"level":"info","message":"Response from POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.265Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"HMRC VAT submission failed\",\"hmrcResponseCode\":401,\"hmrcResponseBody\":{\"error\":\"INVALID_CREDENTIALS\"}}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.265Z"}
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should handle malformed JSON in request body
{"event":{"body":"invalid-json"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.264Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle numeric vatDue as string
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1500.75\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.266Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.266Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.266Z","timestamp":"2025-08-01T00:24:59.266Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"1500.75","vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":1500.75,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1500.75,"vatDueAcquisitions":0,"vatDueSales":1500.75,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.266Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle numeric vatDue as string
{"hmrcRequestBody":{"finalised":true,"netVatDue":1500.75,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1500.75,"vatDueAcquisitions":0,"vatDueSales":1500.75,"vatReclaimedCurrPeriod":0},"level":"info","message":"Response from POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.266Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle numeric vatDue as string
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"123456789012\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.266Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle numeric vatDue as number
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":2000.25,\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.267Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.268Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.268Z","timestamp":"2025-08-01T00:24:59.268Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":2000.25,"vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":2000.25,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":2000.25,"vatDueAcquisitions":0,"vatDueSales":2000.25,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.268Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle numeric vatDue as number
{"hmrcRequestBody":{"finalised":true,"netVatDue":2000.25,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":2000.25,"vatDueAcquisitions":0,"vatDueSales":2000.25,"vatReclaimedCurrPeriod":0},"level":"info","message":"Response from POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.268Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle numeric vatDue as number
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"123456789012\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.268Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle malformed JSON in request body
{"event":{"body":"invalid-json"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.269Z"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle network errors
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"23A1\",\"vatDue\":\"1000.50\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.272Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.272Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:24:59.272Z","timestamp":"2025-08-01T00:24:59.272Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"1000.50","vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":1000.5,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000.5,"vatDueAcquisitions":0,"vatDueSales":1000.5,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:24:59.272Z","url":"https://test/organisations/vat/193054661/returns"}
stdout | app/unit-tests/submitVatHandler.test.js > httpPost > should handle missing body property
{"event":{},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.274Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.275Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.275Z"}
 ✓  0  app/unit-tests/submitVatHandler.test.js (16 tests) 151ms
stdout | app/unit-tests/submitVatHandler.stubbed.test.js > submitVatHandleLocal > should handle missing body property
{"event":{},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.267Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:24:59.287Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing vatNumber parameter from body, Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:24:59.287Z"}
 ✓  0  app/unit-tests/submitVatHandler.stubbed.test.js (11 tests) 152ms
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should exchange code for access token successfully
{"event":{"body":"{\"code\":\"test-auth-code\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.482Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:24:59.487Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should exchange code for access token successfully
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test/oauth/token","timestamp":"2025-08-01T00:24:59.488Z","url":"https://test/oauth/token"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should exchange code for access token successfully
{"hmrcResponseTokens":{"access_token":"test access token","expires_in":3600,"token_type":"Bearer"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:24:59.489Z","tokenValidation":{"accessTokenLength":17,"expiresIn":3600,"hasAccessToken":true,"hasRefreshToken":false,"tokenType":"Bearer"}}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should exchange code for access token successfully
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"test access token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:24:59.489Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should return 400 when code is missing
{"event":{"body":"{}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.498Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing code from event body\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.498Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should return 400 when body is empty
{"event":{"body":""},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.501Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing code from event body\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.502Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should return 400 when body is null
{"event":{"body":null},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.504Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing code from event body\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.505Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should return 400 when code is empty string
{"event":{"body":"{\"code\":\"\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.506Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing code from event body\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.506Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API error response
{"event":{"body":"{\"code\":\"invalid-code\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.508Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:24:59.508Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API error response
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test/oauth/token","timestamp":"2025-08-01T00:24:59.508Z","url":"https://test/oauth/token"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API error response
{"hmrcResponseStatus":400,"hmrcResponseTokens":{"error":"invalid_grant"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:24:59.508Z","tokenValidation":{"accessTokenLength":0,"hasAccessToken":false,"hasRefreshToken":false}}
 ✓  0  app/unit-tests/exchangeClientSecretForAccessToken.test.js (6 tests) 33ms
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API error response
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"HMRC token exchange failed\",\"hmrcResponseCode\":400,\"hmrcResponseBody\":{\"error\":\"invalid_grant\"}}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.513Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"event":{"body":"{\"code\":\"test-code\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.520Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:24:59.520Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test/oauth/token","timestamp":"2025-08-01T00:24:59.524Z","url":"https://test/oauth/token"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"hmrcResponseStatus":401,"hmrcResponseTokens":{"error":"unauthorized_client"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:24:59.524Z","tokenValidation":{"accessTokenLength":0,"hasAccessToken":false,"hasRefreshToken":false}}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle HMRC API 401 unauthorized
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"HMRC token exchange failed\",\"hmrcResponseCode\":401,\"hmrcResponseBody\":{\"error\":\"unauthorized_client\"}}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:24:59.524Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle malformed JSON in request body
{"event":{"body":"invalid-json"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.526Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle network errors
{"event":{"body":"{\"code\":\"test-code\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.529Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:24:59.529Z"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle network errors
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test/oauth/token","timestamp":"2025-08-01T00:24:59.529Z","url":"https://test/oauth/token"}
stdout | app/unit-tests/exchangeTokenHandler.test.js > httpPost > should handle missing body property
{"event":{},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.536Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing code from event body\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:24:59.537Z"}
 ✓  0  app/unit-tests/exchangeTokenHandler.test.js (10 tests) 61ms
 ✓  0  app/unit-tests/server.test.js (15 tests) 322ms
stdout | app/unit-tests/main.test.js > Main Output > should terminate without error
Run with: undefined
 ✓  0  app/unit-tests/main.test.js (2 tests) 8ms
 ✓  0  app/unit-tests/module-index.test.js (1 test) 10ms
stdout | app/integration-tests/logReceipt.integration.test.js > Integration – log receipt flow > should log a receipt to S3 via the in-memory mock
{"event":{"body":"{\"formBundleNumber\":\"FOO123\",\"chargeRefNumber\":\"BAR456\",\"processingDate\":\"2025-07-14T10:00:00.000Z\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:24:59.879Z"}
stdout | app/integration-tests/logReceipt.integration.test.js > Integration – log receipt flow > should log a receipt to S3 via the in-memory mock
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"FOO123\",\"chargeRefNumber\":\"BAR456\",\"processingDate\":\"2025-07-14T10:00:00.000Z\"},\"key\":\"receipts/FOO123.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.001Z"}
stdout | app/integration-tests/auth.integration.test.js > Integration – auth flow > should generate an auth URL when state is supplied
{"event":{"queryStringParameters":{"state":"xyz-123"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.010Z"}
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"authUrl\":\"https://test.test.test.uk/oauth/authorize?response_type=code&client_id=test%20client%20id&redirect_uri=http%3A%2F%2Ftest.redirect%3A3000%2F&scope=write%3Avat%20read%3Avat&state=xyz-123\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.019Z"}
stdout | app/integration-tests/auth.integration.test.js > Integration – auth flow > should exchange code for a stubbed access token
{"event":{"body":"{\"code\":\"anything\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.023Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:25:00.023Z"}
 ✓  0  app/integration-tests/logReceipt.integration.test.js (1 test) 156ms
stdout | app/integration-tests/auth.integration.test.js > Integration – auth flow > should exchange code for a stubbed access token
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test.test.test.uk/oauth/token","timestamp":"2025-08-01T00:25:00.024Z","url":"https://test.test.test.uk/oauth/token"}
stdout | app/integration-tests/auth.integration.test.js > Integration – auth flow > should exchange code for a stubbed access token
{"hmrcResponseStatus":200,"hmrcResponseTokens":{"access_token":"stubbed-access-token"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:25:00.265Z","tokenValidation":{"accessTokenLength":20,"hasAccessToken":true,"hasRefreshToken":false}}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"event":{"body":"{\"code\":\"xyz\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.270Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:25:00.274Z"}
stdout | app/integration-tests/auth.integration.test.js > Integration – auth flow > should exchange code for a stubbed access token
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"stubbed-access-token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.265Z"}
stdout | app/integration-tests/auth.integration.test.js > Integration – auth flow > should exchange code for a stubbed access token
Response status: 200
Response body: {"hmrcAccessToken":"stubbed-access-token"}
 ✓  0  app/integration-tests/auth.integration.test.js (2 tests) 403ms
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should submit VAT and receive a stubbed receipt
{"event":{"body":"{\"vatNumber\":\"999999999\",\"periodKey\":\"23A1\",\"vatDue\":\"500.00\",\"hmrcAccessToken\":\"stubbed-access-token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.265Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:25:00.281Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:25:00.281Z","timestamp":"2025-08-01T00:25:00.281Z","tokenValidation":{"accessTokenLength":20,"accessTokenPrefix":"stubbed-...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"500.00","vatNumber":"999999999"}}
{"body":{"finalised":true,"netVatDue":500,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":500,"vatDueAcquisitions":0,"vatDueSales":500,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test.test.test.uk","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer stubbed-access-token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test.test.test.uk/organisations/vat/999999999/returns","timestamp":"2025-08-01T00:25:00.282Z","url":"https://test.test.test.uk/organisations/vat/999999999/returns"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test.test.test.uk/oauth/token","timestamp":"2025-08-01T00:25:00.275Z","url":"https://test.test.test.uk/oauth/token"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should submit VAT and receive a stubbed receipt
{"hmrcRequestBody":{"finalised":true,"netVatDue":500,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":500,"vatDueAcquisitions":0,"vatDueSales":500,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":200,"level":"info","message":"Response from POST https://test.test.test.uk/organisations/vat/999999999/returns","timestamp":"2025-08-01T00:25:00.550Z","url":"https://test.test.test.uk/organisations/vat/999999999/returns"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should submit VAT and receive a stubbed receipt
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"999999999-FB123\",\"chargeRefNumber\":\"999999999-CR456\",\"processingDate\":\"2025-08-01T00:25:00.504Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.550Z"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"event":{"queryStringParameters":{"state":"ABC"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.554Z"}
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"authUrl\":\"https://test.test.test.uk/oauth/authorize?response_type=code&client_id=test%20client%20id&redirect_uri=http%3A%2F%2Fhmrc.redirect%3A3000%2F&scope=write%3Avat%20read%3Avat&state=ABC\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.554Z"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"event":{"body":"{\"code\":\"C1\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.555Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:25:00.556Z"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"hmrcResponseStatus":200,"hmrcResponseTokens":{"access_token":"test access token"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:25:00.564Z","tokenValidation":{"accessTokenLength":17,"hasAccessToken":true,"hasRefreshToken":false}}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"test access token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.566Z"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"event":{"body":"{\"vatNumber\":\"111222333\",\"periodKey\":\"24B1\",\"vatDue\":\"1000.00\",\"hmrcAccessToken\":\"test access token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.571Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:25:00.575Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:25:00.576Z","timestamp":"2025-08-01T00:25:00.576Z","tokenValidation":{"accessTokenLength":17,"accessTokenPrefix":"test acc...","hasAccessToken":true,"isValidFormat":true,"periodKey":"24B1","vatDue":"1000.00","vatNumber":"111222333"}}
{"body":{"finalised":true,"netVatDue":1000,"periodKey":"24B1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000,"vatDueAcquisitions":0,"vatDueSales":1000,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test.test.test.uk","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer test access token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test.test.test.uk/organisations/vat/111222333/returns","timestamp":"2025-08-01T00:25:00.577Z","url":"https://test.test.test.uk/organisations/vat/111222333/returns"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test.test.test.uk/oauth/token","timestamp":"2025-08-01T00:25:00.578Z","url":"https://test.test.test.uk/oauth/token"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"hmrcResponseStatus":200,"hmrcResponseTokens":{"access_token":"stubbed-access-token"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:25:00.611Z","tokenValidation":{"accessTokenLength":20,"hasAccessToken":true,"hasRefreshToken":false}}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"stubbed-access-token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.611Z"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"event":{"body":"{\"vatNumber\":\"123123123\",\"periodKey\":\"23A1\",\"vatDue\":\"750.00\",\"hmrcAccessToken\":\"stubbed-access-token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.612Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:25:00.612Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:25:00.612Z","timestamp":"2025-08-01T00:25:00.612Z","tokenValidation":{"accessTokenLength":20,"accessTokenPrefix":"stubbed-...","hasAccessToken":true,"isValidFormat":true,"periodKey":"23A1","vatDue":"750.00","vatNumber":"123123123"}}
{"body":{"finalised":true,"netVatDue":750,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":750,"vatDueAcquisitions":0,"vatDueSales":750,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test.test.test.uk","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer stubbed-access-token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test.test.test.uk/organisations/vat/123123123/returns","timestamp":"2025-08-01T00:25:00.612Z","url":"https://test.test.test.uk/organisations/vat/123123123/returns"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"hmrcRequestBody":{"finalised":true,"netVatDue":1000,"periodKey":"24B1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":1000,"vatDueAcquisitions":0,"vatDueSales":1000,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":200,"level":"info","message":"Response from POST https://test.test.test.uk/organisations/vat/111222333/returns","timestamp":"2025-08-01T00:25:00.614Z","url":"https://test.test.test.uk/organisations/vat/111222333/returns"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"111222333-SYSFB\",\"chargeRefNumber\":\"111222333-SYSCR\",\"processingDate\":\"2025-08-01T00:25:00.605Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.615Z"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"event":{"body":"{\"receipt\":{\"formBundleNumber\":\"111222333-SYSFB\",\"chargeRefNumber\":\"111222333-SYSCR\",\"processingDate\":\"2025-08-01T00:25:00.605Z\"}}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.616Z"}
stdout | app/integration-tests/submitVatFlow.integration.test.js > System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"receipt\":{\"formBundleNumber\":\"111222333-SYSFB\",\"chargeRefNumber\":\"111222333-SYSCR\",\"processingDate\":\"2025-08-01T00:25:00.605Z\"}},\"key\":\"receipts/undefined.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.624Z"}
 ✓  0  web/unit-tests/navigation.frontend.test.js (15 tests) 544ms
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"hmrcRequestBody":{"finalised":true,"netVatDue":750,"periodKey":"23A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":750,"vatDueAcquisitions":0,"vatDueSales":750,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":200,"level":"info","message":"Response from POST https://test.test.test.uk/organisations/vat/123123123/returns","timestamp":"2025-08-01T00:25:00.631Z","url":"https://test.test.test.uk/organisations/vat/123123123/returns"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"123123123-FB123\",\"chargeRefNumber\":\"123123123-CR456\",\"processingDate\":\"2025-08-01T00:25:00.624Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.632Z"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"event":{"body":"{\"formBundleNumber\":\"123123123-FB123\",\"chargeRefNumber\":\"123123123-CR456\",\"processingDate\":\"2025-08-01T00:25:00.624Z\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.634Z"}
{"level":"warn","message":"DIY_SUBMIT_TEST_S3_ENDPOINT is set to 'off': No receipt saved.","timestamp":"2025-08-01T00:25:00.634Z"}
stdout | app/integration-tests/submitVat.integration.test.js > Integration – VAT flow > should run the whole flow end-to-end in memory
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"123123123-FB123\",\"chargeRefNumber\":\"123123123-CR456\",\"processingDate\":\"2025-08-01T00:25:00.624Z\"},\"key\":\"receipts/123123123-FB123.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.635Z"}
 ✓  0  app/integration-tests/submitVat.integration.test.js (2 tests) 383ms
 ✓  0  app/integration-tests/submitVatFlow.integration.test.js (1 test) 377ms
   ✓ System Test – end-to-end AWS-like flow > full end-to-end: submit VAT and read back logged receipt from S3  365ms
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App
MSW server started for integration tests
 ✓  0  web/unit-tests/userJourneys.frontend.test.js (14 tests) 715ms
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should generate auth URL through Express endpoint
{"event":{"queryStringParameters":{"state":"integration-test-state"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.818Z"}
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"authUrl\":\"https://test-api.service.hmrc.gov.uk/oauth/authorize?response_type=code&client_id=integration-test-client-id&redirect_uri=https%3A%2F%2Ftest.submit.diyaccounting.co.uk%2F&scope=write%3Avat%20read%3Avat&state=integration-test-state\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.822Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should generate auth URL through Express endpoint
Auth URL response: {
  authUrl: 'https://test-api.service.hmrc.gov.uk/oauth/authorize?response_type=code&client_id=integration-test-client-id&redirect_uri=https%3A%2F%2Ftest.submit.diyaccounting.co.uk%2F&scope=write%3Avat%20read%3Avat&state=integration-test-state'
}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should exchange token through Express endpoint
{"event":{"body":"{\"code\":\"integration-test-code\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.883Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:25:00.884Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should exchange token through Express endpoint
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test-api.service.hmrc.gov.uk/oauth/token","timestamp":"2025-08-01T00:25:00.884Z","url":"https://test-api.service.hmrc.gov.uk/oauth/token"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should exchange token through Express endpoint
{"hmrcResponseStatus":200,"hmrcResponseTokens":{"access_token":"mocked-access-token"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:25:00.916Z","tokenValidation":{"accessTokenLength":19,"hasAccessToken":true,"hasRefreshToken":false}}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should exchange token through Express endpoint
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"mocked-access-token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.916Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should exchange token through Express endpoint
Token exchange response: { hmrcAccessToken: 'mocked-access-token' }
 ✓  0  web/unit-tests/vatFlow.frontend.test.js (22 tests) 779ms
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should handle missing state in auth URL
{"event":{"queryStringParameters":{}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.928Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing state query parameter from URL\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:25:00.929Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Auth Flow Integration > should handle missing code in token exchange
{"event":{"body":"{}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.949Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing code from event body\"}","headers":{},"statusCode":400},"timestamp":"2025-08-01T00:25:00.950Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > VAT Submission Integration > should submit VAT return through Express endpoint
{"event":{"body":"{\"vatNumber\":\"193054661\",\"periodKey\":\"18A1\",\"vatDue\":\"150.00\",\"hmrcAccessToken\":\"mocked-access-token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:00.971Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:25:00.972Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:25:00.972Z","timestamp":"2025-08-01T00:25:00.972Z","tokenValidation":{"accessTokenLength":19,"accessTokenPrefix":"mocked-a...","hasAccessToken":true,"isValidFormat":true,"periodKey":"18A1","vatDue":"150.00","vatNumber":"193054661"}}
{"body":{"finalised":true,"netVatDue":150,"periodKey":"18A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":150,"vatDueAcquisitions":0,"vatDueSales":150,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test-api.service.hmrc.gov.uk","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer mocked-access-token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test-api.service.hmrc.gov.uk/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:25:00.973Z","url":"https://test-api.service.hmrc.gov.uk/organisations/vat/193054661/returns"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > VAT Submission Integration > should submit VAT return through Express endpoint
{"hmrcRequestBody":{"finalised":true,"netVatDue":150,"periodKey":"18A1","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":150,"vatDueAcquisitions":0,"vatDueSales":150,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":200,"level":"info","message":"Response from POST https://test-api.service.hmrc.gov.uk/organisations/vat/193054661/returns","timestamp":"2025-08-01T00:25:00.988Z","url":"https://test-api.service.hmrc.gov.uk/organisations/vat/193054661/returns"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > VAT Submission Integration > should submit VAT return through Express endpoint
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"mocked-bundle-12345\",\"chargeRefNumber\":\"mocked-charge-ref\",\"processingDate\":\"2025-07-15T23:40:00Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:00.989Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > VAT Submission Integration > should submit VAT return through Express endpoint
VAT submission response: {
  receipt: {
    formBundleNumber: 'mocked-bundle-12345',
    chargeRefNumber: 'mocked-charge-ref',
    processingDate: '2025-07-15T23:40:00Z'
  }
}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > VAT Submission Integration > should handle missing VAT parameters
{"event":{"body":"{\"vatNumber\":\"123456789\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.002Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:25:01.002Z"}
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Missing periodKey parameter from body, Missing vatDue parameter from body, Missing hmrcAccessToken parameter from body\"}","headers":{"Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"statusCode":400},"timestamp":"2025-08-01T00:25:01.002Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Receipt Logging Integration > should log receipt through Express endpoint
{"event":{"body":"{\"formBundleNumber\":\"test-bundle-123\",\"chargeRefNumber\":\"test-charge-ref\",\"processingDate\":\"2025-07-15T23:40:00Z\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.020Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Receipt Logging Integration > should log receipt through Express endpoint
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"test-bundle-123\",\"chargeRefNumber\":\"test-charge-ref\",\"processingDate\":\"2025-07-15T23:40:00Z\"},\"key\":\"receipts/test-bundle-123.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:01.027Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Receipt Logging Integration > should log receipt through Express endpoint
Receipt logging response: {
  receipt: {
    formBundleNumber: 'test-bundle-123',
    chargeRefNumber: 'test-charge-ref',
    processingDate: '2025-07-15T23:40:00Z'
  },
  key: 'receipts/test-bundle-123.json'
}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Receipt Logging Integration > should handle S3 errors in receipt logging
{"event":{"body":"{\"formBundleNumber\":\"test-bundle-456\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.043Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Receipt Logging Integration > should handle S3 errors in receipt logging
{"error":{},"level":"error","message":"Failed to log receipt to S3","timestamp":"2025-08-01T00:25:01.044Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Receipt Logging Integration > should handle S3 errors in receipt logging
{"level":"error","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"message\":\"Failed to log receipt\",\"details\":\"Failed to log receipt: S3 connection failed\"}","headers":{},"statusCode":500},"timestamp":"2025-08-01T00:25:01.044Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"event":{"queryStringParameters":{"state":"flow-test-state"}},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.085Z"}
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"authUrl\":\"https://test-api.service.hmrc.gov.uk/oauth/authorize?response_type=code&client_id=integration-test-client-id&redirect_uri=https%3A%2F%2Ftest.submit.diyaccounting.co.uk%2F&scope=write%3Avat%20read%3Avat&state=flow-test-state\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:01.085Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"event":{"body":"{\"code\":\"flow-test-code\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.092Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:25:01.092Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test-api.service.hmrc.gov.uk/oauth/token","timestamp":"2025-08-01T00:25:01.093Z","url":"https://test-api.service.hmrc.gov.uk/oauth/token"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"hmrcResponseStatus":200,"hmrcResponseTokens":{"access_token":"mocked-access-token"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:25:01.098Z","tokenValidation":{"accessTokenLength":19,"hasAccessToken":true,"hasRefreshToken":false}}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"mocked-access-token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:01.098Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"event":{"body":"{\"vatNumber\":\"987654321\",\"periodKey\":\"18A2\",\"vatDue\":\"250.00\",\"hmrcAccessToken\":\"mocked-access-token\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.109Z"}
{"detectedIP":"unknown","level":"info","message":"Server detected client IP from request headers but overwrote them with a detected address","timestamp":"2025-08-01T00:25:01.110Z"}
{"govClientHeaders":["Gov-Client-Connection-Method","Gov-Client-Browser-JS-User-Agent","Gov-Client-Device-ID","Gov-Client-Multi-Factor","Gov-Client-Public-IP","Gov-Client-Public-IP-Timestamp","Gov-Client-Public-Port","Gov-Client-Screens","Gov-Client-Timezone","Gov-Client-User-IDs","Gov-Client-Window-Size","Gov-Vendor-Forwarded","Gov-Vendor-License-IDs","Gov-Vendor-Product-Name","Gov-Vendor-Public-IP","Gov-Vendor-Version"],"level":"info","message":"submitVat function called with access token","submissionStartTime":"2025-08-01T00:25:01.110Z","timestamp":"2025-08-01T00:25:01.110Z","tokenValidation":{"accessTokenLength":19,"accessTokenPrefix":"mocked-a...","hasAccessToken":true,"isValidFormat":true,"periodKey":"18A2","vatDue":"250.00","vatNumber":"987654321"}}
{"body":{"finalised":true,"netVatDue":250,"periodKey":"18A2","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":250,"vatDueAcquisitions":0,"vatDueSales":250,"vatReclaimedCurrPeriod":0},"environment":{"hmrcBase":"https://test-api.service.hmrc.gov.uk","nodeEnv":"test"},"headers":{"Accept":"application/vnd.hmrc.1.0+json","Authorization":"Bearer mocked-access-token","Content-Type":"application/json","Gov-Client-Connection-Method":"WEB_APP_VIA_SERVER","Gov-Client-Public-IP":"unknown","Gov-Vendor-Forwarded":"by=203.0.113.6&for=198.51.100.0","Gov-Vendor-License-IDs":"my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1","Gov-Vendor-Product-Name":"DIY Accounting Submit","Gov-Vendor-Version":"web-submit-diyaccounting-co-uk-0.0.2-4"},"level":"info","message":"Request to POST https://test-api.service.hmrc.gov.uk/organisations/vat/987654321/returns","timestamp":"2025-08-01T00:25:01.110Z","url":"https://test-api.service.hmrc.gov.uk/organisations/vat/987654321/returns"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"hmrcRequestBody":{"finalised":true,"netVatDue":250,"periodKey":"18A2","totalAcquisitionsExVAT":0,"totalValueGoodsSuppliedExVAT":0,"totalValuePurchasesExVAT":0,"totalValueSalesExVAT":0,"totalVatDue":250,"vatDueAcquisitions":0,"vatDueSales":250,"vatReclaimedCurrPeriod":0},"hmrcResponseStatus":200,"level":"info","message":"Response from POST https://test-api.service.hmrc.gov.uk/organisations/vat/987654321/returns","timestamp":"2025-08-01T00:25:01.120Z","url":"https://test-api.service.hmrc.gov.uk/organisations/vat/987654321/returns"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"mocked-bundle-12345\",\"chargeRefNumber\":\"mocked-charge-ref\",\"processingDate\":\"2025-07-15T23:40:00Z\"}}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:01.120Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"event":{"body":"{\"formBundleNumber\":\"mocked-bundle-12345\",\"chargeRefNumber\":\"mocked-charge-ref\",\"processingDate\":\"2025-07-15T23:40:00Z\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.129Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"receipt\":{\"formBundleNumber\":\"mocked-bundle-12345\",\"chargeRefNumber\":\"mocked-charge-ref\",\"processingDate\":\"2025-07-15T23:40:00Z\"},\"key\":\"receipts/mocked-bundle-12345.json\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:01.130Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Full Flow Integration > should handle complete auth and VAT submission flow
Full flow completed successfully
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Error Handling > should handle large request bodies
{"event":{"body":"{\"code\":\"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\",\"extra\":\"yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy\"}"},"level":"warn","message":"Event has missing URL path or host header","timestamp":"2025-08-01T00:25:01.147Z"}
{"level":"info","message":"Secret retrieved from environment variable DIY_SUBMIT_HMRC_CLIENT_SECRET and cached","timestamp":"2025-08-01T00:25:01.148Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Error Handling > should handle large request bodies
{"body":{},"headers":{"Content-Type":"application/x-www-form-urlencoded"},"level":"info","message":"Request to POST https://test-api.service.hmrc.gov.uk/oauth/token","timestamp":"2025-08-01T00:25:01.150Z","url":"https://test-api.service.hmrc.gov.uk/oauth/token"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Error Handling > should handle large request bodies
{"hmrcResponseStatus":200,"hmrcResponseTokens":{"access_token":"mocked-access-token"},"level":"info","message":"exchangeClientSecretForAccessToken response","timestamp":"2025-08-01T00:25:01.157Z","tokenValidation":{"accessTokenLength":19,"hasAccessToken":true,"hasRefreshToken":false}}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App > Error Handling > should handle large request bodies
{"level":"info","message":"Responding to request with response","request":"https://unknown","response":{"body":"{\"hmrcAccessToken\":\"mocked-access-token\"}","headers":{},"statusCode":200},"timestamp":"2025-08-01T00:25:01.158Z"}
stdout | app/integration-tests/server.integration.test.js > Integration – Server Express App
MSW server closed
 ✓  0  app/integration-tests/server.integration.test.js (14 tests) 490ms
 Test Files  17 passed (17)
      Tests  144 passed (144)
   Start at  02:24:57
   Duration  3.61s (transform 1.88s, setup 0ms, collect 21.39s, tests 4.67s, environment 5ms, prepare 4.95s)
