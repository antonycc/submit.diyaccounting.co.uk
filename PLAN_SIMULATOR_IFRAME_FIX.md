# Plan: Fix Simulator iframe CSP Violation, Open-in-New-Tab, and Test Failure

## Context

The simulator is deployed at `ci-simulator.submit.diyaccounting.co.uk` and embedded via iframe on `ci.submit.diyaccounting.co.uk/simulator.html`. The iframe loads and renders correctly on page load. Three issues need attention.

## Issue 1: CSP Violation When Clicking Watch Buttons (CRITICAL)

### Symptoms

1. On page load, benign console warnings:
   - `GET https://ci.submit.diyaccounting.co.uk/simulator-local.js net::ERR_ABORTED 403` -- expected, this file only exists locally
   - `Refused to execute script... MIME type ('application/xml')` -- S3 returns XML error page for missing file

2. When clicking any Watch button (Submit VAT, View Obligations, View Return):
   - `Framing 'https://ci.submit.diyaccounting.co.uk/' violates the following Content Security Policy directive: "frame-ancestors 'none'"`
   - The iframe switches from showing the simulator to "ci.submit.diyaccounting.co.uk refused to connect"

### Root Cause Analysis

The journey button click handler in `web/public/simulator.html` (line 331) contains:

```javascript
const simBase = window.__simulatorLocal ? "/sim/" : "/";
try {
    iframe.contentWindow.location.href = simBase + "index.html";
} catch (e) {
    // Cross-origin - can't reset, just proceed
}
```

When deployed (not local), `simBase = "/"`. The code executes:

```javascript
iframe.contentWindow.location.href = "/index.html";
```

**The critical misunderstanding**: The catch block expects a cross-origin security error, but **writing** to `location.href` on a cross-origin frame is actually **allowed** by the browser security model (only reading is blocked). So:

1. The assignment **does not throw** -- the catch block never fires
2. The relative URL `/index.html` resolves against the **calling script's origin** (the parent page: `ci.submit.diyaccounting.co.uk`), **not** the iframe's origin (`ci-simulator.submit.diyaccounting.co.uk`)
3. This navigates the iframe to `https://ci.submit.diyaccounting.co.uk/index.html`
4. The main site's EdgeStack.java sets `frame-ancestors 'none'` in its CSP response headers
5. The browser blocks the framing, breaking the iframe

### Solution

Replace `iframe.contentWindow.location.href` with `iframe.src`, using the already-computed `window.__simulatorFrameSrc`:

```javascript
// Reset iframe to home
statusEl.textContent = "Loading simulator...";
iframe.src = window.__simulatorFrameSrc;
```

`window.__simulatorFrameSrc` is set correctly for both cases:
- Local: `/sim/` (set when `window.__simulatorLocal` is true)
- Deployed: `https://ci-simulator.submit.diyaccounting.co.uk/` (computed from hostname)

Setting `iframe.src` always works correctly because it resolves relative to the parent document's base URL and is the standard API for iframe navigation.

### Files to Modify

- `web/public/simulator.html` -- fix the journey button click handler (lines 330-335)

### Why the 403 on simulator-local.js Is Not a Problem

The `simulator-local.js` file is generated by `scripts/build-simulator.js` and only exists during local development. In production, the `<script src="./simulator-local.js" onerror="void(0)">` tag correctly suppresses the error via the `onerror` handler. The 403 and MIME type warnings in the console are cosmetic and do not affect functionality.

## Issue 2: postVatReturnBehaviour-simulator Test Failure (OUT OF SCOPE)

### Symptoms

The `npm run test:postVatReturnBehaviour-simulator` test fails in CI (job 62049274575) at:

```
Error: expect(locator).toContainText(expected) failed
Locator: locator('#appNameParagraph')
Timeout: 10000ms
Error: element(s) not found
```

### Root Cause Analysis

The test runs the full VAT submission flow with HMRC sandbox test scenarios (INVALID_VRN, INVALID_PERIODKEY, etc.). The failure occurs during the INVALID_VRN scenario:

1. The test calls `requestAndVerifySubmitReturn` with `testScenario: "INVALID_VRN"`
2. This calls `fillInVat` which sets the `Gov-Test-Scenario` header
3. The VAT form is submitted to the local server
4. The server's HMRC API call (via the HTTP simulator) returns a 400 with `VRN_INVALID`
5. The server converts this to a 500 error response to the client
6. The page shows an error message instead of redirecting to HMRC auth
7. `goToHmrcAuth` fails because `#appNameParagraph` doesn't exist (the page is showing an error, not the HMRC auth page)

The browser console log confirms:
```
Submission error: Error: Failed to submit VAT. Remote call failed: POST /api/v1/hmrc/vat/return
- Status: 500 Internal Server Error
- Body: {"code":"VRN_INVALID","message":"The provided VAT registration number is invalid"}
```

### Theories

1. **HTTP Simulator doesn't handle Gov-Test-Scenario correctly**: The simulator may be processing the scenario at the wrong point in the flow (before auth redirect instead of after)
2. **requestAndVerifySubmitReturn assumes all scenarios go through HMRC auth**: The function unconditionally calls `goToHmrcAuth`, but error scenarios may short-circuit before reaching HMRC auth
3. **Server-side error handling changed**: A recent change to error handling may have altered the response flow for HMRC API errors

### Recommended Investigation (Future)

- Check how the HTTP simulator handles Gov-Test-Scenario headers for POST /organisations/vat/{vrn}/returns
- Check whether `requestAndVerifySubmitReturn` needs separate handling for error scenarios vs success scenarios
- Compare with the proxy test (`test:postVatReturnBehaviour-proxy`) to see if it handles HMRC auth differently

## Issue 3: Add "Open in New Tab" Icon Next to Expand Button

### Description

Add an external link icon next to the Expand button that opens the standalone simulator in a new browser tab. The URL should be:
- `https://ci-simulator.submit.diyaccounting.co.uk/` in CI
- `https://prod-simulator.submit.diyaccounting.co.uk/` in production
- `/sim/` in local development

### Solution

Add an anchor element styled as an icon button next to the Expand button in the simulator container:

```html
<a href="#" id="simulatorOpenLink" class="simulator-open-btn"
   target="_blank" rel="noopener noreferrer"
   aria-label="Open simulator in new tab"
   title="Open simulator in new tab">
  &#x2197;
</a>
```

Set the href dynamically using the already-computed `window.__simulatorFrameSrc`:

```javascript
document.getElementById("simulatorOpenLink").href = window.__simulatorFrameSrc;
```

Style the icon to match the existing Expand button aesthetic.

### Files to Modify

- `web/public/simulator.html` -- add the icon element and JavaScript to set href
- `web/public/submit.css` -- add `.simulator-open-btn` styles (if needed, or inline)

## Verification

1. `npm test` -- unit tests pass
2. `npm run test:simulatorBehaviour-simulator` -- local simulator behaviour tests pass
3. Push to `helpdocs` branch, deploy
4. Manual: visit `https://ci.submit.diyaccounting.co.uk/simulator.html`:
   - Verify iframe loads simulator correctly
   - Click each Watch button -- iframe should reset to simulator home, not show CSP error
   - Verify "open in new tab" icon appears next to Expand and opens simulator in new tab
5. `npm run test:simulatorBehaviour-ci` -- CI simulator behaviour tests pass
