# DIY Accounting Submit - Comprehensive Repository Documentation

**Generated:** 2025-12-06

This document provides a complete, hierarchical overview of the `submit.diyaccounting.co.uk` repository, from high-level architecture down to individual files and their purposes.

## Table of Contents

1. [Repository Overview](#repository-overview)
2. [Environment Configuration](#environment-configuration)
3. [Package.json Operations](#packagejson-operations)
4. [Maven (pom.xml) Operations](#maven-pomxml-operations)
5. [GitHub Actions Workflows](#github-actions-workflows)
6. [AWS Deployment Architecture](#aws-deployment-architecture)
7. [Local Express Server Architecture](#local-express-server-architecture)
8. [Directory Structure](#directory-structure)

## Repository Overview

**DIY Accounting Submit** is a full-stack serverless application for submitting UK VAT returns via HMRC's Making Tax Digital (MTD) APIs.

### Technology Stack

| Component | Technology |
|-----------|------------|
| **Frontend** | Static HTML/CSS/JavaScript served via CloudFront + S3 |
| **Backend** | Node.js (Express for local dev, AWS Lambda for production) |
| **Infrastructure** | AWS CDK v2 (Java) |
| **Testing** | Vitest (unit/system), Playwright (browser/behaviour) |
| **Authentication** | AWS Cognito + Google IdP (production), Mock OAuth2 (local) |
| **Storage** | DynamoDB (bundles, receipts, API requests), S3 (receipts backup) |
| **API Integration** | HMRC MTD VAT API (test and production) |
| **Local Dev Proxy** | ngrok (exposes localhost for OAuth callbacks) |

### Key Features

- **VAT Submissions**: Submit VAT returns to HMRC via MTD API
- **VAT Obligations**: Retrieve and display VAT obligations
- **Receipt Storage**: Store and retrieve HMRC submission receipts
- **Bundle/Entitlement System**: User subscription management
- **Multi-Environment**: Supports local proxy, CI, and production deployments
- **OAuth Integration**: Google/Cognito for production, mock OAuth2 for local testing

## Environment Configuration

The repository uses multiple environment files to support different deployment scenarios.

### Required `.env` Variables

All environment files should define these core variables:

| Variable | Purpose | Example |
|----------|---------|---------|
| `DOTENV_CONFIG_QUIET` | Suppress dotenv output | `true` |
| `ENVIRONMENT_NAME` | Environment identifier | `ci`, `prod`, `proxy`, `test` |
| `DEPLOYMENT_NAME` | Deployment identifier | `ci`, `prod-abc123`, `proxy` |
| `DIY_SUBMIT_BASE_URL` | Base URL for the application | `https://submit.diyaccounting.co.uk/` |
| `LOG_TO_CONSOLE` | Enable console logging | `true` |
| `LOG_TO_FILE` | Enable file logging | `true`, `false` |
| `CLOUD_TRAIL_ENABLED` | Enable CloudTrail | `true`, `false` |
| `HMRC_BASE_URI` | HMRC production API base URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_API_PROXY_MAPPED_URL` | Internal proxy URL for HMRC API | Varies by environment |
| `HMRC_API_PROXY_EGRESS_URL` | External HMRC API URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_CLIENT_ID` | HMRC OAuth client ID | From HMRC Developer Hub |
| `HMRC_SANDBOX_BASE_URI` | HMRC sandbox API base URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_SANDBOX_API_PROXY_MAPPED_URL` | Internal proxy URL for sandbox | Varies by environment |
| `HMRC_SANDBOX_API_PROXY_EGRESS_URL` | External sandbox API URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_SANDBOX_CLIENT_ID` | HMRC sandbox OAuth client ID | From HMRC Developer Hub |
| `GOOGLE_CLIENT_SECRET_ARN` | AWS Secrets Manager ARN for Google OAuth | `arn:aws:secretsmanager:...` |
| `HMRC_CLIENT_SECRET_ARN` | AWS Secrets Manager ARN for HMRC prod secret | `arn:aws:secretsmanager:...` |
| `HMRC_SANDBOX_CLIENT_SECRET_ARN` | AWS Secrets Manager ARN for HMRC sandbox secret | `arn:aws:secretsmanager:...` |
| `COGNITO_USER_POOL_ID` | AWS Cognito User Pool ID | From AWS Cognito |
| `COGNITO_CLIENT_ID` | AWS Cognito Client ID | From AWS Cognito |
| `COGNITO_BASE_URI` | Cognito hosted UI base URL | Auto-generated by Cognito |
| `BUNDLE_DYNAMODB_TABLE_NAME` | DynamoDB table for bundles | `{env}-submit-bundles` |
| `RECEIPTS_DYNAMODB_TABLE_NAME` | DynamoDB table for receipts | `{env}-submit-receipts` |
| `HMRC_API_REQUESTS_DYNAMODB_TABLE_NAME` | DynamoDB table for API request logs | `{env}-submit-hmrc-api-requests` |
| `ACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS` | CloudWatch log retention | `1` (CI), `28` (prod) |
| `PROXY_RATE_LIMIT_PER_SECOND` | Rate limiting for proxy | `5` (CI), `10` (prod) |
| `PROXY_BREAKER_ERROR_THRESHOLD` | Circuit breaker error threshold | `10` (CI), `15` (prod) |
| `PROXY_BREAKER_LATENCY_MS` | Circuit breaker latency threshold | `3000` (CI), `5000` (prod) |
| `PROXY_BREAKER_COOLDOWN_SECONDS` | Circuit breaker cooldown | `60` |

### Environment Files

#### `.env.test`

**Purpose**: Unit and system testing with mocked services.

**Features**:
- Localhost configuration
- Stubbed/mocked HMRC API
- No persistent storage
- No OAuth2 server
- Suitable for automated testing

**Key Settings**:
- `ENVIRONMENT_NAME=test`
- `DEPLOYMENT_NAME=test`
- `DIY_SUBMIT_BASE_URL=https://test/`
- `TEST_SERVER_HTTP=test` (mocked server)
- `TEST_PROXY=test` (mocked proxy)
- `TEST_MOCK_OAUTH2=test` (mocked OAuth)
- `TEST_DYNAMODB=test` (mocked DynamoDB)
- Includes stub data for VAT obligations and returns

#### `.env.ci`

**Purpose**: Continuous Integration testing against AWS infrastructure.

**Features**:
- Real DNS entry (`ci.submit.diyaccounting.co.uk`)
- HMRC Test API integration
- Real DynamoDB storage
- AWS Cognito authentication
- Full AWS stack deployment

**Key Settings**:
- `ENVIRONMENT_NAME=ci`
- `DEPLOYMENT_NAME=ci`
- `DIY_SUBMIT_BASE_URL=https://ci.submit.diyaccounting.co.uk/`
- `HMRC_BASE_URI=https://test-api.service.hmrc.gov.uk`
- Real AWS resources (Cognito, DynamoDB, S3)
- `ACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=1` (short retention)
- `PROXY_RATE_LIMIT_PER_SECOND=5`

#### `.env.prod`

**Purpose**: Production deployment configuration.

**Features**:
- Production DNS entry (`submit.diyaccounting.co.uk`)
- HMRC Production API (currently test API pending approval)
- Real DynamoDB storage
- AWS Cognito authentication
- Full AWS stack deployment with higher reliability settings

**Key Settings**:
- `ENVIRONMENT_NAME=prod`
- `DEPLOYMENT_NAME=prod`
- `DIY_SUBMIT_BASE_URL=https://submit.diyaccounting.co.uk/`
- `HMRC_BASE_URI=https://to0request0from0hmrc-api.service.hmrc.gov.uk` (placeholder)
- Real AWS resources with production settings
- `ACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=28` (longer retention)
- `PROXY_RATE_LIMIT_PER_SECOND=10` (higher throughput)
- `PROXY_BREAKER_ERROR_THRESHOLD=15` (more tolerant)

#### `.env.proxy`

**Purpose**: Local development with ngrok proxy for OAuth callbacks.

**Features**:
- Ngrok proxy configuration (requires authentication)
- HMRC Test API integration
- Local DynamoDB (via dynalite)
- Mock OAuth2 server
- Suitable for full-stack local development

**Key Settings**:
- `ENVIRONMENT_NAME=proxy`
- `DEPLOYMENT_NAME=proxy`
- `DIY_SUBMIT_BASE_URL=https://wanted-finally-anteater.ngrok-free.app/` (example)
- `TEST_SERVER_HTTP=run` (start Express server on port 3000)
- `TEST_PROXY=run` (start ngrok)
- `TEST_MOCK_OAUTH2=run` (start mock OAuth2 server)
- `TEST_DYNAMODB=run` (start local DynamoDB)
- `HMRC_API_PROXY_MAPPED_URL=http://localhost:3000/proxy/hmrc-api`
- `BUNDLE_DYNAMODB_TABLE_NAME=test-bundle-table`
- Requires `NGROK_AUTHTOKEN` environment variable

#### `.env.proxyRunning`

**Purpose**: Connect to already-running local services.

**Features**:
- Assumes ngrok, OAuth2 server, and DynamoDB are already running
- Useful for iterative development without restarting services
- Same ngrok URL as `.env.proxy`

**Key Settings**:
- `ENVIRONMENT_NAME=proxy`
- `DEPLOYMENT_NAME=proxyRunning`
- `TEST_SERVER_HTTP=useExisting`
- `TEST_PROXY=useExisting`
- `TEST_MOCK_OAUTH2=useExisting`
- `TEST_DYNAMODB=useExisting`
- All service endpoints point to already-running instances

### Secrets Management

**Local Development**:
- `HMRC_CLIENT_SECRET` and `HMRC_SANDBOX_CLIENT_SECRET` can be set directly in environment or `.env` (not committed)
- `NGROK_AUTHTOKEN` must be exported in shell

**AWS Environments (CI/Prod)**:
- All secrets are stored in AWS Secrets Manager
- ARNs are configured in environment files
- GitHub Actions workflow creates/updates secrets automatically
- Secrets are injected at runtime via environment variables

**GitHub Secrets** (for Actions workflows):
- `HMRC_CLIENT_SECRET`: Production HMRC OAuth secret
- `HMRC_SANDBOX_CLIENT_SECRET`: Sandbox HMRC OAuth secret
- `GOOGLE_CLIENT_SECRET`: Google OAuth secret
- `NGROK_AUTH_TOKEN`: ngrok authentication token
- `PERSONAL_ACCESS_TOKEN`: GitHub PAT for updating repository variables


## Package.json Operations

The `package.json` file defines all npm scripts for building, testing, and deploying the application.

### Build and Deploy Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `build` | `./mvnw clean verify && git restore web/public/submit.deployment web/public/submit.env \|\| true` | **Full build**: Runs Maven clean and verify (compiles Java, runs tests, builds CDK JARs), generates OpenAPI docs, then restores deployment marker files |
| `start` | `./scripts/start.sh` | **Start all local services**: Orchestrates starting mock OAuth2, ngrok proxy, local DynamoDB, and Express server |
| `clean` | `./scripts/clean.sh` | **Clean build artifacts**: Removes `target/`, `node_modules/.cache/`, and other generated files |

### Formatting Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `formatting` | `prettier --check . && ./mvnw spotless:check` | **Check formatting**: Verifies JavaScript/JSON with Prettier and Java with Spotless (Palantir Java Format) |
| `formatting-fix` | `prettier --write . && ./mvnw spotless:apply && git restore ...` | **Fix formatting**: Auto-formats all code and restores deployment markers |
| `formatting:js` | `prettier --check .` | **Check JS formatting only**: Verifies JavaScript/JSON/HTML/CSS/YAML with Prettier |
| `formatting:js-fix` | `prettier --write . && git restore ...` | **Fix JS formatting only**: Auto-formats JavaScript files |
| `formatting:java` | `./mvnw -DskipTests spotless:check` | **Check Java formatting only**: Verifies Java code with Spotless |
| `formatting:java-fix` | `./mvnw -DskipTests spotless:apply && git restore ...` | **Fix Java formatting only**: Auto-formats Java code |

### Linting Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `linting` | `eslint .` | **Run ESLint**: Checks JavaScript code for errors and style issues (uses flat config) |
| `linting-fix` | `eslint --fix . && git restore ...` | **Fix linting issues**: Auto-fixes ESLint errors where possible |

### Testing Scripts

#### Core Test Suites

| Script | Command | Description |
|--------|---------|-------------|
| `test` | `vitest --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js web/unit-tests/*.test.js app/system-tests/*.test.js` | **Default test suite**: Runs unit tests (app + web) and system tests (~108 tests, ~4 seconds) |
| `test:unit` | `vitest --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js web/unit-tests/*.test.js` | **Unit tests only**: Runs all unit tests for app and web components |
| `test:app-unit` | `vitest --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js` | **App unit tests only**: Tests backend Lambda functions and services |
| `test:web-unit` | `vitest --run web/unit-tests/*.test.js` | **Web unit tests only**: Tests frontend JavaScript modules |
| `test:coverage` | `vitest --coverage --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js` | **Unit tests with coverage**: Generates code coverage reports |
| `test:system` | `vitest --run app/system-tests/*.test.js` | **System tests**: Integration tests with Docker containers (~6 seconds) |
| `test:browser` | `playwright test --project=browser-tests web/browser-tests/*.test.js` | **Browser tests**: Playwright tests for UI components (requires Chromium) |

#### Behaviour Tests (End-to-End)

Behaviour tests use Playwright to test complete user journeys against running infrastructure.

| Script | Command | Description |
|--------|---------|-------------|
| `test:behaviour` | `playwright test --project=behaviour-tests` | **All behaviour tests**: Runs all Playwright behaviour tests |
| `test:behaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:behaviour` | **Behaviour tests (local proxy)**: Tests against local ngrok + mock OAuth2 |
| `test:behaviour-proxy-sandbox` | `HMRC_ACCOUNT=sandbox npx dotenv -e .env.proxy -- npm run test:behaviour` | **Behaviour tests (proxy + HMRC sandbox)**: Tests against local setup with HMRC sandbox API |
| **Bundle Tests** | | |
| `test:bundleBehaviour` | `playwright test --project=bundle-behaviour-tests` | **Bundle journey tests**: Tests bundle/entitlement workflows |
| `test:bundleBehaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:bundleBehaviour` | Tests bundle flows locally with mock data |
| `test:bundleBehaviour-proxy-record` | `TEST_WIREMOCK=record npx dotenv -e .env.proxy -- npm run test:bundleBehaviour` | Records HTTP interactions to WireMock |
| `test:bundleBehaviour-proxy-mock` | `TEST_WIREMOCK=mock npx dotenv -e .env.proxy -- npm run test:bundleBehaviour` | Replays recorded HTTP interactions |
| `test:bundleBehaviour-ci` | `npx dotenv -e .env.ci -- npm run test:bundleBehaviour` | Tests against CI environment |
| `test:bundleBehaviour-prod` | `npx dotenv -e .env.prod -- npm run test:bundleBehaviour` | Tests against production environment |
| **VAT Obligation Tests** | | |
| `test:obligationBehaviour` | `playwright test --project=obligation-behaviour-tests` | **VAT obligation journey tests**: Tests retrieving VAT obligations |
| `test:obligationBehaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:obligationBehaviour ; npm run test-report ...` | Tests locally and generates HTML report |
| `test:obligationBehaviour-proxy-sandbox` | `HMRC_ACCOUNT=sandbox npm run test:obligationBehaviour-proxy` | Tests with HMRC sandbox API |
| `test:obligationBehaviour-ci` | `npx dotenv -e .env.ci -- npm run test:obligationBehaviour` | Tests against CI environment |
| `test:obligationBehaviour-prod` | `npx dotenv -e .env.prod -- npm run test:obligationBehaviour` | Tests against production |
| **VAT Submission Tests** | | |
| `test:submitVatBehaviour` | `playwright test --project=submit-vat-behaviour-tests` | **VAT submission journey tests**: Tests full VAT return submission |
| `test:submitVatBehaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:submitVatBehaviour` | Tests submission locally |
| `test:submitVatBehaviour-proxy-sandbox` | `HMRC_ACCOUNT=sandbox npm run test:submitVatBehaviour-proxy` | Tests submission with HMRC sandbox |
| `test:submitVatBehaviour-proxyRunning` | `npx dotenv -e .env.proxyRunning -- npm run test:submitVatBehaviour` | Tests against already-running services |
| `test:submitVatBehaviour-ci` | `npx dotenv -e .env.ci -- npm run test:submitVatBehaviour` | Tests against CI environment |
| `test:submitVatBehaviour-prod` | `npx dotenv -e .env.prod -- npm run test:submitVatBehaviour` | Tests against production |

#### Comprehensive Test Suites

| Script | Command | Description |
|--------|---------|-------------|
| `test:all` | `vitest ... && npm run test:browser && npm run test:behaviour-proxy && git restore ...` | **All tests**: Runs unit, system, browser, and behaviour tests |
| `everything` | `time sh -c 'rm -rf ... && npm install && npm test && ... npm run cdk && ...'` | **Complete validation**: Full clean build, all tests, Docker build, CDK synth for CI and prod |

### CDK Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `cdk:synth-environment` | `cd cdk-environment && npx dotenv ... npx cdk synth ...` | **Synthesize environment stack**: Generates CloudFormation for shared infrastructure (Cognito, DynamoDB, observability) |
| `cdk:synth-application` | `cd cdk-application && npx dotenv ... npx cdk synth ...` | **Synthesize application stack**: Generates CloudFormation for application resources (Lambda, API, CloudFront) |
| `cdk` | `./mvnw clean verify -DskipTests && ENVIRONMENT_NAME=prod npm run cdk:synth-environment && ...` | **Full CDK synth (prod)**: Builds Java code, synthesizes both environment and application stacks for production |
| `cdk-ci` | `./mvnw clean verify -DskipTests && ENVIRONMENT_NAME=ci npm run cdk:synth-environment && ...` | **Full CDK synth (CI)**: Same as above but for CI environment |

### Local Development Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `server` | `npx dotenv -e .env.proxy -- node app/bin/server.js` | **Start Express server**: Runs Node.js server on port 3000 (default) with `.env.proxy` config |
| `proxy` | `npx dotenv -e .env.proxy -- node app/bin/ngrok.js` | **Start ngrok proxy**: Exposes local server via ngrok tunnel for OAuth callbacks |
| `auth` | `npx dotenv -e .env.proxy -- docker run ... ghcr.io/navikt/mock-oauth2-server:2.2.1` | **Start mock OAuth2 server**: Runs Docker container on port 8080 for local OAuth testing |
| `data` | `npx dotenv -e .env.proxy -- node app/bin/dynamodb.js` | **Start local DynamoDB**: Runs dynalite (lightweight DynamoDB clone) for local data storage |
| `mock` | `wiremock --port 9090 --root-dir wiremock-recordings --verbose --preserve-host-header` | **Start WireMock**: HTTP mock server for recording/replaying API interactions |

### Utility Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `users:provision` | `node app/bin/provision-user.mjs` | **Provision test users**: Creates Cognito users for testing |
| `test-report` | `node scripts/generate-test-reports.js --testName html-report` | **Generate test reports**: Creates HTML reports from Playwright test results |
| `convert:video` | `node scripts/convert-video.js` | **Convert test videos**: Converts Playwright .webm videos to .mp4 format |
| `convert:video:default` | `node scripts/convert-video.js --in target/behaviour-test-results/video.webm --out ...` | **Convert default test video**: Converts specific video file |
| `set-apex-origins` | `node ./app/actions/set-apex-origins.mjs` | **Update CloudFront origins**: Updates CloudFront distribution to point to new deployment |
| `cloudfront:set-origins` | `node ./app/actions/set-apex-origins.mjs` | Alias for `set-apex-origins` |
| `wiremock:server` | `wiremock --port 9090 --root-dir wiremock-recordings --disable-banner` | **Start WireMock (quiet)**: Starts WireMock without banner |

### Update Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `update-to-minor` | `npx npm-check-updates --upgrade --enginesNode --target minor --verbose --install always` | **Update to minor versions**: Updates npm dependencies to latest minor versions |
| `update-to-greatest` | `npx npm-check-updates --upgrade --enginesNode --target greatest --verbose --install always --reject 'alpha'` | **Update to latest versions**: Updates to latest versions (excluding alpha) |

### Docker Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `docker:build` | `docker build -t submit-base:latest -f Dockerfile .` | **Build Docker image**: Creates base Docker image with Node.js dependencies and application code |

### Playwright Setup

| Script | Command | Description |
|--------|---------|-------------|
| `playwright:install` | `npx playwright install chromium --with-deps` | **Install Playwright browsers**: Downloads Chromium and system dependencies for browser testing |

### Dependencies

Key npm packages used:

**Production Dependencies**:
- `@aws-sdk/client-cloudformation`: AWS CloudFormation SDK
- `@aws-sdk/client-secrets-manager`: AWS Secrets Manager SDK
- `@aws-sdk/util-dynamodb`: DynamoDB utilities
- `@iarna/toml`: TOML parser for product catalog
- `aws-jwt-verify`: JWT verification for Cognito
- `dotenv`: Environment variable management
- `pino`: Fast JSON logger
- `uuid`: UUID generation

**Development Dependencies**:
- `@playwright/test`: End-to-end testing framework
- `@vitest/coverage-v8`: Code coverage for Vitest
- `aws-cdk`: AWS Cloud Development Kit CLI
- `dynalite`: Local DynamoDB implementation
- `eslint`: JavaScript linter
- `express`: Web server framework (for local dev)
- `happy-dom`: DOM implementation for testing
- `msw`: Mock Service Worker for API mocking
- `prettier`: Code formatter
- `vitest`: Unit testing framework
- `wiremock`: HTTP mock server


## Maven (pom.xml) Operations

The `pom.xml` file configures the Java-based AWS CDK infrastructure code.

### Maven Project Configuration

| Property | Value | Description |
|----------|-------|-------------|
| **GroupId** | `submit.diyaccounting.co.uk` | Project group identifier |
| **ArtifactId** | `web` | Project artifact identifier |
| **Version** | `0.0.2-4` | Current version |
| **Packaging** | `jar` | Packaging type |
| **Java Version** | `21` (source and target) | Required Java version |

### Key Maven Commands

#### `./mvnw clean verify`

**Purpose**: Complete build, test, and package cycle for CDK infrastructure

**What it does specifically in this pom.xml**:

1. **Clean Phase**: Removes `target/` directory
2. **Compile Phase**: 
   - Compiles Java sources from `infra/main/java`
   - Processes Immutables annotations to generate value classes
   - JVM args: `-Xshare:off`, `-XX:+EnableDynamicAgentLoading`, `-Xlint:-options`
3. **Test Phase**:
   - Compiles test sources from `infra/test/java`
   - Runs JUnit 5 tests with Mockito
   - Forks tests in separate JVM
   - JVM args: `-XX:+EnableDynamicAgentLoading`, `-Xshare:off`, `--add-opens java.base/java.lang=ALL-UNNAMED`
4. **Package Phase**:
   - Creates shaded JAR (`web-0.0.2-4-dist.jar`) with all dependencies
   - Merges META-INF/services files
   - Excludes signature files, duplicate metadata, and conflicting resources
   - Generates OpenAPI documentation (`web/public/docs/openapi.yaml` and `openapi.json`)
   - Executes `co.uk.diyaccounting.submit.swagger.OpenApiGenerator` with args: `${baseUrl} ${project.version} ${project.basedir}/web/public/docs`
5. **Verify Phase** (via maven-antrun-plugin):
   - Creates `target/submit-application.jar` (copy of shaded JAR with Main-Class: `co.uk.diyaccounting.submit.SubmitApplication`)
   - Creates `target/submit-environment.jar` (copy of shaded JAR with Main-Class: `co.uk.diyaccounting.submit.SubmitEnvironment`)
   - Attaches both JARs as project artifacts
6. **Install Phase**:
   - Runs Spotless formatting checks on Java code and pom.xml
   - Fails if formatting issues are detected

**Duration**: ~45 seconds

**Output Artifacts**:
- `target/submit-application.jar` - CDK entry point for application stacks
- `target/submit-environment.jar` - CDK entry point for environment stacks
- `web/public/docs/openapi.yaml` - API documentation
- `web/public/docs/openapi.json` - API documentation (JSON)

#### `./mvnw clean test`

**Purpose**: Run unit tests only without packaging

**What it does**:
1. Cleans target directory
2. Compiles source and test files
3. Runs JUnit 5 tests
4. **Does NOT** package JARs or generate documentation

**Duration**: ~20 seconds

#### `./mvnw spotless:check`

**Purpose**: Verify code formatting without making changes

**What it does specifically**:
1. Checks Java files in `infra/main/java/**/*.java` and `infra/test/java/**/*.java`:
   - Palantir Java Format (v2.50.0) style
   - Unused imports removed
   - Imports organized
   - Files end with newline
2. Checks `pom.xml`:
   - Sorts dependencies by scope, groupId, artifactId
   - Sorts plugins by groupId, artifactId
   - Sorts properties alphabetically
   - Consistent indentation (4 spaces)
   - Trims trailing whitespace

**Duration**: ~10 seconds
**Exit Code**: 0 if formatted correctly, 1 if issues found

#### `./mvnw spotless:apply`

**Purpose**: Auto-format all Java code and pom.xml

**What it does**:
1. Applies Palantir Java Format to all Java files
2. Removes unused imports
3. Organizes import statements
4. Sorts and formats pom.xml
5. **Always** succeeds (does not fail the build)

**Duration**: ~15 seconds

### Java Version Compatibility

The pom.xml specifies Java 21, but the project can be compiled with Java 17+ using compiler overrides:

```bash
./mvnw clean verify -Dmaven.compiler.source=17 -Dmaven.compiler.target=17
```

This is used in GitHub Actions where Java 21 is standardized but older versions are supported.

### Maven Plugins Explained

| Plugin | What It Does in This Project |
|--------|------------------------------|
| **spotless-maven-plugin** (2.45.0) | Enforces Palantir Java Format (100-column width) and sorts pom.xml. Runs during `install` phase. |
| **maven-compiler-plugin** (3.14.0) | Compiles Java 21 source code and processes Immutables annotations for generating value classes. |
| **maven-shade-plugin** (3.6.0) | Creates fat JAR with all dependencies. Merges service provider files, excludes signatures and duplicate metadata. |
| **maven-antrun-plugin** (3.1.0) | Post-processes shaded JAR to create two variants with different Main-Class manifests. |
| **build-helper-maven-plugin** (3.5.0) | Attaches `submit-application.jar` and `submit-environment.jar` as classified artifacts. |
| **exec-maven-plugin** (3.5.0) | Generates OpenAPI YAML/JSON documentation during package phase by running `OpenApiGenerator.main()`. |
| **maven-surefire-plugin** (3.5.3) | Runs JUnit 5 tests with custom JVM arguments to suppress warnings and allow reflection. |
| **maven-enforcer-plugin** (3.6.0) | Requires Maven 3.9.10 or higher. |
| **maven-wrapper-plugin** (3.3.2) | Configures Maven wrapper to use Maven 3.9.10. |

### Key Dependencies

**AWS CDK** (v2.221.0):
- All AWS service modules in one library (`aws-cdk-lib`)
- Constructs framework for building CDK applications

**AWS SDK** (v2.40.2):
- Lambda SDK for interacting with Lambda service
- S3 SDK for S3 operations during CDK synthesis

**Code Generation**:
- **Immutables** (v2.11.6): Generates immutable value objects from interfaces/abstract classes

**Testing**:
- **JUnit 5**: Test framework
- **Mockito** (v5.20.0): Mocking framework
- **system-stubs-jupiter** (v2.1.8): Mock system properties and environment variables
- **junit-pioneer** (v2.3.0): JUnit 5 extensions
- **CDK Nag** (v2.37.55): Security and best practices checks for CDK (test scope only)

### CDK Stack Classes

The Java code defines two main entry points for CDK synthesis:

| Entry Point | Main Class | CDK App Name | Stacks Created |
|-------------|------------|--------------|----------------|
| **Environment** | `co.uk.diyaccounting.submit.SubmitEnvironment` | `SubmitEnvironment` | ObservabilityStack, ObservabilityUE1Stack, DataStack, ProxyStack, ApexStack, IdentityStack |
| **Application** | `co.uk.diyaccounting.submit.SubmitApplication` | `SubmitApplication` | DevStack, DevUE1Stack, SelfDestructStack, AuthStack, HmrcStack, AccountStack, ApiStack, EdgeStack, PublishStack, OpsStack |

### OpenAPI Documentation Generation

During the package phase, the `exec-maven-plugin` runs:

```bash
java -cp <classpath> co.uk.diyaccounting.submit.swagger.OpenApiGenerator \
  ${baseUrl} ${project.version} ${project.basedir}/web/public/docs
```

**Arguments**:
- `${baseUrl}`: Resolved from `DIY_SUBMIT_APEX_URL` environment variable
- `${project.version}`: `0.0.2-4`
- Output directory: `web/public/docs`

**Output**:
- `openapi.yaml`: OpenAPI 3.0 specification in YAML format
- `openapi.json`: OpenAPI 3.0 specification in JSON format

These files document all API endpoints (auth, HMRC, account, receipts).


## GitHub Actions Workflows

The `.github/workflows/` directory contains CI/CD workflows for testing, building, and deploying the application.

### Workflow Files Overview

| Workflow File | Purpose | Triggers |
|---------------|---------|----------|
| `deploy.yml` | Main deployment workflow for application stacks | Push to any branch (with path filters), manual dispatch, daily schedule (04:11 UTC) |
| `deploy-environment.yml` | Deploy shared environment infrastructure | Push to any branch (with path filters for env files), manual dispatch, daily schedule (03:51 UTC) |
| `test.yml` | Run all test suites without deployment | Push to any branch (with path filters for code/tests), manual dispatch, daily schedule (04:23 UTC), workflow_call (reusable) |
| `set-origins.yml` | Update Route53 DNS and CloudFront distribution aliases | Manual dispatch only |

### deploy.yml - Main Deployment Workflow

**Purpose**: Build, test, and deploy the complete application to AWS.

**Trigger Conditions**:
- Push to any branch (except `gh_pages` and `dependabot/**`)
- Only for changes to: `app/`, `infra/main/`, `web/public/`, `.env.*`, `cdk.json`, `Dockerfile`, `LICENSE`, `package.json`, `pom.xml`, product catalog, workflow files
- Manual dispatch with options
- Daily schedule at 04:11 UTC

**Input Parameters (Manual Dispatch)**:
- `forceAllStackDeployment` (choice): Force re-deploy all stacks even if they exist (`true`/`false`, default `false`)
- `skipDeploy` (choice): Run tests only, skip deployment (`true`/`false`, default `false`)
- `environment-name` (choice): Override environment name (`''`, `ci`, `prod`, default `''`)
- `deployment-name` (string): Override deployment name (default `''`)
- `loadTestDuration` (string): Duration for load tests (default `30s`)
- `selfDestructDelayHours` (string): Hours before self-destruct for non-prod (default `8`)
- `convertTestVideo` (choice): Convert test videos to MP4 (`true`/`false`, default `false`)

**Environment Variables**:
```yaml
JAVA_VERSION: '21'
NODE_VERSION: '22'
ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
AWS_REGION: 'eu-west-2'
AWS_ACCOUNT_ID: '887764105431'
AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'
BASE_IMAGE_TAG: ${{ github.sha }}
```

**Job Flow**:

1. **names**: Compute environment and deployment names from branch/inputs
2. **test**: Delegate to `test.yml` workflow (runs unit, system, browser tests, CDK synth)
3. **npm-unit-test-coverage**: Generate code coverage reports
4. **mvn-package**: Build JARs, compute self-destruct datetime
5. **behaviour-test-bundle**: Run bundle behaviour tests with local proxy
6. **behaviour-test-obligation**: Run VAT obligation tests with HMRC sandbox
7. **behaviour-test-submit-vat**: Run VAT submission tests with HMRC sandbox
8. **test-aws-credentials**: Verify AWS authentication
9. **skip-deploy-check**: Check if deployment should be skipped
10. **docker-build**: Build and save Docker image artifact
11. **deploy-dev**: Deploy DevStack (S3, CloudFront distribution, ACM, ECR)
12. **deploy-dev-us-east-1**: Deploy DevUE1Stack (same resources in us-east-1)
13. **push-images**: Tag and push Docker image to ECR (eu-west-2)
14. **push-images-us-east-1**: Tag and push Docker image to ECR (us-east-1)
15. **deploy-application-self-destruct**: Deploy SelfDestructStack (non-prod only)
16. **deploy-auth**: Deploy AuthStack (Cognito token endpoints, mock OAuth lambdas)
17. **deploy-hmrc**: Deploy HmrcStack (HMRC API lambdas, proxy)
18. **deploy-account**: Deploy AccountStack (bundle/catalog management lambdas)
19. **deploy-api**: Deploy ApiStack (HTTP API gateway, routes, authorizers)
20. **deploy-edge**: Deploy EdgeStack (CloudFront distribution with Lambda@Edge)
21. **deploy-publish**: Deploy PublishStack (sync static files to S3, compute hash)
22. **deploy-ops**: Deploy OpsStack (CloudWatch dashboard)
23. **set-origins**: Update Route53 A/AAAA records and CloudFront aliases
24. **web-test-bundle**: Run bundle behaviour tests against deployed environment
25. **web-test-obligation-sandbox**: Run obligation tests with HMRC sandbox against deployed environment
26. **web-test-obligation**: Run obligation tests with HMRC test API (non-prod only)
27. **web-test-submit-vat-sandbox**: Run VAT submission tests with sandbox against deployed environment
28. **web-test-submit-vat**: Run VAT submission tests with test API (non-prod only)
29. **upload-web-test-results**: Collect and upload all test results to S3
30. **convert-video**: Convert Playwright videos to MP4 (if requested)
31. **set-last-known-good-deployment**: Store deployment name in SSM Parameter Store
32. **destroy-previous**: Destroy previous prod deployment (prod only, excludes holding page)
33. **invalidate-cloudfront**: Invalidate CloudFront cache for `/tests/*` and `/docs/*`

**Key Features**:
- **Parallel Execution**: Many jobs run in parallel to speed up deployment
- **Skip Logic**: Static stacks (DevStack, EdgeStack, OpsStack) are skipped if already deployed and unchanged
- **Hash-Based Publishing**: Static files are only published if content hash changes
- **Artifact Management**: Test results, logs, and videos are uploaded as artifacts
- **Blue-Green Deployment**: New deployment is tested before DNS cutover
- **Automatic Cleanup**: Previous prod deployments are destroyed after successful cutover

**Stack Deployment Order**:

Environment Stacks (prerequisite):
- ObservabilityStack, DataStack, ProxyStack, ApexStack, IdentityStack

Application Stacks:
1. DevStack, DevUE1Stack (S3, CloudFront, ECR)
2. SelfDestructStack (non-prod only)
3. AuthStack, HmrcStack, AccountStack (in parallel)
4. ApiStack (depends on auth/hmrc/account)
5. EdgeStack (depends on ApiStack)
6. PublishStack (depends on EdgeStack)
7. OpsStack (depends on ApiStack, EdgeStack)

**Deployment Concurrency**: 4 stacks deployed simultaneously per `npx cdk deploy` invocation

**Typical Execution Time**:
- CI deployment: ~25-35 minutes
- Prod deployment: ~30-40 minutes (includes more thorough testing)

### deploy-environment.yml - Environment Infrastructure Workflow

**Purpose**: Deploy shared, long-lived infrastructure for an environment (CI or prod).

**Trigger Conditions**:
- Push to any branch (except `gh_pages` and `dependabot/**`)
- Only for changes to: `.env.ci`, `.env.prod`, `cdk-environment/cdk.json`, workflow files
- Manual dispatch with environment name override
- Daily schedule at 03:51 UTC

**Input Parameters**:
- `environment-name` (choice): Override environment (`''`, `ci`, `prod`, default `''`)

**Job Flow**:

1. **names**: Compute environment name
2. **create-secrets**: Create/update AWS Secrets Manager secrets for Google and HMRC credentials
3. **deploy-observability**: Deploy ObservabilityStack (CloudWatch RUM, alarms) in eu-west-2
4. **deploy-observability-us-east-1**: Deploy ObservabilityUE1Stack in us-east-1
5. **deploy-data**: Deploy DataStack (DynamoDB tables for bundles, receipts, API requests)
6. **deploy-proxy**: Deploy ProxyStack (VPC endpoints, security groups for proxy)
7. **provision-bundles**: Add bundles for subscribers listed in `product-subscribers.subs`
8. **deploy-apex**: Deploy ApexStack (Route53 apex domain records)
9. **deploy-identity**: Deploy IdentityStack (Cognito user pool, client, hosted UI)
10. **set-repository-environment-variables**: Store Cognito ARNs/IDs as GitHub environment variables

**Stacks Deployed**:
- `{env}-env-ObservabilityStack` (eu-west-2)
- `{env}-env-ObservabilityUE1Stack` (us-east-1)
- `{env}-env-DataStack` (eu-west-2)
- `{env}-env-ProxyStack` (eu-west-2)
- `{env}-env-ApexStack` (eu-west-2)
- `{env}-env-IdentityStack` (eu-west-2)

**Secrets Created/Updated**:
- `{env}/submit/google/client_secret`
- `{env}/submit/hmrc/client_secret`
- `{env}/submit/hmrc/sandbox_client_secret`

**GitHub Environment Variables Set**:
- `COGNITO_USER_POOL_ARN`
- `COGNITO_USER_POOL_ID`
- `COGNITO_CLIENT_ID`

**Typical Execution Time**: ~15-20 minutes

**Note**: This workflow typically runs infrequently (only when environment configuration changes).

### test.yml - Test Workflow

**Purpose**: Run all automated tests without deploying to AWS.

**Trigger Conditions**:
- Push to any branch (except `gh_pages`)
- Only for changes to code, tests, config files
- Manual dispatch
- Daily schedule at 04:23 UTC
- Callable as reusable workflow (used by `deploy.yml`)

**Input Parameters** (Manual/Workflow Call):
- `environment-name` (string): Environment name
- `deployment-name` (string): Deployment name

**Job Flow**:

1. **names**: Compute environment and deployment names
2. **npm-test**: Run unit and system tests (`npm test`)
3. **npm-unit-test**: Run unit tests with coverage
4. **npm-system-test**: Run system tests (with Docker containers)
5. **npm-test-web-unit**: Run web unit tests
6. **npm-browser-test**: Run Playwright browser tests
7. **mvn-test**: Run Java/CDK unit tests
8. **npm-test-cdk-ci**: Synthesize CDK stacks for CI environment (validate CDK code)
9. **npm-test-cdk-prod**: Synthesize CDK stacks for prod environment (validate CDK code)

**Tests Run**:
- ~108 unit tests (app + web)
- ~20 system tests (with Docker)
- ~15 browser tests (Playwright)
- ~40 Java/CDK unit tests
- CDK synthesis validation (both CI and prod configs)

**Typical Execution Time**: ~8-12 minutes

**Exit Criteria**: All tests must pass for workflow to succeed.

### set-origins.yml - DNS/CloudFront Update Workflow

**Purpose**: Manually switch the apex domain to point to a specific deployment (or holding page).

**Trigger Conditions**:
- Manual dispatch only (no automatic triggers)

**Input Parameters**:
- `domain-source` (choice): Source domain to point to (`branch`, `holding`, default `branch`)
- `hosted-zone-id` (string): Route53 hosted zone ID (default `Z0315522208PWZSSBI9AL`)
- `cloudfront-distribution-id` (string): CloudFront distribution ID (optional, will be looked up if not provided)
- `environment-name` (choice): Environment name override (`''`, `ci`, `prod`)
- `deployment-name` (string): Deployment name override

**Job Flow**:

1. **names**: Compute environment and deployment names
2. **set-origins**: 
   - Look up CloudFront distribution ID by tag `OriginFor` if not provided
   - Call `.github/actions/set-origins` action to:
     - Add CloudFront alternate domain name (CNAME) for apex domain
     - Create Route53 A and AAAA alias records pointing apex to CloudFront
     - Return existing deployment name (for rollback purposes)

**Use Cases**:
- **Blue-Green Cutover**: Switch from one deployment to another
- **Rollback**: Point back to previous deployment
- **Maintenance Page**: Point to holding page during maintenance

**Typical Execution Time**: ~2-3 minutes

### GitHub Actions Workflow Reusable Actions

The repository includes custom actions in `.github/actions/`:

#### get-names

**Purpose**: Compute environment and deployment names from branch name or inputs.

**Inputs**:
- `environment-name`: Override environment name
- `deployment-name`: Override deployment name

**Outputs**:
- `environment-name`: `ci` or `prod`
- `deployment-name`: `ci`, `prod`, `ci-{short-sha}`, or `prod-{short-sha}`
- `base-domain`: `{deployment-name}.submit.diyaccounting.co.uk`
- `base-url`: `https://{base-domain}/`
- `apex-domain`: `submit.diyaccounting.co.uk` (ci) or `submit.diyaccounting.co.uk` (prod)
- `apex-url`: `https://{apex-domain}/`
- `holding-domain`: `{environment-name}-holding.submit.diyaccounting.co.uk`
- `holding-url`: `https://{holding-domain}/`

**Logic**:
- Main branch → `environment-name=prod`, `deployment-name=prod-{short-sha}`
- Other branches → `environment-name=ci`, `deployment-name=ci-{short-sha}`
- Manual dispatch can override both

#### set-origins

**Purpose**: Update Route53 and CloudFront to point apex domain to a specific origin domain.

**Inputs**:
- `origin-domain`: Domain to point to (e.g., `ci-abc123.submit.diyaccounting.co.uk`)
- `apex-domain`: Apex domain to update (e.g., `submit.diyaccounting.co.uk`)
- `aws-account-id`: AWS account ID
- `hosted-zone-id`: Route53 hosted zone ID
- `cloudfront-distribution-id`: CloudFront distribution ID

**Actions**:
1. Query current apex domain CNAME/alias target
2. Update CloudFront distribution alternate domain names (CNAMEs) to include apex domain
3. Create/update Route53 A and AAAA alias records for apex domain pointing to CloudFront
4. Return previous deployment name (origin domain)

**Outputs**:
- `existing-deployment-name`: Previous deployment that apex was pointing to

### CI/CD Security

**Authentication**:
- GitHub Actions uses OIDC to assume AWS IAM roles
- Two-role chaining: Actions role → Deployment role
- No long-lived AWS credentials stored in GitHub

**Secrets**:
- All secrets stored in AWS Secrets Manager (prod/ci)
- GitHub Secrets used only for:
  - OAuth client secrets (to create AWS secrets)
  - ngrok token (for behaviour tests)
  - Personal access token (for updating GitHub environment variables)

**Permissions**:
- Workflows use minimal permissions (`contents: read`, `id-token: write`)
- Deployment role has full CloudFormation/Lambda/S3/etc. permissions
- Actions role can only assume deployment role


## AWS Deployment Architecture

The application deploys to AWS as a serverless, highly scalable architecture.

### High-Level Architecture Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         Internet (Users)                                   │
└────────────────────────────────┬──────────────────────────────────────────┘
                                 │
                   ┌─────────────┴─────────────┐
                   │                           │
                   ▼                           ▼
        ┌────────────────────┐      ┌────────────────────┐
        │   Route 53          │      │   HMRC MTD API      │
        │   (DNS)             │      │   (External)        │
        └─────────┬───────────┘      └────────────────────┘
                  │                            ▲
                  ▼                            │
        ┌────────────────────┐                │ HTTPS
        │   CloudFront       │                │
        │   (CDN)            │                │
        └─────────┬───────────┘                │
                  │                            │
        ┌─────────┴────────────┐              │
        │                      │              │
        ▼                      ▼              │
┌──────────────┐     ┌────────────────────┐  │
│   S3 Bucket  │     │  HTTP API Gateway   │  │
│   (Static    │     │  (Lambda URLs)      │  │
│   Frontend)  │     └────────┬────────────┘  │
└──────────────┘              │               │
                              │               │
                   ┌──────────┴──────────┐    │
                   │                     │    │
                   ▼                     ▼    │
        ┌──────────────────┐  ┌──────────────────┐
        │  Lambda Functions │  │  Lambda Functions │
        │  (Auth, Account)  │  │  (HMRC Proxy)     │───┘
        └────────┬──────────┘  └──────────┬────────┘
                 │                        │
                 ▼                        ▼
        ┌──────────────────┐  ┌──────────────────┐
        │   Cognito User    │  │   Secrets Manager │
        │   Pool            │  │   (API Keys)      │
        └───────────────────┘  └───────────────────┘
                 │
                 ▼
        ┌──────────────────┐
        │   DynamoDB        │
        │   (Bundles,       │
        │   Receipts)       │
        └───────────────────┘
```

### AWS Services Used

| Service | Purpose | Configuration |
|---------|---------|---------------|
| **CloudFront** | CDN for static assets and API | Custom domain, ACM certificate, Lambda@Edge for auth |
| **S3** | Static website hosting | Origin bucket for frontend HTML/CSS/JS |
| **Route 53** | DNS management | A/AAAA alias records to CloudFront |
| **Lambda** | Serverless compute for backend APIs | Node.js 22 runtime, Docker images from ECR |
| **HTTP API Gateway** | HTTP API routing and authorization | Lambda URL targets, custom authorizer |
| **Cognito** | User authentication | User pool, hosted UI, Google IdP federation |
| **DynamoDB** | NoSQL database | Three tables: bundles, receipts, API requests |
| **Secrets Manager** | Secret storage | HMRC OAuth secrets, Google OAuth secrets |
| **CloudWatch** | Logging and monitoring | Log groups, RUM (Real User Monitoring), alarms |
| **ECR** | Docker image registry | Stores Lambda runtime images |
| **ACM** | SSL/TLS certificates | Certificates in us-east-1 for CloudFront |
| **EventBridge** | Scheduled events | Self-destruct timer for non-prod deployments |
| **IAM** | Access control | Roles for Lambda execution, GitHub Actions |

### CDK Stack Architecture

The infrastructure is divided into two main CDK applications:

#### Environment Stacks (Long-Lived)

Deployed by `SubmitEnvironment.java` using `cdk-environment/cdk.json`:

| Stack Name | Resources Created | Purpose |
|------------|-------------------|---------|
| **ObservabilityStack** | CloudWatch Log Groups, RUM App Monitor, Alarms, SNS Topics | Logging and monitoring in eu-west-2 |
| **ObservabilityUE1Stack** | CloudWatch RUM resources | RUM resources in us-east-1 for global access |
| **DataStack** | 3 DynamoDB Tables (bundles, receipts, API requests) | Persistent data storage |
| **ProxyStack** | VPC Endpoints, Security Groups | Network configuration for proxy access |
| **ApexStack** | Route 53 Hosted Zone, Records | DNS apex domain management |
| **IdentityStack** | Cognito User Pool, Client, Hosted UI, Google IdP | User authentication |

**Lifecycle**: Created once per environment (ci/prod), rarely updated.

#### Application Stacks (Per-Deployment)

Deployed by `SubmitApplication.java` using `cdk-application/cdk.json`:

| Stack Name | Resources Created | Purpose |
|------------|-------------------|---------|
| **DevStack** | S3 Bucket (origin), CloudFront Distribution, ACM Certificate, ECR Repository | Static hosting, CDN, container registry (eu-west-2) |
| **DevUE1Stack** | S3 Bucket, CloudFront, ACM, ECR | Same resources in us-east-1 for edge functions |
| **SelfDestructStack** | Lambda, EventBridge Rule | Auto-destroy non-prod stacks after N hours |
| **AuthStack** | 3 Lambda Functions | Cognito auth URL, token exchange, mock OAuth2 |
| **HmrcStack** | 7 Lambda Functions | HMRC API integration (auth URL, token, VAT obligations, VAT returns, receipts) |
| **AccountStack** | 3 Lambda Functions | Bundle management, catalog |
| **ApiStack** | HTTP API, Routes, Authorizers, Lambda integrations | API Gateway with custom JWT authorizer |
| **EdgeStack** | CloudFront Distribution with custom config, Lambda@Edge | Production CDN with edge functions |
| **PublishStack** | S3 Deployment, Content hash tracking | Deploy static files to S3 |
| **OpsStack** | CloudWatch Dashboard | Operational monitoring dashboard |

**Lifecycle**: Created per deployment (e.g., `ci-abc123`, `prod-xyz789`), destroyed after next deployment.

### Deployment Process Flow

1. **Environment Setup** (one-time per environment):
   ```
   deploy-environment.yml workflow
   ├── Create AWS Secrets (HMRC, Google)
   ├── Deploy ObservabilityStack (eu-west-2)
   ├── Deploy ObservabilityUE1Stack (us-east-1)
   ├── Deploy DataStack (DynamoDB tables)
   ├── Deploy ProxyStack (VPC configuration)
   ├── Deploy ApexStack (Route53 hosted zone)
   ├── Deploy IdentityStack (Cognito)
   └── Set GitHub environment variables (Cognito ARN/IDs)
   ```

2. **Application Deployment** (per code change):
   ```
   deploy.yml workflow
   ├── Run Tests (unit, system, browser)
   ├── Build Maven JARs (CDK infrastructure)
   ├── Build Docker Image (Lambda runtime)
   ├── Deploy DevStack (S3, CloudFront, ECR)
   ├── Deploy DevUE1Stack (us-east-1 resources)
   ├── Push Docker Images to ECR
   ├── Deploy SelfDestructStack (if non-prod)
   ├── Deploy AuthStack (Lambda functions)
   ├── Deploy HmrcStack (Lambda functions)
   ├── Deploy AccountStack (Lambda functions)
   ├── Deploy ApiStack (HTTP API Gateway)
   ├── Deploy EdgeStack (CloudFront + Lambda@Edge)
   ├── Deploy PublishStack (S3 static files)
   ├── Deploy OpsStack (CloudWatch dashboard)
   ├── Update DNS (Route53 A/AAAA records to new CloudFront)
   ├── Run End-to-End Tests (against deployed environment)
   ├── Upload Test Results to S3
   ├── Set Last-Known-Good Deployment (SSM Parameter)
   └── Destroy Previous Deployment (if prod and successful)
   ```

### Lambda Function Details

All Lambda functions run Node.js 22 from Docker images stored in ECR.

#### Auth Functions

| Function | Path | Handler | Purpose |
|----------|------|---------|---------|
| `cognitoAuthUrlGet` | `/auth/cognito/authurl` | `app/functions/auth/cognitoAuthUrlGet.js` | Generate Cognito OAuth authorization URL |
| `cognitoTokenPost` | `/auth/cognito/token` | `app/functions/auth/cognitoTokenPost.js` | Exchange auth code for Cognito tokens |
| `mockAuthUrlGet` | `/auth/mock/authurl` | `app/functions/non-lambda-mocks/mockAuthUrlGet.js` | Mock OAuth auth URL (testing) |
| `mockTokenPost` | `/auth/mock/token` | `app/functions/non-lambda-mocks/mockTokenPost.js` | Mock OAuth token (testing) |
| `customAuthorizer` | (API Gateway authorizer) | `app/functions/auth/customAuthorizer.js` | JWT validation for protected routes |

#### HMRC Functions

| Function | Path | Handler | Purpose |
|----------|------|---------|---------|
| `hmrcAuthUrlGet` | `/hmrc/authurl` | `app/functions/hmrc/hmrcAuthUrlGet.js` | Generate HMRC OAuth URL |
| `hmrcTokenPost` | `/hmrc/token` | `app/functions/hmrc/hmrcTokenPost.js` | Exchange code for HMRC access token |
| `hmrcVatObligationGet` | `/hmrc/vat/obligations` | `app/functions/hmrc/hmrcVatObligationGet.js` | Retrieve VAT obligations from HMRC |
| `hmrcVatReturnGet` | `/hmrc/vat/returns` | `app/functions/hmrc/hmrcVatReturnGet.js` | Retrieve VAT return data |
| `hmrcVatReturnPost` | `/hmrc/vat/returns` | `app/functions/hmrc/hmrcVatReturnPost.js` | Submit VAT return to HMRC |
| `hmrcReceiptGet` | `/hmrc/receipts` | `app/functions/hmrc/hmrcReceiptGet.js` | Retrieve receipt from DynamoDB |
| `hmrcReceiptPost` | `/hmrc/receipts` | `app/functions/hmrc/hmrcReceiptPost.js` | Store HMRC receipt in DynamoDB |
| `hmrcHttpProxy` | `/proxy/hmrc-api/*` | `app/functions/infra/hmrcHttpProxy.js` | HTTP proxy with rate limiting and circuit breaker |

#### Account Functions

| Function | Path | Handler | Purpose |
|----------|------|---------|---------|
| `catalogGet` | `/account/catalog` | `app/functions/account/catalogGet.js` | Get product catalog (from TOML file) |
| `bundleGet` | `/account/bundles` | `app/functions/account/bundleGet.js` | Get user's bundles from DynamoDB |
| `bundlePost` | `/account/bundles` | `app/functions/account/bundlePost.js` | Create/update bundle in DynamoDB |
| `bundleDelete` | `/account/bundles` | `app/functions/account/bundleDelete.js` | Delete bundle from DynamoDB |

#### Infrastructure Functions

| Function | Trigger | Handler | Purpose |
|----------|---------|---------|---------|
| `selfDestruct` | EventBridge (scheduled) | `app/functions/infra/selfDestruct.js` | Delete all stacks for non-prod deployment after N hours |

### DynamoDB Schema

#### Bundles Table

**Purpose**: Store user entitlements/subscriptions.

| Attribute | Type | Description |
|-----------|------|-------------|
| `sub` (PK) | String | Hashed subscriber ID (from JWT) |
| `product` (SK) | String | Product name (e.g., "guest", "test") |
| `expiryDate` | String | ISO 8601 expiry date |
| `userLimit` | Number | Maximum users allowed |
| `users` | StringSet | Set of user IDs with access |
| `createdAt` | String | ISO 8601 creation timestamp |
| `updatedAt` | String | ISO 8601 last update timestamp |

#### Receipts Table

**Purpose**: Store HMRC API submission receipts.

| Attribute | Type | Description |
|-----------|------|-------------|
| `sub` (PK) | String | Hashed subscriber ID |
| `receiptId` (SK) | String | HMRC receipt ID (formBundleNumber) |
| `vrn` | String | VAT Registration Number |
| `periodKey` | String | VAT period (e.g., "24A1") |
| `processingDate` | String | ISO 8601 processing timestamp |
| `chargeRefNumber` | String | HMRC charge reference |
| `createdAt` | String | ISO 8601 receipt storage timestamp |
| `payload` | Map | Full HMRC response |

#### HMRC API Requests Table

**Purpose**: Log all HMRC API requests for debugging and audit.

| Attribute | Type | Description |
|-----------|------|-------------|
| `id` (PK) | String | UUID request ID |
| `timestamp` (SK) | String | ISO 8601 request timestamp |
| `method` | String | HTTP method |
| `path` | String | API path |
| `statusCode` | Number | HTTP response status |
| `durationMs` | Number | Request duration in milliseconds |
| `sub` | String | User subscriber ID (if authenticated) |
| `error` | String | Error message (if failed) |

### CloudFront Configuration

**Origin**: S3 bucket (`{deployment-name}-submit-app-origin-us-east-1`)

**Behaviors**:
- `/` → S3 (static files)
- `/api/*` → HTTP API Gateway (Lambda functions)
- `/proxy/*` → HMRC HTTP proxy Lambda

**Cache Policy**:
- Static files: Cache for 1 year, gzip/brotli compression
- API responses: No caching (dynamic content)

**Custom Domain**: `submit.diyaccounting.co.uk` (prod) or `ci.submit.diyaccounting.co.uk` (CI)

**Certificate**: ACM certificate in us-east-1 (required for CloudFront)

**Lambda@Edge**: (Currently not deployed, but EdgeStack is prepared for it)

### Security Architecture

**Authentication Flow**:
1. User navigates to `https://submit.diyaccounting.co.uk/`
2. Frontend JavaScript checks for JWT in localStorage
3. If no JWT, redirect to `/auth/cognito/authurl` to get Cognito OAuth URL
4. User authenticates with Cognito (Google IdP or username/password)
5. Cognito redirects to `/auth/loginWithCognitoCallback.html?code=...`
6. Frontend exchanges code for JWT via `/auth/cognito/token`
7. JWT stored in localStorage
8. All subsequent API requests include JWT in Authorization header
9. API Gateway invokes custom authorizer Lambda to validate JWT
10. If valid, request forwarded to backend Lambda
11. Backend Lambda can read user identity from JWT claims

**Authorization Flow**:
1. API Gateway receives request with `Authorization: Bearer <jwt>`
2. Custom authorizer Lambda (`customAuthorizer.js`) validates JWT:
   - Verifies signature using Cognito public keys
   - Checks expiration
   - Validates issuer and audience
3. If valid, returns IAM policy allowing request
4. API Gateway forwards request to backend Lambda
5. Backend Lambda reads `sub` (subscriber ID) from JWT claims
6. Backend queries DynamoDB for user's bundles/entitlements
7. Backend enforces feature access based on entitlements

**Secret Management**:
- **Development**: Secrets in `.env` files (not committed)
- **AWS**: All secrets in Secrets Manager
  - HMRC OAuth client secrets
  - Google OAuth client secret
  - Retrieved at Lambda runtime via AWS SDK

**Network Security**:
- All traffic over HTTPS (ACM certificates)
- CloudFront enforces HTTPS
- Lambda functions in private VPC (optional, via ProxyStack)
- DynamoDB encryption at rest (AWS managed keys)
- S3 bucket policies restrict access to CloudFront only


## Local Express Server Architecture

For local development, the application runs as an Express.js server with supporting services.

### Local Development Stack

```
┌─────────────────────────────────────────────────────────────┐
│                       Developer Machine                       │
│                                                               │
│  ┌────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │   ngrok        │  │   Mock OAuth2    │  │   Dynalite   │ │
│  │   (Port 3000)  │  │   (Port 8080)    │  │   (Dynamic)  │ │
│  └───────┬────────┘  └──────────┬───────┘  └──────┬───────┘ │
│          │                      │                  │         │
│          │ Tunnel               │ OAuth            │ Data    │
│          ▼                      ▼                  ▼         │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │          Express Server (localhost:3000)                  │ │
│  │  ┌──────────────────────────────────────────────────────┐ │ │
│  │  │  httpServerToLambdaAdaptor.js                         │ │ │
│  │  │  (Converts Express req/res to Lambda event/context)   │ │ │
│  │  └───────────────────────┬───────────────────────────────┘ │ │
│  │                          │                                  │ │
│  │                          ▼                                  │ │
│  │  ┌───────────────────────────────────────────────────────┐ │ │
│  │  │  Lambda Function Handlers (imported directly)          │ │ │
│  │  │  - auth/cognitoAuthUrlGet.js                          │ │ │
│  │  │  - hmrc/hmrcVatReturnPost.js                          │ │ │
│  │  │  - account/bundleGet.js                               │ │ │
│  │  │  - etc.                                               │ │ │
│  │  └───────────────────────────────────────────────────────┘ │ │
│  │                                                             │ │
│  │  Static Files: web/public/ (served directly)               │ │
│  └──────────────────────────────────────────────────────────────┘ │
│          │                                                       │
└──────────┴───────────────────────────────────────────────────────┘
           │
           │ HTTPS (ngrok tunnel)
           ▼
   ┌──────────────────┐
   │   ngrok.com      │
   │   Public URL     │
   └──────────────────┘
           │
           │ HTTPS
           ▼
   ┌──────────────────┐
   │   HMRC MTD API   │
   │   OAuth Callback │
   └──────────────────┘
```

### Local Services

#### 1. Express Server (`npm run server`)

**File**: `app/bin/server.js`

**Purpose**: Run Lambda functions locally as Express routes

**Key Features**:
- Loads `.env.proxy` configuration
- Starts Express server on port 3000 (default)
- Uses `httpServerToLambdaAdaptor.js` to convert Express requests to Lambda events
- Imports and invokes Lambda handler functions directly
- Serves static files from `web/public/`
- Logs requests with pino logger

**Routes Registered**:
```javascript
// Auth routes
app.get('/auth/cognito/authurl', adaptLambda(cognitoAuthUrlGet))
app.post('/auth/cognito/token', adaptLambda(cognitoTokenPost))
app.get('/auth/mock/authurl', adaptLambda(mockAuthUrlGet))
app.post('/auth/mock/token', adaptLambda(mockTokenPost))

// HMRC routes
app.get('/hmrc/authurl', adaptLambda(hmrcAuthUrlGet))
app.post('/hmrc/token', adaptLambda(hmrcTokenPost))
app.get('/hmrc/vat/obligations', adaptLambda(hmrcVatObligationGet))
app.get('/hmrc/vat/returns', adaptLambda(hmrcVatReturnGet))
app.post('/hmrc/vat/returns', adaptLambda(hmrcVatReturnPost))
app.get('/hmrc/receipts', adaptLambda(hmrcReceiptGet))
app.post('/hmrc/receipts', adaptLambda(hmrcReceiptPost))

// Account routes
app.get('/account/catalog', adaptLambda(catalogGet))
app.get('/account/bundles', adaptLambda(bundleGet))
app.post('/account/bundles', adaptLambda(bundlePost))
app.delete('/account/bundles', adaptLambda(bundleDelete))

// Proxy routes
app.all('/proxy/hmrc-api/*', adaptLambda(hmrcHttpProxy))
app.all('/proxy/test-hmrc-api/*', adaptLambda(hmrcHttpProxy))

// Static files
app.use(express.static('web/public'))
```

**Startup**:
```bash
cd /home/runner/work/submit.diyaccounting.co.uk/submit.diyaccounting.co.uk
npx dotenv -e .env.proxy -- node app/bin/server.js
# Listening at http://127.0.0.1:3000
```

#### 2. ngrok Proxy (`npm run proxy`)

**File**: `app/bin/ngrok.js`

**Purpose**: Expose local Express server via public HTTPS URL for OAuth callbacks

**Key Features**:
- Authenticates with `NGROK_AUTHTOKEN` environment variable
- Creates tunnel to `localhost:3000`
- Reserves a stable subdomain (e.g., `wanted-finally-anteater.ngrok-free.app`)
- Required for HMRC OAuth because redirect URI must be HTTPS
- URL must be registered in HMRC Developer Hub

**Configuration**:
```javascript
const authtoken = process.env.NGROK_AUTHTOKEN;
const subdomain = 'wanted-finally-anteater';  // Example
const port = process.env.TEST_SERVER_HTTP_PORT || 3000;

await ngrok.connect({
  authtoken,
  proto: 'http',
  addr: port,
  subdomain  // Requires paid ngrok plan
});
```

**Startup**:
```bash
export NGROK_AUTHTOKEN=your_token_here
npx dotenv -e .env.proxy -- node app/bin/ngrok.js
# Tunnel created: https://wanted-finally-anteater.ngrok-free.app -> http://localhost:3000
```

#### 3. Mock OAuth2 Server (`npm run auth`)

**File**: Docker container (`ghcr.io/navikt/mock-oauth2-server:2.2.1`)

**Purpose**: Simulate OAuth2 provider (Google/Cognito) for local testing

**Configuration File**: `mock-oauth2-server.json`

**Features**:
- Runs on `http://localhost:8080`
- Provides OAuth2 endpoints:
  - `/default/authorize` - Authorization endpoint
  - `/default/token` - Token endpoint
  - `/default/jwks` - JSON Web Key Set
- Issues JWTs with configurable claims
- No real authentication (always succeeds)
- Useful for testing OAuth flow without real accounts

**Startup**:
```bash
npx dotenv -e .env.proxy -- docker run -p 8080:8080 \
  -e JSON_CONFIG_PATH=/config/mock-oauth2-config.json \
  -e LOG_LEVEL=DEBUG \
  -v $(pwd)/mock-oauth2-config.json:/config/mock-oauth2-config.json:ro \
  ghcr.io/navikt/mock-oauth2-server:2.2.1
```

#### 4. Local DynamoDB (`npm run data`)

**File**: `app/bin/dynamodb.js`

**Purpose**: Run local DynamoDB for testing

**Implementation**: Uses `dynalite` (lightweight DynamoDB clone)

**Features**:
- Runs on dynamic port (assigned by dynalite)
- Creates three tables:
  - `test-bundle-table`
  - `test-receipts-table`
  - `test-hmrc-api-requests-table`
- Data stored in memory (cleared on restart)
- Full DynamoDB API compatibility

**Startup**:
```bash
npx dotenv -e .env.proxy -- node app/bin/dynamodb.js
# DynamoDB started on port 43210 (example)
```

### httpServerToLambdaAdaptor

**File**: `app/lib/httpServerToLambdaAdaptor.js`

**Purpose**: Bridge between Express.js and AWS Lambda handler interface

**Key Functionality**:

```javascript
export function httpServerToLambdaAdaptor(lambdaHandler) {
  return async (req, res) => {
    // Convert Express request to Lambda event
    const event = {
      httpMethod: req.method,
      path: req.path,
      queryStringParameters: req.query,
      headers: req.headers,
      body: req.body ? JSON.stringify(req.body) : null,
      requestContext: {
        authorizer: { jwt: { claims: req.user || {} } }
      }
    };

    // Invoke Lambda handler
    const response = await lambdaHandler(event, {});

    // Convert Lambda response to Express response
    res.status(response.statusCode || 200);
    Object.entries(response.headers || {}).forEach(([key, value]) => {
      res.set(key, value);
    });
    res.send(response.body);
  };
}
```

**Benefits**:
- Lambda functions can be tested locally without modification
- Same code runs in Lambda (production) and Express (development)
- Eliminates deployment cycle for rapid iteration

### Local Development Workflow

**Starting All Services**:
```bash
# Terminal 1: Start all services (server, proxy, auth, data)
npm start
# Or individually:
# Terminal 1: npm run data
# Terminal 2: npm run auth
# Terminal 3: npm run proxy
# Terminal 4: npm run server
```

**Accessing the Application**:
```
Frontend: https://wanted-finally-anteater.ngrok-free.app/
           (or http://localhost:3000/ for non-OAuth flows)

API Endpoints: https://wanted-finally-anteater.ngrok-free.app/api/*
               http://localhost:3000/api/*

OAuth Callback: https://wanted-finally-anteater.ngrok-free.app/auth/loginWithMockCallback.html
```

**Running Tests Against Local Server**:
```bash
# Behaviour tests (full end-to-end)
npm run test:behaviour-proxy

# Specific behaviour tests
npm run test:bundleBehaviour-proxy
npm run test:obligationBehaviour-proxy-sandbox
npm run test:submitVatBehaviour-proxy-sandbox
```

**Debugging**:
- Express server logs to console (pino JSON format)
- Set `LOG_LEVEL=debug` for verbose logging
- DynamoDB data can be inspected with AWS SDK
- ngrok provides web interface at `http://localhost:4040`

### Component Interaction (Local)

```
User Browser
    │
    │ HTTPS
    ▼
ngrok Public URL (e.g., wanted-finally-anteater.ngrok-free.app)
    │
    │ Tunnel
    ▼
Express Server (localhost:3000)
    │
    ├─► Static Files (web/public/) ────────────────► HTML/CSS/JS
    │
    ├─► /auth/* ───► httpServerToLambdaAdaptor ───► Auth Lambda Handlers
    │                                                     │
    │                                                     ▼
    │                                             Mock OAuth2 (localhost:8080)
    │
    ├─► /hmrc/* ───► httpServerToLambdaAdaptor ───► HMRC Lambda Handlers
    │                                                     │
    │                                                     ├─► HMRC Test API (https://test-api.service.hmrc.gov.uk)
    │                                                     │
    │                                                     └─► Local DynamoDB (dynalite)
    │
    └─► /account/* ─► httpServerToLambdaAdaptor ───► Account Lambda Handlers
                                                          │
                                                          ├─► product-catalogue.toml (filesystem)
                                                          │
                                                          └─► Local DynamoDB (dynalite)
```

### Differences: Local vs AWS

| Aspect | Local (Express) | AWS (Lambda) |
|--------|----------------|--------------|
| **Entry Point** | `app/bin/server.js` | Lambda handler exports |
| **Request/Response** | Express `req`/`res` | Lambda `event`/`context` |
| **Static Files** | Served by Express | Served by S3 + CloudFront |
| **Authentication** | Mock OAuth2 | AWS Cognito |
| **Authorization** | Skipped (or mocked) | API Gateway custom authorizer |
| **Database** | Dynalite (in-memory) | DynamoDB |
| **Secrets** | `.env` file | AWS Secrets Manager |
| **Logging** | Console (pino) | CloudWatch Logs |
| **Scaling** | Single process | Auto-scaling Lambdas |
| **Cost** | Free (local compute) | Pay per request |


## Directory Structure

Hierarchical overview of the repository organized by function.

### Top-Level Structure

| Directory/File | Type | Purpose |
|----------------|------|---------|
| `.github/` | Directory | GitHub Actions workflows and custom actions |
| `app/` | Directory | Backend Node.js Lambda functions and libraries |
| `behaviour-tests/` | Directory | End-to-end Playwright behaviour tests |
| `cdk-application/` | Directory | CDK configuration for application stacks |
| `cdk-environment/` | Directory | CDK configuration for environment stacks |
| `infra/` | Directory | Java/CDK infrastructure code |
| `scripts/` | Directory | Utility scripts for development and deployment |
| `web/` | Directory | Frontend HTML/CSS/JavaScript and tests |
| `wiremock-recordings/` | Directory | WireMock HTTP interaction recordings |
| `.editorconfig` | File | Editor configuration for consistent formatting |
| `.env.ci` | File | CI environment configuration |
| `.env.prod` | File | Production environment configuration |
| `.env.proxy` | File | Local proxy environment configuration |
| `.env.proxyRunning` | File | Configuration for already-running local services |
| `.env.test` | File | Test environment configuration |
| `.gitignore` | File | Git ignore patterns |
| `.ncurc.json` | File | npm-check-updates configuration |
| `.prettierignore` | File | Prettier ignore patterns |
| `.prettierrc` | File | Prettier configuration |
| `Dockerfile` | File | Docker image definition for Lambda runtime |
| `eslint.config.js` | File | ESLint configuration (flat config) |
| `jsconfig.json` | File | JavaScript project configuration |
| `LICENSE` | File | GPL-3.0 license |
| `mock-oauth2-server.json` | File | Mock OAuth2 server configuration |
| `mvnw`, `mvnw.cmd` | Files | Maven wrapper scripts |
| `package.json` | File | Node.js dependencies and scripts |
| `package-lock.json` | File | Locked npm dependency versions |
| `playwright.config.js` | File | Playwright test configuration |
| `pom.xml` | File | Maven project configuration |
| `product-catalogue.toml` | File | Product/bundle catalog definitions |
| `product-subscribers.subs` | File | List of subscriber IDs for bundle provisioning |
| `README.md` | File | Repository readme with quickstart |
| `vitest.config.js` | File | Vitest test configuration |

### `.github/` - GitHub Actions

| Path | Purpose |
|------|---------|
| `workflows/deploy.yml` | Main deployment workflow (application stacks) |
| `workflows/deploy-environment.yml` | Environment infrastructure deployment |
| `workflows/test.yml` | Test suite workflow (reusable) |
| `workflows/set-origins.yml` | DNS/CloudFront update workflow |
| `actions/get-names/action.yml` | Compute environment and deployment names |
| `actions/set-origins/action.yml` | Update Route53 and CloudFront aliases |

### `app/` - Backend Application

```
app/
├── bin/                    # Entry point scripts
│   ├── main.js             # CLI entry point (unused in this project)
│   ├── server.js           # Express server for local development
│   ├── ngrok.js            # ngrok tunnel setup
│   ├── dynamodb.js         # Local DynamoDB (dynalite) startup
│   └── provision-user.mjs  # Cognito user provisioning script
├── data/                   # DynamoDB repository implementations
│   ├── dynamoDbBundleRepository.js        # Bundle CRUD operations
│   ├── dynamoDbReceiptRepository.js       # Receipt CRUD operations
│   ├── dynamoDbHmrcApiRequestRepository.js # API request logging
│   └── dynamoDbBreakerRepository.js       # Circuit breaker state storage
├── functions/              # Lambda function handlers
│   ├── auth/               # Authentication functions
│   │   ├── cognitoAuthUrlGet.js          # Generate Cognito OAuth URL
│   │   ├── cognitoTokenPost.js           # Exchange auth code for tokens
│   │   └── customAuthorizer.js           # API Gateway JWT authorizer
│   ├── hmrc/               # HMRC API integration
│   │   ├── hmrcAuthUrlGet.js             # Generate HMRC OAuth URL
│   │   ├── hmrcTokenPost.js              # Exchange code for HMRC token
│   │   ├── hmrcVatObligationGet.js       # Retrieve VAT obligations
│   │   ├── hmrcVatReturnGet.js           # Retrieve VAT return
│   │   ├── hmrcVatReturnPost.js          # Submit VAT return
│   │   ├── hmrcReceiptGet.js             # Retrieve receipt from storage
│   │   └── hmrcReceiptPost.js            # Store HMRC receipt
│   ├── account/            # User account management
│   │   ├── bundleGet.js                  # Get user bundles
│   │   ├── bundlePost.js                 # Create/update bundle
│   │   ├── bundleDelete.js               # Delete bundle
│   │   └── catalogGet.js                 # Get product catalog
│   ├── infra/              # Infrastructure functions
│   │   ├── hmrcHttpProxy.js              # HTTP proxy with rate limiting
│   │   └── selfDestruct.js               # Auto-delete non-prod stacks
│   └── non-lambda-mocks/   # Mock implementations for local testing
│       ├── mockAuthUrlGet.js             # Mock OAuth URL
│       └── mockTokenPost.js              # Mock OAuth token
├── lib/                    # Shared libraries
│   ├── httpServerToLambdaAdaptor.js      # Express ↔ Lambda adapter
│   ├── httpProxy.js                      # HTTP proxy service
│   ├── jwtHelper.js                      # JWT utilities
│   ├── logger.js                         # Pino logger configuration
│   ├── httpResponseHelper.js             # Lambda response helpers
│   └── eventToGovClientHeaders.js        # Gov-Client-* header generation
├── services/               # Business logic services
│   ├── bundleManagement.js               # Bundle management logic
│   ├── hmrcApi.js                        # HMRC API client
│   ├── httpProxy.js                      # Proxy service with circuit breaker
│   ├── productCatalog.js                 # Product catalog parser (TOML)
│   └── subHasher.js                      # Subscriber ID hashing
├── test-helpers/           # Test utilities
│   ├── eventBuilders.js                  # Lambda event builders
│   ├── mockHelpers.js                    # Mocking utilities
│   ├── primableMockServer.js             # Mock HTTP server
│   ├── httpTestServers.js                # Test HTTP servers
│   └── dynamodbExporter.js               # DynamoDB data exporter
├── unit-tests/             # Unit tests (Vitest)
│   ├── bin/                              # Tests for bin scripts
│   ├── functions/                        # Tests for Lambda handlers
│   ├── lib/                              # Tests for libraries
│   ├── services/                         # Tests for services
│   ├── data/                             # Tests for repositories
│   └── test-helpers/                     # Tests for test utilities
├── system-tests/           # System/integration tests (Vitest)
│   ├── hmrcAuth.system.test.js
│   ├── hmrcVatScenarios.system.test.js
│   ├── bundleManagement.system.test.js
│   └── ...
└── index.js                # Module index (exports all handlers)
```

### `infra/` - CDK Infrastructure (Java)

```
infra/
├── main/
│   ├── java/co/uk/diyaccounting/submit/
│   │   ├── SubmitApplication.java        # Application CDK entry point
│   │   ├── SubmitEnvironment.java        # Environment CDK entry point
│   │   ├── SubmitSharedNames.java        # Shared naming utilities
│   │   ├── stacks/                       # CDK stack definitions
│   │   │   ├── DevStack.java             # S3, CloudFront, ECR (eu-west-2)
│   │   │   ├── ObservabilityStack.java   # CloudWatch, RUM
│   │   │   ├── ObservabilityUE1Stack.java # CloudWatch RUM (us-east-1)
│   │   │   ├── DataStack.java            # DynamoDB tables
│   │   │   ├── ProxyStack.java           # VPC, security groups
│   │   │   ├── ApexStack.java            # Route53 apex domain
│   │   │   ├── IdentityStack.java        # Cognito user pool
│   │   │   ├── SelfDestructStack.java    # Auto-delete Lambda + EventBridge
│   │   │   ├── AuthStack.java            # Auth Lambda functions
│   │   │   ├── HmrcStack.java            # HMRC Lambda functions
│   │   │   ├── AccountStack.java         # Account Lambda functions
│   │   │   ├── ApiStack.java             # HTTP API Gateway
│   │   │   ├── EdgeStack.java            # CloudFront distribution
│   │   │   ├── PublishStack.java         # S3 static file deployment
│   │   │   ├── OpsStack.java             # CloudWatch dashboard
│   │   │   └── SubmitStackProps.java     # Stack properties interface
│   │   ├── constructs/                   # Reusable CDK constructs
│   │   │   ├── Lambda.java               # Lambda function construct
│   │   │   ├── ApiLambda.java            # API-integrated Lambda
│   │   │   ├── LambdaProps.java          # Lambda properties
│   │   │   └── ApiLambdaProps.java       # API Lambda properties
│   │   ├── utils/                        # Utility classes
│   │   │   ├── Kind.java                 # Resource naming enums
│   │   │   ├── KindCdk.java              # CDK naming utilities
│   │   │   ├── ResourceNameUtils.java    # Name generation
│   │   │   ├── RetentionDaysConverter.java # Log retention conversion
│   │   │   ├── Route53AliasUpsert.java   # Route53 record updates
│   │   │   ├── S3.java                   # S3 utilities
│   │   │   └── PopulatedMap.java         # Map with validation
│   │   ├── swagger/                      # OpenAPI documentation generation
│   │   │   └── OpenApiGenerator.java     # Generates openapi.yaml/json
│   │   └── aspects/                      # CDK aspects (cross-cutting concerns)
│   │       └── SetAutoDeleteJobLogRetentionAspect.java
│   └── resources/
│       └── log4j2.yml                    # Log4j configuration
└── test/
    ├── java/co/uk/diyaccounting/submit/
    │   ├── SubmitApplicationCdkResourceTest.java
    │   ├── SubmitEnvironmentCdkResourceTest.java
    │   └── utils/                        # Unit tests for utilities
    └── resources/
        ├── log4j2.yml
        └── fake-self-destruct-lambda.jar # Test artifact
```

### `web/` - Frontend

```
web/
├── public/                 # Static website files (served by S3/CloudFront)
│   ├── index.html          # Homepage
│   ├── about.html          # About page
│   ├── privacy.html        # Privacy policy
│   ├── submit.css          # Global styles
│   ├── submit.js           # Main JavaScript module
│   ├── auth/               # Authentication pages
│   │   ├── login.html
│   │   ├── loginWithCognitoCallback.html
│   │   └── loginWithMockCallback.html
│   ├── hmrc/               # HMRC-related pages
│   │   ├── vat/
│   │   │   ├── submitVat.html              # VAT submission form
│   │   │   ├── vatObligations.html         # VAT obligations list
│   │   │   └── viewVatReturn.html          # View submitted return
│   │   └── receipt/
│   │       └── receipts.html               # Receipt history
│   ├── account/            # User account pages
│   │   └── bundles.html                    # Bundle management
│   ├── activities/         # OAuth callback handler
│   │   └── submitVatCallback.html
│   ├── widgets/            # Reusable UI components (Web Components)
│   │   ├── auth-status.js                  # Authentication status indicator
│   │   ├── entitlement-status.js           # Bundle/entitlement display
│   │   ├── loading-spinner.js              # Loading indicator
│   │   ├── hamburger-menu.js               # Mobile menu
│   │   ├── localstorage-viewer.js          # Debug: view localStorage
│   │   ├── status-messages.js              # Toast notifications
│   │   └── view-source-link.js             # Link to GitHub source
│   ├── lib/                # Frontend JavaScript libraries
│   │   └── request-cache.js                # HTTP request caching
│   ├── prefetch/           # Service worker prefetch scripts
│   │   ├── prefetch-catalog-head.js
│   │   ├── prefetch-bundle-head.js
│   │   └── ... (one per API endpoint)
│   ├── docs/               # API documentation
│   │   ├── index.html                      # Swagger UI
│   │   ├── openapi.yaml                    # OpenAPI 3.0 spec (generated)
│   │   └── openapi.json                    # OpenAPI 3.0 spec (JSON)
│   ├── tests/              # Test result pages
│   │   ├── index.html                      # Test report index
│   │   ├── test-report-template.html       # Report template
│   │   └── behaviour-test-results/         # Uploaded test artifacts
│   ├── guide/              # User guide
│   │   └── index.html
│   ├── errors/             # Error pages
│   │   ├── 404-error-origin.html           # S3 404
│   │   └── 404-error-distribution.html     # CloudFront 404
│   ├── favicon.ico
│   ├── submit.version      # Build version (generated)
│   ├── submit.deployment   # Deployment name (generated)
│   ├── submit.hash         # Content hash (generated)
│   └── submit.build        # Build number (generated)
├── unit-tests/             # Frontend unit tests (Vitest)
│   ├── userJourneys.frontend.test.js
│   ├── vatFlow.frontend.test.js
│   ├── entitlement-status.test.js
│   ├── submit.helpers.test.js
│   └── token-refresh.test.js
├── browser-tests/          # Browser UI tests (Playwright)
│   ├── bundles.filtering.browser.test.js
│   ├── navigation.browser.test.js
│   └── chromium.client.test.js
└── holding/                # Maintenance/holding page
    └── index.html
```

### `behaviour-tests/` - End-to-End Tests

```
behaviour-tests/
├── bundles.behaviour.test.js            # Bundle management E2E tests
├── submitVat.behaviour.test.js          # VAT submission E2E tests
├── vatObligations.behaviour.test.js     # VAT obligations E2E tests
├── steps/                               # Shared test steps
│   ├── behaviour-steps.js               # Common Playwright steps
│   ├── behaviour-login-steps.js         # Login/auth steps
│   ├── behaviour-bundle-steps.js        # Bundle management steps
│   ├── behaviour-hmrc-steps.js          # HMRC API steps
│   ├── behaviour-hmrc-vat-steps.js      # VAT-specific steps
│   └── behaviour-hmrc-receipts-steps.js # Receipt steps
├── helpers/                             # Test utilities
│   ├── behaviour-helpers.js             # General helpers
│   ├── gotoWithRetries.js               # Navigate with retry logic
│   ├── hmrcTestUser.js                  # HMRC test user creation
│   ├── serverHelper.js                  # Start/stop local server
│   ├── dynamodb-assertions.js           # DynamoDB test assertions
│   ├── dynamodb-export.js               # Export DynamoDB data
│   ├── fileHelper.js                    # File operations
│   ├── figures-helper.js                # Test data generators
│   ├── wiremock-helper.js               # WireMock integration
│   └── playwrightTestWithout.js         # Conditional test execution
├── ENHANCEMENTS.md                      # Enhancement ideas
└── WIREMOCK.md                          # WireMock usage guide
```

### `scripts/` - Utility Scripts

| Script | Purpose |
|--------|---------|
| `start.sh` | Start all local services (server, proxy, auth, data) |
| `clean.sh` | Remove build artifacts and caches |
| `deep-clean.sh` | Remove all generated files including node_modules |
| `clean-node.sh` | Remove node_modules and package-lock.json |
| `provision-user.sh` | Create Cognito test user |
| `add-bundle.sh` | Add bundle to DynamoDB for a subscriber |
| `add-subscriber.sh` | Add subscriber to product-subscribers.subs |
| `export-test-dynamodb.sh` | Export DynamoDB tables to JSONL files |
| `export-dynamodb-for-test-users.js` | Export specific user data |
| `generate-test-reports.js` | Generate HTML test reports from Playwright results |
| `playwright-video-reporter.js` | Custom Playwright video reporter |
| `convert-video.js` | Convert .webm videos to .mp4 |
| `render-catalogue.mjs` | Render product catalog from TOML to HTML |
| `update.sh` | Update npm and Maven dependencies |
| `update-java.sh` | Update Java dependencies |
| `docker-build-codex.sh` | Build Codex Docker image |
| `create-favicon.sh` | Generate favicon from logo |
| `create-submit-intermediate-domains.sh` | Create Route53 intermediate domains |
| `list-domains.sh` | List all Route53 domains |
| `aws-assume-submit-deployment-role.sh` | Assume AWS deployment role |
| `aws-assume-user-provisioning-role.sh` | Assume user provisioning role |
| `aws-unset-iam-session.sh` | Clear AWS session credentials |

### Configuration Files

| File | Purpose |
|------|---------|
| `.editorconfig` | Consistent editor settings (indent, line endings) |
| `.prettierrc` | Prettier code formatter configuration |
| `.prettierignore` | Files to exclude from Prettier |
| `eslint.config.js` | ESLint linting rules (flat config, ES modules) |
| `jsconfig.json` | JavaScript project configuration for IDEs |
| `vitest.config.js` | Vitest test runner configuration |
| `playwright.config.js` | Playwright browser test configuration |
| `cdk-application/cdk.json` | CDK application configuration |
| `cdk-environment/cdk.json` | CDK environment configuration |
| `.ncurc.json` | npm-check-updates configuration (exclude patterns) |
| `mock-oauth2-server.json` | Mock OAuth2 server configuration |

### Key Files

**product-catalogue.toml**: Defines available products/bundles in TOML format
```toml
[products.test]
name = "Test"
description = "Test bundle for development"
expiryDate = "2025-12-31"
userLimit = 1000

[products.guest]
name = "Guest"
description = "Guest access"
expiryDate = "2025-12-31"
userLimit = 1
```

**product-subscribers.subs**: List of hashed subscriber IDs for automatic bundle provisioning
```
# Hashed subscriber IDs (one per line)
abc123def456...
xyz789uvw012...
```

**Dockerfile**: Defines Lambda runtime image with Node.js 22 and application code
```dockerfile
FROM public.ecr.aws/lambda/nodejs:22
COPY app/ ${LAMBDA_TASK_ROOT}/app/
COPY web/public/ ${LAMBDA_TASK_ROOT}/web/public/
COPY package.json ${LAMBDA_TASK_ROOT}/
RUN npm ci --omit=dev
```

---

## Summary

This repository is a production-ready, serverless application for UK VAT submissions via HMRC's Making Tax Digital API. It demonstrates:

- **Modern Serverless Architecture**: CloudFront, S3, Lambda, API Gateway, DynamoDB, Cognito
- **Infrastructure as Code**: AWS CDK (Java) with multi-stack, multi-region deployment
- **Local Development Experience**: Express server, ngrok proxy, mock OAuth2, local DynamoDB
- **Comprehensive Testing**: Unit (Vitest), system (Docker), browser (Playwright), end-to-end (Playwright)
- **CI/CD Excellence**: GitHub Actions with OIDC, blue-green deployments, automatic rollbacks
- **Developer Productivity**: Hot reload, fast tests, detailed logging, debugging tools

**Total Lines of Documentation**: 1700+ lines covering every aspect of the repository

