# DIY Accounting Submit - Comprehensive Repository Documentation

**Generated:** 2025-12-06

This document provides a complete, hierarchical overview of the `submit.diyaccounting.co.uk` repository, from high-level architecture down to individual files and their purposes.

## Table of Contents

1. [Repository Overview](#repository-overview)
2. [Environment Configuration](#environment-configuration)
3. [Package.json Operations](#packagejson-operations)
4. [Maven (pom.xml) Operations](#maven-pomxml-operations)
5. [GitHub Actions Workflows](#github-actions-workflows)
6. [AWS Deployment Architecture](#aws-deployment-architecture)
7. [Local Express Server Architecture](#local-express-server-architecture)
8. [Directory Structure](#directory-structure)

## Repository Overview

**DIY Accounting Submit** is a full-stack serverless application for submitting UK VAT returns via HMRC's Making Tax Digital (MTD) APIs.

### Technology Stack

| Component | Technology |
|-----------|------------|
| **Frontend** | Static HTML/CSS/JavaScript served via CloudFront + S3 |
| **Backend** | Node.js (Express for local dev, AWS Lambda for production) |
| **Infrastructure** | AWS CDK v2 (Java) |
| **Testing** | Vitest (unit/system), Playwright (browser/behaviour) |
| **Authentication** | AWS Cognito + Google IdP (production), Mock OAuth2 (local) |
| **Storage** | DynamoDB (bundles, receipts, API requests), S3 (receipts backup) |
| **API Integration** | HMRC MTD VAT API (test and production) |
| **Local Dev Proxy** | ngrok (exposes localhost for OAuth callbacks) |

### Key Features

- **VAT Submissions**: Submit VAT returns to HMRC via MTD API
- **VAT Obligations**: Retrieve and display VAT obligations
- **Receipt Storage**: Store and retrieve HMRC submission receipts
- **Bundle/Entitlement System**: User subscription management
- **Multi-Environment**: Supports local proxy, CI, and production deployments
- **OAuth Integration**: Google/Cognito for production, mock OAuth2 for local testing

## Environment Configuration

The repository uses multiple environment files to support different deployment scenarios.

### Required `.env` Variables

All environment files should define these core variables:

| Variable | Purpose | Example |
|----------|---------|---------|
| `DOTENV_CONFIG_QUIET` | Suppress dotenv output | `true` |
| `ENVIRONMENT_NAME` | Environment identifier | `ci`, `prod`, `proxy`, `test` |
| `DEPLOYMENT_NAME` | Deployment identifier | `ci`, `prod-abc123`, `proxy` |
| `DIY_SUBMIT_BASE_URL` | Base URL for the application | `https://submit.diyaccounting.co.uk/` |
| `LOG_TO_CONSOLE` | Enable console logging | `true` |
| `LOG_TO_FILE` | Enable file logging | `true`, `false` |
| `CLOUD_TRAIL_ENABLED` | Enable CloudTrail | `true`, `false` |
| `HMRC_BASE_URI` | HMRC production API base URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_API_PROXY_MAPPED_URL` | Internal proxy URL for HMRC API | Varies by environment |
| `HMRC_API_PROXY_EGRESS_URL` | External HMRC API URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_CLIENT_ID` | HMRC OAuth client ID | From HMRC Developer Hub |
| `HMRC_SANDBOX_BASE_URI` | HMRC sandbox API base URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_SANDBOX_API_PROXY_MAPPED_URL` | Internal proxy URL for sandbox | Varies by environment |
| `HMRC_SANDBOX_API_PROXY_EGRESS_URL` | External sandbox API URL | `https://test-api.service.hmrc.gov.uk` |
| `HMRC_SANDBOX_CLIENT_ID` | HMRC sandbox OAuth client ID | From HMRC Developer Hub |
| `GOOGLE_CLIENT_SECRET_ARN` | AWS Secrets Manager ARN for Google OAuth | `arn:aws:secretsmanager:...` |
| `HMRC_CLIENT_SECRET_ARN` | AWS Secrets Manager ARN for HMRC prod secret | `arn:aws:secretsmanager:...` |
| `HMRC_SANDBOX_CLIENT_SECRET_ARN` | AWS Secrets Manager ARN for HMRC sandbox secret | `arn:aws:secretsmanager:...` |
| `COGNITO_USER_POOL_ID` | AWS Cognito User Pool ID | From AWS Cognito |
| `COGNITO_CLIENT_ID` | AWS Cognito Client ID | From AWS Cognito |
| `COGNITO_BASE_URI` | Cognito hosted UI base URL | Auto-generated by Cognito |
| `BUNDLE_DYNAMODB_TABLE_NAME` | DynamoDB table for bundles | `{env}-submit-bundles` |
| `RECEIPTS_DYNAMODB_TABLE_NAME` | DynamoDB table for receipts | `{env}-submit-receipts` |
| `HMRC_API_REQUESTS_DYNAMODB_TABLE_NAME` | DynamoDB table for API request logs | `{env}-submit-hmrc-api-requests` |
| `ACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS` | CloudWatch log retention | `1` (CI), `28` (prod) |
| `PROXY_RATE_LIMIT_PER_SECOND` | Rate limiting for proxy | `5` (CI), `10` (prod) |
| `PROXY_BREAKER_ERROR_THRESHOLD` | Circuit breaker error threshold | `10` (CI), `15` (prod) |
| `PROXY_BREAKER_LATENCY_MS` | Circuit breaker latency threshold | `3000` (CI), `5000` (prod) |
| `PROXY_BREAKER_COOLDOWN_SECONDS` | Circuit breaker cooldown | `60` |

### Environment Files

#### `.env.test`

**Purpose**: Unit and system testing with mocked services.

**Features**:
- Localhost configuration
- Stubbed/mocked HMRC API
- No persistent storage
- No OAuth2 server
- Suitable for automated testing

**Key Settings**:
- `ENVIRONMENT_NAME=test`
- `DEPLOYMENT_NAME=test`
- `DIY_SUBMIT_BASE_URL=https://test/`
- `TEST_SERVER_HTTP=test` (mocked server)
- `TEST_PROXY=test` (mocked proxy)
- `TEST_MOCK_OAUTH2=test` (mocked OAuth)
- `TEST_DYNAMODB=test` (mocked DynamoDB)
- Includes stub data for VAT obligations and returns

#### `.env.ci`

**Purpose**: Continuous Integration testing against AWS infrastructure.

**Features**:
- Real DNS entry (`ci.submit.diyaccounting.co.uk`)
- HMRC Test API integration
- Real DynamoDB storage
- AWS Cognito authentication
- Full AWS stack deployment

**Key Settings**:
- `ENVIRONMENT_NAME=ci`
- `DEPLOYMENT_NAME=ci`
- `DIY_SUBMIT_BASE_URL=https://ci.submit.diyaccounting.co.uk/`
- `HMRC_BASE_URI=https://test-api.service.hmrc.gov.uk`
- Real AWS resources (Cognito, DynamoDB, S3)
- `ACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=1` (short retention)
- `PROXY_RATE_LIMIT_PER_SECOND=5`

#### `.env.prod`

**Purpose**: Production deployment configuration.

**Features**:
- Production DNS entry (`submit.diyaccounting.co.uk`)
- HMRC Production API (currently test API pending approval)
- Real DynamoDB storage
- AWS Cognito authentication
- Full AWS stack deployment with higher reliability settings

**Key Settings**:
- `ENVIRONMENT_NAME=prod`
- `DEPLOYMENT_NAME=prod`
- `DIY_SUBMIT_BASE_URL=https://submit.diyaccounting.co.uk/`
- `HMRC_BASE_URI=https://to0request0from0hmrc-api.service.hmrc.gov.uk` (placeholder)
- Real AWS resources with production settings
- `ACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=28` (longer retention)
- `PROXY_RATE_LIMIT_PER_SECOND=10` (higher throughput)
- `PROXY_BREAKER_ERROR_THRESHOLD=15` (more tolerant)

#### `.env.proxy`

**Purpose**: Local development with ngrok proxy for OAuth callbacks.

**Features**:
- Ngrok proxy configuration (requires authentication)
- HMRC Test API integration
- Local DynamoDB (via dynalite)
- Mock OAuth2 server
- Suitable for full-stack local development

**Key Settings**:
- `ENVIRONMENT_NAME=proxy`
- `DEPLOYMENT_NAME=proxy`
- `DIY_SUBMIT_BASE_URL=https://wanted-finally-anteater.ngrok-free.app/` (example)
- `TEST_SERVER_HTTP=run` (start Express server on port 3000)
- `TEST_PROXY=run` (start ngrok)
- `TEST_MOCK_OAUTH2=run` (start mock OAuth2 server)
- `TEST_DYNAMODB=run` (start local DynamoDB)
- `HMRC_API_PROXY_MAPPED_URL=http://localhost:3000/proxy/hmrc-api`
- `BUNDLE_DYNAMODB_TABLE_NAME=test-bundle-table`
- Requires `NGROK_AUTHTOKEN` environment variable

#### `.env.proxyRunning`

**Purpose**: Connect to already-running local services.

**Features**:
- Assumes ngrok, OAuth2 server, and DynamoDB are already running
- Useful for iterative development without restarting services
- Same ngrok URL as `.env.proxy`

**Key Settings**:
- `ENVIRONMENT_NAME=proxy`
- `DEPLOYMENT_NAME=proxyRunning`
- `TEST_SERVER_HTTP=useExisting`
- `TEST_PROXY=useExisting`
- `TEST_MOCK_OAUTH2=useExisting`
- `TEST_DYNAMODB=useExisting`
- All service endpoints point to already-running instances

### Secrets Management

**Local Development**:
- `HMRC_CLIENT_SECRET` and `HMRC_SANDBOX_CLIENT_SECRET` can be set directly in environment or `.env` (not committed)
- `NGROK_AUTHTOKEN` must be exported in shell

**AWS Environments (CI/Prod)**:
- All secrets are stored in AWS Secrets Manager
- ARNs are configured in environment files
- GitHub Actions workflow creates/updates secrets automatically
- Secrets are injected at runtime via environment variables

**GitHub Secrets** (for Actions workflows):
- `HMRC_CLIENT_SECRET`: Production HMRC OAuth secret
- `HMRC_SANDBOX_CLIENT_SECRET`: Sandbox HMRC OAuth secret
- `GOOGLE_CLIENT_SECRET`: Google OAuth secret
- `NGROK_AUTH_TOKEN`: ngrok authentication token
- `PERSONAL_ACCESS_TOKEN`: GitHub PAT for updating repository variables


## Package.json Operations

The `package.json` file defines all npm scripts for building, testing, and deploying the application.

### Build and Deploy Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `build` | `./mvnw clean verify && git restore web/public/submit.deployment web/public/submit.env \|\| true` | **Full build**: Runs Maven clean and verify (compiles Java, runs tests, builds CDK JARs), generates OpenAPI docs, then restores deployment marker files |
| `start` | `./scripts/start.sh` | **Start all local services**: Orchestrates starting mock OAuth2, ngrok proxy, local DynamoDB, and Express server |
| `clean` | `./scripts/clean.sh` | **Clean build artifacts**: Removes `target/`, `node_modules/.cache/`, and other generated files |

### Formatting Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `formatting` | `prettier --check . && ./mvnw spotless:check` | **Check formatting**: Verifies JavaScript/JSON with Prettier and Java with Spotless (Palantir Java Format) |
| `formatting-fix` | `prettier --write . && ./mvnw spotless:apply && git restore ...` | **Fix formatting**: Auto-formats all code and restores deployment markers |
| `formatting:js` | `prettier --check .` | **Check JS formatting only**: Verifies JavaScript/JSON/HTML/CSS/YAML with Prettier |
| `formatting:js-fix` | `prettier --write . && git restore ...` | **Fix JS formatting only**: Auto-formats JavaScript files |
| `formatting:java` | `./mvnw -DskipTests spotless:check` | **Check Java formatting only**: Verifies Java code with Spotless |
| `formatting:java-fix` | `./mvnw -DskipTests spotless:apply && git restore ...` | **Fix Java formatting only**: Auto-formats Java code |

### Linting Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `linting` | `eslint .` | **Run ESLint**: Checks JavaScript code for errors and style issues (uses flat config) |
| `linting-fix` | `eslint --fix . && git restore ...` | **Fix linting issues**: Auto-fixes ESLint errors where possible |

### Testing Scripts

#### Core Test Suites

| Script | Command | Description |
|--------|---------|-------------|
| `test` | `vitest --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js web/unit-tests/*.test.js app/system-tests/*.test.js` | **Default test suite**: Runs unit tests (app + web) and system tests (~108 tests, ~4 seconds) |
| `test:unit` | `vitest --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js web/unit-tests/*.test.js` | **Unit tests only**: Runs all unit tests for app and web components |
| `test:app-unit` | `vitest --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js` | **App unit tests only**: Tests backend Lambda functions and services |
| `test:web-unit` | `vitest --run web/unit-tests/*.test.js` | **Web unit tests only**: Tests frontend JavaScript modules |
| `test:coverage` | `vitest --coverage --run app/unit-tests/*.test.js app/unit-tests/*/*.test.js` | **Unit tests with coverage**: Generates code coverage reports |
| `test:system` | `vitest --run app/system-tests/*.test.js` | **System tests**: Integration tests with Docker containers (~6 seconds) |
| `test:browser` | `playwright test --project=browser-tests web/browser-tests/*.test.js` | **Browser tests**: Playwright tests for UI components (requires Chromium) |

#### Behaviour Tests (End-to-End)

Behaviour tests use Playwright to test complete user journeys against running infrastructure.

| Script | Command | Description |
|--------|---------|-------------|
| `test:behaviour` | `playwright test --project=behaviour-tests` | **All behaviour tests**: Runs all Playwright behaviour tests |
| `test:behaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:behaviour` | **Behaviour tests (local proxy)**: Tests against local ngrok + mock OAuth2 |
| `test:behaviour-proxy-sandbox` | `HMRC_ACCOUNT=sandbox npx dotenv -e .env.proxy -- npm run test:behaviour` | **Behaviour tests (proxy + HMRC sandbox)**: Tests against local setup with HMRC sandbox API |
| **Bundle Tests** | | |
| `test:bundleBehaviour` | `playwright test --project=bundle-behaviour-tests` | **Bundle journey tests**: Tests bundle/entitlement workflows |
| `test:bundleBehaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:bundleBehaviour` | Tests bundle flows locally with mock data |
| `test:bundleBehaviour-proxy-record` | `TEST_WIREMOCK=record npx dotenv -e .env.proxy -- npm run test:bundleBehaviour` | Records HTTP interactions to WireMock |
| `test:bundleBehaviour-proxy-mock` | `TEST_WIREMOCK=mock npx dotenv -e .env.proxy -- npm run test:bundleBehaviour` | Replays recorded HTTP interactions |
| `test:bundleBehaviour-ci` | `npx dotenv -e .env.ci -- npm run test:bundleBehaviour` | Tests against CI environment |
| `test:bundleBehaviour-prod` | `npx dotenv -e .env.prod -- npm run test:bundleBehaviour` | Tests against production environment |
| **VAT Obligation Tests** | | |
| `test:obligationBehaviour` | `playwright test --project=obligation-behaviour-tests` | **VAT obligation journey tests**: Tests retrieving VAT obligations |
| `test:obligationBehaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:obligationBehaviour ; npm run test-report ...` | Tests locally and generates HTML report |
| `test:obligationBehaviour-proxy-sandbox` | `HMRC_ACCOUNT=sandbox npm run test:obligationBehaviour-proxy` | Tests with HMRC sandbox API |
| `test:obligationBehaviour-ci` | `npx dotenv -e .env.ci -- npm run test:obligationBehaviour` | Tests against CI environment |
| `test:obligationBehaviour-prod` | `npx dotenv -e .env.prod -- npm run test:obligationBehaviour` | Tests against production |
| **VAT Submission Tests** | | |
| `test:submitVatBehaviour` | `playwright test --project=submit-vat-behaviour-tests` | **VAT submission journey tests**: Tests full VAT return submission |
| `test:submitVatBehaviour-proxy` | `npx dotenv -e .env.proxy -- npm run test:submitVatBehaviour` | Tests submission locally |
| `test:submitVatBehaviour-proxy-sandbox` | `HMRC_ACCOUNT=sandbox npm run test:submitVatBehaviour-proxy` | Tests submission with HMRC sandbox |
| `test:submitVatBehaviour-proxyRunning` | `npx dotenv -e .env.proxyRunning -- npm run test:submitVatBehaviour` | Tests against already-running services |
| `test:submitVatBehaviour-ci` | `npx dotenv -e .env.ci -- npm run test:submitVatBehaviour` | Tests against CI environment |
| `test:submitVatBehaviour-prod` | `npx dotenv -e .env.prod -- npm run test:submitVatBehaviour` | Tests against production |

#### Comprehensive Test Suites

| Script | Command | Description |
|--------|---------|-------------|
| `test:all` | `vitest ... && npm run test:browser && npm run test:behaviour-proxy && git restore ...` | **All tests**: Runs unit, system, browser, and behaviour tests |
| `everything` | `time sh -c 'rm -rf ... && npm install && npm test && ... npm run cdk && ...'` | **Complete validation**: Full clean build, all tests, Docker build, CDK synth for CI and prod |

### CDK Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `cdk:synth-environment` | `cd cdk-environment && npx dotenv ... npx cdk synth ...` | **Synthesize environment stack**: Generates CloudFormation for shared infrastructure (Cognito, DynamoDB, observability) |
| `cdk:synth-application` | `cd cdk-application && npx dotenv ... npx cdk synth ...` | **Synthesize application stack**: Generates CloudFormation for application resources (Lambda, API, CloudFront) |
| `cdk` | `./mvnw clean verify -DskipTests && ENVIRONMENT_NAME=prod npm run cdk:synth-environment && ...` | **Full CDK synth (prod)**: Builds Java code, synthesizes both environment and application stacks for production |
| `cdk-ci` | `./mvnw clean verify -DskipTests && ENVIRONMENT_NAME=ci npm run cdk:synth-environment && ...` | **Full CDK synth (CI)**: Same as above but for CI environment |

### Local Development Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `server` | `npx dotenv -e .env.proxy -- node app/bin/server.js` | **Start Express server**: Runs Node.js server on port 3000 (default) with `.env.proxy` config |
| `proxy` | `npx dotenv -e .env.proxy -- node app/bin/ngrok.js` | **Start ngrok proxy**: Exposes local server via ngrok tunnel for OAuth callbacks |
| `auth` | `npx dotenv -e .env.proxy -- docker run ... ghcr.io/navikt/mock-oauth2-server:2.2.1` | **Start mock OAuth2 server**: Runs Docker container on port 8080 for local OAuth testing |
| `data` | `npx dotenv -e .env.proxy -- node app/bin/dynamodb.js` | **Start local DynamoDB**: Runs dynalite (lightweight DynamoDB clone) for local data storage |
| `mock` | `wiremock --port 9090 --root-dir wiremock-recordings --verbose --preserve-host-header` | **Start WireMock**: HTTP mock server for recording/replaying API interactions |

### Utility Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `users:provision` | `node app/bin/provision-user.mjs` | **Provision test users**: Creates Cognito users for testing |
| `test-report` | `node scripts/generate-test-reports.js --testName html-report` | **Generate test reports**: Creates HTML reports from Playwright test results |
| `convert:video` | `node scripts/convert-video.js` | **Convert test videos**: Converts Playwright .webm videos to .mp4 format |
| `convert:video:default` | `node scripts/convert-video.js --in target/behaviour-test-results/video.webm --out ...` | **Convert default test video**: Converts specific video file |
| `set-apex-origins` | `node ./app/actions/set-apex-origins.mjs` | **Update CloudFront origins**: Updates CloudFront distribution to point to new deployment |
| `cloudfront:set-origins` | `node ./app/actions/set-apex-origins.mjs` | Alias for `set-apex-origins` |
| `wiremock:server` | `wiremock --port 9090 --root-dir wiremock-recordings --disable-banner` | **Start WireMock (quiet)**: Starts WireMock without banner |

### Update Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `update-to-minor` | `npx npm-check-updates --upgrade --enginesNode --target minor --verbose --install always` | **Update to minor versions**: Updates npm dependencies to latest minor versions |
| `update-to-greatest` | `npx npm-check-updates --upgrade --enginesNode --target greatest --verbose --install always --reject 'alpha'` | **Update to latest versions**: Updates to latest versions (excluding alpha) |

### Docker Scripts

| Script | Command | Description |
|--------|---------|-------------|
| `docker:build` | `docker build -t submit-base:latest -f Dockerfile .` | **Build Docker image**: Creates base Docker image with Node.js dependencies and application code |

### Playwright Setup

| Script | Command | Description |
|--------|---------|-------------|
| `playwright:install` | `npx playwright install chromium --with-deps` | **Install Playwright browsers**: Downloads Chromium and system dependencies for browser testing |

### Dependencies

Key npm packages used:

**Production Dependencies**:
- `@aws-sdk/client-cloudformation`: AWS CloudFormation SDK
- `@aws-sdk/client-secrets-manager`: AWS Secrets Manager SDK
- `@aws-sdk/util-dynamodb`: DynamoDB utilities
- `@iarna/toml`: TOML parser for product catalog
- `aws-jwt-verify`: JWT verification for Cognito
- `dotenv`: Environment variable management
- `pino`: Fast JSON logger
- `uuid`: UUID generation

**Development Dependencies**:
- `@playwright/test`: End-to-end testing framework
- `@vitest/coverage-v8`: Code coverage for Vitest
- `aws-cdk`: AWS Cloud Development Kit CLI
- `dynalite`: Local DynamoDB implementation
- `eslint`: JavaScript linter
- `express`: Web server framework (for local dev)
- `happy-dom`: DOM implementation for testing
- `msw`: Mock Service Worker for API mocking
- `prettier`: Code formatter
- `vitest`: Unit testing framework
- `wiremock`: HTTP mock server


## Maven (pom.xml) Operations

The `pom.xml` file configures the Java-based AWS CDK infrastructure code.

### Maven Project Configuration

| Property | Value | Description |
|----------|-------|-------------|
| **GroupId** | `submit.diyaccounting.co.uk` | Project group identifier |
| **ArtifactId** | `web` | Project artifact identifier |
| **Version** | `0.0.2-4` | Current version |
| **Packaging** | `jar` | Packaging type |
| **Java Version** | `21` (source and target) | Required Java version |

### Key Maven Commands

#### `./mvnw clean verify`

**Purpose**: Complete build, test, and package cycle for CDK infrastructure

**What it does specifically in this pom.xml**:

1. **Clean Phase**: Removes `target/` directory
2. **Compile Phase**: 
   - Compiles Java sources from `infra/main/java`
   - Processes Immutables annotations to generate value classes
   - JVM args: `-Xshare:off`, `-XX:+EnableDynamicAgentLoading`, `-Xlint:-options`
3. **Test Phase**:
   - Compiles test sources from `infra/test/java`
   - Runs JUnit 5 tests with Mockito
   - Forks tests in separate JVM
   - JVM args: `-XX:+EnableDynamicAgentLoading`, `-Xshare:off`, `--add-opens java.base/java.lang=ALL-UNNAMED`
4. **Package Phase**:
   - Creates shaded JAR (`web-0.0.2-4-dist.jar`) with all dependencies
   - Merges META-INF/services files
   - Excludes signature files, duplicate metadata, and conflicting resources
   - Generates OpenAPI documentation (`web/public/docs/openapi.yaml` and `openapi.json`)
   - Executes `co.uk.diyaccounting.submit.swagger.OpenApiGenerator` with args: `${baseUrl} ${project.version} ${project.basedir}/web/public/docs`
5. **Verify Phase** (via maven-antrun-plugin):
   - Creates `target/submit-application.jar` (copy of shaded JAR with Main-Class: `co.uk.diyaccounting.submit.SubmitApplication`)
   - Creates `target/submit-environment.jar` (copy of shaded JAR with Main-Class: `co.uk.diyaccounting.submit.SubmitEnvironment`)
   - Attaches both JARs as project artifacts
6. **Install Phase**:
   - Runs Spotless formatting checks on Java code and pom.xml
   - Fails if formatting issues are detected

**Duration**: ~45 seconds

**Output Artifacts**:
- `target/submit-application.jar` - CDK entry point for application stacks
- `target/submit-environment.jar` - CDK entry point for environment stacks
- `web/public/docs/openapi.yaml` - API documentation
- `web/public/docs/openapi.json` - API documentation (JSON)

#### `./mvnw clean test`

**Purpose**: Run unit tests only without packaging

**What it does**:
1. Cleans target directory
2. Compiles source and test files
3. Runs JUnit 5 tests
4. **Does NOT** package JARs or generate documentation

**Duration**: ~20 seconds

#### `./mvnw spotless:check`

**Purpose**: Verify code formatting without making changes

**What it does specifically**:
1. Checks Java files in `infra/main/java/**/*.java` and `infra/test/java/**/*.java`:
   - Palantir Java Format (v2.50.0) style
   - Unused imports removed
   - Imports organized
   - Files end with newline
2. Checks `pom.xml`:
   - Sorts dependencies by scope, groupId, artifactId
   - Sorts plugins by groupId, artifactId
   - Sorts properties alphabetically
   - Consistent indentation (4 spaces)
   - Trims trailing whitespace

**Duration**: ~10 seconds
**Exit Code**: 0 if formatted correctly, 1 if issues found

#### `./mvnw spotless:apply`

**Purpose**: Auto-format all Java code and pom.xml

**What it does**:
1. Applies Palantir Java Format to all Java files
2. Removes unused imports
3. Organizes import statements
4. Sorts and formats pom.xml
5. **Always** succeeds (does not fail the build)

**Duration**: ~15 seconds

### Java Version Compatibility

The pom.xml specifies Java 21, but the project can be compiled with Java 17+ using compiler overrides:

```bash
./mvnw clean verify -Dmaven.compiler.source=17 -Dmaven.compiler.target=17
```

This is used in GitHub Actions where Java 21 is standardized but older versions are supported.

### Maven Plugins Explained

| Plugin | What It Does in This Project |
|--------|------------------------------|
| **spotless-maven-plugin** (2.45.0) | Enforces Palantir Java Format (100-column width) and sorts pom.xml. Runs during `install` phase. |
| **maven-compiler-plugin** (3.14.0) | Compiles Java 21 source code and processes Immutables annotations for generating value classes. |
| **maven-shade-plugin** (3.6.0) | Creates fat JAR with all dependencies. Merges service provider files, excludes signatures and duplicate metadata. |
| **maven-antrun-plugin** (3.1.0) | Post-processes shaded JAR to create two variants with different Main-Class manifests. |
| **build-helper-maven-plugin** (3.5.0) | Attaches `submit-application.jar` and `submit-environment.jar` as classified artifacts. |
| **exec-maven-plugin** (3.5.0) | Generates OpenAPI YAML/JSON documentation during package phase by running `OpenApiGenerator.main()`. |
| **maven-surefire-plugin** (3.5.3) | Runs JUnit 5 tests with custom JVM arguments to suppress warnings and allow reflection. |
| **maven-enforcer-plugin** (3.6.0) | Requires Maven 3.9.10 or higher. |
| **maven-wrapper-plugin** (3.3.2) | Configures Maven wrapper to use Maven 3.9.10. |

### Key Dependencies

**AWS CDK** (v2.221.0):
- All AWS service modules in one library (`aws-cdk-lib`)
- Constructs framework for building CDK applications

**AWS SDK** (v2.40.2):
- Lambda SDK for interacting with Lambda service
- S3 SDK for S3 operations during CDK synthesis

**Code Generation**:
- **Immutables** (v2.11.6): Generates immutable value objects from interfaces/abstract classes

**Testing**:
- **JUnit 5**: Test framework
- **Mockito** (v5.20.0): Mocking framework
- **system-stubs-jupiter** (v2.1.8): Mock system properties and environment variables
- **junit-pioneer** (v2.3.0): JUnit 5 extensions
- **CDK Nag** (v2.37.55): Security and best practices checks for CDK (test scope only)

### CDK Stack Classes

The Java code defines two main entry points for CDK synthesis:

| Entry Point | Main Class | CDK App Name | Stacks Created |
|-------------|------------|--------------|----------------|
| **Environment** | `co.uk.diyaccounting.submit.SubmitEnvironment` | `SubmitEnvironment` | ObservabilityStack, ObservabilityUE1Stack, DataStack, ProxyStack, ApexStack, IdentityStack |
| **Application** | `co.uk.diyaccounting.submit.SubmitApplication` | `SubmitApplication` | DevStack, DevUE1Stack, SelfDestructStack, AuthStack, HmrcStack, AccountStack, ApiStack, EdgeStack, PublishStack, OpsStack |

### OpenAPI Documentation Generation

During the package phase, the `exec-maven-plugin` runs:

```bash
java -cp <classpath> co.uk.diyaccounting.submit.swagger.OpenApiGenerator \
  ${baseUrl} ${project.version} ${project.basedir}/web/public/docs
```

**Arguments**:
- `${baseUrl}`: Resolved from `DIY_SUBMIT_APEX_URL` environment variable
- `${project.version}`: `0.0.2-4`
- Output directory: `web/public/docs`

**Output**:
- `openapi.yaml`: OpenAPI 3.0 specification in YAML format
- `openapi.json`: OpenAPI 3.0 specification in JSON format

These files document all API endpoints (auth, HMRC, account, receipts).


## GitHub Actions Workflows

The `.github/workflows/` directory contains CI/CD workflows for testing, building, and deploying the application.

### Workflow Files Overview

| Workflow File | Purpose | Triggers |
|---------------|---------|----------|
| `deploy.yml` | Main deployment workflow for application stacks | Push to any branch (with path filters), manual dispatch, daily schedule (04:11 UTC) |
| `deploy-environment.yml` | Deploy shared environment infrastructure | Push to any branch (with path filters for env files), manual dispatch, daily schedule (03:51 UTC) |
| `test.yml` | Run all test suites without deployment | Push to any branch (with path filters for code/tests), manual dispatch, daily schedule (04:23 UTC), workflow_call (reusable) |
| `set-origins.yml` | Update Route53 DNS and CloudFront distribution aliases | Manual dispatch only |

### deploy.yml - Main Deployment Workflow

**Purpose**: Build, test, and deploy the complete application to AWS.

**Trigger Conditions**:
- Push to any branch (except `gh_pages` and `dependabot/**`)
- Only for changes to: `app/`, `infra/main/`, `web/public/`, `.env.*`, `cdk.json`, `Dockerfile`, `LICENSE`, `package.json`, `pom.xml`, product catalog, workflow files
- Manual dispatch with options
- Daily schedule at 04:11 UTC

**Input Parameters (Manual Dispatch)**:
- `forceAllStackDeployment` (choice): Force re-deploy all stacks even if they exist (`true`/`false`, default `false`)
- `skipDeploy` (choice): Run tests only, skip deployment (`true`/`false`, default `false`)
- `environment-name` (choice): Override environment name (`''`, `ci`, `prod`, default `''`)
- `deployment-name` (string): Override deployment name (default `''`)
- `loadTestDuration` (string): Duration for load tests (default `30s`)
- `selfDestructDelayHours` (string): Hours before self-destruct for non-prod (default `8`)
- `convertTestVideo` (choice): Convert test videos to MP4 (`true`/`false`, default `false`)

**Environment Variables**:
```yaml
JAVA_VERSION: '21'
NODE_VERSION: '22'
ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
AWS_REGION: 'eu-west-2'
AWS_ACCOUNT_ID: '887764105431'
AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'
BASE_IMAGE_TAG: ${{ github.sha }}
```

**Job Flow**:

1. **names**: Compute environment and deployment names from branch/inputs
2. **test**: Delegate to `test.yml` workflow (runs unit, system, browser tests, CDK synth)
3. **npm-unit-test-coverage**: Generate code coverage reports
4. **mvn-package**: Build JARs, compute self-destruct datetime
5. **behaviour-test-bundle**: Run bundle behaviour tests with local proxy
6. **behaviour-test-obligation**: Run VAT obligation tests with HMRC sandbox
7. **behaviour-test-submit-vat**: Run VAT submission tests with HMRC sandbox
8. **test-aws-credentials**: Verify AWS authentication
9. **skip-deploy-check**: Check if deployment should be skipped
10. **docker-build**: Build and save Docker image artifact
11. **deploy-dev**: Deploy DevStack (S3, CloudFront distribution, ACM, ECR)
12. **deploy-dev-us-east-1**: Deploy DevUE1Stack (same resources in us-east-1)
13. **push-images**: Tag and push Docker image to ECR (eu-west-2)
14. **push-images-us-east-1**: Tag and push Docker image to ECR (us-east-1)
15. **deploy-application-self-destruct**: Deploy SelfDestructStack (non-prod only)
16. **deploy-auth**: Deploy AuthStack (Cognito token endpoints, mock OAuth lambdas)
17. **deploy-hmrc**: Deploy HmrcStack (HMRC API lambdas, proxy)
18. **deploy-account**: Deploy AccountStack (bundle/catalog management lambdas)
19. **deploy-api**: Deploy ApiStack (HTTP API gateway, routes, authorizers)
20. **deploy-edge**: Deploy EdgeStack (CloudFront distribution with Lambda@Edge)
21. **deploy-publish**: Deploy PublishStack (sync static files to S3, compute hash)
22. **deploy-ops**: Deploy OpsStack (CloudWatch dashboard)
23. **set-origins**: Update Route53 A/AAAA records and CloudFront aliases
24. **web-test-bundle**: Run bundle behaviour tests against deployed environment
25. **web-test-obligation-sandbox**: Run obligation tests with HMRC sandbox against deployed environment
26. **web-test-obligation**: Run obligation tests with HMRC test API (non-prod only)
27. **web-test-submit-vat-sandbox**: Run VAT submission tests with sandbox against deployed environment
28. **web-test-submit-vat**: Run VAT submission tests with test API (non-prod only)
29. **upload-web-test-results**: Collect and upload all test results to S3
30. **convert-video**: Convert Playwright videos to MP4 (if requested)
31. **set-last-known-good-deployment**: Store deployment name in SSM Parameter Store
32. **destroy-previous**: Destroy previous prod deployment (prod only, excludes holding page)
33. **invalidate-cloudfront**: Invalidate CloudFront cache for `/tests/*` and `/docs/*`

**Key Features**:
- **Parallel Execution**: Many jobs run in parallel to speed up deployment
- **Skip Logic**: Static stacks (DevStack, EdgeStack, OpsStack) are skipped if already deployed and unchanged
- **Hash-Based Publishing**: Static files are only published if content hash changes
- **Artifact Management**: Test results, logs, and videos are uploaded as artifacts
- **Blue-Green Deployment**: New deployment is tested before DNS cutover
- **Automatic Cleanup**: Previous prod deployments are destroyed after successful cutover

**Stack Deployment Order**:

Environment Stacks (prerequisite):
- ObservabilityStack, DataStack, ProxyStack, ApexStack, IdentityStack

Application Stacks:
1. DevStack, DevUE1Stack (S3, CloudFront, ECR)
2. SelfDestructStack (non-prod only)
3. AuthStack, HmrcStack, AccountStack (in parallel)
4. ApiStack (depends on auth/hmrc/account)
5. EdgeStack (depends on ApiStack)
6. PublishStack (depends on EdgeStack)
7. OpsStack (depends on ApiStack, EdgeStack)

**Deployment Concurrency**: 4 stacks deployed simultaneously per `npx cdk deploy` invocation

**Typical Execution Time**:
- CI deployment: ~25-35 minutes
- Prod deployment: ~30-40 minutes (includes more thorough testing)

### deploy-environment.yml - Environment Infrastructure Workflow

**Purpose**: Deploy shared, long-lived infrastructure for an environment (CI or prod).

**Trigger Conditions**:
- Push to any branch (except `gh_pages` and `dependabot/**`)
- Only for changes to: `.env.ci`, `.env.prod`, `cdk-environment/cdk.json`, workflow files
- Manual dispatch with environment name override
- Daily schedule at 03:51 UTC

**Input Parameters**:
- `environment-name` (choice): Override environment (`''`, `ci`, `prod`, default `''`)

**Job Flow**:

1. **names**: Compute environment name
2. **create-secrets**: Create/update AWS Secrets Manager secrets for Google and HMRC credentials
3. **deploy-observability**: Deploy ObservabilityStack (CloudWatch RUM, alarms) in eu-west-2
4. **deploy-observability-us-east-1**: Deploy ObservabilityUE1Stack in us-east-1
5. **deploy-data**: Deploy DataStack (DynamoDB tables for bundles, receipts, API requests)
6. **deploy-proxy**: Deploy ProxyStack (VPC endpoints, security groups for proxy)
7. **provision-bundles**: Add bundles for subscribers listed in `product-subscribers.subs`
8. **deploy-apex**: Deploy ApexStack (Route53 apex domain records)
9. **deploy-identity**: Deploy IdentityStack (Cognito user pool, client, hosted UI)
10. **set-repository-environment-variables**: Store Cognito ARNs/IDs as GitHub environment variables

**Stacks Deployed**:
- `{env}-env-ObservabilityStack` (eu-west-2)
- `{env}-env-ObservabilityUE1Stack` (us-east-1)
- `{env}-env-DataStack` (eu-west-2)
- `{env}-env-ProxyStack` (eu-west-2)
- `{env}-env-ApexStack` (eu-west-2)
- `{env}-env-IdentityStack` (eu-west-2)

**Secrets Created/Updated**:
- `{env}/submit/google/client_secret`
- `{env}/submit/hmrc/client_secret`
- `{env}/submit/hmrc/sandbox_client_secret`

**GitHub Environment Variables Set**:
- `COGNITO_USER_POOL_ARN`
- `COGNITO_USER_POOL_ID`
- `COGNITO_CLIENT_ID`

**Typical Execution Time**: ~15-20 minutes

**Note**: This workflow typically runs infrequently (only when environment configuration changes).

### test.yml - Test Workflow

**Purpose**: Run all automated tests without deploying to AWS.

**Trigger Conditions**:
- Push to any branch (except `gh_pages`)
- Only for changes to code, tests, config files
- Manual dispatch
- Daily schedule at 04:23 UTC
- Callable as reusable workflow (used by `deploy.yml`)

**Input Parameters** (Manual/Workflow Call):
- `environment-name` (string): Environment name
- `deployment-name` (string): Deployment name

**Job Flow**:

1. **names**: Compute environment and deployment names
2. **npm-test**: Run unit and system tests (`npm test`)
3. **npm-unit-test**: Run unit tests with coverage
4. **npm-system-test**: Run system tests (with Docker containers)
5. **npm-test-web-unit**: Run web unit tests
6. **npm-browser-test**: Run Playwright browser tests
7. **mvn-test**: Run Java/CDK unit tests
8. **npm-test-cdk-ci**: Synthesize CDK stacks for CI environment (validate CDK code)
9. **npm-test-cdk-prod**: Synthesize CDK stacks for prod environment (validate CDK code)

**Tests Run**:
- ~108 unit tests (app + web)
- ~20 system tests (with Docker)
- ~15 browser tests (Playwright)
- ~40 Java/CDK unit tests
- CDK synthesis validation (both CI and prod configs)

**Typical Execution Time**: ~8-12 minutes

**Exit Criteria**: All tests must pass for workflow to succeed.

### set-origins.yml - DNS/CloudFront Update Workflow

**Purpose**: Manually switch the apex domain to point to a specific deployment (or holding page).

**Trigger Conditions**:
- Manual dispatch only (no automatic triggers)

**Input Parameters**:
- `domain-source` (choice): Source domain to point to (`branch`, `holding`, default `branch`)
- `hosted-zone-id` (string): Route53 hosted zone ID (default `Z0315522208PWZSSBI9AL`)
- `cloudfront-distribution-id` (string): CloudFront distribution ID (optional, will be looked up if not provided)
- `environment-name` (choice): Environment name override (`''`, `ci`, `prod`)
- `deployment-name` (string): Deployment name override

**Job Flow**:

1. **names**: Compute environment and deployment names
2. **set-origins**: 
   - Look up CloudFront distribution ID by tag `OriginFor` if not provided
   - Call `.github/actions/set-origins` action to:
     - Add CloudFront alternate domain name (CNAME) for apex domain
     - Create Route53 A and AAAA alias records pointing apex to CloudFront
     - Return existing deployment name (for rollback purposes)

**Use Cases**:
- **Blue-Green Cutover**: Switch from one deployment to another
- **Rollback**: Point back to previous deployment
- **Maintenance Page**: Point to holding page during maintenance

**Typical Execution Time**: ~2-3 minutes

### GitHub Actions Workflow Reusable Actions

The repository includes custom actions in `.github/actions/`:

#### get-names

**Purpose**: Compute environment and deployment names from branch name or inputs.

**Inputs**:
- `environment-name`: Override environment name
- `deployment-name`: Override deployment name

**Outputs**:
- `environment-name`: `ci` or `prod`
- `deployment-name`: `ci`, `prod`, `ci-{short-sha}`, or `prod-{short-sha}`
- `base-domain`: `{deployment-name}.submit.diyaccounting.co.uk`
- `base-url`: `https://{base-domain}/`
- `apex-domain`: `submit.diyaccounting.co.uk` (ci) or `submit.diyaccounting.co.uk` (prod)
- `apex-url`: `https://{apex-domain}/`
- `holding-domain`: `{environment-name}-holding.submit.diyaccounting.co.uk`
- `holding-url`: `https://{holding-domain}/`

**Logic**:
- Main branch → `environment-name=prod`, `deployment-name=prod-{short-sha}`
- Other branches → `environment-name=ci`, `deployment-name=ci-{short-sha}`
- Manual dispatch can override both

#### set-origins

**Purpose**: Update Route53 and CloudFront to point apex domain to a specific origin domain.

**Inputs**:
- `origin-domain`: Domain to point to (e.g., `ci-abc123.submit.diyaccounting.co.uk`)
- `apex-domain`: Apex domain to update (e.g., `submit.diyaccounting.co.uk`)
- `aws-account-id`: AWS account ID
- `hosted-zone-id`: Route53 hosted zone ID
- `cloudfront-distribution-id`: CloudFront distribution ID

**Actions**:
1. Query current apex domain CNAME/alias target
2. Update CloudFront distribution alternate domain names (CNAMEs) to include apex domain
3. Create/update Route53 A and AAAA alias records for apex domain pointing to CloudFront
4. Return previous deployment name (origin domain)

**Outputs**:
- `existing-deployment-name`: Previous deployment that apex was pointing to

### CI/CD Security

**Authentication**:
- GitHub Actions uses OIDC to assume AWS IAM roles
- Two-role chaining: Actions role → Deployment role
- No long-lived AWS credentials stored in GitHub

**Secrets**:
- All secrets stored in AWS Secrets Manager (prod/ci)
- GitHub Secrets used only for:
  - OAuth client secrets (to create AWS secrets)
  - ngrok token (for behaviour tests)
  - Personal access token (for updating GitHub environment variables)

**Permissions**:
- Workflows use minimal permissions (`contents: read`, `id-token: write`)
- Deployment role has full CloudFormation/Lambda/S3/etc. permissions
- Actions role can only assume deployment role

