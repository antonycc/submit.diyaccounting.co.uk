<!-- activities.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Activities</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="submit.css" />
    <script src="/config.js"></script>
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">☰</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="index.html">Home</a>
            <a href="activities.html">View Activities</a>
            <a href="bundles.html">Add Bundle</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div class="form-container" style="text-align: center">
        <h2>Available Activities</h2>
        <p>Select an activity to continue:</p>

        <div style="margin: 2em 0">
          <button type="button" class="btn" onclick="window.location.href='submitVat.html'">
            VAT Return Submission
          </button>
        </div>

        <div id="activitiesByBundle" style="text-align: left; margin: 1.5em auto; max-width: 640px"></div>

        <div
          class="add-service-section"
          style="margin: 2em 0; padding: 1.5em; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #ddd"
        >
          <p style="margin-bottom: 1em; color: #666; font-style: italic">
            Need more choices? Select additional bundles to expand your available activities.
          </p>
          <button
            type="button"
            class="btn"
            onclick="window.location.href='bundles.html'"
            style="background-color: #28a745; border-color: #28a745"
          >
            Add Bundle
          </button>
        </div>

        <div style="margin-top: 2em">
          <button
            type="button"
            class="btn"
            onclick="window.location.href='index.html'"
            style="background-color: #6c757d; border-color: #6c757d"
          >
            Back to Home
          </button>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited. Licensed under GPL v3.0</p>
        </div>
      </div>
    </footer>

    <script>
      // Hamburger menu toggle functionality
      function toggleMenu() {
        const dropdown = document.getElementById("menuDropdown");
        dropdown.classList.toggle("show");
      }

      // Update login status display
      function updateLoginStatus() {
        const userInfo = localStorage.getItem("userInfo");
        const loginStatusElement = document.querySelector(".login-status");
        const loginLinkElement = document.querySelector(".login-link");

        if (userInfo) {
          const user = JSON.parse(userInfo);
          loginStatusElement.textContent = `Logged in as ${user.email}`;
          loginLinkElement.textContent = "Logout";
          loginLinkElement.href = "#";
          loginLinkElement.onclick = logout;
        } else {
          loginStatusElement.textContent = "Not logged in";
          loginLinkElement.textContent = "Log in";
          loginLinkElement.href = "login.html";
          loginLinkElement.onclick = null;
        }
      }

      // Logout function
      function logout() {
        console.log("Logging out user");

        // Clear stored tokens and user info
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Update login status
        updateLoginStatus();

        // Redirect to home page
        window.location.href = "index.html";
      }

      // Check authentication status on page load
      function checkAuthStatus() {
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const userInfo = localStorage.getItem("userInfo");

        if (accessToken && userInfo) {
          console.log("User is authenticated");
          updateLoginStatus();
          renderActivitiesByBundle();
        } else {
          console.log("User is not authenticated");
          updateLoginStatus();
          renderActivitiesByBundle();
        }
      }

      // Activities rendering based on bundles
      function parseUserBundles() {
        try {
          const raw = localStorage.getItem("userBundles");
          if (!raw) return [];
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr;
        } catch (_e) {
          return [];
        }
      }

      function hasBundle(bundles, id) {
        return (bundles || []).some((b) => typeof b === "string" && (b === id || b.startsWith(id + "|")));
      }

      function renderActivitiesByBundle() {
        const container = document.getElementById("activitiesByBundle");
        if (!container) return;
        const bundles = parseUserBundles();

        const sections = [];
        // Default bundle always available
        sections.push(`
          <section style="margin-bottom:1em;">
            <h3 style="margin:0 0 .5em 0;">Default bundle</h3>
            <ul>
              <li>VAT Obligations (Production) – open</li>
              <li>Learning pages</li>
            </ul>
          </section>
        `);

        if (hasBundle(bundles, "HMRC_TEST_API")) {
          sections.push(`
            <section style="margin-bottom:1em;">
              <h3 style="margin:0 0 .5em 0;">HMRC Test API bundle</h3>
              <ul>
                <li>Submit VAT (Sandbox API)</li>
                <li>VAT Obligations (Sandbox API)</li>
              </ul>
            </section>
          `);
        }

        container.innerHTML = sections.join("\n");
      }

      // Load and display view source link
      async function loadViewSourceLink() {
        try {
          const response = await fetch("source.txt");
          if (response.ok) {
            const commitHash = (await response.text()).trim();
            if (commitHash) {
              const currentPage = window.location.pathname.split("/").pop() || "index.html";
              const githubUrl = `https://github.com/antonycc/submit.diyaccounting.co.uk/blob/${commitHash}/web/public/${currentPage}`;
              const viewSourceLink = document.getElementById("viewSourceLink");
              viewSourceLink.href = githubUrl;
              viewSourceLink.textContent = `source: ${currentPage}@${commitHash.substring(0, 7)}`;
              viewSourceLink.style.display = "inline";
            }
          }
        } catch (error) {
          console.log("Could not load source.txt:", error);
        }
      }

      // Close menu when clicking outside
      window.onclick = function (event) {
        if (!event.target.matches(".hamburger-btn")) {
          const dropdown = document.getElementById("menuDropdown");
          if (dropdown.classList.contains("show")) {
            dropdown.classList.remove("show");
          }
        }
      };

      localStorage.removeItem("currentActivity");
      console.log("Current activity cleared");

      // Initialize page
      checkAuthStatus();

      // Load view source link on page load
      loadViewSourceLink();
    </script>
    <script>
      // Catalog-driven UI enhancer (non-breaking; runs only when flag is true)
      (async function () {
        try {
          if (!window.CATALOG_DRIVEN_UI) return;
          const main = document.getElementById("mainContent");
          if (!main) return;

          const idToken = localStorage.getItem("cognitoIdToken");
          const headers = idToken ? { Authorization: `Bearer ${idToken}` } : {};

          const [catalogRes, bundlesRes] = await Promise.all([
            fetch('/api/catalog', { headers }),
            fetch('/api/my-bundles', { headers }),
          ]);
          if (!catalogRes.ok) throw new Error('catalog fetch failed');
          if (!bundlesRes.ok) throw new Error('my-bundles fetch failed');
          const catalog = await catalogRes.json();
          const my = await bundlesRes.json();
          const activeBundles = new Set(my.bundles || []);

          // Build activities list
          const items = (catalog.activities || []).map((a) => {
            const required = Array.isArray(a.bundles) ? a.bundles : [];
            const allowed = required.some((b) => activeBundles.has(b));
            const bundlesBadges = required.map((b) => `<span class="badge">${b}</span>`).join(' ');
            const disabled = allowed ? '' : 'disabled';
            const target = a.id === 'submit-vat' ? 'submitVat.html' : (a.id === 'vat-obligations' ? 'vatObligations.html' : '#');
            return `
              <div class="activity ${allowed ? '' : 'disabled'}" style="margin:.5em 0; padding:.5em; border:1px solid #ddd; border-radius:6px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:1em;">
                  <div>
                    <div style="font-weight:600">${a.name}</div>
                    <div style="font-size:.9em; color:#666">Requires: ${bundlesBadges}</div>
                  </div>
                  <button class="btn" ${disabled} onclick="if('${target}'!=='#') window.location.href='${target}'">Open</button>
                </div>
              </div>`;
          }).join('\n');

          main.innerHTML = `
            <div class="form-container" style="text-align:center">
              <h2>Available Activities</h2>
              <p>Rendered from product catalog</p>
              <div>${items}</div>
              <div style="margin-top:2em"><a class="btn" href="bundles.html">Add Bundle</a></div>
            </div>`;
        } catch (e) {
          console.log('CATALOG_DRIVEN_UI rendering failed:', e);
        }
      })();
    </script>
  </body>
</html>
