<!-- usage.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Token Usage</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
    <script src="./lib/analytics.js"></script>
    <script src="./lib/session-beacon.js"></script>
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="header-left">
          <a href="index.html" title="Home" class="home-link">
            <svg class="home-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
          </a>
          <a href="about.html" title="About & Help" class="info-link">
            <svg class="info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
          </a>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="index.html">Activities</a>
        <a href="hmrc/receipt/receipts.html">Receipts</a>
        <a href="bundles.html">Bundles</a>
        <a href="spreadsheets.html">Spreadsheets</a>
      </nav>
    </header>

    <main id="mainContent">
      <div id="statusMessagesContainer" role="alert" aria-live="polite"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <div class="form-container" style="text-align: center">
        <h2>Token Usage</h2>

        <div style="margin-bottom: 1em">
          <button type="button" id="refreshUsageBtn" class="btn" style="min-width: 140px">Refresh</button>
        </div>

        <div style="margin-top: 2em; text-align: left">
          <h3>Token Sources</h3>
          <table id="tokenSourcesTable" style="width: 100%; border-collapse: collapse; margin-top: 0.5em">
            <thead>
              <tr style="border-bottom: 2px solid #dee2e6; text-align: left">
                <th style="padding: 0.5em">Bundle Name</th>
                <th style="padding: 0.5em">Tokens Granted</th>
                <th style="padding: 0.5em">Tokens Remaining</th>
                <th style="padding: 0.5em">Expiry / Refresh</th>
              </tr>
            </thead>
            <tbody id="tokenSourcesBody">
              <tr>
                <td colspan="4" style="padding: 1em; color: #666; text-align: center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top: 2em; text-align: left">
          <h3>Token Consumption</h3>
          <table id="tokenConsumptionTable" style="width: 100%; border-collapse: collapse; margin-top: 0.5em">
            <thead>
              <tr style="border-bottom: 2px solid #dee2e6; text-align: left">
                <th style="padding: 0.5em">Activity</th>
                <th style="padding: 0.5em">Date / Time</th>
                <th style="padding: 0.5em">Tokens Used</th>
              </tr>
            </thead>
            <tbody id="tokenConsumptionBody">
              <tr>
                <td colspan="3" style="padding: 1em; color: #666; text-align: center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div id="subscriptionManagement" style="margin-top: 2em; text-align: left; display: none">
          <h3>Subscription</h3>
          <p style="color: #666; margin-bottom: 0.5em">Manage your subscription billing, payment method, and cancellation.</p>
          <button type="button" id="manageSubscriptionBtn" class="btn" style="background-color: #17a2b8; border-color: #17a2b8; min-width: 200px">Manage Subscription</button>
        </div>

        <div style="margin-top: 2em; text-align: left">
          <h3>Browser Storage</h3>
          <p style="color: #666; margin-bottom: 0.5em">Data stored on this device by this site. Authentication tokens are redacted for security.</p>
          <table id="browserStorageTable" style="width: 100%; border-collapse: collapse; margin-top: 0.5em">
            <thead>
              <tr style="border-bottom: 2px solid #dee2e6; text-align: left">
                <th style="padding: 0.5em">Key</th>
                <th style="padding: 0.5em">Value</th>
              </tr>
            </thead>
            <tbody id="browserStorageBody">
              <tr>
                <td colspan="2" style="padding: 1em; color: #666; text-align: center">Loading...</td>
              </tr>
            </tbody>
          </table>
          <div style="margin-top: 1em">
            <button type="button" id="clearStorageBtn" style="background: #fff; border: 1px solid #dc3545; color: #dc3545; font-size: 0.9em; padding: 6px 16px; border-radius: 4px; cursor: pointer;">Clear storage</button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
          <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
          <a id="apiDocsLink" style="display: inline" target="_blank" href="docs/api/index.html"> api </a>
          <a href="privacy.html">privacy</a>
          <a href="terms.html">terms</a>
          <a href="accessibility.html">accessibility</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 DIY Accounting Limited</p>
        </div>
        <div class="footer-right"></div>
      </div>
    </footer>

    <script src="lib/env-loader.js"></script>
    <script>
      (async function () {
        try { await window.loadEnv(); } catch (e) { console.warn("Failed to load environment:", e); }
      })();
    </script>
    <script type="module" src="submit.js"></script>
    <script src="developer-mode.js"></script>
    <script src="lib/request-cache.js"></script>
    <script src="lib/bundle-cache.js"></script>
    <script src="lib/toml-parser.js"></script>
    <script src="lib/feature-flags.js"></script>
    <script src="widgets/entitlement-status.js"></script>
    <script src="widgets/auth-status.js"></script>
    <script src="widgets/status-messages.js"></script>
    <script src="widgets/loading-spinner.js"></script>
    <script type="module" src="widgets/view-source-link.js"></script>
    <script>
      const getIdToken = () => {
        try {
          return localStorage.getItem("cognitoIdToken");
        } catch (e) {
          return null;
        }
      };

      const __rc = typeof window !== "undefined" && window.requestCache ? window.requestCache : null;

      async function fetchBundleData() {
        const idToken = getIdToken();
        if (!idToken) {
          renderNoAuth();
          return null;
        }

        try {
          let data;
          if (__rc && typeof __rc.getJSON === "function") {
            data = await __rc.getJSON("/api/v1/bundle", {
              ttlMs: 0,
              init: { headers: { Authorization: "Bearer " + idToken } },
            });
          } else if (window.fetchWithIdToken) {
            const response = await window.fetchWithIdToken("/api/v1/bundle", {});
            if (response.ok) {
              data = await response.json();
            }
          }
          return data;
        } catch (err) {
          console.warn("Failed to fetch bundle data:", err);
          return null;
        }
      }

      function renderNoAuth() {
        document.getElementById("tokenSourcesBody").innerHTML =
          '<tr><td colspan="4" style="padding: 1em; color: #666; text-align: center">Please log in to view token usage.</td></tr>';
        document.getElementById("tokenConsumptionBody").innerHTML =
          '<tr><td colspan="3" style="padding: 1em; color: #666; text-align: center">Please log in to view token usage.</td></tr>';
      }

      function renderTokenSources(bundles) {
        const body = document.getElementById("tokenSourcesBody");
        const tokenBundles = (bundles || []).filter(function (b) {
          return b.allocated && b.tokensGranted !== undefined;
        });

        if (tokenBundles.length === 0) {
          body.innerHTML =
            '<tr><td colspan="4" style="padding: 1em; color: #666; text-align: center">No token bundles found.</td></tr>';
          return;
        }

        body.innerHTML = tokenBundles
          .map(function (b) {
            var remaining = Math.max(0, (b.tokensGranted || 0) - (b.tokensConsumed || 0));
            var expiryInfo = "";
            if (b.tokenResetAt) {
              var resetDate = new Date(b.tokenResetAt);
              if (!isNaN(resetDate.getTime())) expiryInfo = "Refreshes " + resetDate.toLocaleDateString();
            }
            if (!expiryInfo && b.expiry) {
              var expiryDate = new Date(b.expiry);
              if (!isNaN(expiryDate.getTime())) expiryInfo = "Expires " + expiryDate.toLocaleDateString();
            }
            return (
              '<tr style="border-bottom: 1px solid #dee2e6">' +
              '<td style="padding: 0.5em">' +
              (b.bundleId || "Unknown") +
              "</td>" +
              '<td style="padding: 0.5em">' +
              (b.tokensGranted || 0) +
              "</td>" +
              '<td style="padding: 0.5em">' +
              remaining +
              "</td>" +
              '<td style="padding: 0.5em">' +
              (expiryInfo || "-") +
              "</td>" +
              "</tr>"
            );
          })
          .join("");
      }

      function renderTokenConsumption(bundles) {
        var body = document.getElementById("tokenConsumptionBody");
        var allEvents = [];

        (bundles || []).forEach(function (b) {
          if (b.tokenEvents && Array.isArray(b.tokenEvents)) {
            b.tokenEvents.forEach(function (evt) {
              allEvents.push(evt);
            });
          }
        });

        // Sort by timestamp descending (most recent first)
        allEvents.sort(function (a, b) {
          return (b.timestamp || "").localeCompare(a.timestamp || "");
        });

        if (allEvents.length === 0) {
          body.innerHTML =
            '<tr><td colspan="3" style="padding: 1em; color: #666; text-align: center">No token consumption recorded.</td></tr>';
          return;
        }

        body.innerHTML = allEvents
          .map(function (evt) {
            var dateStr = evt.timestamp ? new Date(evt.timestamp).toLocaleString() : "-";
            return (
              '<tr style="border-bottom: 1px solid #dee2e6">' +
              '<td style="padding: 0.5em">' +
              (evt.activity || "Unknown") +
              "</td>" +
              '<td style="padding: 0.5em">' +
              dateStr +
              "</td>" +
              '<td style="padding: 0.5em">' +
              (evt.tokensUsed || 1) +
              "</td>" +
              "</tr>"
            );
          })
          .join("");
      }

      async function loadUsage() {
        var data = await fetchBundleData();
        if (!data) return;
        renderTokenSources(data.bundles || []);
        renderTokenConsumption(data.bundles || []);
        renderSubscriptionManagement(data.bundles || []);
      }

      function renderSubscriptionManagement(bundles) {
        var section = document.getElementById("subscriptionManagement");
        var hasSubscription = (bundles || []).some(function (b) {
          return b.allocated && b.stripeSubscriptionId;
        });
        section.style.display = hasSubscription ? "block" : "none";
      }

      document.getElementById("manageSubscriptionBtn").addEventListener("click", async function () {
        var btn = document.getElementById("manageSubscriptionBtn");
        btn.textContent = "Loading...";
        btn.disabled = true;
        try {
          var response = await window.fetchWithIdToken("/api/v1/billing/portal", {});
          if (response.ok) {
            var result = await response.json();
            var portalUrl = result.data ? result.data.portalUrl : result.portalUrl;
            if (portalUrl) {
              window.location.href = portalUrl;
              return;
            }
          }
          btn.textContent = "Manage Subscription";
          btn.disabled = false;
          if (window.showStatus) window.showStatus("Unable to open subscription management. Please try again.", "error");
        } catch (err) {
          btn.textContent = "Manage Subscription";
          btn.disabled = false;
          if (window.showStatus) window.showStatus("Failed to connect to billing service.", "error");
        }
      });

      document.getElementById("refreshUsageBtn").addEventListener("click", function () {
        if (__rc && typeof __rc.invalidate === "function") {
          __rc.invalidate("/api/v1/bundle");
        }
        loadUsage();
        renderBrowserStorage();
      });

      function checkAuthStatus() {
        var userInfo = localStorage.getItem("userInfo");
        if (!userInfo) {
          renderNoAuth();
        }
      }

      function redactValue(key, value) {
        if (/^cognito.*Token$/.test(key)) {
          var claims = window.parseJwtClaims ? window.parseJwtClaims(value) : null;
          if (claims && claims.exp) {
            var remaining = Math.round((claims.exp * 1000 - Date.now()) / 60000);
            if (remaining > 0) return "Present (expires in " + remaining + " min)";
            return "Present (expired)";
          }
          return value ? "Present" : "(empty)";
        }
        if (key === "userInfo") {
          try {
            var info = JSON.parse(value);
            var parts = [];
            if (info.name) parts.push(info.name);
            if (info.email) parts.push(info.email);
            return parts.length > 0 ? parts.join(", ") : value;
          } catch (e) { return value; }
        }
        return value || "(empty)";
      }

      function escapeHtml(str) {
        var div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }

      function renderBrowserStorage() {
        var body = document.getElementById("browserStorageBody");
        var keys = Object.keys(localStorage).sort();
        if (keys.length === 0) {
          body.innerHTML = '<tr><td colspan="2" style="padding: 1em; color: #666; text-align: center">No data stored.</td></tr>';
          return;
        }
        body.innerHTML = keys.map(function (k) {
          var v;
          try { v = localStorage.getItem(k); } catch (e) { v = "[unreadable]"; }
          return '<tr style="border-bottom: 1px solid #dee2e6">' +
            '<td style="padding: 0.5em; font-family: monospace; font-size: 0.85em; white-space: nowrap">' + escapeHtml(k) + '</td>' +
            '<td style="padding: 0.5em; word-break: break-word; font-size: 0.85em">' + escapeHtml(redactValue(k, v)) + '</td>' +
            '</tr>';
        }).join("");
      }

      document.getElementById("clearStorageBtn").addEventListener("click", function () {
        if (!confirm("Clear all local storage for this site? This will log you out.")) return;
        var rumConsent = localStorage.getItem("consent.rum");
        var analyticsConsent = localStorage.getItem("consent.analytics");
        var rumConfig = localStorage.getItem("rum.config");
        localStorage.clear();
        if (rumConsent !== null) localStorage.setItem("consent.rum", rumConsent);
        if (analyticsConsent !== null) localStorage.setItem("consent.analytics", analyticsConsent);
        if (rumConfig !== null) localStorage.setItem("rum.config", rumConfig);
        renderBrowserStorage();
      });

      function initPage() {
        checkAuthStatus();
        loadUsage();
        renderBrowserStorage();
      }

      if (window.__submitReady__) {
        initPage();
      } else {
        document.addEventListener("submit-ready", initPage, { once: true });
      }
    </script>
  </body>
</html>
