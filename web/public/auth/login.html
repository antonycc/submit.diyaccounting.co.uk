<!-- auth/login.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">â˜°</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="../account/receipts.html">Receipts</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="../index.html" class="login-link">Home</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div id="statusMessagesContainer"></div>

      <div class="form-container" style="text-align: center">
        <h2>Login</h2>
        <p>Choose your authentication provider to continue:</p>

        <div class="auth-providers">
          <div class="auth-provider">
            <button type="button" class="btn auth-btn google-btn" id="loginWithGoogle">
              <img src="../images/g-logo.png" alt="Google" class="provider-logo" />
              Continue with Google
            </button>
          </div>

          <div class="auth-provider">
            <button type="button" class="btn auth-btn antonycc-btn" id="loginWithAntonycc">
              <img src="../images/oidc-antonycc-logo.png" alt="OIDC by Antonycc" class="provider-logo" />
              Continue with @antonycc/oidc
            </button>
          </div>

          <div class="auth-provider" id="mockOAuth2Provider">
            <button type="button" class="btn auth-btn" id="loginWithMockOAuth2">
              <img
                src="https://avatars.githubusercontent.com/u/11848947?s=48&v=4"
                alt="navikt/mock-oauth2-server"
                class="provider-logo"
              />
              Continue with mock-oauth2-server
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script src="../submit.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script type="module" src="../widgets/view-source-link.js"></script>
    <script src="../widgets/localstorage-viewer.js"></script>
    <script>
      // Login with Google via Cognito
      async function loginWithGoogle() {
        console.log("Initiating Google login via Cognito");

        console.log("Clear stored tokens and user info");
        localStorage.removeItem("authState");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Generate state parameter for security
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        // Get OAuth URL
        const authResponse = await getAuthUrl(state, "google");
        const authResponseUrl = authResponse.authUrl;

        console.log("Redirecting to Google OAuth URL");
        window.location.href = authResponseUrl;
      }

      // Login with Antonycc via Cognito
      async function loginWithAntonycc() {
        console.log("Initiating Antonycc login via Cognito");

        console.log("Clear stored tokens and user info");
        localStorage.removeItem("authState");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Generate state parameter for security
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        // Get OAuth URL
        const authResponse = await getAuthUrl(state, "antonycc");
        const authResponseUrl = authResponse.authUrl;

        console.log("Redirecting to Antonycc OAuth URL");
        window.location.href = authResponseUrl;
      }

      // Login with Mock OAuth2 Server via Cognito
      async function loginWithMockOAuth2() {
        console.log("Initiating navikt/mock-oauth2-server login via Cognito");

        console.log("Clear stored tokens and user info");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Generate state parameter for security
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        // Get OAuth URL
        const authResponse = await getAuthUrl(state, "mock");
        const authUrl = authResponse.authUrl;

        showStatus(`Handing off to ${authUrl}`, "info");
        console.log("Redirecting to navikt/mock-oauth2-server");
        window.location.href = authUrl;
      }

      // Check if user is already logged in
      function checkExistingAuth() {
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const userInfo = localStorage.getItem("userInfo");

        if (accessToken && userInfo) {
          console.log("User already authenticated");
          updateLoginStatus();
        }
      }

      // DOM elements
      const loginWithGoogleButton = document.getElementById("loginWithGoogle");
      const loginWithAntonyccButton = document.getElementById("loginWithAntonycc");
      const loginWithMockOAuth2Button = document.getElementById("loginWithMockOAuth2");

      // Event listeners
      loginWithGoogleButton.onclick = loginWithGoogle;
      loginWithAntonyccButton.onclick = loginWithAntonycc;
      loginWithMockOAuth2Button.addEventListener("click", async (event) => {
        event.preventDefault(); // Prevent default button action
        await loginWithMockOAuth2();
      });

      localStorage.removeItem("currentActivity");
      console.log("Current activity cleared");

      // Initialize authentication on page load
      checkExistingAuth();
    </script>
  </body>
</html>
