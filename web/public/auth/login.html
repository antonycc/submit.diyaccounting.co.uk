<!-- auth/login.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
    <!-- HEAD-prefetch to help mitigate API cold starts for this page's calls -->
    <!--script async src="../prefetch/prefetch-cognito-authurl-head.js"></script-->
    <!--script async src="../prefetch/prefetch-cognito-token-head.js"></script-->
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()" aria-label="Open navigation menu" aria-expanded="false">â˜°</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="../account/bundles.html">Bundles</a>
            <a href="../hmrc/receipt/receipts.html">Receipts</a>
            <a href="../guide/index.html">User Guide</a>
            <a href="../help/index.html">Help</a>
            <a href="../about.html">About</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="../index.html" class="login-link">Home</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <main id="mainContent">
      <div id="statusMessagesContainer" role="alert" aria-live="polite"></div>

      <div class="form-container" style="text-align: center">
        <h2>Login</h2>
        <p>Choose your authentication provider to continue:</p>

        <div class="auth-providers">
          <div class="auth-provider">
            <button type="button" class="btn auth-btn google-btn" id="loginWithCognito">
              <img src="../images/g-logo.png" alt="Google" class="provider-logo" />
              Continue with Google via Amazon Cognito
            </button>
          </div>

          <!-- Mock auth button injected by login-mock-addon.js in dev environments only -->
          <div id="mock-auth-container"></div>

          <!-- Native Cognito auth form injected by login-native-addon.js for behavior tests -->
          <div id="native-auth-container"></div>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
          <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
          <a id="apiDocsLink" style="display: inline" target="_blank" href="./docs/index.html"> api </a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script src="../lib/env-loader.js"></script>
    <script src="../lib/auth-url-builder.js"></script>
    <script type="module" src="../lib/utils/crypto-utils.js"></script>
    <script type="module" src="../submit.js"></script>
    <script src="../lib/request-cache.js"></script>
    <script src="../lib/toml-parser.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/entitlement-status.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script type="module" src="../widgets/view-source-link.js"></script>
    <script src="../widgets/localstorage-viewer.js"></script>
    <script>
      (async function () {
        try {
          await window.loadEnv();
        } catch (err) {
          console.warn("Failed to load environment:", err);
        }
      })();

      // Login with Google or Antonycc OIDC via Cognito
      async function loginWithCognito() {
        console.log("Initiating login with Google or Antonycc OIDC via Cognito");

        console.log("Clear stored tokens and user info");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        sessionStorage.removeItem("cognito_oauth_state");
        sessionStorage.removeItem("cognito_oauth_nonce");

        // Generate cryptographically secure state parameter for CSRF protection
        // Uses crypto.randomUUID() or crypto.getRandomValues() via crypto-utils.js
        const state = window.generateRandomState ? window.generateRandomState() : crypto.randomUUID().replace(/-/g, "");
        sessionStorage.setItem("cognito_oauth_state", state);

        // Generate cryptographically secure nonce for replay attack protection
        // The nonce is returned in the ID token and must match the original value
        const nonce = window.generateRandomState ? window.generateRandomState() : crypto.randomUUID().replace(/-/g, "");
        sessionStorage.setItem("cognito_oauth_nonce", nonce);

        let authResponseUrl;
        if (window.__env && window.authUrlBuilder) {
          authResponseUrl = window.authUrlBuilder.buildCognitoAuthUrl(state, nonce);
          console.log("Using client-side generated Cognito Auth URL:", authResponseUrl);
        } else {
          // Get OAuth URL from API (fallback)
          const authResponse = await getAuthUrl(state, "cognito");
          authResponseUrl = authResponse.authUrl;
          console.log("Using server-side Cognito Auth URL:", authResponseUrl);
        }

        console.log("Redirecting to Antonycc via Cognito OAuth URL");
        try {
          window.__correlation?.prepareRedirect?.();
        } catch {}
        window.location.href = authResponseUrl;
      }

      // Check if user is already logged in
      function checkExistingAuth() {
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const userInfo = localStorage.getItem("userInfo");

        if (accessToken && userInfo) {
          console.log("User already authenticated");
          updateLoginStatus();
        }
      }

      // DOM elements and event listeners
      const loginWithCognitoButton = document.getElementById("loginWithCognito");
      loginWithCognitoButton.onclick = loginWithCognito;

      sessionStorage.removeItem("currentActivity");
      console.log("Current activity cleared");

      // Initialize authentication on page load
      checkExistingAuth();
    </script>
    <!-- Mock auth addon - only loaded in local development environments -->
    <script>
      // Only load mock auth addon in local development (localhost/127.0.0.1/ngrok)
      // In production, this script is excluded from deployment and not needed
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname.includes('ngrok')) {
        const script = document.createElement('script');
        script.src = './login-mock-addon.js';
        document.body.appendChild(script);
      }
    </script>
    <!-- Native Cognito auth addon - returns empty script unless TEST_AUTH_PROVIDER=cognito-native -->
    <script src="./login-native-addon.js"></script>
  </body>
</html>
