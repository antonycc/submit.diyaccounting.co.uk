<!-- viewVatReturn.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>View VAT Return - DIY Accounting Submit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">☰</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="./vatObligations.html">VAT Obligations</a>
            <a href="../account/bundles.html">Bundles</a>
            <a href="../account/receipts.html">Receipts</a>
            <a href="../docs/index.html">API Docs</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>View VAT Return</h1>
      <p class="subtitle">View submitted VAT return details</p>
    </header>

    <div id="mainContent">
      <div id="statusMessagesContainer"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <!-- Search Form -->
      <div id="searchForm" class="form-container">
        <h2>Retrieve VAT Return</h2>
        <form id="vatReturnForm">
          <div class="form-group">
            <label for="vrn">VAT Registration Number (VRN)</label>
            <input type="text" id="vrn" name="vrn" required value="" placeholder="e.g., 176540158" maxlength="9" pattern="[0-9]{9}" />
            <div class="help-text">Enter your 9-digit VAT registration number</div>
          </div>

          <div class="form-group">
            <label for="periodKey">Period Key</label>
            <input type="text" id="periodKey" name="periodKey" required value="" placeholder="e.g., 24A1" maxlength="5" />
            <div class="help-text">Enter the period key for the return you want to view</div>
          </div>

          <!-- Developer Test Scenario Section -->
          <div id="developerSection" class="form-group" style="display: none">
            <label for="testScenario">Test Scenario (Developer/Sandbox Only)</label>
            <select id="testScenario" name="testScenario">
              <option value="">Default</option>
              <option value="SINGLE_LIABILITY">Single Liability</option>
              <option value="MULTIPLE_LIABILITIES">Multiple Liabilities</option>
              <option value="NOT_FOUND">Return Not Found</option>
            </select>
            <div class="help-text">Test different HMRC sandbox scenarios</div>
          </div>

          <button type="submit" id="retrieveBtn" class="submit-button">View Return</button>
        </form>

        <div class="developer-controls">
          <button type="button" id="toggleDeveloperMode" class="developer-button">Show Developer Options</button>
        </div>
      </div>

      <!-- Results Display -->
      <div id="returnResults" class="results-container" style="display: none">
        <h3>VAT Return Details</h3>
        <div id="returnDetails"></div>
        <div class="button-group">
          <button type="button" id="newSearchBtn" class="secondary-button">View Another Return</button>
          <button type="button" id="backToObligationsBtn" class="secondary-button">Back to Obligations</button>
        </div>
      </div>
    </div>

    <script src="../submit.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/loading-spinner.js"></script>
    <script>
      // Check if we're in sandbox/test mode to show developer options
      function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const vrn = urlParams.get("vrn");
        const periodKey = urlParams.get("periodKey");

        if (vrn) {
          document.getElementById("vrn").value = vrn;
        }
        if (periodKey) {
          document.getElementById("periodKey").value = periodKey;
        }

        const baseUrl = window.location.origin;
        const isSandbox =
          baseUrl.includes("test") ||
          baseUrl.includes("sandbox") ||
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1";

        if (isSandbox) {
          const devSection = document.getElementById("developerSection");
          if (devSection) {
            devSection.style.display = "block";
          }
        }

        // Toggle developer mode button
        const toggleBtn = document.getElementById("toggleDeveloperMode");
        const devSection = document.getElementById("developerSection");

        if (toggleBtn && devSection) {
          toggleBtn.addEventListener("click", () => {
            const isVisible = devSection.style.display !== "none";
            devSection.style.display = isVisible ? "none" : "block";
            toggleBtn.textContent = isVisible ? "Show Developer Options" : "Hide Developer Options";
          });
        }

        // Check if we returned from OAuth
        checkOAuthCallback();

        // Auto-submit if we have URL parameters and access token
        if (vrn && periodKey) {
          const accessToken = sessionStorage.getItem("hmrcAccessToken");
          if (accessToken) {
            document.getElementById("vatReturnForm").requestSubmit();
          }
        }
      }

      // Check if we returned from OAuth and retrieve pending return
      async function checkOAuthCallback() {
        const accessToken = sessionStorage.getItem("hmrcAccessToken");
        const pendingData = localStorage.getItem("pendingOAuthData");

        if (accessToken && pendingData) {
          try {
            const data = JSON.parse(pendingData);
            if (data.activity === "viewReturn") {
              // Populate form fields
              document.getElementById("vrn").value = data.vrn;
              document.getElementById("periodKey").value = data.periodKey;
              if (data.testScenario) {
                document.getElementById("testScenario").value = data.testScenario;
              }

              showStatus("Retrieving VAT return...", "info");
              await retrieveReturn(data.vrn, data.periodKey, data.testScenario, accessToken);

              // Clean up
              localStorage.removeItem("pendingOAuthData");
              localStorage.removeItem("currentActivity");
              sessionStorage.removeItem("oauth_state");
            }
          } catch (error) {
            console.error("Error processing OAuth callback:", error);
            showStatus(`Failed to retrieve return: ${error.message}`, "error");
            localStorage.removeItem("pendingOAuthData");
          }
        }
      }

      // Retrieve VAT return from API
      async function retrieveReturn(vrn, periodKey, testScenario, accessToken) {
        try {
          showLoading();

          // Build query parameters
          const params = new URLSearchParams({ vrn });
          if (testScenario) params.append("Gov-Test-Scenario", testScenario);

          // Get Gov-Client headers
          const govClientHeaders = await getGovClientHeaders();

          const response = await fetchWithId(`/api/v1/hmrc/vat/return/${periodKey}?${params}`, {
            method: "GET",
            headers: {
              "Authorization": `Bearer ${accessToken}`,
              "Content-Type": "application/json",
              ...govClientHeaders,
            },
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to retrieve VAT return");
          }

          // Display results
          displayReturn(result);
          document.getElementById("returnResults").style.display = "block";
          hideStatus();
        } catch (error) {
          console.error("Error retrieving VAT return:", error);
          showStatus(`Failed to retrieve return: ${error.message}`, "error");
        } finally {
          hideLoading();
        }
      }

      // Handle form submission
      document.getElementById("vatReturnForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const loadingSpinner = document.getElementById("loadingSpinner");
        const submitBtn = document.getElementById("retrieveBtn");
        const statusContainer = document.getElementById("statusMessagesContainer");
        const resultsContainer = document.getElementById("returnResults");

        // Clear previous results and status
        statusContainer.innerHTML = "";
        resultsContainer.style.display = "none";

        // Show loading
        loadingSpinner.style.display = "block";
        submitBtn.disabled = true;
        submitBtn.textContent = "Retrieving...";

        try {
          const formData = new FormData(e.target);
          const vrn = formData.get("vrn");
          const periodKey = formData.get("periodKey");
          const testScenario = formData.get("testScenario");

          // Check for access token
          let accessToken = sessionStorage.getItem("hmrcAccessToken");

          if (!accessToken) {
            // No access token, initiate OAuth flow
            showStatus("Initiating HMRC authentication...", "info");

            // Store parameters for restoration after OAuth
            const pendingData = {
              activity: "viewReturn",
              vrn,
              periodKey,
              testScenario,
            };

            await initiateHmrcAuth(location.pathname, pendingData, "read:vat");
            return; // Will redirect to HMRC
          }

          // Have access token, proceed with retrieval
          await retrieveReturn(vrn, periodKey, testScenario, accessToken);
        } catch (error) {
          console.error("Error retrieving VAT return:", error);
          showStatus(error.message, "error");
        } finally {
          // Hide loading
          loadingSpinner.style.display = "none";
          submitBtn.disabled = false;
          submitBtn.textContent = "View Return";
        }
      });
          resultsContainer.style.display = "block";
        } catch (error) {
          console.error("Error retrieving VAT return:", error);
          showStatusMessage(error.message, "error");
        } finally {
          // Hide loading
          loadingSpinner.style.display = "none";
          submitBtn.disabled = false;
          submitBtn.textContent = "View Return";
        }
      });

      function displayReturn(returnData) {
        const detailsContainer = document.getElementById("returnDetails");

        const formatCurrency = (value) => {
          const num = parseFloat(value);
          return isNaN(num) ? "£0.00" : `£${num.toFixed(2)}`;
        };

        const formatBoolean = (value) => {
          return value === true ? "Yes" : value === false ? "No" : "-";
        };

        const detailsHtml = `
          <div class="return-details">
            <div class="detail-section">
              <h4>Period Information</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>Period Key:</label>
                  <span><strong>${returnData.periodKey || "-"}</strong></span>
                </div>
                <div class="detail-item">
                  <label>Finalised:</label>
                  <span class="${returnData.finalised ? "status-fulfilled" : "status-open"}">
                    ${formatBoolean(returnData.finalised)}
                  </span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>VAT Due</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>VAT due on sales:</label>
                  <span>${formatCurrency(returnData.vatDueSales)}</span>
                </div>
                <div class="detail-item">
                  <label>VAT due on acquisitions:</label>
                  <span>${formatCurrency(returnData.vatDueAcquisitions)}</span>
                </div>
                <div class="detail-item">
                  <label>Total VAT due:</label>
                  <span><strong>${formatCurrency(returnData.totalVatDue)}</strong></span>
                </div>
                <div class="detail-item">
                  <label>VAT reclaimed on purchases:</label>
                  <span>${formatCurrency(returnData.vatReclaimedCurrPeriod)}</span>
                </div>
                <div class="detail-item">
                  <label>Net VAT due:</label>
                  <span class="net-amount"><strong>${formatCurrency(returnData.netVatDue)}</strong></span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>Turnover</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>Total value of sales (excl. VAT):</label>
                  <span>${formatCurrency(returnData.totalValueSalesExVAT)}</span>
                </div>
                <div class="detail-item">
                  <label>Total value of purchases (excl. VAT):</label>
                  <span>${formatCurrency(returnData.totalValuePurchasesExVAT)}</span>
                </div>
                <div class="detail-item">
                  <label>Total value of goods supplied (excl. VAT):</label>
                  <span>${formatCurrency(returnData.totalValueGoodsSuppliedExVAT)}</span>
                </div>
                <div class="detail-item">
                  <label>Total acquisitions (excl. VAT):</label>
                  <span>${formatCurrency(returnData.totalAcquisitionsExVAT)}</span>
                </div>
              </div>
            </div>
          </div>
        `;

        detailsContainer.innerHTML = detailsHtml;
      }

      function showStatusMessage(message, type = "info") {
        showStatus(message, type);
      }

      // Button handlers
      document.getElementById("newSearchBtn")?.addEventListener("click", () => {
        const form = document.getElementById("vatReturnForm");
        const resultsContainer = document.getElementById("returnResults");
        form.reset();
        resultsContainer.style.display = "none";
        hideStatus();
      });

      document.getElementById("backToObligationsBtn")?.addEventListener("click", () => {
        window.location.href = "vatObligations.html";
      });

      // Initialize page when DOM is loaded
      document.addEventListener("DOMContentLoaded", initializePage);
    </script>

    <style>
      .return-details {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }

      .detail-section {
        margin-bottom: 30px;
      }

      .detail-section h4 {
        color: #333;
        border-bottom: 2px solid #007acc;
        padding-bottom: 8px;
        margin-bottom: 15px;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .detail-item label {
        font-weight: 500;
        color: #555;
      }

      .detail-item span {
        font-weight: 600;
        color: #333;
      }

      .net-amount {
        font-size: 1.1em;
        color: #007acc;
      }

      .status-fulfilled {
        color: #28a745;
      }

      .status-open {
        color: #dc3545;
      }

      @media (max-width: 768px) {
        .detail-grid {
          grid-template-columns: 1fr;
        }

        .detail-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }
      }
    </style>
  </body>
</html>
