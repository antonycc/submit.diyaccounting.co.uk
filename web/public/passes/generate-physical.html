<!-- generate-physical.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Generate Physical Pass</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Generate a physical pass for printing on merchandise. QR code works forever with limited scans."
    />
    <link rel="canonical" href="https://submit.diyaccounting.co.uk/passes/generate-physical.html" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="../submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
    <script src="../lib/analytics.js"></script>
    <script src="../lib/session-beacon.js"></script>
    <script src="../lib/qrcode.min.js"></script>
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="header-left">
          <a href="../index.html" title="Home" class="home-link">
            <svg class="home-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
          </a>
          <a href="../about.html" title="About & Help" class="info-link">
            <svg class="info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
          </a>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="../index.html">Activities</a>
        <a href="../hmrc/receipt/receipts.html">Receipts</a>
        <a href="../bundles.html">Bundles</a>
        <a href="../spreadsheets.html">Spreadsheets</a>
      </nav>
    </header>

    <main id="mainContent">
      <div id="statusMessagesContainer" role="alert" aria-live="polite"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <div class="form-container" style="text-align: center">
        <h2>Generate a Physical Pass</h2>
        <p style="color: #666; font-size: 0.95em; max-width: 600px; margin: 0 auto 1.5em">
          Create a pass for printing on merchandise &mdash; t-shirts, mugs, stickers.
          The QR code works forever with limited scans, making it perfect for a hard copy.
          Merch ordering coming soon.
        </p>

        <div id="tokenInfo" style="margin-bottom: 1.5em; display: none">
          <p style="font-size: 0.9em; color: #555">
            This will use <strong id="tokenCostDisplay">3</strong> of your
            <strong id="tokensRemainingDisplay">0</strong> remaining tokens
          </p>
        </div>

        <div style="margin: 1em auto; max-width: 440px">
          <label style="display: block; margin-bottom: 0.4em; font-weight: 600; text-align: left">Product type</label>
          <div style="display: flex; gap: 0.5em; flex-wrap: wrap; justify-content: center; margin-bottom: 1em">
            <button type="button" data-product-type="tshirt" class="btn product-type-btn"
              style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #2c5aa0">T-Shirt</button>
            <button type="button" data-product-type="mug-right" class="btn product-type-btn"
              style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #6c757d">Mug (right-handed)</button>
            <button type="button" data-product-type="mug-left" class="btn product-type-btn"
              style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #6c757d">Mug (left-handed)</button>
            <button type="button" data-product-type="sticker" class="btn product-type-btn"
              style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #6c757d">Sticker</button>
          </div>
        </div>

        <div style="margin: 1em auto; max-width: 440px">
          <label for="passNotes" style="display: block; margin-bottom: 0.4em; font-weight: 600; text-align: left">Notes (optional)</label>
          <input
            type="text"
            id="passNotes"
            placeholder="e.g. Conference merch batch"
            autocomplete="off"
            style="width: 100%; padding: 0.6em; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box"
          />
        </div>

        <div style="margin-top: 1.5em">
          <button type="button" id="generatePassBtn" class="btn" style="min-width: 200px" disabled>Generate Pass</button>
        </div>

        <!-- Result section (hidden until pass is generated) -->
        <div id="passResult" style="display: none; margin-top: 2em; padding-top: 2em; border-top: 1px solid #ddd">
          <h3>Your Physical Pass</h3>

          <div style="margin: 1.5em 0">
            <div id="generatedPassCode" style="font-size: 1.8em; font-weight: bold; letter-spacing: 0.02em; color: #2c5aa0; word-break: break-word"></div>
          </div>

          <div style="margin: 1em 0">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5em; flex-wrap: wrap">
              <span id="generatedPassUrl" style="font-size: 0.85em; color: #555; word-break: break-all"></span>
              <button type="button" id="copyUrlBtn" class="btn" style="font-size: 0.8em; padding: 0.3em 0.8em; min-width: unset">Copy Link</button>
            </div>
          </div>

          <div style="display: flex; align-items: center; justify-content: center; gap: 0.5em; margin: 0.5em 0">
            <span id="passCodeSmall" style="font-size: 0.85em; color: #555"></span>
            <button type="button" id="copyCodeBtn" class="btn" style="font-size: 0.8em; padding: 0.3em 0.8em; min-width: unset">Copy Code</button>
          </div>

          <!-- Front design preview: words stacked vertically -->
          <div style="margin: 2em 0">
            <h4 style="color: #333">Front Design</h4>
            <div id="frontPreview" style="display: inline-block; background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 2em; min-width: 200px"></div>
          </div>

          <!-- Back design preview: QR code with passphrase -->
          <div style="margin: 2em 0">
            <h4 style="color: #333">Back Design</h4>
            <div id="generatedPassQrCode" style="display: inline-block; background: white; border: 2px solid #dee2e6; border-radius: 8px; padding: 1.5em; min-width: 200px"></div>
          </div>

          <div style="margin: 1em 0; display: flex; justify-content: center; gap: 1em; flex-wrap: wrap">
            <button type="button" id="downloadFrontSvg" class="btn" style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #495057">Download Front (SVG)</button>
            <button type="button" id="downloadBackSvg" class="btn" style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #495057">Download Back (SVG)</button>
            <button type="button" id="downloadBackPng" class="btn" style="font-size: 0.85em; padding: 0.4em 1em; min-width: unset; background-color: #495057">Download Back (PNG)</button>
          </div>

          <div style="margin-top: 1em">
            <a data-fulfillment-link href="#" style="display: none; color: #6f42c1; font-weight: 600">Order merchandise (coming soon)</a>
          </div>

          <div style="margin-top: 1.5em">
            <p style="font-size: 0.85em; color: #856404; background: #fff3cd; padding: 0.75em; border-radius: 4px; display: inline-block">
              This pass has no expiry date but is limited to 1 scan. Perfect for printed merchandise.
            </p>
            <p style="font-size: 0.85em; color: #0c5460; background: #d1ecf1; padding: 0.75em; border-radius: 4px; display: inline-block; margin-top: 0.5em">
              Merch ordering coming soon &mdash; for now, download the designs and use your favourite print service.
            </p>
          </div>

          <div id="tokensAfter" style="margin-top: 1em; font-size: 0.9em; color: #555"></div>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
          <a id="latestTestsLink" style="display: inline" target="_blank" href="../tests/index.html">tests</a>
          <a id="apiDocsLink" style="display: inline" target="_blank" href="../docs/api/index.html"> api </a>
          <a href="../privacy.html">privacy</a>
          <a href="../terms.html">terms</a>
          <a href="../accessibility.html">accessibility</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 DIY Accounting Limited</p>
        </div>
        <div class="footer-right"></div>
      </div>
    </footer>

    <script src="../lib/env-loader.js"></script>
    <script>
      (async function () {
        try {
          await window.loadEnv();
        } catch (e) {
          console.warn("Failed to load environment:", e);
        }
      })();
    </script>
    <script type="module" src="../submit.js"></script>
    <script src="../developer-mode.js"></script>
    <script src="../lib/request-cache.js"></script>
    <script src="../lib/toml-parser.js"></script>
    <script src="../widgets/entitlement-status.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/loading-spinner.js"></script>
    <script type="module" src="../widgets/view-source-link.js"></script>

    <script>
      const getIdToken = () => {
        try { return localStorage.getItem("cognitoIdToken"); } catch { return null; }
      };

      let __generatedPassUrl = "";
      let __generatedPassCode = "";
      let __generatedWords = [];
      let __frontSvg = "";
      let __backSvg = "";
      let __selectedProductType = "t-shirt";

      // --- Product type selector
      document.querySelectorAll("[data-product-type]").forEach(btn => {
        btn.addEventListener("click", () => {
          __selectedProductType = btn.getAttribute("data-product-type");
          document.querySelectorAll("[data-product-type]").forEach(b => {
            b.style.backgroundColor = b === btn ? "#2c5aa0" : "#6c757d";
          });
          // Re-render previews if pass already generated
          if (__generatedPassCode) {
            renderFrontPreview();
            renderBackPreview();
          }
        });
      });

      // --- Generate front SVG: words stacked vertically
      function generateFrontSvg(words, productType) {
        const fontSize = 36;
        const lineHeight = 48;
        const padding = 30;
        const width = 300;
        const height = padding * 2 + words.length * lineHeight;

        let textElements = "";
        words.forEach((word, i) => {
          const y = padding + (i + 1) * lineHeight - 10;
          textElements += `  <text x="${width / 2}" y="${y}" text-anchor="middle" font-family="'Helvetica Neue', Helvetica, Arial, sans-serif" font-size="${fontSize}" font-weight="bold" fill="#1a1a2e">${escapeXml(word)}</text>\n`;
        });

        return `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <rect width="${width}" height="${height}" fill="white"/>
${textElements}</svg>`;
      }

      // --- Generate back SVG: QR code with passphrase text below
      function generateBackSvg(qrSvgContent, code) {
        const qrSize = 200;
        const totalWidth = 300;
        const textY = qrSize + 30;
        const totalHeight = textY + 30;
        const qrOffsetX = (totalWidth - qrSize) / 2;

        // Extract inner content of QR SVG
        const innerMatch = qrSvgContent.match(/<svg[^>]*>([\s\S]*)<\/svg>/);
        const qrInner = innerMatch ? innerMatch[1] : qrSvgContent;
        const viewBoxMatch = qrSvgContent.match(/viewBox="([^"]*)"/);
        const qrViewBox = viewBoxMatch ? viewBoxMatch[1] : `0 0 ${qrSize} ${qrSize}`;

        return `<svg xmlns="http://www.w3.org/2000/svg" width="${totalWidth}" height="${totalHeight}" viewBox="0 0 ${totalWidth} ${totalHeight}">
  <rect width="${totalWidth}" height="${totalHeight}" fill="white"/>
  <svg x="${qrOffsetX}" y="0" width="${qrSize}" height="${qrSize}" viewBox="${qrViewBox}">
    ${qrInner}
  </svg>
  <text x="${totalWidth / 2}" y="${textY}" text-anchor="middle" font-family="monospace" font-size="11" fill="#555">${escapeXml(code)}</text>
</svg>`;
      }

      function escapeXml(str) {
        return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;");
      }

      function renderFrontPreview() {
        const frontEl = document.getElementById("frontPreview");
        __frontSvg = generateFrontSvg(__generatedWords, __selectedProductType);
        frontEl.innerHTML = __frontSvg;
      }

      async function renderBackPreview() {
        const qrContainer = document.getElementById("generatedPassQrCode");
        try {
          const qrSvg = await QRCode.toString(__generatedPassUrl, {
            type: "svg",
            width: 200,
            margin: 2,
            errorCorrectionLevel: "H",
          });
          __backSvg = generateBackSvg(qrSvg, __generatedPassCode);
          qrContainer.innerHTML = __backSvg;
        } catch (err) {
          console.warn("Failed to generate QR code:", err);
        }
      }

      // --- Initialise page
      async function initPage() {
        checkAuthStatus();

        const idToken = getIdToken();
        if (!idToken) {
          showStatus("Please log in to generate passes.", "warning");
          document.getElementById("generatePassBtn").disabled = true;
          return;
        }

        // Fetch token info
        try {
          const res = await window.fetchWithIdToken("/api/v1/bundle");
          const data = await res.json();
          const bundles = data.bundles || [];
          const totalRemaining = bundles
            .filter(b => b.allocated)
            .reduce((sum, b) => sum + (b.tokensRemaining || 0), 0);

          // Read token cost from catalogue
          let tokenCost = 3;
          try {
            const catRes = await fetch("/submit.catalogue.toml");
            if (catRes.ok) {
              const catText = await catRes.text();
              const cat = window.TOML ? window.TOML.parse(catText) : null;
              if (cat && cat.activities) {
                const activity = cat.activities.find(a => a.id === "generate-pass-physical");
                if (activity && activity.tokenCost !== undefined) tokenCost = activity.tokenCost;
              }
            }
          } catch {}

          document.getElementById("tokenCostDisplay").textContent = tokenCost;
          document.getElementById("tokensRemainingDisplay").textContent = totalRemaining;
          document.getElementById("tokenInfo").style.display = "block";

          const btn = document.getElementById("generatePassBtn");
          if (totalRemaining >= tokenCost) {
            btn.disabled = false;
          } else {
            btn.disabled = true;
            showStatus("You don't have enough tokens to generate a pass.", "warning");
          }
        } catch (err) {
          console.warn("Failed to fetch token info:", err);
          document.getElementById("generatePassBtn").disabled = false;
        }
      }

      // --- Generate pass
      document.getElementById("generatePassBtn").addEventListener("click", async () => {
        const btn = document.getElementById("generatePassBtn");
        const idToken = getIdToken();
        if (!idToken) {
          showStatus("Please log in first.", "warning");
          return;
        }

        btn.textContent = "Generating...";
        btn.disabled = true;

        try {
          const notes = document.getElementById("passNotes").value.trim() || undefined;
          const res = await window.fetchWithIdToken("/api/v1/pass/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ passTypeId: "physical-pass", notes }),
          });

          const body = await res.json();

          if (!res.ok) {
            showStatus(body.message || body.error || "Failed to generate pass", "error");
            btn.textContent = "Generate Pass";
            btn.disabled = false;
            return;
          }

          // Display result
          __generatedPassCode = body.code;
          __generatedPassUrl = body.url;
          __generatedWords = body.code.split("-");

          document.getElementById("generatedPassCode").textContent = body.code;
          document.getElementById("generatedPassUrl").textContent = body.url;
          document.getElementById("passCodeSmall").textContent = body.code;

          // Render front and back previews
          renderFrontPreview();
          await renderBackPreview();

          // Update token display
          if (body.tokensRemaining !== undefined) {
            document.getElementById("tokensRemainingDisplay").textContent = body.tokensRemaining;
            document.getElementById("tokensAfter").textContent =
              `${body.tokensConsumed} tokens consumed. ${body.tokensRemaining} tokens remaining.`;
          }

          document.getElementById("passResult").style.display = "block";
          btn.textContent = "Generate Another";
          btn.disabled = false;
          showStatus("Pass generated successfully!", "success");
        } catch (err) {
          showStatus(`Failed to generate pass: ${err?.message || err}`, "error");
          btn.textContent = "Generate Pass";
          btn.disabled = false;
        }
      });

      // --- Copy URL
      document.getElementById("copyUrlBtn").addEventListener("click", async () => {
        if (!__generatedPassUrl) return;
        try {
          await navigator.clipboard.writeText(__generatedPassUrl);
          document.getElementById("copyUrlBtn").textContent = "Copied!";
          setTimeout(() => { document.getElementById("copyUrlBtn").textContent = "Copy Link"; }, 2000);
        } catch {
          showStatus("Failed to copy to clipboard", "error");
        }
      });

      // --- Copy code
      document.getElementById("copyCodeBtn").addEventListener("click", async () => {
        if (!__generatedPassCode) return;
        try {
          await navigator.clipboard.writeText(__generatedPassCode);
          document.getElementById("copyCodeBtn").textContent = "Copied!";
          setTimeout(() => { document.getElementById("copyCodeBtn").textContent = "Copy Code"; }, 2000);
        } catch {
          showStatus("Failed to copy to clipboard", "error");
        }
      });

      // --- Download front SVG
      document.getElementById("downloadFrontSvg").addEventListener("click", () => {
        if (!__frontSvg) return;
        const blob = new Blob([__frontSvg], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pass-${__generatedPassCode}-front.svg`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // --- Download back SVG
      document.getElementById("downloadBackSvg").addEventListener("click", () => {
        if (!__backSvg) return;
        const blob = new Blob([__backSvg], { type: "image/svg+xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `pass-${__generatedPassCode}-back.svg`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // --- Download back PNG
      document.getElementById("downloadBackPng").addEventListener("click", async () => {
        if (!__generatedPassUrl) return;
        try {
          const dataUrl = await QRCode.toDataURL(__generatedPassUrl, {
            width: 600,
            margin: 2,
            errorCorrectionLevel: "H",
          });
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = `pass-${__generatedPassCode}-back.png`;
          a.click();
        } catch {
          showStatus("Failed to generate PNG", "error");
        }
      });

      // --- Page init
      try { sessionStorage.removeItem("currentActivity"); } catch {}

      if (window.__submitReady__) {
        initPage();
      } else {
        document.addEventListener("submit-ready", initPage, { once: true });
      }
    </script>
  </body>
</html>
