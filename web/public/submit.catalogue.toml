version = "1.1.0"

# BUNDLE → PASS MAPPING SUMMARY
# ==============================
# Bundle ID          → Unlocked by pass types                                     → Payment required?
# default            → (automatic, no pass needed)                                 → No
# day-guest          → day-guest-test-pass, day-guest-pass, digital-pass, physical-pass → No (admin passes) / 10 tokens (user-issued passes, Phase 6)
# invited-guest      → invited-guest, group-invite, campaign                       → No (admin passes) / 10 tokens (campaign, Phase 6)
# resident-guest     → resident-guest                                              → No (admin-issued, email-restricted)
# resident-pro-comp  → resident-pro-comp                                           → No (admin-issued, email-restricted)
# resident-pro       → resident-pro-test-pass, resident-pro-pass (planned: on-subscription via Stripe) → Checkout + initial grant done (Phases 1-4); renewal/cancellation pending (Phases 5, 7)
#
# See PASSES.md for full documentation and submit.passes.toml for pass type definitions.

# default: Automatic bundle for all authenticated users
# Unlocked by: No pass required (automatic allocation)
# Payment: None
# Activities: bundle management, receipts, help
[[bundles]]
id = "default"
name = "Default"
enable = "never"
allocation = "automatic"

# day-guest: Short-term HMRC access
# Unlocked by: day-guest-test-pass (sandbox), day-guest-pass (production), digital-pass (user, 10 tokens), physical-pass (user, 10 tokens)
# Payment: None for admin-issued passes; 10 tokens to issue digital/physical passes (Phase 6)
# Tokens: 3 granted (enough for 3 VAT submissions), no refresh (single use period)
# Access to free authenticated activities including VAT submission for a limited time
[[bundles]]
id = "day-guest"
name = "Day Guest"
levelName = "Guest"
# TODO: 2. Switch to enable = "always" for "public" - AKA open public beta with production credentials recognised by HMRC
enable = "on-pass"
#enable = "always"
hidden = false
# hidden
# ======
# Show this bundle on the bundles page
allocation = "on-request"
# TODO: 2. Switch to 10 for "public" - AKA open public beta with production credentials recognised by HMRC
cap = 0
# cap (GLOBAL capacity limit)
# ===========================
# Maximum number of active (non-expired) allocations of this bundle across ALL users.
# When all cap slots are taken, the bundle shows "global user limit reached, please try
# again tomorrow" in the UI. As allocations expire (per timeout), slots return to the pool.
# Each user can hold at most one of each bundle type (hard-wired rule, not configurable).
# Renewal refreshes the existing allocation's expiry rather than creating a duplicate.
# The GET /api/v1/bundle response includes bundleCapacityAvailable: true/false for each
# catalog bundle so the UI can show availability without exposing exact take-up numbers.
# Implementation: Phase 2.9 in PLAN_PASSES_V2.md
timeout = "P1D"
# DONE: 1. Comment out for closed beta with production credentials validated by HMRC  <<<<---- WE ARE HERE 4th FEB 2026
#listedInEnvironments = ["local", "test", "proxy", "proxyRunning", "ci"]
# listedInEnvironments
# ====================
# Hidden in production until there are production credentials which have been validated by a trial user and checked by HMRC
tokensGranted = 3
# tokensGranted
# =============
# Number of HMRC API tokens allocated with this bundle
# The tokens are credited to the user and expire after the period matching the timeout
# Activities such as submitting VAT returns consume 1 token
# There is a user token activity counter shown in the UI
# Add to GET /api/v1/bundles/
#{
#  "bundles": [{
#    "createdAt": "2026-01-31T20:52:50.772Z",
#    "hashedSub": "a530dcdd1c77138dfd052736fc0790499abec9ae0ccbe63bcacb9cbc050471f7",
#    "ttl": 1772323200,
#    "expiry": "2026-02-01T00:00:00.000Z",
#    "ttl_datestamp": "2026-03-01T00:00:00.000Z",
#    "bundleId": "test"
#  }],
#  "tokensRemaining": 1
#}

# invited-guest: Month-long access for specific invited users
# Unlocked by: invited-guest pass (email-restricted), group-invite pass (shareable), campaign pass (user-issued, 10 tokens)
# Payment: None for admin-issued passes; 10 tokens to issue campaign passes (Phase 6)
# Tokens: 3 granted, refreshing monthly (tokenRefreshInterval = P1M)
# Access to free authenticated activities including VAT submission for specific users with a pass for a longer time
[[bundles]]
id = "invited-guest"
name = "Invited Guest"
levelName = "Guest"
enable = "on-pass"
hidden = true
allocation = "on-email-match"
# on-email-match
# ==============
# Allocate this bundle only if the user's email address matches one of those listed in restrictedToEmailHash on the pass
timeout = "P1M"
tokensGranted = 3
tokenRefreshInterval = "P1M"
# tokenRefreshInterval
# ====================
# Interval after which tokens are replenished to the users account (ideally the same as the timeout otherwise they will stack or have gaps)
#
# To do (later) screens showing the user's token balance and activities driven by more advanced APIs
# GET /api/v1/tokens/ [ { "bundle": "day-guest", "tokens": 2, "expires": "2024-06-30T12:34:56Z" } ]
# GET /api/v1/activities/ [ { "activity": "submit-vat", "tokens": 1, "started": "2024-05-30T12:34:56Z", "completed": "2024-05-30T12:34:56Z", requestId: "abc-123-def-456" } ]

# resident-guest: Permanent free access for existing DIY customers and partners
# Unlocked by: resident-guest pass (email-restricted, admin-issued)
# Payment: None (admin manually sends pass to verified customers via email support)
# Tokens: 3 granted, refreshing monthly, no timeout (unlimited duration)
# Access to free authenticated activities including VAT submission for specific users with a pass without time limit
[[bundles]]
id = "resident-guest"
name = "Resident Guest"
levelName = "Guest"
enable = "on-pass"
hidden = true
allocation = "on-email-match"
# on-email-match
# ==============
# Allocate this bundle only if the user's email address matches one of those listed in restrictedToEmailHash on the pass
tokensGranted = 3
tokenRefreshInterval = "P1M"

# resident-pro-comp: Complimentary pro access for beta testers and partners
# Unlocked by: resident-pro-comp pass (email-restricted, admin-issued)
# Payment: None (gifted to beta testers who validate production HMRC credentials)
# Tokens: 100 granted, refreshing monthly, no timeout (unlimited duration)
# Enables: all activities including generating digital/physical passes (costs 10 tokens each)
# Complimentary pro access for specific users via a pass (beta testers, partners)
[[bundles]]
id = "resident-pro-comp"
name = "Resident Pro (Complimentary)"
levelName = "Pro"
enable = "on-pass"
hidden = true
allocation = "on-email-match"
tokensGranted = 100
tokenRefreshInterval = "P1M"

# resident-pro: Pro subscription access
# Unlocked by: resident-pro-test-pass (sandbox), resident-pro-pass (production), Stripe monthly subscription
# Payment: Pass reveals the card, subscription grants the bundle (£9.99/mo via Stripe Checkout)
# Tokens: 100 granted, refreshing monthly
# Enables: all activities including generating digital/physical passes (costs 10 tokens each)
# Access to all authenticated activities including VAT submission for subscribed users
# Note: resident-pro-comp (above) grants this level for free via on-email-match — comp passes bypass subscription
[[bundles]]
id = "resident-pro"
name = "Resident Pro"
levelName = "Pro"
enable = "on-pass"
hidden = false
# on-pass-on-subscription: Pass gates visibility (card appears after valid pass), subscription gates access.
# After entering a valid pass, user sees a "Subscribe £9.99/mo" button instead of "Request".
# Stripe Checkout creates the subscription; webhook grants the bundle.
allocation = "on-pass-on-subscription"
tokensGranted = 100
tokenRefreshInterval = "P1M"
#listedInEnvironments = ["local", "test", "proxy", "proxyRunning", "ci"]
# listedInEnvironments
# ====================
# Hidden in production until there are production credentials which have been validated by a trial user and checked by HMRC

[[activities]]
id = "bundle"
name = "View and edit your bundles"
display = "never"
bundles = ["default"]
metered = false
# metered
# =======
# If false, this activity does not appear in the user's activity list and does not consume tokens
paths = ["bundles.html", "^/api/v1/catalog.*", "^/api/v1/bundle.*"]

[[activities]]
id = "submit-vat"
name = "Submit VAT (HMRC)"
display = "always-with-upsell"
# display: always-with-upsell
# shows upsell prompt if not entitled
bundles = ["day-guest", "invited-guest", "resident-guest", "resident-pro-comp", "resident-pro"]
tokenCost = 1
metered = true
paths = ["hmrc/vat/submitVat.html", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "vat-obligations"
name = "VAT Obligations (HMRC)"
display = "always-with-upsell"
bundles = ["day-guest", "invited-guest", "resident-guest", "resident-pro-comp", "resident-pro"]
tokenCost = 0
metered = true
paths = ["hmrc/vat/vatObligations.html", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "view-vat-return"
name = "View VAT Return (HMRC)"
display = "always-with-upsell"
bundles = ["day-guest", "invited-guest", "resident-guest", "resident-pro-comp", "resident-pro"]
tokenCost = 0
metered = true
paths = ["hmrc/vat/viewVatReturn.html", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "my-receipts"
name = "View previously submitted receipts"
display = "on-entitlement"
bundles = ["default"]
metered = false
paths = ["hmrc/receipt/receipts.html", "^/api/v1/hmrc/receipt.*"]

[[activities]]
id = "generate-pass-digital"
name = "Generate Digital Pass"
display = "on-entitlement"
bundles = ["resident-pro-comp", "resident-pro"]
tokenCost = 10
metered = true
# generate-pass-digital
# =====================
# Time-limited (7 days), unlimited capacity (100 uses).
# Encourages short digital campaigns (social media, email, messaging).
# See PLAN_GENERATE_PASS_ACTIVITY.md
paths = ["passes/generate-digital.html", "^/api/v1/pass/generate$"]

[[activities]]
id = "generate-pass-physical"
name = "Generate Physical Pass"
display = "on-entitlement"
bundles = ["resident-pro-comp", "resident-pro"]
tokenCost = 10
metered = true
# generate-pass-physical
# ======================
# Usage-limited (10 uses), unlimited time.
# Encourages continued display on merchandise (t-shirts, mugs).
# See PLAN_GENERATE_PASS_ACTIVITY.md
paths = ["passes/generate-physical.html", "^/api/v1/pass/generate$"]

[[activities]]
id = "help"
name = "Learn about DIY Accounting Submit"
display = "always"
bundles = ["default"]
metered = false
paths = ["about.html"]

# Passes:
# Example invite pass record in DynamoDB:
# Do I need a pass admin screen?
#
# {
#    pk: 'invite#correct-horse-battery-staple',
#    code: 'correct-horse-battery-staple',
#
#    // Bundle granted by this invite
#    bundleId: 'invited-guest',
#
#    // Validity window (when the invite can be used)
#    validFrom: '2026-02-01T00:00:00Z',
#    validUntil: '2026-02-14T23:59:59Z',
#
#    // DynamoDB TTL (auto-delete 1 month after validity ends)
#    ttl: 1742169599,  // Unix timestamp: validUntil + 30 days
#
#    // Audit timestamps
#    createdAt: '2026-01-31T12:00:00Z',
#    updatedAt: '2026-01-31T12:00:00Z',
#
#    // Usage controls
#    maxUses: 5,
#    useCount: 0,
#    revokedAt: null,
#
#    // Optional: restrict to specific email (null = anyone)
#    restrictedToEmailHash: 'Ks7d9fJ2mNpQr...',  // or null
#
#    createdBy: 'user#abc123',
# }
