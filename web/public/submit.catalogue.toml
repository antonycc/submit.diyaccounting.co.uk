version = "1.1.0"

[[bundles]]
id = "default"
name = "Default"
enable = "never"
allocation = "automatic"

# Access to Sandbox APIs for testing
[[bundles]]
id = "test"
name = "Test"
levelName = "Test"
enable = "on-pass"
# on-pass
# =======
# Disable until a pass has been accecpted, once we have implemented pass generation and acceptance via a form.
hidden = true
# hidden
# ======
# Hide this bundle from the bundles page until allocated are implemented
allocation = "on-request"
timeout = "P1D"
tokensGranted = 10

# Access to free authenticated activities including VAT submission for a limited time
[[bundles]]
id = "day-guest"
name = "Day Guest"
levelName = "Guest"
# TODO: 2. Switch to enable = "always" for "public" - AKA open public beta with production credentials recognised by HMRC
enable = "on-pass"
#enable = "always"
hidden = false
# hidden
# ======
# Show this bundle on the bundles page
allocation = "on-request"
# TODO: 2. Switch to 10 for "public" - AKA open public beta with production credentials recognised by HMRC
cap = 0
# cap (GLOBAL capacity limit)
# ===========================
# Maximum number of active (non-expired) allocations of this bundle across ALL users.
# When all cap slots are taken, the bundle shows "global user limit reached, please try
# again tomorrow" in the UI. As allocations expire (per timeout), slots return to the pool.
# Each user can hold at most one of each bundle type (hard-wired rule, not configurable).
# Renewal refreshes the existing allocation's expiry rather than creating a duplicate.
# The GET /api/v1/bundle response includes bundleCapacityAvailable: true/false for each
# catalog bundle so the UI can show availability without exposing exact take-up numbers.
# Implementation: Phase 2.9 in PLAN_PASSES_V2.md
timeout = "P1D"
# DONE: 1. Comment out for closed beta with production credentials validated by HMRC  <<<<---- WE ARE HERE 4th FEB 2026
#listedInEnvironments = ["local", "test", "proxy", "proxyRunning", "ci"]
# listedInEnvironments
# ====================
# Hidden in production until there are production credentials which have been validated by a trial user and checked by HMRC
tokensGranted = 3
# tokensGranted
# =============
# Number of HMRC API tokens allocated with this bundle
# The tokens are credited to the user and expire after the period matching the timeout
# Activities such as submitting VAT returns consume 1 token
# There is a user token activity counter shown in the UI
# Add to GET /api/v1/bundles/
#{
#  "bundles": [{
#    "createdAt": "2026-01-31T20:52:50.772Z",
#    "hashedSub": "a530dcdd1c77138dfd052736fc0790499abec9ae0ccbe63bcacb9cbc050471f7",
#    "ttl": 1772323200,
#    "expiry": "2026-02-01T00:00:00.000Z",
#    "ttl_datestamp": "2026-03-01T00:00:00.000Z",
#    "bundleId": "test"
#  }],
#  "tokensRemaining": 1
#}

# Access to free authenticated activities including VAT submission for specfic users with a pass for a longer time
[[bundles]]
id = "invited-guest"
name = "Invited Guest"
levelName = "Guest"
enable = "on-pass"
hidden = true
allocation = "on-email-match"
# on-email-match
# ==============
# Allocate this bundle only if the user's email address matches one of those listed in restrictedToEmailHash on the pass
timeout = "P1M"
tokensGranted = 3
tokenRefreshInterval = "P1M"
# tokenRefreshInterval
# ====================
# Interval after which tokens are replenished to the users account (ideally the same as the timeout otherwise they will stack or have gaps)
#
# To do (later) screens showing the user's token balance and activities driven by more advanced APIs
# GET /api/v1/tokens/ [ { "bundle": "day-guest", "tokens": 2, "expires": "2024-06-30T12:34:56Z" } ]
# GET /api/v1/activities/ [ { "activity": "submit-vat", "tokens": 1, "started": "2024-05-30T12:34:56Z", "completed": "2024-05-30T12:34:56Z", requestId: "abc-123-def-456" } ]

# Access to free authenticated activities including VAT submission for specfic users with a pass without time limit
[[bundles]]
id = "resident-guest"
name = "Resident Guest"
levelName = "Guest"
enable = "on-pass"
hidden = true
allocation = "on-email-match"
# on-email-match
# ==============
# Allocate this bundle only if the user's email address matches one of those listed in restrictedToEmailHash on the pass
tokensGranted = 3
tokenRefreshInterval = "P1M"

# Complimentary pro access for specific users via a pass (beta testers, partners)
[[bundles]]
id = "resident-pro-comp"
name = "Resident Pro (Complimentary)"
levelName = "Pro"
enable = "on-pass"
hidden = true
allocation = "on-email-match"
tokensGranted = 100
tokenRefreshInterval = "P1M"

# Access to all authenticated activities including VAT submission for specfic users on subscription
[[bundles]]
id = "resident-pro"
name = "Resident Pro"
levelName = "Pro"
enable = "on-pass"
hidden = false
# TODO: 3. Switch to allocation = "on-subscription" for "launch" - AKA public launch with production credentials recognised by HMRC and subscription management
allocation = "on-pass"
# allocation = "on-subscription"
# on-subscription
# =========================== ????? Is the subscription just a way to get the pass for 1 bundle issued to subscribed users?
# Allocate this bundle only if the user has an active subscription (subscription management not yet implemented)
tokensGranted = 100
tokenRefreshInterval = "P1M"
#listedInEnvironments = ["local", "test", "proxy", "proxyRunning", "ci"]
# listedInEnvironments
# ====================
# Hidden in production until there are production credentials which have been validated by a trial user and checked by HMRC

[[activities]]
id = "bundle"
name = "View and edit your bundles"
display = "never"
bundles = ["default"]
metered = false
# metered
# =======
# If false, this activity does not appear in the user's activity list and does not consume tokens
paths = ["bundles.html", "^/api/v1/catalog.*", "^/api/v1/bundle.*"]

[[activities]]
id = "submit-vat-sandbox"
name = "Submit VAT (HMRC Sandbox)"
display = "on-entitlement"
bundles = ["test"]
tokenCost = 1
# tokenCost
# =========
# Number of Activity API tokens consumed by this activity when completed
metered = true
# metered
# =======
# If true, this activity appears in the user's activity list and consumes tokens
# and the activity buttons show the token cost
# and if the token balance is insufficient (or zero) the activity is disabled similar to entitlement disabling
paths = ["hmrc/vat/submitVat.html?hmrcAccount=sandbox", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "vat-obligations-sandbox"
name = "VAT Obligations (HMRC Sandbox)"
display = "on-entitlement"
bundles = ["test"]
tokenCost = 0
metered = true
# metered
# =======
# In this case the cost is zero but the activity is metered so when there are 0 avilable tokens the activty is disabled
paths = ["hmrc/vat/vatObligations.html?hmrcAccount=sandbox", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "view-vat-return-sandbox"
name = "View VAT Return (HMRC Sandbox)"
display = "on-entitlement"
bundles = ["test"]
tokenCost = 0
metered = true
paths = ["hmrc/vat/viewVatReturn.html?hmrcAccount=sandbox", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "submit-vat"
name = "Submit VAT (HMRC)"
display = "always-with-upsell"
# display: always-with-upsell
# shows upsell prompt if not entitled
bundles = ["day-guest", "invited-guest", "resident-guest", "resident-pro-comp", "resident-pro"]
tokenCost = 1
metered = true
paths = ["hmrc/vat/submitVat.html", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "vat-obligations"
name = "VAT Obligations (HMRC)"
display = "always-with-upsell"
bundles = ["day-guest", "invited-guest", "resident-guest", "resident-pro-comp", "resident-pro"]
tokenCost = 0
metered = true
paths = ["hmrc/vat/vatObligations.html", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "view-vat-return"
name = "View VAT Return (HMRC)"
display = "always-with-upsell"
bundles = ["day-guest", "invited-guest", "resident-guest", "resident-pro-comp", "resident-pro"]
tokenCost = 0
metered = true
paths = ["hmrc/vat/viewVatReturn.html", "^/api/v1/hmrc/vat.*"]

[[activities]]
id = "my-receipts"
name = "View previously submitted receipts"
display = "on-entitlement"
bundles = ["default"]
metered = false
paths = ["hmrc/receipt/receipts.html", "^/api/v1/hmrc/receipt.*"]

[[activities]]
id = "generate-pass-digital"
name = "Generate Digital Pass"
display = "on-entitlement"
bundles = ["test", "resident-pro-comp", "resident-pro"]
tokenCost = 10
metered = true
# generate-pass-digital
# =====================
# Time-limited (7 days), unlimited capacity (100 uses).
# Encourages short digital campaigns (social media, email, messaging).
# See PLAN_GENERATE_PASS_ACTIVITY.md
paths = ["passes/generate-digital.html", "^/api/v1/pass/generate$"]

[[activities]]
id = "generate-pass-physical"
name = "Generate Physical Pass"
display = "on-entitlement"
bundles = ["test", "resident-pro-comp", "resident-pro"]
tokenCost = 10
metered = true
# generate-pass-physical
# ======================
# Usage-limited (10 uses), unlimited time.
# Encourages continued display on merchandise (t-shirts, mugs).
# See PLAN_GENERATE_PASS_ACTIVITY.md
paths = ["passes/generate-physical.html", "^/api/v1/pass/generate$"]

[[activities]]
id = "help"
name = "Learn about DIY Accounting Submit"
display = "always"
bundles = ["default"]
metered = false
paths = ["about.html"]

# Passes:
# Example invite pass record in DynamoDB:
# Do I need a pass admin screen?
#
# {
#    pk: 'invite#correct-horse-battery-staple',
#    code: 'correct-horse-battery-staple',
#
#    // Bundle granted by this invite
#    bundleId: 'invited-guest',
#
#    // Validity window (when the invite can be used)
#    validFrom: '2026-02-01T00:00:00Z',
#    validUntil: '2026-02-14T23:59:59Z',
#
#    // DynamoDB TTL (auto-delete 1 month after validity ends)
#    ttl: 1742169599,  // Unix timestamp: validUntil + 30 days
#
#    // Audit timestamps
#    createdAt: '2026-01-31T12:00:00Z',
#    updatedAt: '2026-01-31T12:00:00Z',
#
#    // Usage controls
#    maxUses: 5,
#    useCount: 0,
#    revokedAt: null,
#
#    // Optional: restrict to specific email (null = anyone)
#    restrictedToEmailHash: 'Ks7d9fJ2mNpQr...',  // or null
#
#    createdBy: 'user#abc123',
# }
