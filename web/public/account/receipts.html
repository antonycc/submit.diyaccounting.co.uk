<!-- receipts.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Receipts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
  </head>
  <body>

    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">â˜°</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="../account/receipts.html">Receipts</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Your submission receipts</p>
    </header>

    <div id="mainContent">
      <div class="form-container">
        <div id="unauthenticatedHint" style="display: none; margin-bottom: 1em; color: #b30000">
          Please log in to view your receipts.
        </div>
        <div id="receiptsControls" style="display: none; margin-bottom: 1em">
          <button class="btn" id="refreshBtn">Refresh</button>
          <button class="btn" id="exportCsvBtn" style="margin-left: 0.5em">Export CSV</button>
        </div>
        <div style="overflow-x: auto">
          <table id="receiptsTable" class="data-table" style="width: 100%; display: none">
            <thead>
              <tr>
                <th>Date</th>
                <th>Form bundle</th>
                <th>Size</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="emptyState" style="display: none; margin-top: 1em; color: #555">No receipts yet.</div>
      </div>

      <div id="viewerModal" class="modal" style="display: none">
        <div class="modal-content">
          <span class="close" id="closeModalBtn" style="float: right; cursor: pointer">&times;</span>
          <h3>Receipt JSON</h3>
          <pre id="receiptJson" style="white-space: pre-wrap"></pre>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer">
        </div>
      </div>
    </footer>

    <script src="../submit.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script type="module" src="../widgets/view-source-link.js"></script>
    <script src="../widgets/localstorage-viewer.js"></script>
    <script>
      function getIdToken() {
        return localStorage.getItem("cognitoIdToken");
      }

      async function fetchReceipts() {
        const idToken = getIdToken();
        const unauthHint = document.getElementById("unauthenticatedHint");
        const controls = document.getElementById("receiptsControls");
        const table = document.getElementById("receiptsTable");
        const tbody = table.querySelector("tbody");
        const empty = document.getElementById("emptyState");

        if (!idToken) {
          unauthHint.style.display = "block";
          controls.style.display = "none";
          table.style.display = "none";
          empty.style.display = "none";
          return;
        }

        unauthHint.style.display = "none";
        controls.style.display = "block";

        const res = await fetch("/api/my-receipts", {
          headers: { Authorization: `Bearer ${idToken}` },
        });
        if (!res.ok) {
          tbody.innerHTML = "";
          table.style.display = "none";
          empty.textContent = "Failed to load receipts";
          empty.style.display = "block";
          return;
        }
        const json = await res.json();
        const items = Array.isArray(json.receipts) ? json.receipts : [];
        tbody.innerHTML = "";
        if (items.length === 0) {
          table.style.display = "none";
          empty.textContent = "No receipts yet.";
          empty.style.display = "block";
        } else {
          empty.style.display = "none";
          table.style.display = "table";
          for (const it of items) {
            const tr = document.createElement("tr");
            const date = new Date(it.timestamp);
            const dateCell = document.createElement("td");
            dateCell.textContent = isNaN(date.getTime()) ? it.timestamp : date.toLocaleString("en-GB");
            const bundleCell = document.createElement("td");
            bundleCell.textContent = it.formBundleNumber || "";
            const sizeCell = document.createElement("td");
            sizeCell.textContent = typeof it.size === "number" ? `${it.size} bytes` : "";
            const actionsCell = document.createElement("td");

            const viewBtn = document.createElement("button");
            viewBtn.className = "btn";
            viewBtn.textContent = "View";
            viewBtn.onclick = () => viewReceipt(it.name);

            const dlBtn = document.createElement("button");
            dlBtn.className = "btn";
            dlBtn.style.marginLeft = "0.5em";
            dlBtn.textContent = "Download";
            dlBtn.onclick = () => downloadReceipt(it.name);

            actionsCell.appendChild(viewBtn);
            actionsCell.appendChild(dlBtn);

            tr.appendChild(dateCell);
            tr.appendChild(bundleCell);
            tr.appendChild(sizeCell);
            tr.appendChild(actionsCell);
            tbody.appendChild(tr);
          }
        }
      }

      async function viewReceipt(name) {
        const idToken = getIdToken();
        const res = await fetch(`/api/my-receipts/${encodeURIComponent(name)}`, {
          headers: { Authorization: `Bearer ${idToken}` },
        });
        if (!res.ok) return alert("Failed to fetch receipt");
        const text = await res.text();
        document.getElementById("receiptJson").textContent = prettyPrintJson(text);
        document.getElementById("viewerModal").style.display = "block";
      }

      function prettyPrintJson(text) {
        try {
          return JSON.stringify(JSON.parse(text), null, 2);
        } catch {
          return text;
        }
      }

      async function downloadReceipt(name) {
        const idToken = getIdToken();
        const res = await fetch(`/api/my-receipts/${encodeURIComponent(name)}`, {
          headers: { Authorization: `Bearer ${idToken}` },
        });
        if (!res.ok) return alert("Failed to download receipt");
        const blob = new Blob([await res.text()], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      function exportCsv(rows) {
        const header = ["Date", "Form bundle", "Size"];
        const lines = [header.join(",")];
        for (const r of rows) lines.push(r.join(","));
        const blob = new Blob([lines.join("\n")], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "receipts.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      document.getElementById("refreshBtn").addEventListener("click", fetchReceipts);
      document.getElementById("exportCsvBtn").addEventListener("click", async () => {
        const idToken = getIdToken();
        const res = await fetch("/api/my-receipts", { headers: { Authorization: `Bearer ${idToken}` } });
        if (!res.ok) return alert("Failed to export CSV");
        const json = await res.json();
        const items = Array.isArray(json.receipts) ? json.receipts : [];
        const rows = items.map((it) => [it.timestamp, it.formBundleNumber || "", it.size || ""]);
        exportCsv(rows);
      });

      document.getElementById("closeModalBtn").addEventListener("click", () => {
        document.getElementById("viewerModal").style.display = "none";
      });

      // Close modal when clicking on modal background
      window.addEventListener("click", function (event) {
        if (event.target.id === "viewerModal") {
          document.getElementById("viewerModal").style.display = "none";
        }
      });

      // Initialize page
      checkAuthStatus();
      fetchReceipts();
    </script>
  </body>
</html>
