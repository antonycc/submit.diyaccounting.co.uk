<!-- account/bundles.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Bundles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">☰</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="../account/bundles.html">Bundles</a>
            <a href="../account/bundles2.html">Bundles (v2)</a>
            <a href="../account/receipts.html">Receipts</a>
            <a href="../docs/index.html">API Docs</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div id="statusMessagesContainer"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <div class="form-container" style="text-align: center">
        <h2>Bundles</h2>

        <div class="bundles-list" id="catalogBundles"></div>

        <div style="margin-top: 3em; padding-top: 2em; border-top: 1px solid #ddd">
          <h3>Your Current Bundles</h3>
          <div id="currentBundles" style="margin: 1em 0"></div>
        </div>

        <div style="margin-top: 2em">
          <button
            type="button"
            class="btn"
            onclick="window.location.href='../index.html'"
            style="background-color: #6c757d; border-color: #6c757d"
          >
            Back to Home
          </button>
        </div>

        <div style="margin-top: 3em; padding-top: 1em; border-top: 1px solid #eee">
          <button
            type="button"
            class="btn"
            id="removeAllBtn"
            style="background-color: #dc3545; border-color: #dc3545; color: white; font-size: 0.9em"
          >
            Remove All Bundles
          </button>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
          <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/html-report/index.html">tests</a>
          <a
            id="apiDocsLink"
            style="display: inline"
            target="_blank"
            href="../docs/index.html"
          >
            api
          </a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script src="../submit.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script src="../widgets/status-messages.js"></script>
    <script src="../widgets/loading-spinner.js"></script>
    <script type="module" src="../widgets/view-source-link.js"></script>
    <script src="../widgets/localstorage-viewer.js"></script>

    <script>
      // --- helpers
      const getIdToken = () => localStorage.getItem("cognitoIdToken");

      const parseUserBundles = () => {
        try {
          const raw = localStorage.getItem("userBundles");
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      };

      const hasBundle = (bundles, id) => (bundles || []).some((b) => typeof b === "string" && (b === id || b.startsWith(id + "|")));

      const markToRequest = (btn, message = "Request bundle") => {
        btn.textContent = message;
        btn.disabled = false;
        btn.style.backgroundColor = "#2c5aa0";
      };

      const markGranted = (btn, message = "Added ✓") => {
        btn.textContent = message;
        btn.disabled = true;
        btn.style.backgroundColor = "#28a745";
      };

      // --- render one catalog card
      const cardHtml = (b) => {
        return `
          <div class="service-item" style="text-align:left">
            <button type="button" class="btn service-btn" data-bundle-id="${b.id}">Request ${b.id}</button>
          </div>`;
      };

      // --- click handler for all request buttons
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-bundle-id]");
        if (!btn) return;

        const idToken = getIdToken();
        if (!idToken) {
          showStatus("Please log in first to request bundles.", "warning");
          window.location.href = "../auth/login.html";
          return;
        }

        const bundleId = btn.getAttribute("data-bundle-id");
        const card = btn.closest(".service-item");
        const original = btn.textContent;

        const qualifiers = {};
        const tx = card?.querySelector('input[name="transactionId"]');
        if (tx?.value) qualifiers.transactionId = tx.value;
        const tier = card?.querySelector('input[name="subscriptionTier"]');
        if (tier?.value) qualifiers.subscriptionTier = tier.value;

        btn.textContent = "Requesting...";
        btn.disabled = true;

        try {
          const r = await fetch("/api/bundle-post", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${idToken}` },
            body: JSON.stringify({ bundleId, qualifiers }),
          });
          const body = await r.json().catch(() => ({}));

          if (r.ok) {
            if (Array.isArray(body.bundles)) localStorage.setItem("userBundles", JSON.stringify(body.bundles));
            if (body.status === "granted" || body.status === "already_granted") {
              markGranted(btn, "Added ✓");
              showStatus(`Bundle "${bundleId}" added successfully.`, "success");
            } else {
              btn.textContent = original;
              btn.disabled = false;
              showStatus(`Bundle ${bundleId} request failed: unexpected response`, "error");
            }
            // Refresh bundles lists
            try {
              renderCurrentBundles();
            } catch {}
            try {
              updateBundleStatus();
            } catch {}
          } else {
            btn.textContent = original;
            btn.disabled = false;
            showStatus(`Failed to request bundle: ${body.error || "Unknown error"}`, "error");
          }
        } catch (err) {
          btn.textContent = original;
          btn.disabled = false;
          showStatus(`Failed to request bundle. Error: ${err?.message || err}.`, "error");
        }
      });

      // --- reflect previously granted
      function updateBundleStatus() {
        const bundles = parseUserBundles();
        document.querySelectorAll("button[data-bundle-id]").forEach((btn) => {
          const id = btn.getAttribute("data-bundle-id");
          if (hasBundle(bundles, id)) {
            markGranted(btn);
          } else {
            markToRequest(btn, `Request ${id}`);
          }
        });
      }

      // --- bootstrap: fetch catalog and render
      (async function () {
        const container = document.getElementById("catalogBundles");
        try {
          const idToken = getIdToken();
          const headers = idToken ? { Authorization: `Bearer ${idToken}` } : {};
          const res = await fetch("/api/v1/catalog", { headers });
          if (!res.ok) {
            container.innerHTML = '<p class="service-description">Catalog unavailable.</p>';
            return;
          }
          const catalog = await res.json();
          const cards = (catalog.bundles || [])
            .filter((b) => b["allocation"] && b["allocation"] !== "automatic")
            .map(cardHtml)
            .join("\n");
          container.innerHTML = cards || '<p class="service-description">No bundles available.</p>';
          updateBundleStatus();
        } catch {
          container.innerHTML = '<p class="service-description">Failed to load catalog.</p>';
        }
      })();

      // --- render current user bundles with remove buttons
      function renderCurrentBundles() {
        const container = document.getElementById("currentBundles");
        const bundles = parseUserBundles();

        if (bundles.length === 0) {
          container.innerHTML = '<p style="color: #666; font-style: italic;">No bundles added yet.</p>';
          return;
        }

        const bundleCards = bundles
          .map((bundleEntry) => {
            const bundleId = bundleEntry.split("|")[0]; // Remove expiry info if present
            const hasExpiry = bundleEntry.includes("EXPIRY=");
            const expiryInfo = hasExpiry ? bundleEntry.split("EXPIRY=")[1] : "";

            return `
            <div class="service-item" style="text-align:left; margin-bottom: 1em; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 1em;">
              <span style="display:flex; align-items:center; gap:0.75em">
                <span>${bundleId}</span>
                <button type="button" class="btn" data-remove-bundle-id="${bundleId}"
                  style="background-color: #dc3545; border-color: #dc3545; color: white; font-size: 0.8em; padding: 0.15em 0.5em; min-width: unset; width:auto; display:inline-flex; align-items:center;">
                    Remove
                </button>
                ${expiryInfo ? `<span>(expires: ${expiryInfo})</span>` : ""}
              </span>
            </div>`;
          })
          .join("");

        container.innerHTML = bundleCards;
      }

      // --- click handler for remove buttons
      document.addEventListener("click", async (e) => {
        if (e.target.closest("button[data-remove-bundle-id]")) {
          const btn = e.target.closest("button[data-remove-bundle-id]");
          const bundleId = btn.getAttribute("data-remove-bundle-id");
          await removeBundle(bundleId);
        } else if (e.target.id === "removeAllBtn") {
          await removeAllBundles();
        }
      });

      // --- remove individual bundle
      async function removeBundle(bundleId) {
        const idToken = getIdToken();
        if (!idToken) {
          showStatus("Please log in first to remove bundles.", "warning");
          window.location.href = "../auth/login.html";
          return;
        }

        try {
          const response = await fetch("/api/bundle-delete", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`,
            },
            body: JSON.stringify({ bundleId }),
          });

          const result = await response.json().catch(() => ({}));

          if (response.ok) {
            if (Array.isArray(result.bundles)) {
              localStorage.setItem("userBundles", JSON.stringify(result.bundles));
            }
            renderCurrentBundles();
            updateBundleStatus(); // Update the request buttons
            showStatus(`Bundle "${bundleId}" removed successfully.`, "success");
          } else {
            showStatus(`Failed to remove bundle: ${result.error || "Unknown error"}`, "error");
          }
        } catch (error) {
          showStatus("Failed to remove bundle. Please try again.", "error");
          console.error("Remove bundle error:", error);
        }
      }

      // --- remove all bundles
      async function removeAllBundles() {
        const idToken = getIdToken();
        if (!idToken) {
          showStatus("Please log in first to remove bundles.", "warning");
          window.location.href = "../auth/login.html";
          return;
        }

        try {
          const response = await fetch("/api/bundle-delete", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`,
            },
            body: JSON.stringify({ removeAll: true }),
          });

          const result = await response.json().catch(() => ({}));

          if (response.ok) {
            localStorage.setItem("userBundles", JSON.stringify([]));
            renderCurrentBundles();
            updateBundleStatus(); // Update the request buttons
            showStatus("All bundles removed successfully.", "success");
          } else {
            showStatus(`Failed to remove all bundles: ${result.error || "Unknown error"}`, "error");
          }
        } catch (error) {
          showStatus("Failed to remove all bundles. Please try again.", "error");
          console.error("Remove all bundles error:", error);
        }
      }

      // --- initialize current bundles display
      setTimeout(() => {
        renderCurrentBundles();
      }, 100);

      // --- page init
      localStorage.removeItem("currentActivity");
      checkAuthStatus();
    </script>
  </body>
</html>
