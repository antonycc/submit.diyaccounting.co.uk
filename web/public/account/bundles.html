<!-- auth/bundles.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Add Bundle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../submit.css" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">☰</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../index.html">Home</a>
            <a href="../account/bundles.html">Bundles</a>
            <a href="../account/receipts.html">Receipts</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div class="form-container" style="text-align: center">
        <h2>Add Bundle</h2>
        <p>Rendered from product catalog</p>
        <div class="bundles-list" id="catalogBundles"></div>

        <div style="margin-top: 3em; padding-top: 2em; border-top: 1px solid #ddd">
          <h3>Your Current Bundles</h3>
          <div id="currentBundles" style="margin: 1em 0"></div>
        </div>

        <div style="margin-top: 2em">
          <button
            type="button"
            class="btn"
            onclick="window.location.href='../index.html'"
            style="background-color: #6c757d; border-color: #6c757d"
          >
            Back to Home
          </button>
        </div>

        <div style="margin-top: 3em; padding-top: 1em; border-top: 1px solid #eee">
          <button
            type="button"
            class="btn"
            id="removeAllBtn"
            style="background-color: #dc3545; border-color: #dc3545; color: white; font-size: 0.9em"
          >
            Remove All Bundles
          </button>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script src="../submit.js"></script>
    <script src="../widgets/hamburger-menu.js"></script>
    <script src="../widgets/auth-status.js"></script>
    <script type="module" src="../widgets/view-source-link.js"></script>
    <script src="../widgets/localstorage-viewer.js"></script>

    <script>
      // --- helpers
      const getIdToken = () => localStorage.getItem("cognitoIdToken");

      const parseUserBundles = () => {
        try {
          const raw = localStorage.getItem("userBundles");
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      };

      const hasBundle = (bundles, id) =>
        (bundles || []).some((b) => typeof b === "string" && (b === id || b.startsWith(id + "|")));

      const markGranted = (btn, message = "Already Added ✓") => {
        btn.textContent = message;
        btn.disabled = true;
        btn.style.backgroundColor = "#28a745";
        const status = btn.closest(".service-item")?.querySelector(".status");
        if (status) {
          status.textContent = "Active";
          status.style.color = "#2c7a7b";
        }
      };

      // --- render one catalog card
      const cardHtml = (b) => {
        const q = b.qualifiers || {};
        const info = [
          `allocation: ${b.allocation}`,
          b.auth ? `auth: ${b.auth}` : "",
          b.cap != null ? `cap: ${b.cap}` : "",
          b.timeout ? `timeout: ${b.timeout}` : "",
        ]
          .filter(Boolean)
          .join(" • ");

        const qFields = [];
        if (q.requiresTransactionId) qFields.push('<label>Transaction ID <input name="transactionId" /></label>');
        if (Object.prototype.hasOwnProperty.call(q, "subscriptionTier")) {
          qFields.push(
            `<label>Subscription Tier <input name="subscriptionTier" value="${q.subscriptionTier}" /></label>`,
          );
        }

        return `
          <div class="service-item" style="text-align:left">
            <h3>${b.name || b.id}</h3>
            <p class="service-description">${info}</p>
            ${qFields.length ? `<div class="qualifiers" style="display:flex; gap:.5em; flex-wrap:wrap">${qFields.join(" ")}</div>` : ""}
            <button type="button" class="btn service-btn" data-bundle-id="${b.id}">Request ${b.id}</button>
            <div class="status" style="font-size:.9em; color:#666; margin-top:.25em"></div>
          </div>`;
      };

      // --- click handler for all request buttons
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-bundle-id]");
        if (!btn) return;

        const idToken = getIdToken();
        if (!idToken) {
          alert("Please log in first to request bundles.");
          window.location.href = "../auth/login.html";
          return;
        }

        const bundleId = btn.getAttribute("data-bundle-id");
        const card = btn.closest(".service-item");
        const statusEl = card?.querySelector(".status");
        const original = btn.textContent;

        const qualifiers = {};
        const tx = card?.querySelector('input[name="transactionId"]');
        if (tx?.value) qualifiers.transactionId = tx.value;
        const tier = card?.querySelector('input[name="subscriptionTier"]');
        if (tier?.value) qualifiers.subscriptionTier = tier.value;

        btn.textContent = "Requesting...";
        btn.disabled = true;

        try {
          const r = await fetch("/api/request-bundle", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${idToken}` },
            body: JSON.stringify({ bundleId, qualifiers }),
          });
          const body = await r.json().catch(() => ({}));

          if (r.ok) {
            if (Array.isArray(body.bundles)) localStorage.setItem("userBundles", JSON.stringify(body.bundles));
            if (body.status === "granted" || body.status === "already_granted") {
              markGranted(btn, body.status === "granted" ? "Bundle Added ✓" : "Already Added ✓");
              if (statusEl) {
                statusEl.textContent = `Granted ${body.expiry ? `(expires ${body.expiry})` : ""}`;
                statusEl.style.color = "#2c7a7b";
              }
              // Refresh bundles lists (added and to be deleted)
              try { renderCurrentBundles(); } catch {}
              try { updateBundleStatus(); } catch {}
            } else {
              btn.textContent = original;
              btn.disabled = false;
              if (statusEl) {
                statusEl.textContent = "Unknown response";
                statusEl.style.color = "#b00020";
              }
            }
          } else {
            btn.textContent = original;
            btn.disabled = false;
            if (statusEl) {
              statusEl.textContent = `Error: ${body.error || r.status}`;
              statusEl.style.color = "#b00020";
            }
            alert(`Failed to request bundle: ${body.error || "Unknown error"}`);
          }
        } catch (err) {
          btn.textContent = original;
          btn.disabled = false;
          if (statusEl) {
            statusEl.textContent = `Error: ${err?.message || err}`;
            statusEl.style.color = "#b00020";
          }
          alert("Failed to request bundle. Please try again.");
        }
      });

      // --- reflect previously granted
      function updateBundleStatus() {
        const bundles = parseUserBundles();
        document.querySelectorAll("button[data-bundle-id]").forEach((btn) => {
          const id = btn.getAttribute("data-bundle-id");
          if (hasBundle(bundles, id)) markGranted(btn);
        });
      }

      // --- bootstrap: fetch catalog and render
      (async function () {
        const container = document.getElementById("catalogBundles");
        try {
          const idToken = getIdToken();
          const headers = idToken ? { Authorization: `Bearer ${idToken}` } : {};
          const res = await fetch("/api/catalog", { headers });
          if (!res.ok) {
            container.innerHTML = '<p class="service-description">Catalog unavailable.</p>';
            return;
          }
          const catalog = await res.json();
          const cards = (catalog.bundles || [])
            .filter((b) => b["allocation"] && b["allocation"] !== "automatic")
            .map(cardHtml)
            .join("\n");
          container.innerHTML = cards || '<p class="service-description">No bundles available.</p>';
          updateBundleStatus();
        } catch {
          container.innerHTML = '<p class="service-description">Failed to load catalog.</p>';
        }
      })();

      // --- render current user bundles with remove buttons
      function renderCurrentBundles() {
        const container = document.getElementById("currentBundles");
        const bundles = parseUserBundles();

        if (bundles.length === 0) {
          container.innerHTML = '<p style="color: #666; font-style: italic;">No bundles added yet.</p>';
          return;
        }

        const bundleCards = bundles
          .map((bundleEntry) => {
            const bundleId = bundleEntry.split("|")[0]; // Remove expiry info if present
            const hasExpiry = bundleEntry.includes("EXPIRY=");
            const expiryInfo = hasExpiry ? bundleEntry.split("EXPIRY=")[1] : "";

            return `
            <div class="service-item" style="text-align:left; margin-bottom: 1em; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 1em;">
              <h4 style="margin: 0 0 0.5em 0;">${bundleId}</h4>
              ${expiryInfo ? `<p style="font-size: 0.9em; color: #666; margin: 0 0 0.5em 0;">Expires: ${expiryInfo}</p>` : ""}
              <button type="button" class="btn" data-remove-bundle-id="${bundleId}"
                      style="background-color: #dc3545; border-color: #dc3545; color: white; font-size: 0.8em; padding: 0.3em 0.8em;">
                Remove
              </button>
            </div>`;
          })
          .join("");

        container.innerHTML = bundleCards;
      }

      // --- click handler for remove buttons
      document.addEventListener("click", async (e) => {
        if (e.target.closest("button[data-remove-bundle-id]")) {
          const btn = e.target.closest("button[data-remove-bundle-id]");
          const bundleId = btn.getAttribute("data-remove-bundle-id");
          await removeBundle(bundleId);
        } else if (e.target.id === "removeAllBtn") {
          await removeAllBundles();
        }
      });

      // --- remove individual bundle
      async function removeBundle(bundleId) {
        const idToken = getIdToken();
        if (!idToken) {
          alert("Please log in first to remove bundles.");
          window.location.href = "../auth/login.html";
          return;
        }

        if (!confirm(`Are you sure you want to remove the "${bundleId}" bundle?`)) {
          return;
        }

        try {
          const response = await fetch("/api/request-bundle", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`,
            },
            body: JSON.stringify({ bundleId }),
          });

          const result = await response.json().catch(() => ({}));

          if (response.ok) {
            if (Array.isArray(result.bundles)) {
              localStorage.setItem("userBundles", JSON.stringify(result.bundles));
            }
            renderCurrentBundles();
            updateBundleStatus(); // Update the request buttons
            alert(`Bundle "${bundleId}" removed successfully.`);
          } else {
            alert(`Failed to remove bundle: ${result.error || "Unknown error"}`);
          }
        } catch (error) {
          alert("Failed to remove bundle. Please try again.");
          console.error("Remove bundle error:", error);
        }
      }

      // --- remove all bundles
      async function removeAllBundles() {
        const idToken = getIdToken();
        if (!idToken) {
          alert("Please log in first to remove bundles.");
          window.location.href = "../auth/login.html";
          return;
        }

        if (!confirm("Are you sure you want to remove ALL bundles? This action cannot be undone.")) {
          return;
        }

        try {
          const response = await fetch("/api/request-bundle", {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`,
            },
            body: JSON.stringify({ removeAll: true }),
          });

          const result = await response.json().catch(() => ({}));

          if (response.ok) {
            localStorage.setItem("userBundles", JSON.stringify([]));
            renderCurrentBundles();
            updateBundleStatus(); // Update the request buttons
            alert("All bundles removed successfully.");
          } else {
            alert(`Failed to remove all bundles: ${result.error || "Unknown error"}`);
          }
        } catch (error) {
          alert("Failed to remove all bundles. Please try again.");
          console.error("Remove all bundles error:", error);
        }
      }

      // --- initialize current bundles display
      setTimeout(() => {
        renderCurrentBundles();
      }, 100);

      // --- page init
      localStorage.removeItem("currentActivity");
      checkAuthStatus();
    </script>
  </body>
</html>
