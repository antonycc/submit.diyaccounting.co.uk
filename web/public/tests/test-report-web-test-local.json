{
  "testName": "web-test-local",
  "generatedAt": "2026-01-07T23:25:55.754Z",
  "testContext": {
    "testId": "web-test-local",
    "name": "Verify fraud prevention headers for VAT return submission",
    "title": "Fraud Prevention Headers Validation (HMRC: VAT Return POST)",
    "description": "Submits a VAT return to HMRC MTD VAT API and validates fraud prevention headers compliance.",
    "hmrcApis": [
      {
        "url": "/api/v1/hmrc/vat/return",
        "method": "POST"
      },
      {
        "url": "/test/fraud-prevention-headers/validate",
        "method": "GET"
      },
      {
        "url": "/test/fraud-prevention-headers/vat-mtd/validation-feedback",
        "method": "GET"
      }
    ],
    "env": {
      "envName": "proxy",
      "baseUrl": "https://wanted-finally-anteater.ngrok-free.app/",
      "serverPort": "3000",
      "runTestServer": "run",
      "runProxy": "run",
      "runMockOAuth2": "run",
      "testAuthProvider": "mock",
      "testAuthUsername": "user",
      "bundleTableName": "test-bundle-table",
      "hmrcApiRequestsTableName": "test-hmrc-api-requests-table",
      "receiptsTableName": "test-receipts-table",
      "runDynamoDb": "run"
    },
    "testData": {
      "hmrcTestUsername": "441080096176",
      "hmrcTestPassword": "***MASKED***",
      "hmrcTestVatNumber": "299294688",
      "hmrcVatPeriodKey": "25U6",
      "hmrcVatDueAmount": "1000.00",
      "testUserGenerated": true,
      "userSub": "user",
      "observedTraceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
      "testUrl": "https://wanted-finally-anteater.ngrok-free.app/",
      "isSandboxMode": true,
      "intentionallyNotSuppliedHeaders": [
        "gov-client-multi-factor",
        "gov-vendor-license-ids",
        "gov-client-public-port"
      ]
    },
    "validationFeedback": {
      "ok": true,
      "status": 200,
      "feedback": {
        "requests": [
          {
            "path": "/organisations/vat/144948637/obligations",
            "method": "GET",
            "requestTimestamp": "2026-01-07T22:50:09.470Z",
            "code": "INVALID_HEADERS",
            "headers": [
              {
                "header": "gov-client-browser-js-user-agent",
                "value": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-connection-method",
                "value": "WEB_APP_VIA_SERVER",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-device-id",
                "value": "f29bc93d-98fd-40e9-974e-ce3ebba0a595",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-multi-factor",
                "code": "MISSING_HEADER",
                "errors": [],
                "warnings": [
                  "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header."
                ]
              },
              {
                "header": "gov-client-public-ip",
                "value": "40.76.117.242",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-public-ip-timestamp",
                "value": "2026-01-07T22:50:05.598Z",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-public-port",
                "code": "MISSING_HEADER",
                "errors": [
                  "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header."
                ],
                "warnings": []
              },
              {
                "header": "gov-client-screens",
                "value": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-timezone",
                "value": "UTC+00:00",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-user-ids",
                "value": "server=anonymous",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-window-size",
                "value": "width=1280&height=1446",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-forwarded",
                "value": "by=40.76.117.242&for=40.76.117.242,by=40.76.117.242&for=3.172.32.174",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-license-ids",
                "code": "MISSING_HEADER",
                "errors": [],
                "warnings": [
                  "Header required"
                ]
              },
              {
                "header": "gov-vendor-product-name",
                "value": "web-submit-diyaccounting-co-uk",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-public-ip",
                "value": "40.76.117.242",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-version",
                "value": "web-submit-diyaccounting-co-uk=0.0.2-4",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              }
            ],
            "crossValidation": [
              {
                "headers": [
                  "gov-vendor-forwarded",
                  "gov-vendor-public-ip",
                  "gov-client-public-ip"
                ],
                "code": "VALID_HEADERS",
                "errors": []
              }
            ]
          },
          {
            "path": "/organisations/vat/539491020/returns",
            "method": "POST",
            "requestTimestamp": "2026-01-07T23:22:53.471Z",
            "code": "INVALID_HEADERS",
            "headers": [
              {
                "header": "gov-client-browser-js-user-agent",
                "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-connection-method",
                "value": "WEB_APP_VIA_SERVER",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-device-id",
                "value": "3908d470-27f5-4945-b665-19e8809c956f",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-multi-factor",
                "code": "MISSING_HEADER",
                "errors": [],
                "warnings": [
                  "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header."
                ]
              },
              {
                "header": "gov-client-public-ip",
                "value": "88.97.27.180",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-public-ip-timestamp",
                "value": "2026-01-07T23:22:53.257Z",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-public-port",
                "code": "MISSING_HEADER",
                "errors": [
                  "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header."
                ],
                "warnings": []
              },
              {
                "header": "gov-client-screens",
                "value": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-timezone",
                "value": "UTC+00:00",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-user-ids",
                "value": "server=anonymous",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-window-size",
                "value": "width=1280&height=1446",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-forwarded",
                "value": "by=88.97.27.180&for=88.97.27.180",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-license-ids",
                "code": "MISSING_HEADER",
                "errors": [],
                "warnings": [
                  "Header required"
                ]
              },
              {
                "header": "gov-vendor-product-name",
                "value": "web-submit-diyaccounting-co-uk",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-public-ip",
                "value": "88.97.27.180",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-version",
                "value": "web-submit-diyaccounting-co-uk=0.0.2-4",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              }
            ],
            "crossValidation": [
              {
                "headers": [
                  "gov-vendor-forwarded",
                  "gov-vendor-public-ip",
                  "gov-client-public-ip"
                ],
                "code": "VALID_HEADERS",
                "errors": []
              }
            ]
          },
          {
            "path": "/organisations/vat/144948637/returns/24Y9",
            "method": "GET",
            "requestTimestamp": "2026-01-07T22:49:57.713Z",
            "code": "INVALID_HEADERS",
            "headers": [
              {
                "header": "gov-client-browser-js-user-agent",
                "value": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-connection-method",
                "value": "WEB_APP_VIA_SERVER",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-device-id",
                "value": "96fc826c-dbb9-4375-a045-352c4e1c9152",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-multi-factor",
                "code": "MISSING_HEADER",
                "errors": [],
                "warnings": [
                  "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header."
                ]
              },
              {
                "header": "gov-client-public-ip",
                "value": "40.76.117.242",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-public-ip-timestamp",
                "value": "2026-01-07T22:49:53.082Z",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-public-port",
                "code": "MISSING_HEADER",
                "errors": [
                  "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header."
                ],
                "warnings": []
              },
              {
                "header": "gov-client-screens",
                "value": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-timezone",
                "value": "UTC+00:00",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-user-ids",
                "value": "server=anonymous",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-client-window-size",
                "value": "width=1280&height=1446",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-forwarded",
                "value": "by=40.76.117.242&for=40.76.117.242,by=40.76.117.242&for=3.172.32.176",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-license-ids",
                "code": "MISSING_HEADER",
                "errors": [],
                "warnings": [
                  "Header required"
                ]
              },
              {
                "header": "gov-vendor-product-name",
                "value": "web-submit-diyaccounting-co-uk",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-public-ip",
                "value": "40.76.117.242",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              },
              {
                "header": "gov-vendor-version",
                "value": "web-submit-diyaccounting-co-uk=0.0.2-4",
                "code": "VALID_HEADER",
                "errors": [],
                "warnings": []
              }
            ],
            "crossValidation": [
              {
                "headers": [
                  "gov-vendor-forwarded",
                  "gov-vendor-public-ip",
                  "gov-client-public-ip"
                ],
                "code": "VALID_HEADERS",
                "errors": []
              }
            ]
          }
        ]
      }
    },
    "artefactsDir": "/Users/antony/projects/submit.diyaccounting.co.uk/target/behaviour-test-results/postVatReturnFraudPreventi-0a863-s-for-VAT-return-submission-web-test-local",
    "screenshotPath": "target/behaviour-test-results/screenshots/fraudPreventionHeadersVat-behaviour-test",
    "testStartTime": "2026-01-07T23:25:53.285Z"
  },
  "hmrcApiRequests": [
    {
      "hashedSub": "5f202fdb051350c5da3294b66ca72ea2fe0b92e841a7b04d378300a848a3dfb0",
      "id": "hmrcreq-6d984ecc-ade5-4fa3-98a5-90f3e979bc07",
      "requestId": "dc1e574f-4e62-4b98-bd64-06f3d17118cb",
      "amznTraceId": null,
      "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
      "url": "https://test-api.service.hmrc.gov.uk/oauth/token",
      "method": "POST",
      "httpRequest": {
        "method": "POST",
        "headers": {
          "Content-Type": "application/x-www-form-urlencoded",
          "x-request-id": "dc1e574f-4e62-4b98-bd64-06f3d17118cb",
          "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
          "x-correlationid": "dc1e574f-4e62-4b98-bd64-06f3d17118cb"
        },
        "body": "grant_type=authorization_code&client_id=uqMHA6RsDGGa7h8EG2VqfqAmv4tV&client_secret=049b662f-61ea-4113-b38d-a9c8b1bb9f13&redirect_uri=https%3A%2F%2Fwanted-finally-anteater.ngrok-free.app%2Factivities%2FsubmitVatCallback.html&code=6cd5ad5c74194c2ead7487789211b1b1"
      },
      "httpResponse": {
        "statusCode": 200,
        "headers": {
          "cache-control": "no-cache,no-store,max-age=0",
          "connection": "keep-alive",
          "content-length": "172",
          "content-security-policy": "default-src 'self'",
          "content-type": "application/json",
          "date": "Wed, 07 Jan 2026 23:25:48 GMT",
          "strict-transport-security": "max-age=31536000;",
          "via": "1.1 4f2c05fa30365fcac05ad27ee136cce2.cloudfront.net (CloudFront)",
          "x-amz-cf-id": "A3HzC9GjeecvTSDX5l139jL_Xk80F0mM3pZrsi4fmtcNsvirivkXlg==",
          "x-amz-cf-pop": "LHR50-P6",
          "x-cache": "Miss from cloudfront",
          "x-content-type-options": "nosniff",
          "x-envoy-upstream-service-time": "65",
          "x-frame-options": "SAMEORIGIN"
        },
        "body": {
          "access_token": "51fe4c873b08e36dd60497638fb229c3",
          "refresh_token": "0604b580d050b9975454747ab904cddb",
          "expires_in": 14400,
          "scope": "write:vat read:vat",
          "token_type": "bearer"
        }
      },
      "duration": 211,
      "createdAt": "2026-01-07T23:25:48.010Z",
      "ttl": 1770506748,
      "ttl_datestamp": "2026-02-07T23:25:48.010Z"
    },
    {
      "hashedSub": "5f202fdb051350c5da3294b66ca72ea2fe0b92e841a7b04d378300a848a3dfb0",
      "id": "hmrcreq-9c1783ba-fc05-431e-9d89-2db83e618e8a",
      "requestId": "62e0f2fb-6eb6-402b-827f-f5b214f44899",
      "amznTraceId": null,
      "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
      "url": "https://test-api.service.hmrc.gov.uk/test/fraud-prevention-headers/validate",
      "method": "GET",
      "httpRequest": {
        "method": "GET",
        "headers": {
          "Accept": "application/vnd.hmrc.1.0+json",
          "Authorization": "Bearer 51fe4c873b08e36dd60497638fb229c3",
          "Gov-Client-Public-IP": "88.97.27.180",
          "Gov-Client-Device-ID": "634e4eda-5bed-47f1-a333-0238b67f2283",
          "Gov-Client-User-IDs": "server=anonymous",
          "Gov-Client-Connection-Method": "WEB_APP_VIA_SERVER",
          "Gov-Vendor-Public-IP": "88.97.27.180",
          "Gov-Vendor-Forwarded": "by=88.97.27.180&for=88.97.27.180",
          "Gov-Vendor-Product-Name": "web-submit-diyaccounting-co-uk",
          "Gov-Vendor-Version": "web-submit-diyaccounting-co-uk=0.0.2-4",
          "Gov-Client-Browser-JS-User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
          "Gov-Client-Public-IP-Timestamp": "2026-01-07T23:25:48.237Z",
          "Gov-Client-Screens": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
          "Gov-Client-Timezone": "UTC+00:00",
          "Gov-Client-Window-Size": "width=1280&height=1446",
          "x-request-id": "62e0f2fb-6eb6-402b-827f-f5b214f44899",
          "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
          "x-correlationid": "62e0f2fb-6eb6-402b-827f-f5b214f44899"
        }
      },
      "httpResponse": {
        "statusCode": 200,
        "headers": {
          "cache-control": "no-cache,no-store,max-age=0",
          "connection": "keep-alive",
          "content-length": "757",
          "content-security-policy": "default-src 'self'",
          "content-type": "application/json",
          "date": "Wed, 07 Jan 2026 23:25:48 GMT",
          "strict-transport-security": "max-age=31536000;",
          "vary": "Origin",
          "via": "1.1 4f2c05fa30365fcac05ad27ee136cce2.cloudfront.net (CloudFront)",
          "x-amz-cf-id": "HQQNdZ7j__nY-nAF5zSGLX3P25O81WgnU4Xmirbboj8U6VPt9Anq8w==",
          "x-amz-cf-pop": "LHR50-P6",
          "x-cache": "Miss from cloudfront",
          "x-content-type-options": "nosniff",
          "x-envoy-upstream-service-time": "31",
          "x-frame-options": "SAMEORIGIN"
        },
        "body": {
          "specVersion": "3.3",
          "code": "INVALID_HEADERS",
          "message": "At least 1 header is invalid",
          "errors": [
            {
              "code": "MISSING_HEADER",
              "message": "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header.",
              "headers": [
                "gov-client-public-port"
              ]
            }
          ],
          "warnings": [
            {
              "code": "MISSING_HEADER",
              "message": "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header.",
              "headers": [
                "gov-client-multi-factor"
              ]
            },
            {
              "code": "MISSING_HEADER",
              "message": "Header required",
              "headers": [
                "gov-vendor-license-ids"
              ]
            }
          ]
        }
      },
      "duration": 136,
      "createdAt": "2026-01-07T23:25:48.410Z",
      "ttl": 1770506748,
      "ttl_datestamp": "2026-02-07T23:25:48.410Z"
    },
    {
      "hashedSub": "5f202fdb051350c5da3294b66ca72ea2fe0b92e841a7b04d378300a848a3dfb0",
      "id": "hmrcreq-b97f1467-9b67-4962-b0ee-35ffa00c3e77",
      "requestId": "62e0f2fb-6eb6-402b-827f-f5b214f44899",
      "amznTraceId": null,
      "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
      "url": "https://test-api.service.hmrc.gov.uk/organisations/vat/299294688/returns",
      "method": "POST",
      "httpRequest": {
        "method": "POST",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/vnd.hmrc.1.0+json",
          "Authorization": "Bearer 51fe4c873b08e36dd60497638fb229c3",
          "x-request-id": "62e0f2fb-6eb6-402b-827f-f5b214f44899",
          "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
          "x-correlationid": "62e0f2fb-6eb6-402b-827f-f5b214f44899",
          "Gov-Client-Public-IP": "88.97.27.180",
          "Gov-Client-Device-ID": "634e4eda-5bed-47f1-a333-0238b67f2283",
          "Gov-Client-User-IDs": "server=anonymous",
          "Gov-Client-Connection-Method": "WEB_APP_VIA_SERVER",
          "Gov-Vendor-Public-IP": "88.97.27.180",
          "Gov-Vendor-Forwarded": "by=88.97.27.180&for=88.97.27.180",
          "Gov-Vendor-Product-Name": "web-submit-diyaccounting-co-uk",
          "Gov-Vendor-Version": "web-submit-diyaccounting-co-uk=0.0.2-4",
          "Gov-Client-Browser-JS-User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
          "Gov-Client-Public-IP-Timestamp": "2026-01-07T23:25:48.237Z",
          "Gov-Client-Screens": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
          "Gov-Client-Timezone": "UTC+00:00",
          "Gov-Client-Window-Size": "width=1280&height=1446"
        },
        "body": "{\"periodKey\":\"25U6\",\"vatDueSales\":1000,\"vatDueAcquisitions\":0,\"totalVatDue\":1000,\"vatReclaimedCurrPeriod\":0,\"netVatDue\":1000,\"totalValueSalesExVAT\":0,\"totalValuePurchasesExVAT\":0,\"totalValueGoodsSuppliedExVAT\":0,\"totalAcquisitionsExVAT\":0,\"finalised\":true}"
      },
      "httpResponse": {
        "statusCode": 201,
        "headers": {
          "cache-control": "no-cache,no-store,max-age=0",
          "connection": "keep-alive",
          "content-length": "140",
          "content-security-policy": "default-src 'self'",
          "content-type": "application/json",
          "date": "Wed, 07 Jan 2026 23:25:48 GMT",
          "receipt-id": "75ded624-ccf5-416e-a59b-53affadb3ca5",
          "receipt-signature": "This has been deprecated - DO NOT USE",
          "receipt-timestamp": "2026-01-07T23:25:48Z",
          "strict-transport-security": "max-age=31536000;",
          "vary": "Origin",
          "via": "1.1 4f2c05fa30365fcac05ad27ee136cce2.cloudfront.net (CloudFront)",
          "x-amz-cf-id": "_s6rdttUMq6NXG7pSdVyhSZN7RH6jpmwpNqn77I8Ev8VhAhZwRf0kg==",
          "x-amz-cf-pop": "LHR50-P6",
          "x-cache": "Miss from cloudfront",
          "x-content-type-options": "nosniff, nosniff",
          "x-correlationid": "75ded624-ccf5-416e-a59b-53affadb3ca5",
          "x-envoy-upstream-service-time": "50",
          "x-frame-options": "SAMEORIGIN"
        },
        "body": {
          "processingDate": "2026-01-07T23:25:48.549Z",
          "formBundleNumber": "455184147206",
          "paymentIndicator": "DD",
          "chargeRefNumber": "7UNj8xC0x0VeKRpv"
        }
      },
      "duration": 154,
      "createdAt": "2026-01-07T23:25:48.569Z",
      "ttl": 1770506748,
      "ttl_datestamp": "2026-02-07T23:25:48.569Z"
    },
    {
      "userId": "user",
      "requestId": "validation-feedback-1767828353316",
      "url": "https://test-api.service.hmrc.gov.uk/test/fraud-prevention-headers/vat-mtd/validation-feedback",
      "httpRequest": {
        "method": "GET",
        "headers": {
          "Accept": "application/vnd.hmrc.1.0+json",
          "x-request-id": "request-123",
          "traceparent": "00-dbc4c6ef6cc05fdbd8c7c50fe06972b7-4d8315614b43a893-01",
          "x-correlationid": "correlation-123"
        }
      },
      "httpResponse": {
        "statusCode": 200,
        "body": {
          "requests": [
            {
              "path": "/organisations/vat/144948637/obligations",
              "method": "GET",
              "requestTimestamp": "2026-01-07T22:50:09.470Z",
              "code": "INVALID_HEADERS",
              "headers": [
                {
                  "header": "gov-client-browser-js-user-agent",
                  "value": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-connection-method",
                  "value": "WEB_APP_VIA_SERVER",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-device-id",
                  "value": "f29bc93d-98fd-40e9-974e-ce3ebba0a595",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-multi-factor",
                  "code": "MISSING_HEADER",
                  "errors": [],
                  "warnings": [
                    "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header."
                  ]
                },
                {
                  "header": "gov-client-public-ip",
                  "value": "40.76.117.242",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-public-ip-timestamp",
                  "value": "2026-01-07T22:50:05.598Z",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-public-port",
                  "code": "MISSING_HEADER",
                  "errors": [
                    "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header."
                  ],
                  "warnings": []
                },
                {
                  "header": "gov-client-screens",
                  "value": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-timezone",
                  "value": "UTC+00:00",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-user-ids",
                  "value": "server=anonymous",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-window-size",
                  "value": "width=1280&height=1446",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-forwarded",
                  "value": "by=40.76.117.242&for=40.76.117.242,by=40.76.117.242&for=3.172.32.174",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-license-ids",
                  "code": "MISSING_HEADER",
                  "errors": [],
                  "warnings": [
                    "Header required"
                  ]
                },
                {
                  "header": "gov-vendor-product-name",
                  "value": "web-submit-diyaccounting-co-uk",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-public-ip",
                  "value": "40.76.117.242",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-version",
                  "value": "web-submit-diyaccounting-co-uk=0.0.2-4",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                }
              ],
              "crossValidation": [
                {
                  "headers": [
                    "gov-vendor-forwarded",
                    "gov-vendor-public-ip",
                    "gov-client-public-ip"
                  ],
                  "code": "VALID_HEADERS",
                  "errors": []
                }
              ]
            },
            {
              "path": "/organisations/vat/539491020/returns",
              "method": "POST",
              "requestTimestamp": "2026-01-07T23:22:53.471Z",
              "code": "INVALID_HEADERS",
              "headers": [
                {
                  "header": "gov-client-browser-js-user-agent",
                  "value": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-connection-method",
                  "value": "WEB_APP_VIA_SERVER",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-device-id",
                  "value": "3908d470-27f5-4945-b665-19e8809c956f",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-multi-factor",
                  "code": "MISSING_HEADER",
                  "errors": [],
                  "warnings": [
                    "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header."
                  ]
                },
                {
                  "header": "gov-client-public-ip",
                  "value": "88.97.27.180",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-public-ip-timestamp",
                  "value": "2026-01-07T23:22:53.257Z",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-public-port",
                  "code": "MISSING_HEADER",
                  "errors": [
                    "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header."
                  ],
                  "warnings": []
                },
                {
                  "header": "gov-client-screens",
                  "value": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-timezone",
                  "value": "UTC+00:00",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-user-ids",
                  "value": "server=anonymous",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-window-size",
                  "value": "width=1280&height=1446",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-forwarded",
                  "value": "by=88.97.27.180&for=88.97.27.180",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-license-ids",
                  "code": "MISSING_HEADER",
                  "errors": [],
                  "warnings": [
                    "Header required"
                  ]
                },
                {
                  "header": "gov-vendor-product-name",
                  "value": "web-submit-diyaccounting-co-uk",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-public-ip",
                  "value": "88.97.27.180",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-version",
                  "value": "web-submit-diyaccounting-co-uk=0.0.2-4",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                }
              ],
              "crossValidation": [
                {
                  "headers": [
                    "gov-vendor-forwarded",
                    "gov-vendor-public-ip",
                    "gov-client-public-ip"
                  ],
                  "code": "VALID_HEADERS",
                  "errors": []
                }
              ]
            },
            {
              "path": "/organisations/vat/144948637/returns/24Y9",
              "method": "GET",
              "requestTimestamp": "2026-01-07T22:49:57.713Z",
              "code": "INVALID_HEADERS",
              "headers": [
                {
                  "header": "gov-client-browser-js-user-agent",
                  "value": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-connection-method",
                  "value": "WEB_APP_VIA_SERVER",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-device-id",
                  "value": "96fc826c-dbb9-4375-a045-352c4e1c9152",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-multi-factor",
                  "code": "MISSING_HEADER",
                  "errors": [],
                  "warnings": [
                    "Header missing. This may be correct for single factor authentication, for example username and password. If this is the case, you must contact us explaining why you cannot submit this header."
                  ]
                },
                {
                  "header": "gov-client-public-ip",
                  "value": "40.76.117.242",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-public-ip-timestamp",
                  "value": "2026-01-07T22:49:53.082Z",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-public-port",
                  "code": "MISSING_HEADER",
                  "errors": [
                    "Header missing. You will not be able to submit a header if the connection is between client and server in a private network. If this is the case, you must contact us explaining why you cannot submit this header."
                  ],
                  "warnings": []
                },
                {
                  "header": "gov-client-screens",
                  "value": "width=1280&height=1446&colour-depth=24&scaling-factor=1",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-timezone",
                  "value": "UTC+00:00",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-user-ids",
                  "value": "server=anonymous",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-client-window-size",
                  "value": "width=1280&height=1446",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-forwarded",
                  "value": "by=40.76.117.242&for=40.76.117.242,by=40.76.117.242&for=3.172.32.176",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-license-ids",
                  "code": "MISSING_HEADER",
                  "errors": [],
                  "warnings": [
                    "Header required"
                  ]
                },
                {
                  "header": "gov-vendor-product-name",
                  "value": "web-submit-diyaccounting-co-uk",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-public-ip",
                  "value": "40.76.117.242",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                },
                {
                  "header": "gov-vendor-version",
                  "value": "web-submit-diyaccounting-co-uk=0.0.2-4",
                  "code": "VALID_HEADER",
                  "errors": [],
                  "warnings": []
                }
              ],
              "crossValidation": [
                {
                  "headers": [
                    "gov-vendor-forwarded",
                    "gov-vendor-public-ip",
                    "gov-client-public-ip"
                  ],
                  "code": "VALID_HEADERS",
                  "errors": []
                }
              ]
            }
          ]
        }
      },
      "timestamp": "2026-01-07T23:25:53.316Z",
      "source": "test-executor-direct"
    }
  ],
  "playwrightReport": {
    "exists": true,
    "status": "failed",
    "failedTests": [
      "09ad7a86c5d6b024ba57-7e9d69a90c6e120217e6"
    ]
  },
  "testSourceFile": {
    "filename": "behaviour-tests/postVatReturnFraudPreventionHeaders.behaviour.test.js",
    "content": "// behaviour-tests/postVatReturnFraudPreventionHeaders.behaviour.test.js\n// Simplified test to verify HMRC fraud prevention headers compliance\n\nimport { test } from \"./helpers/playwrightTestWithout.js\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\nimport { dotenvConfigIfNotBlank } from \"@app/lib/env.js\";\nimport {\n  addOnPageLogging,\n  createHmrcTestUser,\n  getEnvVarAndLog,\n  isSandboxMode,\n  runLocalHttpServer,\n  runLocalOAuth2Server,\n  runLocalDynamoDb,\n  runLocalSslProxy,\n  saveHmrcTestUserToFiles,\n  checkFraudPreventionHeadersFeedback,\n  generatePeriodKey,\n} from \"./helpers/behaviour-helpers.js\";\nimport { consentToDataCollection, goToHomePage, goToHomePageExpectNotLoggedIn } from \"./steps/behaviour-steps.js\";\nimport {\n  clickLogIn,\n  loginWithCognitoOrMockAuth,\n  logOutAndExpectToBeLoggedOut,\n  verifyLoggedInStatus,\n} from \"./steps/behaviour-login-steps.js\";\nimport { ensureBundlePresent, goToBundlesPage } from \"./steps/behaviour-bundle-steps.js\";\nimport { completeVat, fillInVat, initSubmitVat, submitFormVat, verifyVatSubmission } from \"./steps/behaviour-hmrc-vat-steps.js\";\nimport { fillInHmrcAuth, goToHmrcAuth, grantPermissionHmrcAuth, initHmrcAuth, submitHmrcAuth } from \"./steps/behaviour-hmrc-steps.js\";\nimport {\n  deleteTraceparentTxt,\n  deleteUserSubTxt,\n  deleteHashedUserSubTxt,\n  extractUserSubFromLocalStorage,\n  appendUserSubTxt,\n  appendHashedUserSubTxt,\n  appendTraceparentTxt,\n} from \"./helpers/fileHelper.js\";\nimport { startWiremock, stopWiremock } from \"./helpers/wiremock-helper.js\";\nimport { exportAllTables } from \"./helpers/dynamodb-export.js\";\nimport {\n  assertConsistentHashedSub,\n  assertFraudPreventionHeaders,\n  assertHmrcApiRequestExists,\n  assertHmrcApiRequestValues,\n  intentionallyNotSuppliedHeaders,\n  readDynamoDbExport,\n} from \"./helpers/dynamodb-assertions.js\";\nimport { expect } from \"@playwright/test\";\n\ndotenvConfigIfNotBlank({ path: \".env\" }); // Not checked in, HMRC API credentials\n\nlet wiremockMode;\nlet wiremockPort;\n\nconst screenshotPath = \"target/behaviour-test-results/screenshots/fraudPreventionHeadersVat-behaviour-test\";\n\nconst originalEnv = { ...process.env };\n\nconst envFilePath = getEnvVarAndLog(\"envFilePath\", \"DIY_SUBMIT_ENV_FILEPATH\", null);\nconst envName = getEnvVarAndLog(\"envName\", \"ENVIRONMENT_NAME\", \"local\");\nconst httpServerPort = getEnvVarAndLog(\"serverPort\", \"TEST_SERVER_HTTP_PORT\", 3000);\nconst runTestServer = getEnvVarAndLog(\"runTestServer\", \"TEST_SERVER_HTTP\", null);\nconst runProxy = getEnvVarAndLog(\"runProxy\", \"TEST_PROXY\", null);\nconst runMockOAuth2 = getEnvVarAndLog(\"runMockOAuth2\", \"TEST_MOCK_OAUTH2\", null);\nconst testAuthProvider = getEnvVarAndLog(\"testAuthProvider\", \"TEST_AUTH_PROVIDER\", null);\nconst testAuthUsername = getEnvVarAndLog(\"testAuthUsername\", \"TEST_AUTH_USERNAME\", null);\nconst baseUrl = getEnvVarAndLog(\"baseUrl\", \"DIY_SUBMIT_BASE_URL\", null);\nconst hmrcTestUsername = getEnvVarAndLog(\"hmrcTestUsername\", \"TEST_HMRC_USERNAME\", null);\nconst hmrcTestPassword = getEnvVarAndLog(\"hmrcTestPassword\", \"TEST_HMRC_PASSWORD\", null);\nconst hmrcTestVatNumber = getEnvVarAndLog(\"hmrcTestVatNumber\", \"TEST_HMRC_VAT_NUMBER\", null);\nconst hmrcVatPeriodFromDate = \"2025-01-01\";\nconst hmrcVatPeriodToDate = \"2025-12-01\";\nconst runDynamoDb = getEnvVarAndLog(\"runDynamoDb\", \"TEST_DYNAMODB\", null);\nconst bundleTableName = getEnvVarAndLog(\"bundleTableName\", \"BUNDLE_DYNAMODB_TABLE_NAME\", null);\nconst hmrcApiRequestsTableName = getEnvVarAndLog(\"hmrcApiRequestsTableName\", \"HMRC_API_REQUESTS_DYNAMODB_TABLE_NAME\", null);\nconst receiptsTableName = getEnvVarAndLog(\"receiptsTableName\", \"RECEIPTS_DYNAMODB_TABLE_NAME\", null);\nconst runFraudPreventionHeaderValidation = true;\n\n// eslint-disable-next-line sonarjs/pseudo-random\nconst hmrcVatPeriodKey = generatePeriodKey();\nconst hmrcVatDueAmount = \"1000.00\";\n\nlet mockOAuth2Process;\nlet serverProcess;\nlet ngrokProcess;\nlet dynamoControl;\nlet userSub = null;\nlet observedTraceparent = null;\n\ntest.setTimeout(300_000);\n\ntest.beforeEach(async ({}, testInfo) => {\n  testInfo.annotations.push({ type: \"test-id\", description: \"web-test-local\" });\n});\n\ntest.beforeAll(async ({ page }, testInfo) => {\n  console.log(\"Starting beforeAll hook...\");\n\n  if (!envFilePath) {\n    throw new Error(\"Environment variable DIY_SUBMIT_ENV_FILEPATH is not set, assuming no environment; not attempting tests.\");\n  }\n\n  process.env = {\n    ...originalEnv,\n  };\n\n  wiremockMode = process.env.TEST_WIREMOCK || \"off\";\n  wiremockPort = process.env.WIREMOCK_PORT || 9090;\n\n  if (wiremockMode === \"record\" || wiremockMode === \"mock\") {\n    const targets = [];\n    if (process.env.HMRC_BASE_URI) targets.push(process.env.HMRC_BASE_URI);\n    if (process.env.HMRC_SANDBOX_BASE_URI) targets.push(process.env.HMRC_SANDBOX_BASE_URI);\n    await startWiremock({\n      mode: wiremockMode,\n      port: wiremockPort,\n      outputDir: process.env.WIREMOCK_RECORD_OUTPUT_DIR || \"\",\n      targets,\n    });\n    // override HMRC endpoints so the app uses WireMock\n    process.env.HMRC_BASE_URI = `http://localhost:${wiremockPort}`;\n    process.env.HMRC_SANDBOX_BASE_URI = `http://localhost:${wiremockPort}`;\n  }\n\n  // Run servers needed for the test (after env overrides so child sees them)\n  dynamoControl = await runLocalDynamoDb(runDynamoDb, bundleTableName, hmrcApiRequestsTableName, receiptsTableName);\n  mockOAuth2Process = await runLocalOAuth2Server(runMockOAuth2);\n  serverProcess = await runLocalHttpServer(runTestServer, httpServerPort);\n  ngrokProcess = await runLocalSslProxy(runProxy, httpServerPort, baseUrl);\n\n  // Clean up any existing artefacts from previous test runs\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n  deleteUserSubTxt(outputDir);\n  deleteHashedUserSubTxt(outputDir);\n  deleteTraceparentTxt(outputDir);\n\n  console.log(\"beforeAll hook completed successfully\");\n});\n\ntest.afterAll(async () => {\n  // Shutdown local servers at end of test\n  if (ngrokProcess) {\n    ngrokProcess.kill();\n  }\n  if (serverProcess) {\n    serverProcess.kill();\n  }\n  if (mockOAuth2Process) {\n    mockOAuth2Process.kill();\n  }\n  try {\n    await dynamoControl?.stop?.();\n  } catch {}\n  // stop local servers...\n  if (wiremockMode && wiremockMode !== \"off\") {\n    await stopWiremock({ mode: wiremockMode, port: wiremockPort });\n  }\n});\n\ntest.afterEach(async ({ page }, testInfo) => {\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n  appendUserSubTxt(outputDir, testInfo, userSub);\n  await appendHashedUserSubTxt(outputDir, testInfo, userSub);\n  appendTraceparentTxt(outputDir, testInfo, observedTraceparent);\n});\n\ntest(\"Verify fraud prevention headers for VAT return submission\", async ({ page }, testInfo) => {\n  // Only run in sandbox mode\n  if (!isSandboxMode()) {\n    console.log(\"[SKIP] Fraud prevention headers test is only run in sandbox mode\");\n    test.skip();\n    return;\n  }\n\n  // Compute test URL based on which servers are running\n  const testUrl =\n    (runTestServer === \"run\" || runTestServer === \"useExisting\") && runProxy !== \"run\" && runProxy !== \"useExisting\"\n      ? `http://127.0.0.1:${httpServerPort}/`\n      : baseUrl;\n\n  // Add console logging to capture browser messages\n  addOnPageLogging(page);\n\n  page.on(\"response\", (response) => {\n    try {\n      if (observedTraceparent) return;\n      const headers = response.headers?.() ?? {};\n      const h = typeof headers === \"function\" ? headers() : headers;\n      const tp = (h && (h[\"traceparent\"] || h[\"Traceparent\"])) || null;\n      if (tp) observedTraceparent = tp;\n    } catch {}\n  });\n\n  // ---------- Test artefacts (video-adjacent) ----------\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n\n  /* ************************* */\n  /* HMRC TEST USER CREATION   */\n  /* ************************* */\n\n  // Variables to hold test credentials (either from env or generated)\n  let testUsername = hmrcTestUsername;\n  let testPassword = hmrcTestPassword;\n  let testVatNumber = hmrcTestVatNumber;\n\n  // If in sandbox mode and credentials are not provided, create a test user\n  if (!hmrcTestUsername) {\n    console.log(\"[HMRC Test User] Sandbox mode detected without full credentials - creating test user\");\n\n    const hmrcClientId = process.env.HMRC_SANDBOX_CLIENT_ID || process.env.HMRC_CLIENT_ID;\n    const hmrcClientSecret = process.env.HMRC_SANDBOX_CLIENT_SECRET || process.env.HMRC_CLIENT_SECRET;\n\n    if (!hmrcClientId) {\n      console.error(\"[HMRC Test User] No HMRC client ID found in environment. Cannot create test user.\");\n      throw new Error(\"HMRC_SANDBOX_CLIENT_ID or HMRC_CLIENT_ID is required to create test users\");\n    }\n\n    if (!hmrcClientSecret) {\n      console.error(\"[HMRC Test User] No HMRC client secret found in environment. Cannot create test user.\");\n      throw new Error(\"HMRC_SANDBOX_CLIENT_SECRET or HMRC_CLIENT_SECRET is required to create test users\");\n    }\n\n    console.log(\"[HMRC Test User] Creating HMRC sandbox test user with VAT enrolment using client credentials\");\n\n    const testUser = await createHmrcTestUser(hmrcClientId, hmrcClientSecret, {\n      serviceNames: [\"mtd-vat\"],\n    });\n\n    // Extract credentials from the created test user\n    testUsername = testUser.userId;\n    testPassword = testUser.password;\n    testVatNumber = testUser.vrn;\n\n    console.log(\"[HMRC Test User] Successfully created test user:\");\n    console.log(`  User ID: ${testUser.userId}`);\n    console.log(`  User Full Name: ${testUser.userFullName}`);\n    console.log(`  VAT Registration Number: ${testUser.vrn}`);\n    console.log(`  Organisation: ${testUser.organisationDetails?.name || \"N/A\"}`);\n\n    // Save test user details to files\n    const repoRoot = path.resolve(process.cwd());\n\n    saveHmrcTestUserToFiles(testUser, outputDir, repoRoot);\n\n    // Update environment variables for this test run\n    process.env.TEST_HMRC_USERNAME = testUsername;\n    process.env.TEST_HMRC_PASSWORD = testPassword;\n    process.env.TEST_HMRC_VAT_NUMBER = testVatNumber;\n\n    console.log(\"[HMRC Test User] Updated environment variables with generated credentials\");\n  }\n\n  /* ****** */\n  /*  HOME  */\n  /* ****** */\n\n  await goToHomePageExpectNotLoggedIn(page, testUrl, screenshotPath);\n\n  /* ******* */\n  /*  LOGIN  */\n  /* ******* */\n\n  await clickLogIn(page, screenshotPath);\n  await loginWithCognitoOrMockAuth(page, testAuthProvider, testAuthUsername, screenshotPath);\n  await verifyLoggedInStatus(page, screenshotPath);\n  await consentToDataCollection(page, screenshotPath);\n\n  /* ********* */\n  /*  BUNDLES  */\n  /* ********* */\n\n  await goToBundlesPage(page, screenshotPath);\n  if (isSandboxMode()) {\n    await ensureBundlePresent(page, \"Test\", screenshotPath);\n  }\n  await goToHomePage(page, screenshotPath);\n  await goToBundlesPage(page, screenshotPath);\n  await goToHomePage(page, screenshotPath);\n\n  /* *********** */\n  /* `SUBMIT VAT */\n  /* *********** */\n\n  await initSubmitVat(page, screenshotPath);\n  await fillInVat(page, testVatNumber, hmrcVatPeriodKey, hmrcVatDueAmount, null, runFraudPreventionHeaderValidation, screenshotPath);\n  await submitFormVat(page, screenshotPath);\n\n  /* ************ */\n  /* `HMRC AUTH   */\n  /* ************ */\n\n  await goToHmrcAuth(page, screenshotPath);\n  await initHmrcAuth(page, screenshotPath);\n  await fillInHmrcAuth(page, testUsername, testPassword, screenshotPath);\n  await submitHmrcAuth(page, screenshotPath);\n  await grantPermissionHmrcAuth(page, screenshotPath);\n\n  /* ******************* */\n  /* `SUBMIT VAT RESULTS */\n  /* ******************* */\n\n  await completeVat(page, baseUrl, null, screenshotPath);\n  await verifyVatSubmission(page, null, screenshotPath);\n\n  /* ****************** */\n  /*  Extract user sub  */\n  /* ****************** */\n\n  userSub = await extractUserSubFromLocalStorage(page, testInfo);\n\n  /* ********************************** */\n  /*  FRAUD PREVENTION HEADERS FEEDBACK */\n  /* ********************************** */\n\n  // For sandbox tests, fetch fraud prevention headers validation feedback\n  // Note: This request is made directly from test executor to HMRC, not through Lambda\n  // We capture the result to include in the test report even without DynamoDB access\n  const requestId = \"request-123\";\n  const traceparent = observedTraceparent;\n  const correlationId = \"correlation-123\";\n  const validationFeedbackResult = await checkFraudPreventionHeadersFeedback(page, testInfo, screenshotPath, userSub, requestId, traceparent, correlationId);\n  //await new Promise((resolve) => setTimeout(resolve, 100)); // 100ms delay\n\n  /* ********* */\n  /*  LOG OUT  */\n  /* ********* */\n\n  await logOutAndExpectToBeLoggedOut(page, screenshotPath);\n\n  /* ****************** */\n  /*  TEST CONTEXT JSON */\n  /* ****************** */\n\n  // Build test context metadata and write testContext.json next to the video\n  const testContext = {\n    testId: \"web-test-local\",\n    name: testInfo.title,\n    title: \"Fraud Prevention Headers Validation (HMRC: VAT Return POST)\",\n    description: \"Submits a VAT return to HMRC MTD VAT API and validates fraud prevention headers compliance.\",\n    hmrcApis: [\n      { url: \"/api/v1/hmrc/vat/return\", method: \"POST\" },\n      { url: \"/test/fraud-prevention-headers/validate\", method: \"GET\" },\n      { url: \"/test/fraud-prevention-headers/vat-mtd/validation-feedback\", method: \"GET\" },\n    ],\n    env: {\n      envName,\n      baseUrl,\n      serverPort: httpServerPort,\n      runTestServer,\n      runProxy,\n      runMockOAuth2,\n      testAuthProvider,\n      testAuthUsername,\n      bundleTableName,\n      hmrcApiRequestsTableName,\n      receiptsTableName,\n      runDynamoDb,\n    },\n    testData: {\n      hmrcTestUsername: testUsername,\n      hmrcTestPassword: testPassword ? \"***MASKED***\" : \"<not provided>\", // Mask password in test context\n      hmrcTestVatNumber: testVatNumber,\n      hmrcVatPeriodKey,\n      hmrcVatDueAmount,\n      testUserGenerated: isSandboxMode() && (!hmrcTestUsername || !hmrcTestPassword || !hmrcTestVatNumber),\n      userSub,\n      observedTraceparent,\n      testUrl,\n      isSandboxMode: isSandboxMode(),\n      intentionallyNotSuppliedHeaders,\n    },\n    // Validation feedback from HMRC (captured directly from test executor, not via Lambda/DynamoDB)\n    validationFeedback: validationFeedbackResult\n      ? {\n          ok: validationFeedbackResult.ok,\n          status: validationFeedbackResult.status,\n          feedback: validationFeedbackResult.feedback,\n        }\n      : null,\n    artefactsDir: outputDir,\n    screenshotPath,\n    testStartTime: new Date().toISOString(),\n  };\n  try {\n    fs.writeFileSync(path.join(outputDir, \"testContext.json\"), JSON.stringify(testContext, null, 2), \"utf-8\");\n  } catch (_e) {}\n\n  /* ****************** */\n  /*  FIGURES (SCREENSHOTS) */\n  /* ****************** */\n\n  // Select and copy key screenshots, then generate figures.json\n  const { selectKeyScreenshots, copyScreenshots, generateFiguresMetadata, writeFiguresJson } = await import(\"./helpers/figures-helper.js\");\n\n  const keyScreenshotPatterns = [\"10.*fill.*in.*submission.*pagedown\", \"02.*complete.*vat.*receipt\"];\n\n  const screenshotDescriptions = {\n    \"10.*fill.*in.*submission.*pagedown\": \"VAT return form filled out with test data including VAT number, period key, and amount due\",\n    \"02.*complete.*vat.*receipt\": \"Successful VAT return submission confirmation showing receipt details from HMRC\",\n  };\n\n  const selectedScreenshots = selectKeyScreenshots(screenshotPath, keyScreenshotPatterns, 5);\n  console.log(`[Figures]: Selected ${selectedScreenshots.length} key screenshots from ${screenshotPath}`);\n\n  const copiedScreenshots = copyScreenshots(screenshotPath, outputDir, selectedScreenshots);\n  console.log(`[Figures]: Copied ${copiedScreenshots.length} screenshots to ${outputDir}`);\n\n  const figures = generateFiguresMetadata(copiedScreenshots, screenshotDescriptions);\n  writeFiguresJson(outputDir, figures);\n\n  /* **************** */\n  /*  EXPORT DYNAMODB */\n  /* **************** */\n\n  // Export DynamoDB tables if dynalite was used\n  if (runDynamoDb === \"run\" || runDynamoDb === \"useExisting\") {\n    console.log(\"[DynamoDB Export]: Starting export of all tables...\");\n    try {\n      const exportResults = await exportAllTables(outputDir, dynamoControl.endpoint, {\n        bundleTableName,\n        hmrcApiRequestsTableName,\n        receiptsTableName,\n      });\n      console.log(\"[DynamoDB Export]: Export completed:\", exportResults);\n    } catch (error) {\n      console.error(\"[DynamoDB Export]: Failed to export tables:\", error);\n    }\n  }\n\n  /* ********************************************* */\n  /*  APPEND VALIDATION FEEDBACK TO HMRC REQUESTS  */\n  /* ********************************************* */\n\n  // Write validation feedback to hmrc-api-requests.jsonl even without DynamoDB\n  // This ensures the test report can display the feedback in CI environments\n  if (validationFeedbackResult) {\n    const hmrcApiRequestsFile = path.join(outputDir, \"hmrc-api-requests.jsonl\");\n    const hmrcBase = process.env.HMRC_SANDBOX_BASE_URI || \"https://test-api.service.hmrc.gov.uk\";\n    const validationFeedbackRecord = {\n      userId: userSub || \"unknown\",\n      requestId: `validation-feedback-${Date.now()}`,\n      url: `${hmrcBase}/test/fraud-prevention-headers/vat-mtd/validation-feedback`,\n      httpRequest: {\n        method: \"GET\",\n        headers: {\n          Accept: \"application/vnd.hmrc.1.0+json\",\n          \"x-request-id\": requestId,\n          traceparent: traceparent,\n          \"x-correlationid\": correlationId,\n        },\n      },\n      httpResponse: {\n        statusCode: validationFeedbackResult.status,\n        body: validationFeedbackResult.feedback,\n      },\n      timestamp: new Date().toISOString(),\n      source: \"test-executor-direct\", // Indicates this was captured directly, not via Lambda\n    };\n    try {\n      fs.appendFileSync(hmrcApiRequestsFile, JSON.stringify(validationFeedbackRecord) + \"\\n\", \"utf-8\");\n      console.log(\"[Validation Feedback]: Appended validation feedback to hmrc-api-requests.jsonl\");\n    } catch (error) {\n      console.error(\"[Validation Feedback]: Failed to append validation feedback:\", error);\n    }\n  }\n\n  /* ********************************** */\n  /*  ASSERT DYNAMODB HMRC API REQUESTS */\n  /* ********************************** */\n\n  // Assert that HMRC API requests were logged correctly\n  if (runDynamoDb === \"run\" || runDynamoDb === \"useExisting\") {\n    const hmrcApiRequestsFile = path.join(outputDir, \"hmrc-api-requests.jsonl\");\n\n    // Assert OAuth token exchange request exists\n    const oauthRequests = assertHmrcApiRequestExists(hmrcApiRequestsFile, \"POST\", \"/oauth/token\", \"OAuth token exchange\");\n    console.log(`[DynamoDB Assertions]: Found ${oauthRequests.length} OAuth token exchange request(s)`);\n\n    // Assert VAT return POST request exists and validate key fields\n    const vatPostRequests = assertHmrcApiRequestExists(\n      hmrcApiRequestsFile,\n      \"POST\",\n      `/organisations/vat/${testVatNumber}/returns`,\n      \"VAT return submission\",\n    );\n    console.log(`[DynamoDB Assertions]: Found ${vatPostRequests.length} VAT return POST request(s)`);\n    expect(vatPostRequests.length).toBeGreaterThan(0);\n    vatPostRequests.forEach((vatPostRequest) => {\n      // Assert that the request body contains the submitted data\n      assertHmrcApiRequestValues(vatPostRequest, {\n        \"httpRequest.method\": \"POST\",\n        \"httpResponse.statusCode\": 201,\n      });\n\n      // Check that request body contains the period key and VAT due amount\n      const requestBody = JSON.parse(vatPostRequest.httpRequest.body);\n      expect(requestBody.periodKey).toBe(hmrcVatPeriodKey.toUpperCase());\n      expect(requestBody.vatDueSales).toBe(parseFloat(hmrcVatDueAmount));\n      console.log(\"[DynamoDB Assertions]: VAT POST request body validated successfully\");\n    });\n\n    // Assert Fraud prevention headers validation feedback GET request exists and validate key fields\n    assertFraudPreventionHeaders(hmrcApiRequestsFile, true, true, false);\n\n    // Assert consistent hashedSub across authenticated requests\n    const hashedSubs = assertConsistentHashedSub(hmrcApiRequestsFile, \"Submit VAT test\");\n    console.log(`[DynamoDB Assertions]: Found ${hashedSubs.length} unique hashedSub value(s): ${hashedSubs.join(\", \")}`);\n  }\n});\n"
  },
  "envConfig": {
    "filename": ".env.proxy",
    "content": "# .env.proxy\n#\n# Features:\n#   Proxy configuration which uses ngrok (and expects to be authenticated).\n#   HMRC Test API.\n#   DynamoDB (like) storage.\n#   Mock OAuth2 server.\nDIY_SUBMIT_ENV_FILEPATH=.env.proxy\nDOTENV_CONFIG_QUIET=true\nENVIRONMENT_NAME=proxy\nDEPLOYMENT_NAME=proxy\nDIY_SUBMIT_BASE_URL=https://wanted-finally-anteater.ngrok-free.app/\n\nLOG_TO_CONSOLE=true\nLOG_TO_FILE=true\nCLOUD_TRAIL_ENABLED=\n\n# TODO: Find a way to have a local ssl termination for proxy host\n# TODO: Switch to this to avoid the 301 redirects during testing: https://test-www.tax.service.gov.uk/oauth/authorize?response_type=code&client_id=uqMHA6RsDGGa7h8EG2VqfqAmv4tV&redirect_uri=https%3A%2F%2Fwanted-finally-anteater.ngrok-free.app%2Factivities%2FsubmitVatCallback.html&scope=read%3Avat&state=91b3946b6b544ec682b7b48dda3bb935\n# TODO: Replace usages of HMRC_BASE_URI with either the mapped or egress URL as appropriate\nHMRC_BASE_URI=https://test-api.service.hmrc.gov.uk\nHMRC_CLIENT_ID=uqMHA6RsDGGa7h8EG2VqfqAmv4tV\nHMRC_SANDBOX_BASE_URI=https://test-api.service.hmrc.gov.uk\nHMRC_SANDBOX_CLIENT_ID=uqMHA6RsDGGa7h8EG2VqfqAmv4tV\nGOOGLE_CLIENT_SECRET_ARN=\nHMRC_CLIENT_SECRET_ARN=\nHMRC_SANDBOX_CLIENT_SECRET_ARN=\nCOGNITO_USER_POOL_ID=\nCOGNITO_CLIENT_ID=\nCOGNITO_BASE_URI=\nUSER_SUB_HASH_SALT=local-development-salt-not-for-production\nBUNDLE_DYNAMODB_TABLE_NAME=test-bundle-table\nRECEIPTS_DYNAMODB_TABLE_NAME=test-receipts-table\nHMRC_API_REQUESTS_DYNAMODB_TABLE_NAME=test-hmrc-api-requests-table\nHMRC_VAT_RETURN_POST_ASYNC_REQUESTS_TABLE_NAME=test-hmrc-vat-return-post-async-requests-table\nHMRC_VAT_RETURN_GET_ASYNC_REQUESTS_TABLE_NAME=test-hmrc-vat-return-get-async-requests-table\nHMRC_VAT_OBLIGATION_GET_ASYNC_REQUESTS_TABLE_NAME=test-hmrc-vat-obligation-get-async-requests-table\nSQS_QUEUE_URL=none\nACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=\nS3_RETAIN_RECEIPTS_BUCKET=\n\nTEST_SERVER_HTTP_PORT=3000\nTEST_SERVER_HTTP=run\nTEST_PROXY=run\nTEST_MOCK_OAUTH2=run\nTEST_AUTH_PROVIDER=mock\nTEST_AUTH_USERNAME=user\nTEST_AUTH_PASSWORD=\nTEST_DYNAMODB=run\n\nTEST_BUNDLE_EXPIRY_DATE=2025-12-31\nTEST_BUNDLE_USER_LIMIT=1000\nTEST_BUNDLE_MOCK=true\nTEST_VAT_OBLIGATIONS={}\nTEST_VAT_RETURN={}\n\n#TEST_WIREMOCK=record\n#TEST_WIREMOCK=mock\nWIREMOCK_MOCK_ENVIRONMENT=proxy\nWIREMOCK_PORT=9090\nWIREMOCK_RECORD_OUTPUT_DIR=wiremock-recordings/proxy\n"
  },
  "artifacts": {
    "screenshots": [
      "fill-in-submission-pagedown.png",
      "complete-vat-receipt.png",
      "submit-mock.png",
      "complete-vat-waiting.png",
      "receipt.png"
    ],
    "videos": [
      "video.webm"
    ],
    "figures": [
      {
        "filename": "fill-in-submission-pagedown.png",
        "order": 1,
        "description": "VAT return form filled out with test data including VAT number, period key, and amount due",
        "caption": "07 23 25 38 570985055 10 Fill In Submission Pagedown"
      },
      {
        "filename": "complete-vat-receipt.png",
        "order": 2,
        "description": "Successful VAT return submission confirmation showing receipt details from HMRC",
        "caption": "07 23 25 49 908347158 02 Complete Vat Receipt"
      },
      {
        "filename": "submit-mock.png",
        "order": 3,
        "description": "Screenshot captured during test execution",
        "caption": "07 23 25 18 669129376 01 Submit Mock"
      },
      {
        "filename": "complete-vat-waiting.png",
        "order": 4,
        "description": "Screenshot captured during test execution",
        "caption": "07 23 25 49 770629564 01 Complete Vat Waiting"
      },
      {
        "filename": "receipt.png",
        "order": 5,
        "description": "Screenshot captured during test execution",
        "caption": "07 23 25 50 593187228 08 Receipt"
      }
    ]
  }
}