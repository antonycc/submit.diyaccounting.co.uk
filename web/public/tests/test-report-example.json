{
  "testName": "example",
  "generatedAt": "2025-12-05T23:38:48.822Z",
  "testContext": {
    "name": "Click through: View VAT obligations from HMRC",
    "title": "View VAT Obligations (HMRC: VAT Obligations GET)",
    "description": "Retrieves VAT obligations from HMRC MTD VAT API and verifies the results flow in the UI.",
    "hmrcApis": [
      {
        "url": "/api/v1/hmrc/vat/obligation",
        "method": "GET"
      }
    ],
    "env": {
      "envName": "proxy",
      "baseUrl": "https://wanted-finally-anteater.ngrok-free.app/",
      "serverPort": "3000",
      "runTestServer": "run",
      "runProxy": "run",
      "runMockOAuth2": "run",
      "testAuthProvider": "mock",
      "testAuthUsername": "user",
      "bundleTableName": "test-bundle-table",
      "hmrcApiRequestsTableName": "test-hmrc-api-requests-table",
      "receiptsTableName": "test-receipts-table",
      "runDynamoDb": "run"
    },
    "testData": {
      "hmrcTestVatNumber": "470275746",
      "hmrcTestUsername": "858526463234",
      "hmrcTestPassword": "***MASKED***",
      "hmrcVatPeriodFromDate": "2025-01-07",
      "hmrcVatPeriodToDate": "2025-11-01",
      "testUserGenerated": true,
      "userSub": "user",
      "observedTraceparent": "00-2c35b5b563f4292cb995d92c8f48560f-bbc24b5374b07874-01",
      "testUrl": "https://wanted-finally-anteater.ngrok-free.app/",
      "isSandboxMode": true
    },
    "artefactsDir": "/Users/antony/projects/submit.diyaccounting.co.uk/target/behaviour-test-results/vatObligations.behaviour-C-5c45b-w-VAT-obligations-from-HMRC-obligation-behaviour-tests",
    "screenshotPath": "target/behaviour-test-results/screenshots/vat-obligations-behaviour-test",
    "testStartTime": "2025-12-05T23:38:46.581Z"
  },
  "hmrcApiRequests": [
    {
      "hashedSub": "04f8996da763b7a969b1028ee3007569eaf3a635486ddab211d512c85b9df8fb",
      "requestId": "345124ac-e75f-4e5a-9739-0a880cbbe74c",
      "amznTraceId": null,
      "traceparent": "00-2c35b5b563f4292cb995d92c8f48560f-bbc24b5374b07874-01",
      "url": "https://test-api.service.hmrc.gov.uk/organisations/vat/470275746/obligations?from=2025-01-07&to=2025-11-01",
      "method": "GET",
      "httpRequest": {
        "method": "GET",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/vnd.hmrc.1.0+json",
          "Authorization": "Bearer b98b6b9530be3a93b51e79671e74e626",
          "Gov-Client-Connection-Method": "WEB_APP_VIA_SERVER",
          "Gov-Client-Browser-JS-User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/143.0.7499.4 Safari/537.36",
          "Gov-Client-Device-ID": "38c54c6c-4cc2-415e-b238-1650be5a41f9",
          "Gov-Client-Multi-Factor": "type=OTHER",
          "Gov-Client-Public-IP": "88.97.27.180",
          "Gov-Client-Public-IP-Timestamp": "2025-12-05T23:38:43.644Z",
          "Gov-Client-Public-Port": "443",
          "Gov-Client-Screens": "width=1920&height=1080&scaling-factor=1&colour-depth=16,width=3000&height=2000&scaling-factor=1.25&colour-depth=16",
          "Gov-Client-Timezone": "Europe/London",
          "Gov-Client-User-IDs": "test=1",
          "Gov-Client-Window-Size": "{\"width\":1280,\"height\":720}",
          "Gov-Vendor-Forwarded": "by=203.0.113.6&for=198.51.100.0",
          "Gov-Vendor-License-IDs": "my-licensed-software=8D7963490527D33716835EE7C195516D5E562E03B224E9B359836466EE40CDE1",
          "Gov-Vendor-Product-Name": "DIY Accounting Submit",
          "Gov-Vendor-Public-IP": "88.97.27.180",
          "Gov-Vendor-Version": "web-submit-diyaccounting-co-uk-0.0.2-4",
          "x-request-id": "345124ac-e75f-4e5a-9739-0a880cbbe74c",
          "traceparent": "00-2c35b5b563f4292cb995d92c8f48560f-bbc24b5374b07874-01"
        }
      },
      "httpResponse": {
        "statusCode": 200,
        "headers": {
          "cache-control": "no-cache,no-store,max-age=0",
          "connection": "keep-alive",
          "content-length": "227",
          "content-security-policy": "default-src 'self'",
          "content-type": "application/json",
          "date": "Fri, 05 Dec 2025 23:38:43 GMT",
          "strict-transport-security": "max-age=31536000;",
          "vary": "Origin",
          "via": "1.1 44c8518ee2715e9ab8d35e8941daca88.cloudfront.net (CloudFront)",
          "x-amz-cf-id": "VM-DcO0cFoa1b2kQsma90R5C5YGxPgTvROxmQnEEh5Yhmf-RX3R_pQ==",
          "x-amz-cf-pop": "LHR50-P6",
          "x-cache": "Miss from cloudfront",
          "x-content-type-options": "nosniff, nosniff",
          "x-correlationid": "e5c572cf-f6d6-4c89-85b6-1cd09ed1bded",
          "x-envoy-upstream-service-time": "38",
          "x-frame-options": "SAMEORIGIN"
        },
        "body": {
          "obligations": [
            {
              "periodKey": "18A1",
              "start": "2017-01-01",
              "end": "2017-03-31",
              "due": "2017-05-07",
              "status": "F",
              "received": "2017-05-06"
            },
            {
              "periodKey": "18A2",
              "start": "2017-04-01",
              "end": "2017-06-30",
              "due": "2017-08-07",
              "status": "O"
            }
          ]
        }
      },
      "duration": 210,
      "createdAt": "2025-12-05T23:38:43.893Z",
      "ttl": 1767656323,
      "ttl_datestamp": "2026-01-05T23:38:43.893Z"
    },
    {
      "hashedSub": "04f8996da763b7a969b1028ee3007569eaf3a635486ddab211d512c85b9df8fb",
      "requestId": "5ae6c58c-7e36-486b-91dc-25fc72b4adde",
      "amznTraceId": null,
      "traceparent": "00-2c35b5b563f4292cb995d92c8f48560f-bbc24b5374b07874-01",
      "url": "https://test-api.service.hmrc.gov.uk/oauth/token",
      "method": "POST",
      "httpRequest": {
        "method": "POST",
        "headers": {
          "Content-Type": "application/x-www-form-urlencoded",
          "x-request-id": "4cf64589-03a5-4f8c-b320-7d6a06fbc2ac",
          "traceparent": "00-2c35b5b563f4292cb995d92c8f48560f-bbc24b5374b07874-01"
        },
        "body": "grant_type=authorization_code&client_id=uqMHA6RsDGGa7h8EG2VqfqAmv4tV&client_secret=049b662f-61ea-4113-b38d-a9c8b1bb9f13&redirect_uri=https%3A%2F%2Fwanted-finally-anteater.ngrok-free.app%2Factivities%2FsubmitVatCallback.html&code=8014a3c5e6c24852921681ba65342f98"
      },
      "httpResponse": {
        "statusCode": 200,
        "headers": {
          "cache-control": "no-cache,no-store,max-age=0",
          "connection": "keep-alive",
          "content-length": "162",
          "content-security-policy": "default-src 'self'",
          "content-type": "application/json",
          "date": "Fri, 05 Dec 2025 23:38:43 GMT",
          "strict-transport-security": "max-age=31536000;",
          "via": "1.1 44c8518ee2715e9ab8d35e8941daca88.cloudfront.net (CloudFront)",
          "x-amz-cf-id": "eyK4ROy-l1kKZ41wlcyEdDjxXmpdnGFlEOIbqJgo4xo-1w2b-7em6Q==",
          "x-amz-cf-pop": "LHR50-P6",
          "x-cache": "Miss from cloudfront",
          "x-content-type-options": "nosniff",
          "x-envoy-upstream-service-time": "220",
          "x-frame-options": "SAMEORIGIN"
        },
        "body": {
          "access_token": "b98b6b9530be3a93b51e79671e74e626",
          "refresh_token": "b597f13109c0ea790e75116c8c75fd51",
          "expires_in": 14400,
          "scope": "read:vat",
          "token_type": "bearer"
        }
      },
      "duration": 353,
      "createdAt": "2025-12-05T23:38:43.400Z",
      "ttl": 1767656323,
      "ttl_datestamp": "2026-01-05T23:38:43.400Z"
    }
  ],
  "playwrightReport": {
    "exists": true,
    "status": "passed",
    "failedTests": []
  },
  "testSourceFile": {
    "filename": "behaviour-tests/vatObligations.behaviour.test.js",
    "content": "// behaviour-tests/vatObligations.behaviour.test.js\n\nimport { test } from \"./helpers/playwrightTestWithout.js\";\nimport { expect } from \"@playwright/test\";\nimport fs from \"node:fs\";\nimport path from \"node:path\";\nimport { dotenvConfigIfNotBlank } from \"@app/lib/env.js\";\nimport {\n  addOnPageLogging,\n  createHmrcTestUser,\n  getEnvVarAndLog,\n  isSandboxMode,\n  runLocalDynamoDb,\n  runLocalHttpServer,\n  runLocalOAuth2Server,\n  runLocalSslProxy,\n  saveHmrcTestUserToFiles,\n} from \"./helpers/behaviour-helpers.js\";\nimport {\n  consentToDataCollection,\n  goToHomePage,\n  goToHomePageExpectNotLoggedIn,\n  goToHomePageUsingHamburgerMenu,\n} from \"./steps/behaviour-steps.js\";\nimport {\n  clickLogIn,\n  loginWithCognitoOrMockAuth,\n  logOutAndExpectToBeLoggedOut,\n  verifyLoggedInStatus,\n} from \"./steps/behaviour-login-steps.js\";\nimport { ensureBundlePresent, goToBundlesPage } from \"./steps/behaviour-bundle-steps.js\";\nimport {\n  fillInVatObligations,\n  initVatObligations,\n  submitVatObligationsForm,\n  verifyVatObligationsResults,\n} from \"./steps/behaviour-hmrc-vat-steps.js\";\nimport {\n  acceptCookiesHmrc,\n  fillInHmrcAuth,\n  goToHmrcAuth,\n  grantPermissionHmrcAuth,\n  initHmrcAuth,\n  submitHmrcAuth,\n} from \"./steps/behaviour-hmrc-steps.js\";\nimport { exportAllTables } from \"./helpers/dynamodb-export.js\";\nimport { assertHmrcApiRequestExists, assertHmrcApiRequestValues, assertConsistentHashedSub } from \"./helpers/dynamodb-assertions.js\";\nimport {\n  appendTraceparentTxt,\n  appendUserSubTxt,\n  appendHashedUserSubTxt,\n  deleteTraceparentTxt,\n  deleteUserSubTxt,\n  deleteHashedUserSubTxt,\n  extractUserSubFromLocalStorage,\n} from \"./helpers/fileHelper.js\";\nimport { startWiremock, stopWiremock } from \"./helpers/wiremock-helper.js\";\n\n//if (!process.env.DIY_SUBMIT_ENV_FILEPATH) {\n//  dotenvConfigIfNotBlank({ path: \".env.test\" });\n//} else {\n//  console.log(`Already loaded environment from custom path: ${process.env.DIY_SUBMIT_ENV_FILEPATH}`);\n//}\ndotenvConfigIfNotBlank({ path: \".env\" }); // Not checked in, HMRC API credentials\n\nlet wiremockMode;\nlet wiremockPort;\n\nconst screenshotPath = \"target/behaviour-test-results/screenshots/vat-obligations-behaviour-test\";\n\nconst originalEnv = { ...process.env };\n\nconst envFilePath = getEnvVarAndLog(\"envFilePath\", \"DIY_SUBMIT_ENV_FILEPATH\", null);\nconst envName = getEnvVarAndLog(\"envName\", \"ENVIRONMENT_NAME\", \"local\");\nconst httpServerPort = getEnvVarAndLog(\"serverPort\", \"TEST_SERVER_HTTP_PORT\", 3000);\nconst runTestServer = getEnvVarAndLog(\"runTestServer\", \"TEST_SERVER_HTTP\", null);\nconst runProxy = getEnvVarAndLog(\"runProxy\", \"TEST_PROXY\", null);\nconst runMockOAuth2 = getEnvVarAndLog(\"runMockOAuth2\", \"TEST_MOCK_OAUTH2\", null);\nconst testAuthProvider = getEnvVarAndLog(\"testAuthProvider\", \"TEST_AUTH_PROVIDER\", null);\nconst testAuthUsername = getEnvVarAndLog(\"testAuthUsername\", \"TEST_AUTH_USERNAME\", null);\nconst baseUrl = getEnvVarAndLog(\"baseUrl\", \"DIY_SUBMIT_BASE_URL\", null);\nconst hmrcTestVatNumber = getEnvVarAndLog(\"hmrcTestVatNumber\", \"TEST_HMRC_VAT_NUMBER\", null);\nconst hmrcTestUsername = getEnvVarAndLog(\"hmrcTestUsername\", \"TEST_HMRC_USERNAME\", null);\nconst hmrcTestPassword = getEnvVarAndLog(\"hmrcTestPassword\", \"TEST_HMRC_PASSWORD\", null);\nconst hmrcVatPeriodFromDate = \"2025-01-07\";\nconst hmrcVatPeriodToDate = \"2025-11-01\";\nconst runDynamoDb = getEnvVarAndLog(\"runDynamoDb\", \"TEST_DYNAMODB\", null);\nconst bundleTableName = getEnvVarAndLog(\"bundleTableName\", \"BUNDLE_DYNAMODB_TABLE_NAME\", null);\nconst hmrcApiRequestsTableName = getEnvVarAndLog(\"hmrcApiRequestsTableName\", \"HMRC_API_REQUESTS_DYNAMODB_TABLE_NAME\", null);\nconst receiptsTableName = getEnvVarAndLog(\"receiptsTableName\", \"RECEIPTS_DYNAMODB_TABLE_NAME\", null);\n\nlet mockOAuth2Process;\nlet serverProcess;\nlet ngrokProcess;\nlet dynamoControl;\nlet userSub = null;\nlet observedTraceparent = null;\n\ntest.setTimeout(300_000);\n\ntest.beforeAll(async ({ page }, testInfo) => {\n  console.log(\"Starting beforeAll hook...\");\n\n  if (!envFilePath) {\n    throw new Error(\"Environment variable DIY_SUBMIT_ENV_FILEPATH is not set, assuming no environment; not attempting tests.\");\n  }\n\n  process.env = {\n    ...originalEnv,\n  };\n\n  // Run servers needed for the test\n  dynamoControl = await runLocalDynamoDb(runDynamoDb, bundleTableName, hmrcApiRequestsTableName, receiptsTableName);\n  mockOAuth2Process = await runLocalOAuth2Server(runMockOAuth2);\n  serverProcess = await runLocalHttpServer(runTestServer, httpServerPort);\n  ngrokProcess = await runLocalSslProxy(runProxy, httpServerPort, baseUrl);\n\n  // Clean up any existing artefacts from previous test runs\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n  deleteUserSubTxt(outputDir);\n  deleteHashedUserSubTxt(outputDir);\n  deleteTraceparentTxt(outputDir);\n\n  wiremockMode = process.env.TEST_WIREMOCK || \"off\";\n  wiremockPort = process.env.WIREMOCK_PORT || 9090;\n\n  if (wiremockMode === \"record\" || wiremockMode === \"mock\") {\n    const targets = [];\n    if (process.env.HMRC_BASE_URI) targets.push(process.env.HMRC_BASE_URI);\n    if (process.env.HMRC_SANDBOX_BASE_URI) targets.push(process.env.HMRC_SANDBOX_BASE_URI);\n    await startWiremock({\n      mode: wiremockMode,\n      port: wiremockPort,\n      outputDir: process.env.WIREMOCK_RECORD_OUTPUT_DIR || \"\",\n      targets,\n    });\n    // override HMRC endpoints so the app uses WireMock\n    process.env.HMRC_BASE_URI = `http://localhost:${wiremockPort}`;\n    process.env.HMRC_SANDBOX_BASE_URI = `http://localhost:${wiremockPort}`;\n  }\n\n  console.log(\"beforeAll hook completed successfully\");\n});\n\ntest.afterAll(async () => {\n  // Shutdown local servers at end of test\n  if (ngrokProcess) {\n    ngrokProcess.kill();\n  }\n  if (serverProcess) {\n    serverProcess.kill();\n  }\n  if (mockOAuth2Process) {\n    mockOAuth2Process.kill();\n  }\n  try {\n    await dynamoControl?.stop?.();\n  } catch {}\n  // stop local servers...\n  if (wiremockMode && wiremockMode !== \"off\") {\n    await stopWiremock({ mode: wiremockMode, port: wiremockPort });\n  }\n});\n\ntest.afterEach(async ({ page }, testInfo) => {\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n  appendUserSubTxt(outputDir, testInfo, userSub);\n  appendHashedUserSubTxt(outputDir, testInfo, userSub);\n  appendTraceparentTxt(outputDir, testInfo, observedTraceparent);\n});\n\ntest(\"Click through: View VAT obligations from HMRC\", async ({ page }, testInfo) => {\n  // Compute test URL based on which servers are running\n  const testUrl =\n    (runTestServer === \"run\" || runTestServer === \"useExisting\") && runProxy !== \"run\" && runProxy !== \"useExisting\"\n      ? `http://127.0.0.1:${httpServerPort}/`\n      : baseUrl;\n\n  // Add console logging to capture browser messages\n  addOnPageLogging(page, screenshotPath);\n\n  // ---------- Test artefacts (video-adjacent) ----------\n  const outputDir = testInfo.outputPath(\"\");\n  fs.mkdirSync(outputDir, { recursive: true });\n\n  // Capture the first traceparent header observed in any API response\n  page.on(\"response\", (response) => {\n    try {\n      if (observedTraceparent) return;\n      const headers = response.headers?.() ?? response.headers?.() ?? {};\n      const h = typeof headers === \"function\" ? headers() : headers;\n      const tp = (h && (h[\"traceparent\"] || h[\"Traceparent\"])) || null;\n      if (tp) {\n        observedTraceparent = tp;\n      }\n    } catch (_e) {\n      // ignore header parsing errors\n    }\n  });\n\n  /* ************************* */\n  /* HMRC TEST USER CREATION   */\n  /* ************************* */\n\n  // Variables to hold test credentials (either from env or generated)\n  let testUsername = hmrcTestUsername;\n  let testPassword = hmrcTestPassword;\n  let testVatNumber = hmrcTestVatNumber;\n\n  // If in sandbox mode and credentials are not provided, create a test user\n  if (!hmrcTestUsername) {\n    console.log(\"[HMRC Test User] Sandbox mode detected without full credentials - creating test user\");\n    // Get HMRC client ID from environment (sandbox or default)\n    const hmrcClientId = process.env.HMRC_SANDBOX_CLIENT_ID || process.env.HMRC_CLIENT_ID;\n    const hmrcClientSecret = process.env.HMRC_SANDBOX_CLIENT_SECRET || process.env.HMRC_CLIENT_SECRET;\n\n    if (!hmrcClientId) {\n      console.error(\"[HMRC Test User] No HMRC client ID found in environment. Cannot create test user.\");\n      throw new Error(\"HMRC_SANDBOX_CLIENT_ID or HMRC_CLIENT_ID is required to create test users\");\n    }\n\n    if (!hmrcClientSecret) {\n      console.error(\"[HMRC Test User] No HMRC client secret found in environment. Cannot create test user.\");\n      throw new Error(\"HMRC_SANDBOX_CLIENT_SECRET or HMRC_CLIENT_SECRET is required to create test users\");\n    }\n\n    console.log(\"[HMRC Test User] Creating HMRC sandbox test user with VAT enrolment using client credentials\");\n\n    const testUser = await createHmrcTestUser(hmrcClientId, hmrcClientSecret, {\n      serviceNames: [\"mtd-vat\"],\n    });\n\n    // Extract credentials from the created test user\n    testUsername = testUser.userId;\n    testPassword = testUser.password;\n    testVatNumber = testUser.vrn;\n\n    console.log(\"[HMRC Test User] Successfully created test user:\");\n    console.log(`  User ID: ${testUser.userId}`);\n    console.log(`  User Full Name: ${testUser.userFullName}`);\n    console.log(`  VAT Registration Number: ${testUser.vrn}`);\n    console.log(`  Organisation: ${testUser.organisationDetails?.name || \"N/A\"}`);\n\n    // Save test user details to files\n    const repoRoot = path.resolve(process.cwd());\n    saveHmrcTestUserToFiles(testUser, outputDir, repoRoot);\n\n    // Update environment variables for this test run\n    process.env.TEST_HMRC_USERNAME = testUsername;\n    process.env.TEST_HMRC_PASSWORD = testPassword;\n    process.env.TEST_HMRC_VAT_NUMBER = testVatNumber;\n\n    console.log(\"[HMRC Test User] Updated environment variables with generated credentials\");\n  }\n\n  /* ****** */\n  /*  HOME  */\n  /* ****** */\n\n  await goToHomePageExpectNotLoggedIn(page, testUrl, screenshotPath);\n\n  /* ******* */\n  /*  LOGIN  */\n  /* ******* */\n\n  await clickLogIn(page, screenshotPath);\n  await loginWithCognitoOrMockAuth(page, testAuthProvider, testAuthUsername, screenshotPath);\n  await verifyLoggedInStatus(page, screenshotPath);\n  await consentToDataCollection(page, screenshotPath);\n\n  /* ********* */\n  /*  BUNDLES  */\n  /* ********* */\n\n  await goToBundlesPage(page, screenshotPath);\n  if (isSandboxMode()) {\n    await ensureBundlePresent(page, \"Test\", screenshotPath);\n  }\n  // TODO: Support testing in non-sandbox mode with production credentials\n  if (envName !== \"prod\") {\n    await ensureBundlePresent(page, \"Guest\", screenshotPath);\n    await goToHomePage(page, screenshotPath);\n    await goToBundlesPage(page, screenshotPath);\n  }\n  await goToHomePageUsingHamburgerMenu(page, screenshotPath);\n\n  /* ******************* */\n  /*  GET OBLIGATIONS    */\n  /* ******************* */\n\n  await initVatObligations(page, screenshotPath);\n  await fillInVatObligations(page, testVatNumber, { hmrcVatPeriodFromDate, hmrcVatPeriodToDate }, screenshotPath);\n  await submitVatObligationsForm(page, screenshotPath);\n\n  /* ************ */\n  /* `HMRC AUTH   */\n  /* ************ */\n\n  await acceptCookiesHmrc(page, screenshotPath);\n  await goToHmrcAuth(page, screenshotPath);\n  await initHmrcAuth(page, screenshotPath);\n  await fillInHmrcAuth(page, testUsername, testPassword, screenshotPath);\n  await submitHmrcAuth(page, screenshotPath);\n  await grantPermissionHmrcAuth(page, screenshotPath);\n\n  /* ******************** */\n  /*  VIEW OBLIGATIONS    */\n  /* ******************** */\n\n  await verifyVatObligationsResults(page, screenshotPath);\n  await goToHomePageUsingHamburgerMenu(page, screenshotPath);\n\n  // TODO: When in sandbox mode, trigger each test scenario in turn, going back to home page each time\n\n  /* ****************** */\n  /*  Extract user sub  */\n  /* ****************** */\n\n  userSub = await extractUserSubFromLocalStorage(page, testInfo);\n\n  /* ********* */\n  /*  LOG OUT  */\n  /* ********* */\n\n  await logOutAndExpectToBeLoggedOut(page, screenshotPath);\n\n  /* **************** */\n  /*  EXPORT DYNAMODB */\n  /* **************** */\n\n  // Export DynamoDB tables if dynalite was used\n  if (runDynamoDb === \"run\" || runDynamoDb === \"useExisting\") {\n    console.log(\"[DynamoDB Export]: Starting export of all tables...\");\n    try {\n      const exportResults = await exportAllTables(outputDir, dynamoControl.endpoint, {\n        bundleTableName,\n        hmrcApiRequestsTableName,\n        receiptsTableName,\n      });\n      console.log(\"[DynamoDB Export]: Export completed:\", exportResults);\n    } catch (error) {\n      console.error(\"[DynamoDB Export]: Failed to export tables:\", error);\n    }\n  }\n\n  /* ********************************** */\n  /*  ASSERT DYNAMODB HMRC API REQUESTS */\n  /* ********************************** */\n\n  // Assert that HMRC API requests were logged correctly\n  if (runDynamoDb === \"run\") {\n    const hmrcApiRequestsFile = path.join(outputDir, \"hmrc-api-requests.jsonl\");\n\n    // Assert OAuth token exchange request exists\n    const oauthRequests = assertHmrcApiRequestExists(hmrcApiRequestsFile, \"POST\", \"/oauth/token\", \"OAuth token exchange\");\n    console.log(`[DynamoDB Assertions]: Found ${oauthRequests.length} OAuth token exchange request(s)`);\n\n    // Assert VAT obligations GET request exists and validate key fields\n    const obligationsRequests = assertHmrcApiRequestExists(\n      hmrcApiRequestsFile,\n      \"GET\",\n      `/organisations/vat/${testVatNumber}/obligations`,\n      \"VAT obligations retrieval\",\n    );\n    console.log(`[DynamoDB Assertions]: Found ${obligationsRequests.length} VAT obligations GET request(s)`);\n\n    if (obligationsRequests.length > 0) {\n      const obligationsRequest = obligationsRequests[0];\n      // Assert that the response is successful\n      assertHmrcApiRequestValues(obligationsRequest, {\n        \"httpRequest.method\": \"GET\",\n        \"httpResponse.statusCode\": 200,\n      });\n\n      // Check that response body contains obligations data\n      const responseBody = obligationsRequest.httpResponse.body;\n      expect(responseBody).toBeDefined();\n      expect(responseBody.obligations).toBeDefined();\n      console.log(\"[DynamoDB Assertions]: VAT obligations response validated successfully\");\n    }\n\n    // Assert consistent hashedSub across authenticated requests\n    const hashedSubs = assertConsistentHashedSub(hmrcApiRequestsFile, \"VAT Obligations test\");\n    console.log(`[DynamoDB Assertions]: Found ${hashedSubs.length} unique hashedSub value(s): ${hashedSubs.join(\", \")}`);\n  }\n\n  /* ****************** */\n  /*  FIGURES (SCREENSHOTS) */\n  /* ****************** */\n\n  // Select and copy key screenshots, then generate figures.json\n  const { selectKeyScreenshots, copyScreenshots, generateFiguresMetadata, writeFiguresJson } = await import(\"./helpers/figures-helper.js\");\n\n  const keyScreenshotPatterns = [\n    \"init.*vat.*obligation\", // VAT obligations form\n    \"fill.*vat.*obligation\", // VAT obligations form filled\n    \"hmrc.*auth\", // HMRC authorization screen\n    \"verify.*vat.*obligation.*result\", // VAT obligations results\n    \"vat.*obligation.*result\", // Alternative obligations results pattern\n  ];\n\n  const screenshotDescriptions = {\n    \"init.*vat.*obligation\": \"VAT obligations form initial state ready for user input\",\n    \"fill.*vat.*obligation\": \"VAT obligations form filled with VAT number and date range parameters\",\n    \"hmrc.*auth\": \"HMRC authorization page where user grants permission to access VAT obligations data\",\n    \"verify.*vat.*obligation.*result\": \"VAT obligations results page displaying retrieved obligation periods and their status\",\n    \"vat.*obligation.*result\": \"Retrieved VAT obligations showing due dates and submission deadlines\",\n  };\n\n  const selectedScreenshots = selectKeyScreenshots(screenshotPath, keyScreenshotPatterns, 5);\n  console.log(`[Figures]: Selected ${selectedScreenshots.length} key screenshots from ${screenshotPath}`);\n\n  const copiedScreenshots = copyScreenshots(screenshotPath, outputDir, selectedScreenshots);\n  console.log(`[Figures]: Copied ${copiedScreenshots.length} screenshots to ${outputDir}`);\n\n  const figures = generateFiguresMetadata(copiedScreenshots, screenshotDescriptions);\n  writeFiguresJson(outputDir, figures);\n\n  /* ****************** */\n  /*  TEST CONTEXT JSON */\n  /* ****************** */\n\n  // Build and write testContext.json\n  const testContext = {\n    name: testInfo.title,\n    title: \"View VAT Obligations (HMRC: VAT Obligations GET)\",\n    description: \"Retrieves VAT obligations from HMRC MTD VAT API and verifies the results flow in the UI.\",\n    hmrcApis: [\n      {\n        url: \"/api/v1/hmrc/vat/obligation\",\n        method: \"GET\",\n      },\n    ],\n    env: {\n      envName,\n      baseUrl,\n      serverPort: httpServerPort,\n      runTestServer,\n      runProxy,\n      runMockOAuth2,\n      testAuthProvider,\n      testAuthUsername,\n      bundleTableName,\n      hmrcApiRequestsTableName,\n      receiptsTableName,\n      runDynamoDb,\n    },\n    testData: {\n      hmrcTestVatNumber: testVatNumber,\n      hmrcTestUsername: testUsername,\n      hmrcTestPassword: testPassword ? \"***MASKED***\" : \"<not provided>\", // Mask password in test context\n      hmrcVatPeriodFromDate,\n      hmrcVatPeriodToDate,\n      testUserGenerated: isSandboxMode() && !hmrcTestUsername,\n      userSub,\n      observedTraceparent,\n      testUrl,\n      isSandboxMode: isSandboxMode(),\n    },\n    artefactsDir: outputDir,\n    screenshotPath,\n    testStartTime: new Date().toISOString(),\n  };\n  try {\n    fs.writeFileSync(path.join(outputDir, \"testContext.json\"), JSON.stringify(testContext, null, 2), \"utf-8\");\n  } catch (_e) {}\n});\n"
  },
  "envConfig": {
    "filename": ".env.proxy",
    "content": "# .env.proxy\n#\n# Features:\n#   Proxy configuration which uses ngrok (and expects to be authenticated).\n#   HMRC Test API.\n#   DynamoDB (like) storage.\n#   Mock OAuth2 server.\nDIY_SUBMIT_ENV_FILEPATH=.env.proxy\nDOTENV_CONFIG_QUIET=true\nENVIRONMENT_NAME=proxy\nDEPLOYMENT_NAME=proxy\nDIY_SUBMIT_BASE_URL=https://wanted-finally-anteater.ngrok-free.app/\n\nLOG_TO_CONSOLE=true\nLOG_TO_FILE=true\nCLOUD_TRAIL_ENABLED=\n\n# TODO: Find a way to have a local ssl termination for proxy host\n# TODO: Switch to this to avoid the 301 redirects during testing: https://test-www.tax.service.gov.uk/oauth/authorize?response_type=code&client_id=uqMHA6RsDGGa7h8EG2VqfqAmv4tV&redirect_uri=https%3A%2F%2Fwanted-finally-anteater.ngrok-free.app%2Factivities%2FsubmitVatCallback.html&scope=read%3Avat&state=91b3946b6b544ec682b7b48dda3bb935\n# TODO: Replace usages of HMRC_BASE_URI with either the mapped or egress URL as appropriate\nHMRC_BASE_URI=https://test-api.service.hmrc.gov.uk\nHMRC_API_PROXY_MAPPED_URL=http://localhost:3000/proxy/hmrc-api\nHMRC_API_PROXY_EGRESS_URL=https://test-api.service.hmrc.gov.uk\nHMRC_CLIENT_ID=uqMHA6RsDGGa7h8EG2VqfqAmv4tV\nHMRC_SANDBOX_BASE_URI=https://test-api.service.hmrc.gov.uk\nHMRC_SANDBOX_API_PROXY_MAPPED_URL=http://localhost:3000/proxy/test-hmrc-api\nHMRC_SANDBOX_API_PROXY_EGRESS_URL=https://test-api.service.hmrc.gov.uk\nHMRC_SANDBOX_CLIENT_ID=uqMHA6RsDGGa7h8EG2VqfqAmv4tV\nGOOGLE_CLIENT_SECRET_ARN=\nHMRC_CLIENT_SECRET_ARN=\nHMRC_SANDBOX_CLIENT_SECRET_ARN=\nCOGNITO_USER_POOL_ID=\nCOGNITO_CLIENT_ID=\nCOGNITO_BASE_URI=\nBUNDLE_DYNAMODB_TABLE_NAME=test-bundle-table\nRECEIPTS_DYNAMODB_TABLE_NAME=test-receipts-table\nHMRC_API_REQUESTS_DYNAMODB_TABLE_NAME=test-hmrc-api-requests-table\nACCESS_LOG_GROUP_RETENTION_PERIOD_DAYS=\nS3_RETAIN_RECEIPTS_BUCKET=\n\nPROXY_RATE_LIMIT_PER_SECOND=100\nPROXY_BREAKER_ERROR_THRESHOLD=20\nPROXY_BREAKER_LATENCY_MS=10000\nPROXY_BREAKER_COOLDOWN_SECONDS=30\n\nTEST_SERVER_HTTP_PORT=3000\nTEST_SERVER_HTTP=run\nTEST_PROXY=run\nTEST_MOCK_OAUTH2=run\nTEST_AUTH_PROVIDER=mock\nTEST_AUTH_USERNAME=user\nTEST_AUTH_PASSWORD=\nTEST_DYNAMODB=run\n\nTEST_BUNDLE_EXPIRY_DATE=2025-12-31\nTEST_BUNDLE_USER_LIMIT=1000\nTEST_BUNDLE_MOCK=true\nTEST_VAT_OBLIGATIONS={}\nTEST_VAT_RETURN={}\n\n#TEST_WIREMOCK=record\n#TEST_WIREMOCK=mock\nWIREMOCK_MOCK_ENVIRONMENT=proxy\nWIREMOCK_PORT=9090\nWIREMOCK_RECORD_OUTPUT_DIR=wiremock-recordings/proxy\n"
  },
  "artifacts": {
    "screenshots": [
      "2025-12-05_23-38-11-285754062-03-home-page.png",
      "2025-12-05_23-38-38-790851208-01-init-hmrc-auth.png",
      "2025-12-05_23-38-14-196189786-01-submit-mock.png",
      "2025-12-05_23-38-45-650327109-01-obligations-results.png",
      "2025-12-05_23-38-46-733279592-04-home.png"
    ],
    "videos": ["video.webm"],
    "figures": [
      {
        "filename": "2025-12-05_23-38-11-285754062-03-home-page.png",
        "order": 1,
        "description": "Screenshot captured during test execution",
        "caption": "05 23 38 11 285754062 03 Home Page"
      },
      {
        "filename": "2025-12-05_23-38-38-790851208-01-init-hmrc-auth.png",
        "order": 2,
        "description": "HMRC authorization page where user grants permission to access VAT obligations data",
        "caption": "05 23 38 38 790851208 01 Init Hmrc Auth"
      },
      {
        "filename": "2025-12-05_23-38-14-196189786-01-submit-mock.png",
        "order": 3,
        "description": "Screenshot captured during test execution",
        "caption": "05 23 38 14 196189786 01 Submit Mock"
      },
      {
        "filename": "2025-12-05_23-38-45-650327109-01-obligations-results.png",
        "order": 4,
        "description": "Screenshot captured during test execution",
        "caption": "05 23 38 45 650327109 01 Obligations Results"
      },
      {
        "filename": "2025-12-05_23-38-46-733279592-04-home.png",
        "order": 5,
        "description": "Screenshot captured during test execution",
        "caption": "05 23 38 46 733279592 04 Home"
      }
    ]
  }
}
