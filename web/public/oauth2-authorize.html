<!-- oauth2-authorize.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./submit.css" />
    <title>Hand off to Mock OAuth</title>
  </head>
  <body>
    <header>
      <div class="header-nav"></div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Hand off to Mock OAuth server...</p>
    </header>

    <div id="mainContent">
      <!-- Status messages -->
      <div id="statusMessagesContainer"></div>

      <!-- mock-oauth2-server Auth Provider (Enabled) -->
      <div class="auth-provider">
        <button type="button" class="btn auth-btn" id="mockOAuth2Button">
          <img
            src="https://avatars.githubusercontent.com/u/11848947?s=48&v=4"
            alt="navikt/mock-oauth2-server"
            class="provider-logo"
          />
          Hand off to mock-oauth2-server
        </button>
      </div>
    </div>

    <script src="./submit.js"></script>
    <script>
      // Check for OAuth callback parameters and redirect to submitVat.html if found
      //const urlParams = new URLSearchParams(window.location.search);
      //const code = urlParams.get("code");
      //const state = urlParams.get("state");
      //const error = urlParams.get("error");

      //if (code || error) {
      // OAuth callback detected, redirect to submitVat.html with parameters
      //  console.log('OAuth callback detected on home page, redirecting to submitVat.html');
      //  window.location.href = 'submitVat.html' + window.location.search;
      //}

      // Authentication status management

      // Login with Mock OAuth2 Server via Cognito
      //    docker run -p 8080:8080 ghcr.io/navikt/mock-oauth2-server:2.2.0
      async function handOffToMockOAuth2() {
        console.log("Hand off to navikt/mock-oauth2-server");

        // Generate state parameter for security
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        // Get OAuth URL
        const authResponse = await getAuthUrl(state, "mock");
        const authUrl = authResponse.authUrl;

        // Build Cognito OAuth URL see: http://localhost:8080/default/debugger
        //`redirect_uri=${encodeURIComponent("http://127.0.0.1:3000/loginCallback.html")}&` +
        //const authUrl = `http://localhost:8080/oauth/authorize?` +
        //        `response_type=code&` +
        //        `client_id=debugger&` +
        //        `redirect_uri=${encodeURIComponent("loginCallback.html")}&` +
        //        `scope=${encodeURIComponent("openid somescope")}&` +
        //        `state=${state}&` +
        //        `identity_provider=MockOAuth2Server`;

        showStatus(`Handing off to ${authUrl}`, "info");
        console.log("Redirecting to navikt/mock-oauth2-server");
        //(async function() { await sleep(1000); })();
        //sleep(1000);
        window.location.href = authUrl;
      }

      // Register click action
      const mockOAuth2Button = document.getElementById("mockOAuth2Button");
      mockOAuth2Button.addEventListener("click", async (event) => {
        event.preventDefault(); // Prevent default button action
        await handOffToMockOAuth2();
      });

      //function sleep(ms) {
      //(async function() { await new Promise(resolve => setTimeout(resolve, ms)); })();
      //return new Promise(resolve => setTimeout(resolve, ms));
      //}
    </script>
  </body>
</html>
