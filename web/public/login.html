<!-- login.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="submit.css" />
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">â˜°</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="index.html">Home</a>
            <a href="receipts.html">Receipts</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="index.html" class="login-link">Home</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div class="form-container" style="text-align: center">
        <h2>Login</h2>
        <p>Choose your authentication provider to continue:</p>

        <div class="auth-providers">
          <!-- Google Auth Provider (Enabled) -->
          <div class="auth-provider">
            <button type="button" class="btn auth-btn google-btn" id="loginWithGoogle">
              <img src="./brand/proprietary/g-logo.png" alt="Google" class="provider-logo" />
              Continue with Google
            </button>
          </div>

          <!-- mock-oauth2-server Auth Provider (Enabled) -->
          <div class="auth-provider" id="mockOAuth2Provider">
            <button type="button" class="btn auth-btn" onclick="loginWithMockOAuth2()">
              <img
                src="https://avatars.githubusercontent.com/u/11848947?s=48&v=4"
                alt="navikt/mock-oauth2-server"
                class="provider-logo"
              />
              Continue with mock-oauth2-server
            </button>
          </div>

          <!-- Facebook Auth Provider (Disabled) -->
          <!--div class="auth-provider disabled">
            <button type="button" class="btn auth-btn disabled-btn" disabled>
              <img
                src="https://static.xx.fbcdn.net/rsrc.php/v3/yX/r/Kvo5FesWVKX.png"
                alt="Facebook"
                class="provider-logo"
              />
              Continue with Facebook
            </button>
            <p class="coming-soon-text">Coming soon</p>
          </div-->
        </div>

      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
      </div>
    </footer>

    <script src="./submit.js"></script>
    <script src="./localstorage-viewer.js"></script>
    <script>
      // Hamburger menu toggle functionality
      function toggleMenu() {
        const dropdown = document.getElementById("menuDropdown");
        dropdown.classList.toggle("show");
      }

      // Load and display view source link
      async function loadViewSourceLink() {
        try {
          const response = await fetch("source.txt");
          if (response.ok) {
            const commitHash = (await response.text()).trim();
            if (commitHash) {
              const currentPage = window.location.pathname.split("/").pop() || "index.html";
              const githubUrl = `https://github.com/antonycc/submit.diyaccounting.co.uk/blob/${commitHash}/web/public/${currentPage}`;
              const viewSourceLink = document.getElementById("viewSourceLink");
              viewSourceLink.href = githubUrl;
              viewSourceLink.target = "_blank";
              viewSourceLink.textContent = `source: ${currentPage}@${commitHash.substring(0, 7)}`;
              viewSourceLink.style.display = "inline";
            }
          }
        } catch (error) {
          console.log("Could not load source.txt:", error);
        }
      }

      // Login with Google via Cognito
      async function loginWithGoogle() {
        console.log("Initiating Google login via Cognito");

        console.log("Clear stored tokens and user info");
        localStorage.removeItem("authState");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Generate state parameter for security
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        // Get OAuth URL
        const authResponse = await getAuthUrl(state, "google");
        const authResponseUrl = authResponse.authUrl;

        console.log("Redirecting to Google OAuth URL");
        window.location.href = authResponseUrl;
      }

      // Login with Mock OAuth2 Server via Cognito
      function loginWithMockOAuth2() {
        console.log("Initiating navikt/mock-oauth2-server login via Cognito");

        console.log("Clear stored tokens and user info");
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Generate state parameter for security
        const state = Math.random().toString(36).substring(2, 15);
        localStorage.setItem("authState", state);

        // Build Cognito OAuth URL
        const authUrl =
          `./oauth2-authorize.html?` +
          `response_type=code&` +
          `client_id=test-client&` +
          `redirect_uri=${encodeURIComponent("loginWithGoogleCallback.html")}&` +
          `scope=${encodeURIComponent("test")}&` +
          `state=${state}&` +
          `identity_provider=MockOAuth2Server`;

        console.log("Redirecting to Cognito OAuth URL");
        window.location.href = authUrl;
      }

      // Update login status display
      function updateLoginStatus() {
        const userInfo = localStorage.getItem("userInfo");
        const loginStatusElement = document.querySelector(".login-status");
        const loginLinkElement = document.querySelector(".login-link");

        if (userInfo) {
          const user = JSON.parse(userInfo);
          const userLabel = user.email ? user.email : user.sub;
          console.log("User info:", user);
          console.log("User label:", userLabel);
          loginStatusElement.textContent = `Logged in as ${userLabel}`;
          loginLinkElement.textContent = "Logout";
          loginLinkElement.href = "#";
          loginLinkElement.onclick = logout;
        } else {
          loginStatusElement.textContent = "Not logged in";
          loginLinkElement.textContent = "Home";
          loginLinkElement.href = "index.html";
          loginLinkElement.onclick = null;
        }
      }

      // Logout function
      function logout() {
        console.log("Logging out user");

        // Clear stored tokens and user info
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Update login status
        updateLoginStatus();

        // Redirect to Cognito logout URL
        const logoutUrl =
          `https://${COGNITO_CONFIG.domain}/logout?` +
          `client_id=${COGNITO_CONFIG.clientId}&` +
          `logout_uri=${encodeURIComponent(window.location.origin + "/")}`;

        window.location.href = logoutUrl;
      }

      // Check if user is already logged in
      function checkExistingAuth() {
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const userInfo = localStorage.getItem("userInfo");

        if (accessToken && userInfo) {
          console.log("User already authenticated");
          updateLoginStatus();

          // Optionally redirect to bundles page if already logged in
          // window.location.href = 'bundles.html';
        }
      }

      // DOM elements
      const loginWithGoogleButton = document.getElementById("loginWithGoogle");

      // Event listeners
      loginWithGoogleButton.onclick = loginWithGoogle;

      // Close menu when clicking outside
      window.onclick = function (event) {
        if (!event.target.matches(".hamburger-btn")) {
          const dropdown = document.getElementById("menuDropdown");
          if (dropdown.classList.contains("show")) {
            dropdown.classList.remove("show");
          }
        }
      };

      localStorage.removeItem("currentActivity");
      console.log("Current activity cleared");

      // Initialize authentication on page load
      checkExistingAuth();

      // Load view source link on page load
      loadViewSourceLink();
    </script>

    <script>
      // Hide the section if the page wasn't served from specific domains
      const allowedDomains = ["127.0.0.1", "localhost", "wanted-finally-anteater.ngrok-free.app"];
      const currentDomain = window.location.hostname;

      if (!allowedDomains.includes(currentDomain)) {
        document.querySelectorAll('#mockOAuth2Provider').forEach(element => {
          element.style.display = 'none';
        });
      }
    </script>
  </body>
</html>
