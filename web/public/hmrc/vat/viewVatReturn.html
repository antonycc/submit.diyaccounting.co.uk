<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>View VAT Return - DIY Accounting Submit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../../submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
    <!-- HEAD-prefetch to help mitigate API cold starts for this page's calls -->
    <!--script async src="../../prefetch/prefetch-hmrc-authurl-head.js"></script-->
    <!--script async src="../../prefetch/prefetch-hmrc-vat-return-get-head.js"></script-->
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()" aria-label="Open navigation menu" aria-expanded="false">☰</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="../../index.html">Home</a>
            <a href="../../account/bundles.html">Bundles</a>
            <a href="../receipt/receipts.html">Receipts</a>
            <a href="../../guide/index.html">User Guide</a>
            <a href="../../help/index.html">Help</a>
            <a href="../../about.html">About</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="../../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>View VAT Return</h1>
      <p class="subtitle">View submitted VAT return details</p>
    </header>

    <main id="mainContent">
      <div id="sandboxIndicator" class="sandbox-indicator">⚠️ SANDBOX MODE - Using HMRC Test API</div>

      <div id="testDataLink" class="test-data-link">
        <a
          href="#"
          onclick="
            event.preventDefault();
            window.testDataGenerator.populateViewVatReturnForm();
          "
          >add test data</a
        >
      </div>

      <div id="statusMessagesContainer" role="alert" aria-live="polite"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <!-- Search Form -->
      <div class="form-toggle-buttons">
        <button type="button" id="toggleFormBtn" class="secondary-button" style="display: none">
          Show Search Form
        </button>
        <button type="button" id="cancelRequestBtn" class="cancel-button" style="display: none">
          Cancel Request
        </button>
      </div>
      <div id="searchForm" class="form-container">
        <h2>Retrieve VAT Return</h2>
        <form id="vatReturnForm">
          <div class="form-group">
            <label for="vrn">VAT registration number</label>
            <p id="vrn-hint" class="hint">
              This is 9 numbers, sometimes with 'GB' at the start, for example
              123456789 or GB123456789. You can find it on your VAT registration certificate.
            </p>
            <input
              type="text"
              id="vrn"
              name="vrn"
              required
              value=""
              placeholder="e.g., 983238295"
              maxlength="9"
              pattern="[0-9]{9}"
              aria-describedby="vrn-hint"
              spellcheck="false"
            />
          </div>

          <div class="form-group">
            <label>VAT period</label>
            <p id="periodDates-hint" class="hint">Enter the start and end dates of the VAT period you want to view</p>
            <div class="period-date-inputs" style="display: flex; gap: 1em; flex-wrap: wrap;">
              <div>
                <label for="periodStart">Period start</label>
                <input
                  type="date"
                  id="periodStart"
                  name="periodStart"
                  required
                  aria-describedby="periodDates-hint"
                />
              </div>
              <div>
                <label for="periodEnd">Period end</label>
                <input
                  type="date"
                  id="periodEnd"
                  name="periodEnd"
                  required
                  aria-describedby="periodDates-hint"
                />
              </div>
            </div>
            <!-- Hidden fields for backwards compatibility -->
            <input type="hidden" id="periodKey" name="periodKey" value="" />
          </div>

          <!-- Developer Test Scenario Section -->
          <div id="developerSection" class="form-group" style="display: none">
            <label for="testScenario">Test scenario (Developer/Sandbox only)</label>
            <p id="testScenario-hint" class="hint">Test different HMRC sandbox scenarios</p>
            <select id="testScenario" name="testScenario" aria-describedby="testScenario-hint">
              <option value="">Default</option>
              <!-- Values aligned with _developers/reference/hmrc-mtd-vat-api-1.0.yaml (GET /organisations/vat/{vrn}/returns/{periodKey}) -->
              <option value="DATE_RANGE_TOO_LARGE">Date Range Too Large</option>
              <option value="INSOLVENT_TRADER">Insolvent Trader</option>
              <option value="SUBMIT_API_HTTP_500">Submit API responds with 500</option>
              <option value="SUBMIT_HMRC_API_HTTP_500">HMRC API responds with 500</option>
              <option value="SUBMIT_HMRC_API_HTTP_503">HMRC API responds with 503</option>
              <option value="SUBMIT_HMRC_API_HTTP_SLOW_10S">HMRC API responds slowly</option>
            </select>
            <div style="margin-top: 10px">
              <input type="checkbox" id="runFraudPreventionHeaderValidation" name="runFraudPreventionHeaderValidation" />
              <label for="runFraudPreventionHeaderValidation" style="display: inline; font-weight: normal"
                >Validate Fraud Prevention Headers</label
              >
            </div>
          </div>

          <button type="submit" id="retrieveBtn" class="btn">View Return</button>
        </form>

        <div class="developer-controls">
          <button type="button" id="toggleDeveloperMode" class="developer-button">Show Developer Options</button>
        </div>
      </div>

      <!-- Results Display -->
      <div id="returnResults" class="results-container" style="display: none">
        <h3>VAT Return Details</h3>
        <div id="returnDetails"></div>
        <div class="button-group">
          <button type="button" id="newSearchBtn" class="secondary-button">View Another Return</button>
          <button type="button" id="backToObligationsBtn" class="secondary-button">Back to Obligations</button>
        </div>
      </div>

      <!-- Navigation Button -->
      <div class="navigation-container" style="text-align: center; margin-top: 2em">
        <button type="button" class="btn" id="homePageBtn" onclick="window.location.href = '../../index.html'">Return to Home</button>
        <button type="button" class="btn" id="receiptsPageBtn" onclick="window.location.href = '../receipt/receipts.html'">
          My Receipts
        </button>
      </div>
    </main>

    <footer>
      <div class="footer-left">
        <a href="#" id="viewSourceLink" style="display: none">view source</a>
        <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
        <a id="apiDocsLink" style="display: inline" target="_blank" href="./docs/index.html"> api </a>
      </div>
      <div class="footer-content">
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
      </div>
    </footer>

    <script src="../../lib/env-loader.js"></script>
    <script src="../../lib/auth-url-builder.js"></script>
    <script src="../../lib/test-data-generator.js"></script>
    <script type="module" src="../../submit.js"></script>
    <script src="../../lib/request-cache.js"></script>
    <script src="../../lib/toml-parser.js"></script>
    <script src="../../widgets/hamburger-menu.js"></script>
    <script src="../../widgets/entitlement-status.js"></script>
    <script src="../../widgets/auth-status.js"></script>
    <script src="../../widgets/status-messages.js"></script>
    <script>
      (async function () {
        try {
          await window.loadEnv();
        } catch (err) {
          console.warn("Failed to load environment:", err);
        }
      })();

      // Date formatting utilities (inline version for non-module context)
      const DateUtils = {
        formatDateRange(start, end) {
          const startDate = new Date(start);
          const endDate = new Date(end);
          const dateOptions = { day: "numeric", month: "short", year: "numeric" };
          return `${startDate.toLocaleDateString("en-GB", dateOptions)} to ${endDate.toLocaleDateString("en-GB", dateOptions)}`;
        }
      };

      // Global variables
      let returnData = null;

      // Check if we're in sandbox/test mode to show developer options
      async function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const vrn = urlParams.get("vrn");
        const periodStart = urlParams.get("periodStart");
        const periodEnd = urlParams.get("periodEnd");
        const hmrcAccount = urlParams.get("hmrcAccount");

        if (vrn) {
          document.getElementById("vrn").value = vrn;
        }
        if (periodStart) {
          document.getElementById("periodStart").value = periodStart;
        }
        if (periodEnd) {
          document.getElementById("periodEnd").value = periodEnd;
        }

        // Show sandbox indicator if hmrcAccount=sandbox
        if (hmrcAccount === "sandbox") {
          const sandboxIndicator = document.getElementById("sandboxIndicator");
          if (sandboxIndicator) {
            sandboxIndicator.classList.add("visible");
          }
          const testDataLink = document.getElementById("testDataLink");
          if (testDataLink) {
            testDataLink.classList.add("visible");
          }
        }

        // Toggle developer mode button
        const toggleBtn = document.getElementById("toggleDeveloperMode");
        const devSection = document.getElementById("developerSection");

        if (toggleBtn && devSection) {
          toggleBtn.addEventListener("click", () => {
            const isVisible = devSection.style.display !== "none";
            devSection.style.display = isVisible ? "none" : "block";
            toggleBtn.textContent = isVisible ? "Show Developer Options" : "Hide Developer Options";
          });
        }
      }

      // Form visibility management
      let formHidden = false;

      function hideForm() {
        const container = document.getElementById("searchForm");
        const toggleBtn = document.getElementById("toggleFormBtn");
        const cancelBtn = document.getElementById("cancelRequestBtn");
        if (container && toggleBtn) {
          container.style.display = "none";
          toggleBtn.style.display = "inline-block";
          if (cancelBtn) cancelBtn.style.display = "inline-block";
          formHidden = true;
        }
      }

      function showForm() {
        const container = document.getElementById("searchForm");
        const toggleBtn = document.getElementById("toggleFormBtn");
        const cancelBtn = document.getElementById("cancelRequestBtn");
        if (container && toggleBtn) {
          container.style.display = "block";
          toggleBtn.style.display = "none";
          if (cancelBtn) cancelBtn.style.display = "none";
          formHidden = false;
        }
      }

      function cancelRequest() {
        // Clear all in-progress session data
        sessionStorage.removeItem("pendingReturnRequest");
        sessionStorage.removeItem("hmrcAccessToken");
        sessionStorage.removeItem("oauth_state");
        sessionStorage.removeItem("hmrcAccount");
        sessionStorage.removeItem("currentActivity");

        // Show form and hide results
        showForm();
        document.getElementById("returnResults").style.display = "none";
        hideStatus();
        console.log("Request cancelled, session data cleared");
      }

      // OAuth callback handling
      function handleOAuthCallback() {
        const accessToken = sessionStorage.getItem("hmrcAccessToken");
        if (accessToken) {
          console.log("OAuth callback handler (accessToken found)");
          // If we have an access token, retrieve stored parameters and execute the call
          continueReturnRetrieval();
        } else {
          console.log("OAuth callback handler (no accessToken found)");
        }
      }

      async function continueReturnRetrieval() {
        try {
          const accessToken = sessionStorage.getItem("hmrcAccessToken");
          const pendingRequest = JSON.parse(sessionStorage.getItem("pendingReturnRequest") || "null");

          if (!pendingRequest) {
            console.log("No pending return request found");
            // Don't clear token - it might be valid from VAT submission
            // Let form submission use it directly
            return;
          }

          console.log("Retrieved pending request:", pendingRequest);
          // Hide form while retrieving
          hideForm();
          showLoading();
          showStatus("Retrieving VAT return...", "info");

          // Restore form values
          if (pendingRequest.vrn) document.getElementById("vrn").value = pendingRequest.vrn;
          if (pendingRequest.periodStart) document.getElementById("periodStart").value = pendingRequest.periodStart;
          if (pendingRequest.periodEnd) document.getElementById("periodEnd").value = pendingRequest.periodEnd;
          if (pendingRequest.testScenario) document.getElementById("testScenario").value = pendingRequest.testScenario;
          if (pendingRequest.runFraudPreventionHeaderValidation)
            document.getElementById("runFraudPreventionHeaderValidation").checked = pendingRequest.runFraudPreventionHeaderValidation;

          // Build query parameters - use date range instead of periodKey
          const params = new URLSearchParams({
            vrn: pendingRequest.vrn,
            periodStart: pendingRequest.periodStart,
            periodEnd: pendingRequest.periodEnd,
          });
          if (pendingRequest.testScenario) params.append("Gov-Test-Scenario", pendingRequest.testScenario);
          if (pendingRequest.runFraudPreventionHeaderValidation) params.append("runFraudPreventionHeaderValidation", "true");
          if (pendingRequest.allowSandboxObligations) params.append("allowSandboxObligations", "true");

          // Get Gov-Client headers
          const govClientHeaders = await getGovClientHeaders();

          const requestHeaders = {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json",
            ...govClientHeaders,
          };

          // Add hmrcAccount header if present in URL
          const urlParams = new URLSearchParams(window.location.search);
          const hmrcAccount = urlParams.get("hmrcAccount");
          if (hmrcAccount) {
            requestHeaders["hmrcAccount"] = hmrcAccount;
          }

          const response = await window.authorizedFetch(`/api/v1/hmrc/vat/return?${params}`, {
            method: "GET",
            headers: {
              ...requestHeaders,
              "x-wait-time-ms": "0",
            },
            pollPendingMessage: "Still processing...",
            pollSuccessMessage: "VAT return retrieved.",
            pollErrorMessage: "Failed to retrieve VAT return.",
          });

          const result = await response.json();

          if (!response.ok) {
            // Handle 401 specifically to trigger re-authentication
            if (response.status === 401) {
              sessionStorage.removeItem("hmrcAccessToken");
              showStatus("Access token expired. Please re-authenticate.", "error");
              return;
            }
            throw new Error(result.message || "Failed to retrieve VAT return");
          }

          // Display results - add period dates for display
          result.periodStart = pendingRequest.periodStart;
          result.periodEnd = pendingRequest.periodEnd;
          displayReturn(result);
          document.getElementById("returnResults").style.display = "block";
          document.getElementById("searchForm").style.display = "none";
          hideStatus();

          // Clean up session storage - keep token for subsequent HMRC operations
          sessionStorage.removeItem("currentActivity");
          sessionStorage.removeItem("pendingReturnRequest");
          // Keep hmrcAccessToken for subsequent operations (obligations, submit return)
          sessionStorage.removeItem("oauth_state");
          // Keep hmrcAccount for subsequent operations
          console.log("Return retrieval completed successfully");
        } catch (error) {
          console.error("Error retrieving VAT return:", error);
          showStatus(`Failed to retrieve return: ${error.message}`, "error");
          // Auto-expand form on error so user can retry
          showForm();
          // Clear pending request data to prevent auto-retry loop on next page load
          sessionStorage.removeItem("pendingReturnRequest");
          sessionStorage.removeItem("hmrcAccessToken");
          sessionStorage.removeItem("oauth_state");
          sessionStorage.removeItem("hmrcAccount");
          sessionStorage.removeItem("currentActivity");
          console.log("Return retrieval failed, cleared session storage to prevent retry loop");
        } finally {
          hideLoading();
        }
      }

      // Handle form submission
      async function handleFormSubmission(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const vrn = formData.get("vrn").trim();
        const periodStart = formData.get("periodStart");
        const periodEnd = formData.get("periodEnd");
        const testScenario = formData.get("testScenario");
        const runFraudPreventionHeaderValidation = document.getElementById("runFraudPreventionHeaderValidation")?.checked || false;

        // Basic validation
        if (!vrn || !periodStart || !periodEnd) {
          showStatus("Please enter your VAT registration number and VAT period start and end dates.", "error");
          return;
        }

        if (!/^\d{9}$/.test(vrn)) {
          showStatus("VAT number must be exactly 9 digits.", "error");
          return;
        }

        // Check if we have an access token
        const accessToken = sessionStorage.getItem("hmrcAccessToken");

        // Check hmrcAccount for sandbox mode
        const urlParams = new URLSearchParams(window.location.search);
        const hmrcAccount = urlParams.get("hmrcAccount") || sessionStorage.getItem("hmrcAccount");
        const allowSandboxObligations = hmrcAccount === "sandbox";

        if (!accessToken) {
          try {
            showLoading();
            showStatus("Initiating HMRC authentication...", "info");

            // Store request parameters and generate state
            const state = generateRandomState();
            const requestData = {
              vrn,
              periodStart,
              periodEnd,
              testScenario,
              runFraudPreventionHeaderValidation,
              allowSandboxObligations,
            };

            const currentActivity = `${location.pathname}`;

            sessionStorage.setItem("oauth_state", state);
            sessionStorage.setItem("pendingReturnRequest", JSON.stringify(requestData));
            sessionStorage.setItem("currentActivity", currentActivity);
            if (hmrcAccount === "sandbox") {
              sessionStorage.setItem("hmrcAccount", hmrcAccount);
            } else {
              sessionStorage.removeItem("hmrcAccount");
            }
            console.log("Stored pending request and current activity:", requestData, currentActivity, hmrcAccount);

            // Get OAuth URL with read-only scope
            let authResponseUrl;
            if (window.__env && window.authUrlBuilder) {
              authResponseUrl = window.authUrlBuilder.buildHmrcAuthUrl(state, "read:vat", hmrcAccount || "live");
              console.log("Using client-side generated HMRC Auth URL:", authResponseUrl);
            } else {
              // Get OAuth URL from API (fallback)
              const authResponse = await getAuthUrl(state, "hmrc", "read:vat");
              authResponseUrl = authResponse.authUrl;
              console.log("Using server-side HMRC Auth URL:", authResponseUrl);
            }

            showStatus(`Redirecting to HMRC for authentication at ${authResponseUrl}...`, "info");

            // Redirect to HMRC OAuth
            console.log(`Page transition initiated: Redirecting to HMRC OAuth URL ${authResponseUrl}`);
            window.location.href = authResponseUrl;
          } catch (error) {
            console.error("Authentication error:", error);
            showStatus(`Authentication failed: ${error.message}`, "error");
            hideLoading();
          }
        } else {
          // We have an access token, proceed directly
          try {
            showLoading();
            showStatus("Retrieving VAT return...", "info");

            // Build query parameters with date range
            const params = new URLSearchParams({ vrn, periodStart, periodEnd });
            if (testScenario) params.append("Gov-Test-Scenario", testScenario);
            if (runFraudPreventionHeaderValidation) params.append("runFraudPreventionHeaderValidation", "true");
            if (allowSandboxObligations) params.append("allowSandboxObligations", "true");

            // Get Gov-Client headers
            const govClientHeaders = await getGovClientHeaders();

            const requestHeaders = {
              "Authorization": `Bearer ${accessToken}`,
              "Content-Type": "application/json",
              ...govClientHeaders,
            };

            // Add hmrcAccount header if present
            if (hmrcAccount) {
              requestHeaders["hmrcAccount"] = hmrcAccount;
            }

            const response = await window.authorizedFetch(`/api/v1/hmrc/vat/return?${params}`, {
              method: "GET",
              headers: {
                ...requestHeaders,
                "x-wait-time-ms": "0",
              },
              pollPendingMessage: "Still processing...",
              pollSuccessMessage: "VAT return retrieved.",
              pollErrorMessage: "Failed to retrieve VAT return.",
            });

            const result = await response.json();

            if (!response.ok) {
              // Handle 401 specifically to trigger re-authentication
              if (response.status === 401) {
                sessionStorage.removeItem("hmrcAccessToken");
                showStatus("Access token expired. Please try again.", "error");
                return;
              }
              throw new Error(result.message || "Failed to retrieve VAT return");
            }

            // Display results - add period dates for display
            result.periodStart = periodStart;
            result.periodEnd = periodEnd;
            displayReturn(result);
            document.getElementById("returnResults").style.display = "block";
            document.getElementById("searchForm").style.display = "none";
            hideStatus();
          } catch (error) {
            console.error("Error retrieving VAT return:", error);
            showStatus(`Failed to retrieve return: ${error.message}`, "error");
          } finally {
            hideLoading();
          }
        }
      }

      // getAuthUrl is provided globally by submit.js (now supports optional scope)

      function displayReturn(returnData) {
        const detailsContainer = document.getElementById("returnDetails");

        // Helper function to escape HTML and prevent XSS
        const escapeHtml = (text) => {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        };

        const formatCurrency = (value, decimalPlaces = 2) => {
          const num = parseFloat(value);
          if (isNaN(num)) return decimalPlaces === 0 ? "£0" : "£0.00";
          return decimalPlaces === 0 ? `£${Math.round(num).toLocaleString()}` : `£${num.toFixed(2)}`;
        };

        const formatWholePounds = (value) => formatCurrency(value, 0);

        const formatBoolean = (value) => {
          return value === true ? "Yes" : value === false ? "No" : "-";
        };

        // Get period display from the dates (periodStart/periodEnd are set on returnData before calling displayReturn)
        const periodDisplay = returnData.periodStart && returnData.periodEnd
          ? DateUtils.formatDateRange(returnData.periodStart, returnData.periodEnd)
          : (returnData.start && returnData.end
            ? DateUtils.formatDateRange(returnData.start, returnData.end)
            : "-");

        const detailsHtml = `
          <div class="return-details">
            <div class="detail-section">
              <h4>Period Information</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>Period:</label>
                  <span><strong>${escapeHtml(periodDisplay)}</strong></span>
                </div>
                <div class="detail-item">
                  <label>Finalised:</label>
                  <span class="${returnData.finalised ? "status-fulfilled" : "status-open"}">
                    ${formatBoolean(returnData.finalised)}
                  </span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>VAT Amounts</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>Box 1: VAT due on sales and other outputs:</label>
                  <span>${formatCurrency(returnData.vatDueSales)}</span>
                </div>
                <div class="detail-item">
                  <label>Box 2: VAT due on acquisitions from EU:</label>
                  <span>${formatCurrency(returnData.vatDueAcquisitions)}</span>
                </div>
                <div class="detail-item">
                  <label>Box 3: Total VAT due (Box 1 + Box 2):</label>
                  <span><strong>${formatCurrency(returnData.totalVatDue)}</strong></span>
                </div>
                <div class="detail-item">
                  <label>Box 4: VAT reclaimed on purchases and inputs:</label>
                  <span>${formatCurrency(returnData.vatReclaimedCurrPeriod)}</span>
                </div>
                <div class="detail-item">
                  <label>Box 5: Net VAT to pay or reclaim:</label>
                  <span class="net-amount"><strong>${formatCurrency(returnData.netVatDue)}</strong></span>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h4>Turnover (whole pounds)</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <label>Box 6: Total value of sales (excl. VAT):</label>
                  <span>${formatWholePounds(returnData.totalValueSalesExVAT)}</span>
                </div>
                <div class="detail-item">
                  <label>Box 7: Total value of purchases (excl. VAT):</label>
                  <span>${formatWholePounds(returnData.totalValuePurchasesExVAT)}</span>
                </div>
                <div class="detail-item">
                  <label>Box 8: Total value of goods supplied to EU (excl. VAT):</label>
                  <span>${formatWholePounds(returnData.totalValueGoodsSuppliedExVAT)}</span>
                </div>
                <div class="detail-item">
                  <label>Box 9: Total acquisitions from EU (excl. VAT):</label>
                  <span>${formatWholePounds(returnData.totalAcquisitionsExVAT)}</span>
                </div>
              </div>
            </div>
          </div>
        `;

        detailsContainer.innerHTML = detailsHtml;
      }

      // Button handlers
      document.getElementById("newSearchBtn")?.addEventListener("click", () => {
        const form = document.getElementById("vatReturnForm");
        const resultsContainer = document.getElementById("returnResults");
        const searchForm = document.getElementById("searchForm");
        form.reset();
        resultsContainer.style.display = "none";
        searchForm.style.display = "block";
        hideStatus();
      });

      document.getElementById("backToObligationsBtn")?.addEventListener("click", () => {
        window.location.href = "vatObligations.html";
      });

      // Input validation for VAT registration number
      document.getElementById("vrn").addEventListener("input", function (e) {
        // Only allow digits
        e.target.value = e.target.value.replace(/\D/g, "");
      });

      // Event listeners
      document.getElementById("vatReturnForm").addEventListener("submit", handleFormSubmission);

      // Initialize page when DOM is loaded
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("JS block started loading: DOMContentLoaded event handler");

        // Toggle form button handler
        document.getElementById("toggleFormBtn")?.addEventListener("click", () => {
          showForm();
        });

        // Cancel request button handler
        document.getElementById("cancelRequestBtn")?.addEventListener("click", () => {
          cancelRequest();
        });

        await initializePage();
        // Check if we're returning from OAuth
        handleOAuthCallback();

        // Auto-submit if we have URL parameters and no OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const vrn = urlParams.get("vrn");
        const periodStart = urlParams.get("periodStart");
        const periodEnd = urlParams.get("periodEnd");
        if (vrn && periodStart && periodEnd && !sessionStorage.getItem("hmrcAccessToken")) {
          // Will trigger OAuth flow
          document.getElementById("vatReturnForm").requestSubmit();
        } else if (vrn && periodStart && periodEnd && sessionStorage.getItem("hmrcAccessToken")) {
          // Have token, execute directly
          document.getElementById("vatReturnForm").requestSubmit();
        }
        console.log("JS block finished loading: DOMContentLoaded event handler");
      });

      console.log("JS block finished loading.");
    </script>

    <style>
      .return-details {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }

      .detail-section {
        margin-bottom: 30px;
      }

      .detail-section h4 {
        color: #333;
        border-bottom: 2px solid #007acc;
        padding-bottom: 8px;
        margin-bottom: 15px;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .detail-item label {
        font-weight: 500;
        color: #555;
      }

      .detail-item span {
        font-weight: 600;
        color: #333;
      }

      .net-amount {
        font-size: 1.1em;
        color: #007acc;
      }

      .status-fulfilled {
        color: #28a745;
      }

      .status-open {
        color: #dc3545;
      }

      @media (max-width: 768px) {
        .detail-grid {
          grid-template-columns: 1fr;
        }

        .detail-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }
      }
    </style>
  </body>
</html>
