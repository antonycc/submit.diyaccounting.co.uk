<!-- submitVat.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Submit VAT Return - DIY Accounting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="../../submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
    <script src="../../lib/analytics.js"></script>
    <!-- HEAD-prefetch to help mitigate API cold starts for this page's calls -->
    <!--script async src="../../prefetch/prefetch-hmrc-authurl-head.js"></script-->
    <!--script async src="../../prefetch/prefetch-hmrc-vat-return-head.js"></script-->
    <!--script async src="../../prefetch/prefetch-hmrc-receipt-head.js"></script-->
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="header-left">
          <a href="../../index.html" title="Home" class="home-link">
            <svg class="home-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
          </a>
          <a href="../../about.html" title="About & Help" class="info-link">
            <svg class="info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
          </a>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="../../auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="../../index.html">Activities</a>
        <a href="../../hmrc/receipt/receipts.html">Receipts</a>
        <a href="../../bundles.html">Bundles</a>
        <a href="../../spreadsheets.html">Spreadsheets</a>
      </nav>
    </header>

    <main id="mainContent">
      <div id="sandboxIndicator" class="sandbox-indicator">⚠️ SANDBOX MODE - Using HMRC Test API</div>

      <div id="statusMessagesContainer" role="alert" aria-live="polite"></div>

      <div id="loadingSpinner" class="spinner" style="display: none"></div>

      <!-- VAT Submission Form -->
      <div class="form-toggle-buttons">
        <button type="button" id="toggleFormBtn" class="secondary-button" style="display: none">Show Submission Form</button>
        <button type="button" id="cancelRequestBtn" class="cancel-button" style="display: none">Cancel Request</button>
      </div>
      <div id="vatForm" class="form-container">
        <h2>VAT Return Submission</h2>
        <form id="vatSubmissionForm">
          <div class="form-group">
            <label for="vatNumber">VAT registration number</label>
            <p id="vatNumber-hint" class="hint">
              This is 9 numbers, sometimes with 'GB' at the start, for example 123456789 or GB123456789. You can find it on your VAT
              registration certificate.
            </p>
            <input
              type="text"
              id="vatNumber"
              name="vatNumber"
              required
              value=""
              placeholder="e.g., 983238295"
              maxlength="9"
              pattern="[0-9]{9}"
              aria-describedby="vatNumber-hint"
              spellcheck="false"
              autocomplete="off"
            />
          </div>

          <div class="form-group">
            <label>VAT period</label>
            <p id="periodDates-hint" class="hint">Enter the start and end dates of your VAT period</p>
            <div class="period-date-inputs" style="display: flex; gap: 1em; flex-wrap: wrap">
              <div>
                <label for="periodStart">Period start</label>
                <input type="date" id="periodStart" name="periodStart" required aria-describedby="periodDates-hint" autocomplete="off" />
              </div>
              <div>
                <label for="periodEnd">Period end</label>
                <input type="date" id="periodEnd" name="periodEnd" required aria-describedby="periodDates-hint" autocomplete="off" />
              </div>
            </div>
            <!-- Hidden fields for backwards compatibility -->
            <input type="hidden" id="periodKey" name="periodKey" value="" />
          </div>

          <!-- 9-Box VAT Return Entry -->
          <fieldset class="vat-boxes">
            <legend>VAT Return Details</legend>

            <!-- Box 1: VAT due on sales -->
            <div class="form-group">
              <label for="vatDueSales">Box 1: VAT due on sales and other outputs</label>
              <p id="vatDueSales-hint" class="hint">Enter an amount with up to 2 decimal places, for example £600 or £193.54</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="vatDueSales"
                  name="vatDueSales"
                  required
                  value=""
                  placeholder="0.00"
                  inputmode="decimal"
                  aria-describedby="vatDueSales-hint"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 2: VAT due on acquisitions -->
            <div class="form-group">
              <label for="vatDueAcquisitions">Box 2: VAT due on acquisitions from EU</label>
              <p id="vatDueAcquisitions-hint" class="hint">
                Enter an amount with up to 2 decimal places, for example £600 or £193.54. Usually 0 post-Brexit.
              </p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="vatDueAcquisitions"
                  name="vatDueAcquisitions"
                  required
                  value="0"
                  placeholder="0.00"
                  inputmode="decimal"
                  aria-describedby="vatDueAcquisitions-hint"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 3: Total VAT due (calculated) -->
            <div class="form-group calculated-field">
              <label for="totalVatDue">Box 3: Total VAT due (Box 1 + Box 2)</label>
              <p id="totalVatDue-hint" class="hint">Auto-calculated: Sum of boxes 1 and 2</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="totalVatDue"
                  name="totalVatDue"
                  required
                  value=""
                  placeholder="0.00"
                  inputmode="decimal"
                  aria-describedby="totalVatDue-hint"
                  readonly
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 4: VAT reclaimed -->
            <div class="form-group">
              <label for="vatReclaimedCurrPeriod">Box 4: VAT reclaimed on purchases and other inputs</label>
              <p id="vatReclaimedCurrPeriod-hint" class="hint">Enter an amount with up to 2 decimal places, for example £600 or £193.54</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="vatReclaimedCurrPeriod"
                  name="vatReclaimedCurrPeriod"
                  required
                  value=""
                  placeholder="0.00"
                  inputmode="decimal"
                  aria-describedby="vatReclaimedCurrPeriod-hint"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 5: Net VAT due (calculated) -->
            <div class="form-group calculated-field">
              <label for="netVatDue">Box 5: Net VAT due or to be reclaimed</label>
              <p id="netVatDue-hint" class="hint">Auto-calculated: Difference between boxes 3 and 4 (always positive)</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="netVatDue"
                  name="netVatDue"
                  required
                  value=""
                  placeholder="0.00"
                  inputmode="decimal"
                  aria-describedby="netVatDue-hint"
                  readonly
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 6: Total value of sales -->
            <div class="form-group">
              <label for="totalValueSalesExVAT">Box 6: Total value of sales excluding VAT</label>
              <p id="totalValueSalesExVAT-hint" class="hint">Enter a whole number without pence, for example £15000</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="totalValueSalesExVAT"
                  name="totalValueSalesExVAT"
                  required
                  value=""
                  placeholder="0"
                  inputmode="numeric"
                  aria-describedby="totalValueSalesExVAT-hint"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 7: Total value of purchases -->
            <div class="form-group">
              <label for="totalValuePurchasesExVAT">Box 7: Total value of purchases excluding VAT</label>
              <p id="totalValuePurchasesExVAT-hint" class="hint">Enter a whole number without pence, for example £15000</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="totalValuePurchasesExVAT"
                  name="totalValuePurchasesExVAT"
                  required
                  value=""
                  placeholder="0"
                  inputmode="numeric"
                  aria-describedby="totalValuePurchasesExVAT-hint"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 8: Total value of goods supplied to EU -->
            <div class="form-group">
              <label for="totalValueGoodsSuppliedExVAT">Box 8: Total value of goods supplied to EU</label>
              <p id="totalValueGoodsSuppliedExVAT-hint" class="hint">Enter a whole number without pence. Usually 0 post-Brexit.</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="totalValueGoodsSuppliedExVAT"
                  name="totalValueGoodsSuppliedExVAT"
                  required
                  value="0"
                  placeholder="0"
                  inputmode="numeric"
                  aria-describedby="totalValueGoodsSuppliedExVAT-hint"
                  autocomplete="off"
                />
              </div>
            </div>

            <!-- Box 9: Total acquisitions from EU -->
            <div class="form-group">
              <label for="totalAcquisitionsExVAT">Box 9: Total value of acquisitions from EU</label>
              <p id="totalAcquisitionsExVAT-hint" class="hint">Enter a whole number without pence. Usually 0 post-Brexit.</p>
              <div class="input-prefix">
                <span class="prefix">£</span>
                <input
                  type="text"
                  id="totalAcquisitionsExVAT"
                  name="totalAcquisitionsExVAT"
                  required
                  value="0"
                  placeholder="0"
                  inputmode="numeric"
                  aria-describedby="totalAcquisitionsExVAT-hint"
                  autocomplete="off"
                />
              </div>
            </div>
          </fieldset>

          <!-- Legal Declaration -->
          <div class="declaration-box">
            <input type="checkbox" id="declaration" name="declaration" required aria-describedby="declaration-hint" />
            <label for="declaration">
              When you submit this VAT information you are making a legal declaration that the information is true and complete. A false
              declaration can result in prosecution.
            </label>
            <p id="declaration-hint" class="hint">You must tick this box to confirm you understand before submitting</p>
          </div>

          <!-- Developer Test Scenario Section -->
          <div id="developerSection" class="form-group" style="display: none">
            <div id="testDataLink" class="test-data-link">
              <a
                href="#"
                onclick="
                  event.preventDefault();
                  window.testDataGenerator.populateSubmitVatForm();
                "
                >add test data</a
              >
            </div>
            <label for="testScenario">Test scenario (Developer/Sandbox only)</label>
            <p id="testScenario-hint" class="hint">Test different HMRC sandbox error scenarios</p>
            <select id="testScenario" name="testScenario" aria-describedby="testScenario-hint">
              <option value="">Default</option>
              <!-- Values aligned with _developers/reference/hmrc-mtd-vat-api-1.0.yaml (POST /organisations/vat/{vrn}/returns) -->
              <option value="INVALID_VRN">Invalid VAT registration number</option>
              <option value="INVALID_PERIODKEY">Invalid Period Key</option>
              <option value="INVALID_PAYLOAD">Invalid Payload</option>
              <option value="DUPLICATE_SUBMISSION">Duplicate Submission</option>
              <option value="TAX_PERIOD_NOT_ENDED">Tax Period Not Ended</option>
              <option value="INSOLVENT_TRADER">Insolvent Trader</option>
              <option value="SUBMIT_API_HTTP_500">Submit API responds with 500</option>
              <option value="SUBMIT_HMRC_API_HTTP_500">HMRC API responds with 500</option>
              <option value="SUBMIT_HMRC_API_HTTP_503">HMRC API responds with 503</option>
              <option value="SUBMIT_HMRC_API_HTTP_SLOW_10S">HMRC API responds slowly</option>
            </select>
            <div style="margin-top: 10px">
              <input type="checkbox" id="runFraudPreventionHeaderValidation" name="runFraudPreventionHeaderValidation" />
              <label for="runFraudPreventionHeaderValidation" style="display: inline; font-weight: normal"
                >Validate Fraud Prevention Headers</label
              >
            </div>
            <div id="sandboxObligationsOption" style="margin-top: 10px; display: none">
              <input type="checkbox" id="allowSandboxObligations" name="allowSandboxObligations" />
              <label for="allowSandboxObligations" style="display: inline; font-weight: normal"
                >Allow any open obligation (Sandbox only - uses first available period if dates don't match)</label
              >
            </div>
          </div>

          <p id="tokenCostInfo" class="hint" style="margin-top: 0.5em; display: none"></p>
          <button type="submit" class="btn" id="submitBtn">Submit VAT Return</button>
        </form>
      </div>

      <!-- Receipt Display -->
      <div id="receiptDisplay" class="receipt" style="display: none">
        <h3>✅ VAT Return Submitted Successfully!</h3>
        <div class="receipt-details">
          <div class="receipt-item">
            <span><strong>Processing Date:</strong></span>
            <span id="processingDate"></span>
          </div>
          <div class="receipt-item">
            <span><strong>Form Bundle Number:</strong></span>
            <span id="formBundleNumber"></span>
          </div>
          <div class="receipt-item">
            <span><strong>Charge Reference:</strong></span>
            <span id="chargeRefNumber"></span>
          </div>
        </div>
        <p style="margin-top: 1em; color: #666; font-size: 0.9em">
          Your VAT return has been successfully submitted to HMRC. Please keep this receipt for your records.
        </p>
      </div>
    </main>

    <footer>
      <div class="footer-left">
        <a href="#" id="viewSourceLink" style="display: none">view source</a>
        <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
        <a id="apiDocsLink" style="display: inline" target="_blank" href="../../docs/api/index.html"> api </a>
      </div>
      <div class="footer-content">
        <div class="footer-center">
          <p>&copy; 2025-2026 DIY Accounting Limited</p>
        </div>
      </div>
    </footer>

    <script src="../../lib/env-loader.js"></script>
    <script src="../../lib/auth-url-builder.js"></script>
    <script src="../../lib/test-data-generator.js"></script>
    <script type="module" src="../../submit.js"></script>
    <script src="../../developer-mode.js"></script>
    <script src="../../lib/request-cache.js"></script>
    <script src="../../lib/toml-parser.js"></script>
    <script src="../../widgets/entitlement-status.js"></script>
    <script src="../../widgets/auth-status.js"></script>
    <script src="../../widgets/status-messages.js"></script>
    <script>
      (async function () {
        try {
          await window.loadEnv();
        } catch (err) {
          console.warn("Failed to load environment:", err);
        }
      })();

      // Obligation formatting utilities (inline version for non-module context)
      const ObligationUtils = {
        formatObligationForDisplay(obligation) {
          const startDate = new Date(obligation.start);
          const endDate = new Date(obligation.end);
          const dueDate = obligation.due ? new Date(obligation.due) : null;
          const dateOptions = { day: "numeric", month: "short", year: "numeric" };
          return {
            _periodKey: obligation.periodKey,
            id: obligation.periodKey,
            displayName: `${startDate.toLocaleDateString("en-GB", dateOptions)} to ${endDate.toLocaleDateString("en-GB", dateOptions)}`,
            startDate: obligation.start,
            endDate: obligation.end,
            dueDate: obligation.due,
            dueDateFormatted: dueDate ? dueDate.toLocaleDateString("en-GB", dateOptions) : null,
            status: obligation.status,
            statusDisplay: obligation.status === "O" ? "Open" : "Submitted",
          };
        },
        formatObligationsForSelection(obligations) {
          if (!Array.isArray(obligations)) return [];
          return obligations.map(this.formatObligationForDisplay).sort((a, b) => new Date(b.endDate) - new Date(a.endDate));
        },
        filterOpenObligations(formattedObligations) {
          return formattedObligations.filter((o) => o.status === "O");
        },
        getDropdownOptionText(formattedObligation) {
          if (formattedObligation.dueDateFormatted) {
            return `${formattedObligation.displayName} (Due: ${formattedObligation.dueDateFormatted})`;
          }
          return formattedObligation.displayName;
        },
      };

      // Note: Obligation dropdown has been replaced with date inputs (periodStart/periodEnd).
      // Period key is now resolved server-side from the dates.

      // Auto-calculation functions for 9-box VAT return
      function calculateTotalVatDue() {
        const box1 = parseFloat(document.getElementById("vatDueSales").value) || 0;
        const box2 = parseFloat(document.getElementById("vatDueAcquisitions").value) || 0;
        const total = Math.round((box1 + box2) * 100) / 100;
        document.getElementById("totalVatDue").value = total.toFixed(2);
        calculateNetVatDue();
      }

      function calculateNetVatDue() {
        const box3 = parseFloat(document.getElementById("totalVatDue").value) || 0;
        const box4 = parseFloat(document.getElementById("vatReclaimedCurrPeriod").value) || 0;
        const net = Math.round(Math.abs(box3 - box4) * 100) / 100;
        document.getElementById("netVatDue").value = net.toFixed(2);
      }

      // VAT field validation constants (matching HMRC API spec)
      const VAT_MONETARY_MIN = -9999999999999.99;
      const VAT_MONETARY_MAX = 9999999999999.99;
      const NET_VAT_DUE_MIN = 0;
      const NET_VAT_DUE_MAX = 99999999999.99;
      const VAT_WHOLE_MIN = -9999999999999;
      const VAT_WHOLE_MAX = 9999999999999;

      // Show field-level error message
      function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        // Remove existing error
        clearFieldError(fieldId);

        // Add error styling to field
        field.classList.add("input--error");
        field.setAttribute("aria-invalid", "true");

        // Create and insert error message
        const errorId = `${fieldId}-error`;
        const errorEl = document.createElement("p");
        errorEl.id = errorId;
        errorEl.className = "error-message";
        errorEl.innerHTML = `<span class="visually-hidden">Error:</span> ${message}`;

        // Update aria-describedby
        const existingDescribedBy = field.getAttribute("aria-describedby") || "";
        if (!existingDescribedBy.includes(errorId)) {
          field.setAttribute("aria-describedby", `${existingDescribedBy} ${errorId}`.trim());
        }

        // Insert error after the input wrapper or input itself
        const wrapper = field.closest(".input-prefix") || field;
        wrapper.insertAdjacentElement("afterend", errorEl);
      }

      // Clear field-level error message
      function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        field.classList.remove("input--error");
        field.removeAttribute("aria-invalid");

        const errorId = `${fieldId}-error`;
        const errorEl = document.getElementById(errorId);
        if (errorEl) errorEl.remove();

        // Clean up aria-describedby
        const describedBy = field.getAttribute("aria-describedby") || "";
        field.setAttribute("aria-describedby", describedBy.replace(errorId, "").trim());
      }

      // Validate VAT monetary amount (boxes 1-4)
      function validateVatMonetaryAmount(value, fieldId, fieldLabel) {
        const strValue = String(value).trim();
        if (strValue === "") {
          showFieldError(fieldId, `Enter the ${fieldLabel}`);
          return false;
        }

        const num = parseFloat(strValue);
        if (isNaN(num)) {
          showFieldError(fieldId, `Enter a valid number for ${fieldLabel}`);
          return false;
        }

        if (num < VAT_MONETARY_MIN || num > VAT_MONETARY_MAX) {
          showFieldError(fieldId, `${fieldLabel} must be between £-9,999,999,999,999.99 and £9,999,999,999,999.99`);
          return false;
        }

        const decimalParts = strValue.split(".");
        if (decimalParts[1] && decimalParts[1].length > 2) {
          showFieldError(fieldId, `${fieldLabel} must have no more than 2 decimal places`);
          return false;
        }

        clearFieldError(fieldId);
        return true;
      }

      // Validate net VAT due (box 5)
      function validateNetVatDue(value, fieldId) {
        const num = parseFloat(value);
        if (isNaN(num)) {
          showFieldError(fieldId, "Net VAT due must be a valid number");
          return false;
        }

        if (num < NET_VAT_DUE_MIN) {
          showFieldError(fieldId, "Net VAT due must be a positive value (calculated as absolute difference)");
          return false;
        }

        if (num > NET_VAT_DUE_MAX) {
          showFieldError(fieldId, "Net VAT due must be £99,999,999,999.99 or less");
          return false;
        }

        clearFieldError(fieldId);
        return true;
      }

      // Validate whole pound amount (boxes 6-9)
      function validateVatWholeAmount(value, fieldId, fieldLabel) {
        const strValue = String(value).trim();
        if (strValue === "") {
          showFieldError(fieldId, `Enter the ${fieldLabel}`);
          return false;
        }

        const num = parseFloat(strValue);
        if (isNaN(num)) {
          showFieldError(fieldId, `Enter a valid number for ${fieldLabel}`);
          return false;
        }

        if (!Number.isInteger(num)) {
          showFieldError(fieldId, `${fieldLabel} must be a whole number without pence`);
          return false;
        }

        if (num < VAT_WHOLE_MIN || num > VAT_WHOLE_MAX) {
          showFieldError(fieldId, `${fieldLabel} must be between £-9,999,999,999,999 and £9,999,999,999,999`);
          return false;
        }

        clearFieldError(fieldId);
        return true;
      }

      // Validate all 9-box fields
      function validateAll9BoxFields() {
        let isValid = true;

        // Boxes 1-4: monetary amounts with 2 decimal places
        isValid = validateVatMonetaryAmount(document.getElementById("vatDueSales").value, "vatDueSales", "VAT due on sales") && isValid;

        isValid =
          validateVatMonetaryAmount(document.getElementById("vatDueAcquisitions").value, "vatDueAcquisitions", "VAT due on acquisitions") &&
          isValid;

        isValid =
          validateVatMonetaryAmount(document.getElementById("vatReclaimedCurrPeriod").value, "vatReclaimedCurrPeriod", "VAT reclaimed") &&
          isValid;

        // Box 5: net VAT due (calculated, but validate anyway)
        isValid = validateNetVatDue(document.getElementById("netVatDue").value, "netVatDue") && isValid;

        // Boxes 6-9: whole pound amounts
        isValid =
          validateVatWholeAmount(document.getElementById("totalValueSalesExVAT").value, "totalValueSalesExVAT", "total value of sales") &&
          isValid;

        isValid =
          validateVatWholeAmount(
            document.getElementById("totalValuePurchasesExVAT").value,
            "totalValuePurchasesExVAT",
            "total value of purchases",
          ) && isValid;

        isValid =
          validateVatWholeAmount(
            document.getElementById("totalValueGoodsSuppliedExVAT").value,
            "totalValueGoodsSuppliedExVAT",
            "total value of goods supplied to EU",
          ) && isValid;

        isValid =
          validateVatWholeAmount(
            document.getElementById("totalAcquisitionsExVAT").value,
            "totalAcquisitionsExVAT",
            "total acquisitions from EU",
          ) && isValid;

        return isValid;
      }

      // Collect 9-box VAT data from form
      function collect9BoxData() {
        return {
          vatDueSales: parseFloat(document.getElementById("vatDueSales").value) || 0,
          vatDueAcquisitions: parseFloat(document.getElementById("vatDueAcquisitions").value) || 0,
          totalVatDue: parseFloat(document.getElementById("totalVatDue").value) || 0,
          vatReclaimedCurrPeriod: parseFloat(document.getElementById("vatReclaimedCurrPeriod").value) || 0,
          netVatDue: parseFloat(document.getElementById("netVatDue").value) || 0,
          totalValueSalesExVAT: Math.round(parseFloat(document.getElementById("totalValueSalesExVAT").value) || 0),
          totalValuePurchasesExVAT: Math.round(parseFloat(document.getElementById("totalValuePurchasesExVAT").value) || 0),
          totalValueGoodsSuppliedExVAT: Math.round(parseFloat(document.getElementById("totalValueGoodsSuppliedExVAT").value) || 0),
          totalAcquisitionsExVAT: Math.round(parseFloat(document.getElementById("totalAcquisitionsExVAT").value) || 0),
          finalised: true,
        };
      }

      // Form submission handler
      async function handleFormSubmission(event) {
        event.preventDefault();

        const formData = new FormData(form);
        const vatNumber = formData.get("vatNumber").trim();
        const periodStart = formData.get("periodStart") || "";
        const periodEnd = formData.get("periodEnd") || "";
        const declaration = document.getElementById("declaration").checked;
        const testScenario = (document.getElementById("testScenario")?.value || "").trim();
        const runFraudPreventionHeaderValidation = document.getElementById("runFraudPreventionHeaderValidation")?.checked || false;
        const allowSandboxObligations = document.getElementById("allowSandboxObligations")?.checked || false;

        // Collect 9-box data
        const vatBoxData = collect9BoxData();

        // Basic validation
        if (!vatNumber) {
          showStatus("Please enter your VAT registration number.", "error");
          return;
        }
        if (!periodStart || !periodEnd) {
          showStatus("Please enter your VAT period start and end dates.", "error");
          return;
        }

        if (!/^\d{9}$/.test(vatNumber)) {
          showStatus("VAT number must be exactly 9 digits.", "error");
          return;
        }

        // Validate all 9-box fields with field-level error messages
        if (!validateAll9BoxFields()) {
          showStatus("Please correct the errors in the VAT box fields highlighted above.", "error");
          return;
        }

        // Validate declaration checkbox
        if (!declaration) {
          showStatus("You must confirm the declaration before submitting.", "error");
          return;
        }

        // GA4 ecommerce: begin_checkout when VAT return submission starts
        if (typeof gtag === "function") {
          gtag("event", "begin_checkout", {
            currency: "GBP",
            value: 0,
            items: [
              {
                item_id: "vat-return",
                item_name: "VAT Return",
                price: 0,
                currency: "GBP",
              },
            ],
          });
        }

        // Store submission data for the submission handler
        submissionData = {
          vatNumber,
          periodStart,
          periodEnd,
          ...vatBoxData,
          testScenario,
          runFraudPreventionHeaderValidation,
          allowSandboxObligations,
        };

        const urlParams = new URLSearchParams(window.location.search);
        const hmrcAccount = urlParams.get("hmrcAccount");
        const requestData = JSON.stringify(submissionData);

        sessionStorage.setItem("submission_data", requestData);
        if (hmrcAccount === "sandbox") {
          sessionStorage.setItem("hmrcAccount", hmrcAccount);
        } else {
          sessionStorage.removeItem("hmrcAccount");
        }

        // Check if we already have an HMRC access token
        const accessToken = sessionStorage.getItem("hmrcAccessToken");

        if (accessToken) {
          // Token available - submit directly without OAuth redirect
          console.log("HMRC access token found, submitting directly");
          continueVatSubmission();
        } else {
          // No token - redirect to HMRC OAuth
          try {
            showLoading();
            showStatus("Initiating HMRC authentication...", "info");

            const state = generateRandomState();
            const currentActivity = `${location.pathname}`;

            sessionStorage.setItem("oauth_state", state);
            sessionStorage.setItem("currentActivity", currentActivity);
            console.log("Stored pending request and current activity:", requestData, currentActivity, hmrcAccount);

            // Get OAuth URL
            let authResponseUrl;
            if (window.__env && window.authUrlBuilder) {
              authResponseUrl = window.authUrlBuilder.buildHmrcAuthUrl(state, "write:vat read:vat", hmrcAccount || "live");
              console.log("Using client-side generated HMRC Auth URL:", authResponseUrl);
            } else {
              // Get OAuth URL from API (fallback)
              const authResponse = await getAuthUrl(state, "hmrc");
              authResponseUrl = authResponse.authUrl;
              console.log("Using server-side HMRC Auth URL:", authResponseUrl);
            }

            sessionStorage.setItem("currentActivity", location.pathname);
            console.log("Current activity set to:", location.pathname);

            showStatus(`Redirecting to HMRC for authentication at ${authResponseUrl}...`, "info");

            // Redirect to HMRC OAuth
            console.log(`Page transition initiated: Redirecting to HMRC OAuth URL ${authResponseUrl}`);
            try {
              window.__correlation?.prepareRedirect?.();
            } catch {}
            window.location.href = authResponseUrl;
          } catch (error) {
            console.error("Authentication error:", error);
            showStatus(`Authentication failed: ${error.message}`, "error");
            hideLoading();
          }
        }
      }

      // Form visibility management
      let formHidden = false;

      function hideForm() {
        const container = document.getElementById("vatForm");
        const toggleBtn = document.getElementById("toggleFormBtn");
        const cancelBtn = document.getElementById("cancelRequestBtn");
        if (container && toggleBtn) {
          container.style.display = "none";
          toggleBtn.style.display = "inline-block";
          if (cancelBtn) cancelBtn.style.display = "inline-block";
          formHidden = true;
        }
      }

      function showForm() {
        const container = document.getElementById("vatForm");
        const toggleBtn = document.getElementById("toggleFormBtn");
        const cancelBtn = document.getElementById("cancelRequestBtn");
        if (container && toggleBtn) {
          container.style.display = "block";
          toggleBtn.style.display = "none";
          if (cancelBtn) cancelBtn.style.display = "none";
          formHidden = false;
        }
      }

      function cancelRequest() {
        // Clear all in-progress session data
        sessionStorage.removeItem("submission_data");
        sessionStorage.removeItem("hmrcAccessToken");
        sessionStorage.removeItem("oauth_state");
        sessionStorage.removeItem("hmrcAccount");
        sessionStorage.removeItem("currentActivity");

        // Show form and clear status
        showForm();
        hideStatus();
        console.log("Request cancelled, session data cleared");
      }

      // OAuth callback handling
      function handleOAuthCallback() {
        const accessToken = sessionStorage.getItem("hmrcAccessToken");
        if (accessToken) {
          console.log("OAuth callback handler (code present, auto-continue)");
          continueVatSubmission();
        } else {
          console.log("OAuth callback handler (no action taken)");
        }
      }

      async function continueVatSubmission() {
        try {
          const accessToken = sessionStorage.getItem("hmrcAccessToken");
          const submissionData = JSON.parse(sessionStorage.getItem("submission_data") || "null");

          if (!submissionData) {
            console.log("No pending submission data found");
            // Don't clear hmrcAccessToken - it may be needed for future submissions
            // (e.g., in simulator mode the token is pre-injected on every page load)
            sessionStorage.removeItem("oauth_state");
            return;
          }

          console.log("Retrieved submission data:", submissionData);

          // Hide form while submitting
          hideForm();
          showLoading();
          showStatus("Submitting VAT return to HMRC...", "info");

          // Submit VAT return with 9-box data
          // Pass period info (either periodKey or periodStart/periodEnd)
          const submitResponse = await submitVatWithCalculatedHeaders(submissionData.vatNumber, submissionData, accessToken);

          // Display success
          showStatus("VAT return processed", "success");
          displayReceipt(submitResponse);
          // Refresh token display after consumption
          updateTokenInfo();
          // hideStatus(); // Don't hide success status immediately

          // Clean up session storage - keep token for subsequent HMRC operations
          sessionStorage.removeItem("currentActivity");
          sessionStorage.removeItem("oauth_state");
          sessionStorage.removeItem("submission_data");
          // Clear form draft after successful submission
          if (window.clearFormDraft) {
            window.clearFormDraft();
          }
          // Keep hmrcAccessToken and hmrcAccount for subsequent operations (view return, obligations)
          console.log("Continue submission handler (success, session storage cleared)");
        } catch (error) {
          console.error("Submission error:", error);
          showStatus(`Submission failed: ${error.message}`, "error");
          // Auto-expand form on error so user can retry
          showForm();
          // Clear submission data to prevent auto-retry loop on next page load
          // User will need to manually retry by filling the form again
          sessionStorage.removeItem("submission_data");
          sessionStorage.removeItem("hmrcAccessToken");
          sessionStorage.removeItem("oauth_state");
          sessionStorage.removeItem("hmrcAccount");
          sessionStorage.removeItem("currentActivity");
          console.log("Submission failed, cleared session storage to prevent retry loop");
        } finally {
          hideLoading();
        }
      }

      async function submitVatWithCalculatedHeaders(vatNumber, vatData, accessToken) {
        const storedData = JSON.parse(sessionStorage.getItem("submission_data") || "null");
        const testScenario = (document.getElementById("testScenario")?.value || storedData?.testScenario || "").trim();
        const runFraudPreventionHeaderValidation =
          document.getElementById("runFraudPreventionHeaderValidation")?.checked || storedData?.runFraudPreventionHeaderValidation || false;
        const allowSandboxObligations =
          document.getElementById("allowSandboxObligations")?.checked || storedData?.allowSandboxObligations || false;

        // Get Gov-Client headers
        const govClientHeaders = await getGovClientHeaders();

        const requestHeaders = {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json",
          ...govClientHeaders,
        };
        if (testScenario) {
          requestHeaders["Gov-Test-Scenario"] = testScenario;
        }
        return await submitVat(
          vatNumber,
          vatData,
          accessToken,
          requestHeaders,
          runFraudPreventionHeaderValidation,
          allowSandboxObligations,
        );
      }

      async function submitVat(vatNumber, vatData, accessToken, headers, runFraudPreventionHeaderValidation, allowSandboxObligations) {
        const url = "/api/v1/hmrc/vat/return";
        const body = JSON.stringify({
          vatNumber,
          periodStart: vatData.periodStart,
          periodEnd: vatData.periodEnd,
          // Include all 9-box fields
          vatDueSales: vatData.vatDueSales,
          vatDueAcquisitions: vatData.vatDueAcquisitions,
          totalVatDue: vatData.totalVatDue,
          vatReclaimedCurrPeriod: vatData.vatReclaimedCurrPeriod,
          netVatDue: vatData.netVatDue,
          totalValueSalesExVAT: vatData.totalValueSalesExVAT,
          totalValuePurchasesExVAT: vatData.totalValuePurchasesExVAT,
          totalValueGoodsSuppliedExVAT: vatData.totalValueGoodsSuppliedExVAT,
          totalAcquisitionsExVAT: vatData.totalAcquisitionsExVAT,
          finalised: vatData.finalised,
          accessToken,
          runFraudPreventionHeaderValidation,
          allowSandboxObligations,
        });
        console.log(`Submitting VAT. Remote call initiated: POST ${url} ++ Body: ${body}`);

        const requestHeaders = {
          "Content-Type": "application/json",
          ...headers,
        };

        // Add hmrcAccount header if present
        const hmrcAccount = sessionStorage.getItem("hmrcAccount");
        if (hmrcAccount) {
          requestHeaders["hmrcAccount"] = hmrcAccount;
        }

        const response = await window.authorizedFetch(url, {
          method: "POST",
          headers: requestHeaders,
          body,
        });
        const responseJson = await response.json();
        if (!response.ok) {
          // Handle token exhaustion with a user-friendly message
          if (response.status === 403 && responseJson?.error?.reason === "tokens_exhausted") {
            const tokenInfoEl = document.getElementById("tokenCostInfo");
            if (tokenInfoEl) {
              tokenInfoEl.innerHTML = 'No tokens remaining. <a href="/bundles.html" style="color:#c00;">View Bundles</a>';
              tokenInfoEl.style.display = "";
              tokenInfoEl.style.color = "#c00";
            }
            throw new Error(
              "No tokens remaining. Your token allowance has been used. Tokens refresh at the start of the next period. Visit the Bundles page for more options.",
            );
          }
          const message = `Failed to submit VAT. Remote call failed: POST ${url} - Status: ${response.status} ${response.statusText} - Body: ${JSON.stringify(responseJson)}`;
          console.error(message);
          throw new Error(message);
        }

        console.log(`Submitted VAT. Remote call completed successfully: POST ${url}`, responseJson, responseJson.receipt);
        // Return the receipt object when present (production), otherwise return the full body (tests/mocks)
        return responseJson?.receipt ?? responseJson;
      }

      function displayReceipt(response) {
        console.log("Page display transition: Displaying receipt and hiding form", response);
        // Hide the form
        vatFormContainer.style.display = "none";

        // Handle both direct receipt object and wrapped response (from module's submitVat)
        const receipt = response.receipt ?? response;

        // GA4 ecommerce: purchase when VAT return is successfully submitted
        if (typeof gtag === "function") {
          gtag("event", "purchase", {
            transaction_id: receipt.formBundleNumber || "",
            value: 0,
            currency: "GBP",
            items: [
              {
                item_id: "vat-return",
                item_name: "VAT Return",
                price: 0,
                currency: "GBP",
              },
            ],
          });
        }

        // Format and display the processing date
        const processingDate = new Date(receipt.processingDate);
        document.getElementById("processingDate").textContent = processingDate.toLocaleDateString("en-GB", {
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        document.getElementById("formBundleNumber").textContent = receipt.formBundleNumber;
        document.getElementById("chargeRefNumber").textContent = receipt.chargeRefNumber ?? "";

        // Show the receipt
        receiptDisplay.style.display = "block";
      }

      // Global variables
      let accessToken = null;
      let submissionData = null;

      // DOM elements - initialized in DOMContentLoaded
      let form = null;
      let receiptDisplay = null;
      let vatFormContainer = null;

      // Initialize page
      async function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const vrn = urlParams.get("vrn");
        const periodKey = urlParams.get("periodKey");
        const periodStart = urlParams.get("periodStart");
        const periodEnd = urlParams.get("periodEnd");
        const hmrcAccount = urlParams.get("hmrcAccount");

        // If URL params provide complete period data, clear any stale submission_data
        // This handles navigation from obligations page where URL params should take precedence
        if (vrn && periodStart && periodEnd) {
          sessionStorage.removeItem("submission_data");
          console.log("Cleared stale submission_data - using URL params instead");
        }

        if (vrn) {
          document.getElementById("vatNumber").value = vrn;
        }

        // Support URL-based period initialization (for testing/deep linking)
        if (periodStart) {
          document.getElementById("periodStart").value = periodStart;
        }
        if (periodEnd) {
          document.getElementById("periodEnd").value = periodEnd;
        }
        // Legacy periodKey support (set hidden field for backwards compatibility)
        if (periodKey) {
          document.getElementById("periodKey").value = periodKey;
        }

        // Show sandbox indicator and store hmrcAccount if hmrcAccount=sandbox
        if (hmrcAccount === "sandbox") {
          sessionStorage.setItem("hmrcAccount", hmrcAccount);
          const sandboxIndicator = document.getElementById("sandboxIndicator");
          if (sandboxIndicator) {
            sandboxIndicator.classList.add("visible");
          }
          const testDataLink = document.getElementById("testDataLink");
          if (testDataLink) {
            testDataLink.classList.add("visible");
          }
        } else if (hmrcAccount) {
          // Clear sandbox mode if explicitly set to something else
          sessionStorage.removeItem("hmrcAccount");
        }

        // Developer mode is now controlled by the global toggle via developer-mode.js
        // Show developer section based on sessionStorage and listen for changes
        const devSection = document.getElementById("developerSection");
        const sandboxObligationsOption = document.getElementById("sandboxObligationsOption");
        // hmrcAccount was already declared above from urlParams

        function updateDeveloperSectionVisibility() {
          const developerModeEnabled = sessionStorage.getItem("showDeveloperOptions") === "true";
          if (devSection) {
            devSection.style.display = developerModeEnabled ? "block" : "none";
          }
          // Show sandbox obligations option only in sandbox mode when developer mode is on
          if (sandboxObligationsOption && hmrcAccount === "sandbox" && developerModeEnabled) {
            sandboxObligationsOption.style.display = "block";
          } else if (sandboxObligationsOption) {
            sandboxObligationsOption.style.display = "none";
          }
        }

        // Initial check
        updateDeveloperSectionVisibility();

        // Listen for developer mode toggle changes
        window.addEventListener("developer-mode-changed", updateDeveloperSectionVisibility);

        // Load and display token info if authenticated
        updateTokenInfo();
      }

      async function updateTokenInfo() {
        const tokenInfoEl = document.getElementById("tokenCostInfo");
        if (!tokenInfoEl) return;
        try {
          // Only fetch token info if the user is authenticated
          const idToken = (() => {
            try {
              return localStorage.getItem("cognitoIdToken");
            } catch {
              return null;
            }
          })();
          if (!idToken || !window.fetchWithIdToken) return;
          const res = await window.fetchWithIdToken("/api/v1/bundle", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });
          if (!res || !res.ok) return;
          const data = await res.json();
          if (!data || !data.bundles) return;

          // Find allocated bundles that have tokens
          const bundlesWithTokens = (data.bundles || []).filter((b) => b.allocated && b.tokensRemaining !== undefined);
          if (bundlesWithTokens.length === 0) return;

          const totalRemaining = bundlesWithTokens.reduce((sum, b) => sum + (b.tokensRemaining || 0), 0);
          const refreshDate = bundlesWithTokens[0]?.tokenResetAt;

          if (totalRemaining > 0) {
            tokenInfoEl.textContent = `This submission will use 1 token (${totalRemaining} remaining)`;
            tokenInfoEl.style.display = "";
          } else {
            let msg = "No tokens remaining.";
            if (refreshDate) {
              const d = new Date(refreshDate);
              msg += ` Tokens refresh on ${d.toLocaleDateString()}.`;
            }
            tokenInfoEl.textContent = msg;
            tokenInfoEl.style.display = "";
            tokenInfoEl.style.color = "#c00";
          }
        } catch (err) {
          console.warn("Could not load token info:", err);
        }
      }

      // Expose page-specific functions to window for testing
      window.submitVat = submitVat;
      window.handleOAuthCallback = handleOAuthCallback;
      window.continueSubmission = continueVatSubmission;
      window.displayReceipt = displayReceipt;
      window.handleFormSubmission = handleFormSubmission;
      window.calculateTotalVatDue = calculateTotalVatDue;
      window.calculateNetVatDue = calculateNetVatDue;
      window.collect9BoxData = collect9BoxData;

      // Helper function that runs immediately if DOM is ready, otherwise waits for DOMContentLoaded
      // This ensures compatibility with both browser loading and test environments
      function onDOMReady(fn) {
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", fn);
        } else {
          // DOM is already ready (interactive or complete)
          fn();
        }
      }

      // Initialize
      onDOMReady(async function () {
        console.log("JS block started loading: DOMContentLoaded event handler");

        // Initialize DOM element references
        form = document.getElementById("vatSubmissionForm");
        receiptDisplay = document.getElementById("receiptDisplay");
        vatFormContainer = document.getElementById("vatForm");

        // Event listeners
        if (form) {
          form.addEventListener("submit", handleFormSubmission);
        }

        // Input validation
        const vatNumberInput = document.getElementById("vatNumber");
        if (vatNumberInput) {
          vatNumberInput.addEventListener("input", function (e) {
            // Only allow digits
            e.target.value = e.target.value.replace(/\D/g, "");
          });
        }

        // Note: Obligation dropdown replaced with date inputs - period key resolved server-side

        // Auto-calculation event listeners for 9-box VAT return
        const vatDueSalesInput = document.getElementById("vatDueSales");
        const vatDueAcquisitionsInput = document.getElementById("vatDueAcquisitions");
        const vatReclaimedInput = document.getElementById("vatReclaimedCurrPeriod");
        const totalValueSalesInput = document.getElementById("totalValueSalesExVAT");
        const totalValuePurchasesInput = document.getElementById("totalValuePurchasesExVAT");
        const totalValueGoodsSuppliedInput = document.getElementById("totalValueGoodsSuppliedExVAT");
        const totalAcquisitionsInput = document.getElementById("totalAcquisitionsExVAT");

        if (vatDueSalesInput) {
          vatDueSalesInput.addEventListener("input", calculateTotalVatDue);
          vatDueSalesInput.addEventListener("blur", function () {
            validateVatMonetaryAmount(this.value, "vatDueSales", "VAT due on sales");
          });
        }
        if (vatDueAcquisitionsInput) {
          vatDueAcquisitionsInput.addEventListener("input", calculateTotalVatDue);
          vatDueAcquisitionsInput.addEventListener("blur", function () {
            validateVatMonetaryAmount(this.value, "vatDueAcquisitions", "VAT due on acquisitions");
          });
        }
        if (vatReclaimedInput) {
          vatReclaimedInput.addEventListener("input", calculateNetVatDue);
          vatReclaimedInput.addEventListener("blur", function () {
            validateVatMonetaryAmount(this.value, "vatReclaimedCurrPeriod", "VAT reclaimed");
          });
        }
        if (totalValueSalesInput) {
          totalValueSalesInput.addEventListener("blur", function () {
            validateVatWholeAmount(this.value, "totalValueSalesExVAT", "total value of sales");
          });
        }
        if (totalValuePurchasesInput) {
          totalValuePurchasesInput.addEventListener("blur", function () {
            validateVatWholeAmount(this.value, "totalValuePurchasesExVAT", "total value of purchases");
          });
        }
        if (totalValueGoodsSuppliedInput) {
          totalValueGoodsSuppliedInput.addEventListener("blur", function () {
            validateVatWholeAmount(this.value, "totalValueGoodsSuppliedExVAT", "total value of goods supplied to EU");
          });
        }
        if (totalAcquisitionsInput) {
          totalAcquisitionsInput.addEventListener("blur", function () {
            validateVatWholeAmount(this.value, "totalAcquisitionsExVAT", "total acquisitions from EU");
          });
        }

        // === Form Data Persistence (WCAG 2.2.1 mitigation) ===
        // Auto-save form data as user types so it's preserved if session expires

        const FORM_DRAFT_KEY = "vat_form_draft";

        // Fields to persist
        const persistableFields = [
          "vatNumber",
          "periodStart",
          "periodEnd",
          "vatDueSales",
          "vatDueAcquisitions",
          "vatReclaimedCurrPeriod",
          "totalValueSalesExVAT",
          "totalValuePurchasesExVAT",
          "totalValueGoodsSuppliedExVAT",
          "totalAcquisitionsExVAT",
        ];

        // Save form data to sessionStorage
        function saveFormDraft() {
          const draft = {};
          for (const fieldId of persistableFields) {
            const field = document.getElementById(fieldId);
            if (field && field.value) {
              draft[fieldId] = field.value;
            }
          }
          if (Object.keys(draft).length > 0) {
            draft._savedAt = new Date().toISOString();
            sessionStorage.setItem(FORM_DRAFT_KEY, JSON.stringify(draft));
          }
        }

        // Restore form data from sessionStorage
        function restoreFormDraft() {
          const draftJson = sessionStorage.getItem(FORM_DRAFT_KEY);
          if (!draftJson) return false;

          try {
            const draft = JSON.parse(draftJson);
            let restored = false;
            for (const fieldId of persistableFields) {
              if (draft[fieldId]) {
                const field = document.getElementById(fieldId);
                // Only restore if field is empty (don't override URL params)
                if (field && !field.value) {
                  field.value = draft[fieldId];
                  restored = true;
                }
              }
            }
            if (restored) {
              // Trigger recalculation of auto-calculated fields
              calculateTotalVatDue();
              console.log("Restored form draft from", draft._savedAt);
            }
            return restored;
          } catch (e) {
            console.warn("Could not restore form draft:", e);
            return false;
          }
        }

        // Clear form draft (after successful submission)
        function clearFormDraft() {
          sessionStorage.removeItem(FORM_DRAFT_KEY);
        }

        // Attach auto-save to all persistable fields
        for (const fieldId of persistableFields) {
          const field = document.getElementById(fieldId);
          if (field) {
            field.addEventListener("input", saveFormDraft);
            field.addEventListener("change", saveFormDraft);
          }
        }

        // Restore draft on page load (if not coming from URL params)
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get("vrn") && !urlParams.get("periodStart")) {
          restoreFormDraft();
        }

        // Expose clearFormDraft for post-submission cleanup
        window.clearFormDraft = clearFormDraft;

        // Toggle form button handler
        document.getElementById("toggleFormBtn")?.addEventListener("click", () => {
          showForm();
        });

        // Cancel request button handler
        document.getElementById("cancelRequestBtn")?.addEventListener("click", () => {
          cancelRequest();
        });

        // Initialize page state (e.g., show sandbox indicator when applicable)
        await initializePage();
        // Check if we're returning from OAuth
        handleOAuthCallback();
        console.log("JS block finished loading: DOMContentLoaded event handler");
      });

      console.log("JS block finished loading.");
    </script>
  </body>
</html>
