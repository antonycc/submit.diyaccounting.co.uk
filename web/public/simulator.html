<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Simulator - DIY Accounting Submit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Try DIY Accounting Submit in demo mode. No account required. Experience VAT return submission without affecting real data."
    />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://submit.diyaccounting.co.uk/simulator.html" />
    <link rel="stylesheet" href="./submit.css" />
    <style>
      /* Purple gradient backdrop contained within the portrait frame */
      #mainContent {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-lg);
        padding: 1em;
      }
      header .subtitle {
        display: none;
      }

      /* Hero section */
      .simulator-hero {
        text-align: center;
        padding: 2em 0;
        color: white;
      }
      .simulator-hero h2 {
        font-size: 2em;
        font-weight: 700;
        margin: 0 0 0.5em 0;
        color: white;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .simulator-hero p {
        font-size: 1.1em;
        margin: 0 auto;
        opacity: 0.95;
      }

      /* Navigation links */
      .simulator-nav {
        display: flex;
        justify-content: center;
        gap: 1em;
        margin-bottom: 1.5em;
        flex-wrap: wrap;
      }
      .simulator-nav a {
        color: white;
        text-decoration: underline;
        padding: 0.5em 1em;
        border-radius: var(--radius-sm);
        transition: background-color 0.2s;
      }
      .simulator-nav a:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Override simulator container for this page */
      .simulator-container {
        background: white;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      /* Journey buttons override for white background */
      .journey-buttons {
        background: white;
        padding: 1em;
        border-radius: var(--radius-lg);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .journey-status {
        background: white;
        border: 1px solid var(--color-border);
      }

      /* CTA at bottom */
      .simulator-cta {
        text-align: center;
        padding: 2em 0;
        color: white;
      }
      .simulator-cta a {
        color: white;
        text-decoration: underline;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="header-left">
          <a href="index.html" title="Home" class="home-link">
            <svg class="home-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
          </a>
          <a href="about.html" title="About & Help" class="info-link">
            <svg class="info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
          </a>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Simulator Mode</span>
          <span class="login-status">Demo User</span>
        </div>
      </div>
      <h1>Try the Simulator</h1>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="index.html">Activities</a>
        <a href="hmrc/receipt/receipts.html">Receipts</a>
        <a href="bundles.html">Bundles</a>
      </nav>
    </header>

    <main id="mainContent">
      <!-- Hero Section -->
      <section class="simulator-hero">
        <h2>Experience DIY Accounting Submit</h2>
        <p>Try the full application without creating an account. No real data is submitted to HMRC.</p>
      </section>

      <!-- Navigation to help -->
      <nav class="simulator-nav" aria-label="Help navigation">
        <a href="help.html">Help & FAQs</a>
        <a href="guide.html">User Guide</a>
        <a href="about.html">About</a>
        <a href="mcp.html">MCP Server (coming soon)</a>
      </nav>

      <!-- Demo Notice -->
      <div class="simulator-notice" role="alert">
        <strong>Demo Mode:</strong> This is a fully functional simulator. No real VAT returns are submitted to HMRC. No account is required.
        Data resets when you leave the page.
      </div>

      <!-- Journey Buttons -->
      <div class="journey-buttons" role="group" aria-label="Demo journeys">
        <button type="button" class="journey-btn" data-journey="submit-vat" id="journeySubmitVat">
          <span class="journey-icon" aria-hidden="true">&#9654;</span>
          <span class="journey-label">Watch: Submit VAT Return</span>
        </button>
        <button type="button" class="journey-btn" data-journey="view-obligations" id="journeyViewObligations">
          <span class="journey-icon" aria-hidden="true">&#9654;</span>
          <span class="journey-label">Watch: View Obligations</span>
        </button>
        <button type="button" class="journey-btn" data-journey="view-return" id="journeyViewReturn">
          <span class="journey-icon" aria-hidden="true">&#9654;</span>
          <span class="journey-label">Watch: View Return</span>
        </button>
      </div>

      <!-- Journey Status -->
      <div class="journey-status" role="status" aria-live="polite">
        <span id="journeyStatusText">Select a demo journey above to watch it in action, or explore the simulator below</span>
        <div class="journey-controls" id="journeyControls" style="display: none">
          <button type="button" id="pauseBtn" aria-label="Pause journey">&#9208;</button>
          <button type="button" id="stopBtn" aria-label="Stop journey">&#9209;</button>
        </div>
      </div>

      <!-- Simulator Container -->
      <div class="simulator-container" id="simulatorContainer" role="region" aria-label="DIY Accounting Submit Simulator">
        <button type="button" class="simulator-expand-btn" id="simulatorExpandBtn" aria-label="Expand simulator">
          <span id="expandIcon">&#x26F6;</span> <span id="expandLabel">Expand</span>
        </button>
        <a
          href="#"
          id="simulatorOpenLink"
          class="simulator-open-btn"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Open simulator in new tab"
          title="Open simulator in new tab"
          >&#x2197; Open the simulator in a new tab</a
        >
        <div class="simulator-overlay-label" aria-hidden="true">SIMULATOR</div>
        <iframe
          id="simulatorFrame"
          class="simulator-frame"
          title="DIY Accounting Submit Simulator - Demo Mode"
          sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
        >
          <p>
            Your browser does not support iframes. Please visit
            <a href="https://simulator.submit.diyaccounting.co.uk/">the simulator directly</a>.
          </p>
        </iframe>
      </div>

      <!-- Call to Action -->
      <section class="simulator-cta">
        <p>
          Ready to submit real VAT returns?
          <a href="index.html">Go to the main application</a>
          and log in with your Google account.
        </p>
      </section>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
          <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
          <a id="apiDocsLink" style="display: inline" target="_blank" href="docs/api/index.html">api</a>
          <a href="privacy.html">privacy</a>
          <a href="terms.html">terms</a>
          <a href="accessibility.html">accessibility</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script>
      // Compute simulator URL from current hostname using {env}-simulator.submit.diyaccounting.co.uk pattern
      // (matches Cognito pattern: {env}-auth.submit.diyaccounting.co.uk)
      //   submit.diyaccounting.co.uk     → https://prod-simulator.submit.diyaccounting.co.uk/
      //   ci.submit.diyaccounting.co.uk  → https://ci-simulator.submit.diyaccounting.co.uk/
      //   localhost / other              → production fallback
      var host = window.location.hostname;
      var baseDomain = "submit.diyaccounting.co.uk";
      if (host === baseDomain) {
        window.__simulatorFrameSrc = "https://prod-simulator." + baseDomain + "/";
      } else if (host.endsWith("." + baseDomain)) {
        var env = host.slice(0, host.length - baseDomain.length - 1);
        window.__simulatorFrameSrc = "https://" + env + "-simulator." + baseDomain + "/";
      } else {
        window.__simulatorFrameSrc = "https://prod-simulator." + baseDomain + "/";
      }
    </script>
    <script src="./simulator-local.js" onerror="void 0"></script>
    <script>
      // If build-simulator has been run, simulator-local.js sets __simulatorLocal = true
      // which switches the iframe to the same-origin /sim/ path
      if (window.__simulatorLocal) window.__simulatorFrameSrc = "/sim/";
      document.getElementById("simulatorFrame").src = window.__simulatorFrameSrc;
      document.getElementById("simulatorOpenLink").href = window.__simulatorFrameSrc;
    </script>

    <script>
      // Lightbox expand/collapse for simulator iframe
      document.getElementById("simulatorExpandBtn").addEventListener("click", function () {
        var container = document.getElementById("simulatorContainer");
        var icon = document.getElementById("expandIcon");
        var label = document.getElementById("expandLabel");
        var isExpanded = container.classList.toggle("simulator-expanded");
        icon.textContent = isExpanded ? "\u2716" : "\u26F6";
        label.textContent = isExpanded ? "Close" : "Expand";
        this.setAttribute("aria-label", isExpanded ? "Close expanded simulator" : "Expand simulator");
      });
      // ESC key to close lightbox
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          var container = document.getElementById("simulatorContainer");
          if (container.classList.contains("simulator-expanded")) {
            container.classList.remove("simulator-expanded");
            document.getElementById("expandIcon").textContent = "\u26F6";
            document.getElementById("expandLabel").textContent = "Expand";
            document.getElementById("simulatorExpandBtn").setAttribute("aria-label", "Expand simulator");
          }
        }
      });
    </script>

    <script type="module" src="./widgets/simulator-journeys.js"></script>
    <script type="module">
      import { SimulatorJourney, journeySubmitVat, journeyViewObligations, journeyViewReturn } from "./widgets/simulator-journeys.js";

      const journeys = {
        "submit-vat": journeySubmitVat,
        "view-obligations": journeyViewObligations,
        "view-return": journeyViewReturn,
      };

      let activeJourney = null;

      // Set up journey button handlers
      document.querySelectorAll(".journey-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const journeyName = btn.dataset.journey;
          const iframe = document.getElementById("simulatorFrame");
          const statusEl = document.getElementById("journeyStatusText");
          const controlsEl = document.getElementById("journeyControls");

          // Disable all journey buttons during playback
          document.querySelectorAll(".journey-btn").forEach((b) => (b.disabled = true));

          // Reset iframe to simulator home
          statusEl.textContent = "Loading simulator...";
          iframe.src = window.__simulatorFrameSrc;
          await new Promise((r) => setTimeout(r, 2000));

          activeJourney = new SimulatorJourney(iframe, statusEl);
          controlsEl.style.display = "flex";

          try {
            await journeys[journeyName](activeJourney);
          } catch (e) {
            if (e.message !== "Journey aborted") {
              console.error("Journey error:", e);
              statusEl.textContent = "Journey encountered an error. Try again or explore manually.";
            }
          }

          controlsEl.style.display = "none";
          if (activeJourney) activeJourney.destroy();
          activeJourney = null;

          // Re-enable journey buttons
          document.querySelectorAll(".journey-btn").forEach((b) => (b.disabled = false));
        });
      });

      // Pause button handler
      document.getElementById("pauseBtn").addEventListener("click", () => {
        if (activeJourney) {
          activeJourney.paused = !activeJourney.paused;
          document.getElementById("pauseBtn").textContent = activeJourney.paused ? "\u25B6" : "\u23F8";
        }
      });

      // Stop button handler
      document.getElementById("stopBtn").addEventListener("click", () => {
        if (activeJourney) {
          activeJourney.aborted = true;
          document.getElementById("journeyStatusText").textContent = "Journey stopped. Select another journey or explore manually.";
        }
      });
    </script>
  </body>
</html>
