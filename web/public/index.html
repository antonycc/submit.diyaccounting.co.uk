<!-- index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - VAT Returns for MTD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Submit VAT returns to HMRC Making Tax Digital. Secure VAT submission tool for DIY Accounting spreadsheet users. Free guest tier available."
    />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://submit.diyaccounting.co.uk/" />
    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="DIY Accounting Submit - VAT Returns for MTD" />
    <meta
      property="og:description"
      content="Submit VAT returns to HMRC Making Tax Digital. Secure VAT submission tool for DIY Accounting spreadsheet users. Free guest tier available."
    />
    <meta property="og:url" content="https://submit.diyaccounting.co.uk/" />
    <meta property="og:site_name" content="DIY Accounting" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="./submit.css" />
    <!-- CloudWatch RUM configuration placeholders; replace values during deployment -->
    <meta name="rum:appMonitorId" content="${RUM_APP_MONITOR_ID}" />
    <meta name="rum:region" content="${AWS_REGION}" />
    <meta name="rum:identityPoolId" content="${RUM_IDENTITY_POOL_ID}" />
    <meta name="rum:guestRoleArn" content="${RUM_GUEST_ROLE_ARN}" />
    <script src="./lib/analytics.js"></script>
    <script src="./lib/session-beacon.js"></script>
    <!-- HEAD-prefetch scripts to prime API Gateway/Lambda and authorizers to reduce cold-start impact -->
    <!--script async src="./prefetch/prefetch-catalog-head.js"></script-->
    <!--script async src="./prefetch/prefetch-bundle-head.js"></script-->
  </head>
  <body>
    <a href="#mainContent" class="skip-link">Skip to main content</a>
    <header>
      <div class="header-nav">
        <div class="header-left">
          <a href="index.html" title="Home" class="home-link">
            <svg class="home-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
          </a>
          <a href="about.html" title="About & Help" class="info-link">
            <svg class="info-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
            </svg>
          </a>
        </div>
        <div class="auth-section">
          <span class="entitlement-status">Activity: unrestricted</span>
          <span class="login-status">Not logged in</span>
          <a href="auth/login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
      <nav class="main-nav" aria-label="Main navigation">
        <a href="index.html" class="active">Activities</a>
        <a href="hmrc/receipt/receipts.html">Receipts</a>
        <a href="bundles.html">Bundles</a>
        <a href="spreadsheets.html">Spreadsheets</a>
      </nav>
    </header>

    <main id="mainContent">
      <div
        id="waitlistBanner"
        style="
          display: none;
          position: sticky;
          top: 0;
          z-index: 100;
          background-color: #d1ecf1;
          color: #0c5460;
          border-bottom: 1px solid #bee5eb;
          padding: 0.75em 1em;
          text-align: center;
          font-size: 0.95em;
        "
        role="complementary"
        aria-label="Early access registration"
      >
        <span>We're getting ready to launch. Register for early access and we'll send you an invitation.</span>
        <button
          type="button"
          id="waitlistJoinBtn"
          class="btn"
          style="
            margin-left: 1em;
            padding: 0.3em 1em;
            font-size: 0.9em;
            min-width: unset;
            width: auto;
            display: inline;
            vertical-align: middle;
          "
        >
          Register for Early Access
        </button>
        <button
          type="button"
          id="waitlistDismissBtn"
          style="
            background: none;
            border: none;
            color: #0c5460;
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 0.5em;
            vertical-align: middle;
            padding: 0 0.3em;
          "
          aria-label="Dismiss early access banner"
        >
          &#x2715;
        </button>
      </div>

      <div id="statusMessagesContainer" role="alert" aria-live="polite"></div>

      <div class="form-container" style="text-align: center">
        <div id="dynamicActivities" style="margin: 2em 0"></div>

        <!--div id="activitiesByBundle" style="text-align: left; margin: 1.5em auto; max-width: 640px"></div-->
      </div>

      <div
        style="
          max-width: 540px;
          margin: 2em auto 0;
          padding: 1em 1.25em;
          background: white;
          border-radius: 8px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
          text-align: center;
          font-size: 0.9em;
          color: #555;
        "
      >
        <span style="color: #977000; font-size: 1.2em; letter-spacing: 0.05em" aria-label="5 out of 5 stars"
          >&#9733;&#9733;&#9733;&#9733;&#9733;</span
        >
        <span style="font-weight: 600; color: #333; margin-left: 0.4em">5.0</span>
        <a
          href="https://maps.app.goo.gl/a9vQaci6xLU6v2Gr7"
          target="_blank"
          rel="noopener"
          style="margin-left: 0.4em; color: #2c5aa0; font-size: 0.9em"
          >9 reviews on Google</a
        >
        <p style="margin: 0.5em 0 0; font-style: italic; line-height: 1.5">
          &ldquo;I highly recommend the DIY Accounting accounts packages &mdash; far better value and much simpler than expensive
          subscription accounting packages.&rdquo;
        </p>
        <p style="margin: 0.25em 0 0; font-size: 0.85em; color: #767676">&mdash; Steve Walsh</p>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
          <a id="latestTestsLink" style="display: inline" target="_blank" href="tests/index.html">tests</a>
          <a id="apiDocsLink" style="display: inline" target="_blank" href="docs/api/index.html"> api </a>
          <a href="privacy.html">privacy</a>
          <a href="terms.html">terms</a>
          <a href="accessibility.html">accessibility</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025-2026 DIY Accounting Limited</p>
        </div>
        <div class="footer-right" id="localstorageContainer"></div>
      </div>
    </footer>

    <script src="lib/env-loader.js"></script>
    <script>
      (async function () {
        try { await window.loadEnv(); } catch (e) { console.warn("Failed to load environment:", e); }
      })();
    </script>
    <script type="module" src="./submit.js"></script>
    <script src="developer-mode.js"></script>
    <script src="lib/request-cache.js"></script>
    <script src="lib/toml-parser.js"></script>
    <script src="lib/feature-flags.js"></script>
    <script src="widgets/entitlement-status.js"></script>
    <script src="widgets/auth-status.js"></script>
    <script type="module" src="widgets/view-source-link.js"></script>
    <script src="widgets/localstorage-viewer.js"></script>
    <script>
      // In-memory user bundles state (list of bundleId strings)
      let __userBundles = [];
      let __sandboxBundleIds = new Set();
      let __tokensRemaining = 0;
      let __hasTokenBundles = false;
      let __fetchBundlesController = null;

      async function initializeBundles() {
        const idToken = localStorage.getItem("cognitoIdToken");
        const userInfo = localStorage.getItem("userInfo");
        if (idToken && userInfo) {
          console.log("User is authenticated");

          // Abort previous fetch if any
          if (__fetchBundlesController) {
            __fetchBundlesController.abort();
          }
          __fetchBundlesController = new AbortController();
          const signal = __fetchBundlesController.signal;

          // Fetch user bundles from endpoint (single source of truth)
          try {
            const rc = window.requestCache;
            let bundlesData;
            if (rc && typeof rc.getJSON === "function") {
              bundlesData = await rc.getJSON("/api/v1/bundle", {
                ttlMs: 5000,
                init: { headers: { Authorization: `Bearer ${idToken}` }, signal },
              });
            } else {
              const response = await window.fetchWithIdToken("/api/v1/bundle", { signal });
              if (response.ok) {
                bundlesData = await response.json();
              }
            }

            if (bundlesData && bundlesData.bundles && Array.isArray(bundlesData.bundles)) {
              const allocated = bundlesData.bundles.filter((b) => b.allocated);
              __userBundles = allocated.map((b) => b.bundleId);
              __sandboxBundleIds = new Set(allocated.filter((b) => b.qualifiers?.sandbox === true).map((b) => b.bundleId));
              // Set sessionStorage for sandbox mode based on bundle qualifiers (single source of truth)
              if (__sandboxBundleIds.size > 0) {
                sessionStorage.setItem("hmrcAccount", "sandbox");
              } else {
                sessionStorage.removeItem("hmrcAccount");
              }
              __tokensRemaining = typeof bundlesData.tokensRemaining === "number" ? bundlesData.tokensRemaining : 0;
              __hasTokenBundles = bundlesData.bundles.some((b) => b.allocated && b.tokensGranted !== undefined);
            } else {
              __userBundles = [];
              __sandboxBundleIds = new Set();
              __tokensRemaining = 0;
              __hasTokenBundles = false;
            }
          } catch (err) {
            if (err.name === "AbortError") {
              console.log("Fetch user bundles aborted");
              return;
            }
            console.warn("Failed to fetch bundles:", err);
            __userBundles = [];
          } finally {
            if (__fetchBundlesController?.signal === signal) {
              __fetchBundlesController = null;
            }
          }
          renderDynamicActivities();
        } else {
          console.log("User is not authenticated");
          __userBundles = [];
          renderDynamicActivities();
        }
      }

      // Activities rendering based on bundles
      function parseUserBundles() {
        // Return in-memory state; do not use localStorage for bundles
        return Array.isArray(__userBundles) ? __userBundles : [];
      }

      //function hasBundle(bundles, id) {
      //  return (bundles || []).some((b) => typeof b === "string" && b === id);
      //}

      // Parse bundle expiry date from bundle string or object
      function parseBundleExpiry(bundleEntry) {
        if (!bundleEntry) return null;
        if (typeof bundleEntry === "object") return bundleEntry.expiry || null;
        if (typeof bundleEntry !== "string") return null;

        const parts = bundleEntry.split("|");
        if (parts.length < 2) return null;
        const expiryMatch = parts[1].match(/EXPIRY=(.+)/);
        if (expiryMatch && expiryMatch[1]) {
          return expiryMatch[1]; // ISO date string like "2025-12-31" or full ISO timestamp
        }
        return null;
      }

      // Check if a bundle is expired
      function isBundleExpired(bundleEntry) {
        const expiryStr = parseBundleExpiry(bundleEntry);
        if (!expiryStr) return false; // No expiry means not expired
        const expiryDate = new Date(expiryStr);
        if (isNaN(expiryDate.getTime())) return false; // Invalid date
        return expiryDate < new Date(); // Expired if expiry date is in the past
      }

      // Get user's active bundles (automatic + granted non-expired)
      // Automatic bundles are only granted to authenticated users
      function getActiveBundles(catalog, userBundles) {
        const active = new Set();
        const isLoggedIn = !!localStorage.getItem("cognitoIdToken");

        // In simulator mode, grant all bundles so all activities are accessible
        if (document.documentElement.dataset.simulator === "true" && catalog.bundles) {
          for (const bundle of catalog.bundles) {
            active.add(bundle.id);
          }
          return Array.from(active);
        }

        // Add automatic bundles for authenticated users
        if (catalog.bundles && isLoggedIn) {
          for (const bundle of catalog.bundles) {
            if (bundle.allocation === "automatic") {
              active.add(bundle.id);
            }
          }
        }

        // Add granted non-expired bundles
        for (const bundleEntry of userBundles) {
          if (!isBundleExpired(bundleEntry)) {
            const bundleId = typeof bundleEntry === "string" ? bundleEntry.split("|")[0] : bundleEntry.bundleId;
            active.add(bundleId);
          }
        }

        return Array.from(active);
      }

      // Get user's expired bundles
      function getExpiredBundles(userBundles) {
        const expired = new Set();
        for (const bundleEntry of userBundles) {
          if (isBundleExpired(bundleEntry)) {
            const bundleId = typeof bundleEntry === "string" ? bundleEntry.split("|")[0] : bundleEntry.bundleId;
            expired.add(bundleId);
          }
        }
        return Array.from(expired);
      }

      // Check if user has access to an activity
      function canAccessActivity(activity, activeBundles) {
        if (!activity.bundles || !Array.isArray(activity.bundles)) return false;
        return activity.bundles.some((bundleId) => activeBundles.includes(bundleId));
      }

      // function renderActivitiesByBundle() {
      //   const container = document.getElementById("activitiesByBundle");
      //   if (!container) return;
      //
      //   // Keep the bundle summary section for now, but we could make this dynamic too
      //   const bundles = parseUserBundles();
      //   const sections = [];
      //
      //   // Default bundle always available
      //   sections.push(`
      //     <section style="margin-bottom:1em;">
      //       <h3 style="margin:0 0 .5em 0;">Default bundle</h3>
      //       <ul>
      //         <li>VAT Obligations (Production) – available</li>
      //         <li>View receipts – available</li>
      //       </ul>
      //     </section>
      //   `);
      //
      //   if (hasBundle(bundles, "test") || hasBundle(bundles, "test")) {
      //     sections.push(`
      //       <section style="margin-bottom:1em;">
      //         <h3 style="margin:0 0 .5em 0;">Test API bundle</h3>
      //         <ul>
      //           <li>Submit VAT (Sandbox API) – available</li>
      //           <li>VAT Obligations (Sandbox API) – available</li>
      //         </ul>
      //       </section>
      //     `);
      //   }
      //
      //   container.innerHTML = sections.join("");
      //   container.style.display = "block"; // Make sure it's visible
      // }

      // Generate dynamic activity buttons based on display rules from catalogue
      // Display rules:
      //   - "never": don't show the button
      //   - "on-entitlement": show only if user has an active bundle (default)
      //   - "always-with-upsell": always show; if not entitled, show as call-to-action linking to bundles page
      //   - "always": always show the button regardless of entitlement
      async function renderDynamicActivities() {
        const dynamicContainer = document.getElementById("dynamicActivities");
        if (!dynamicContainer) return;

        try {
          // Fetch catalog
          const response = await fetch("/submit.catalogue.toml");
          if (!response.ok) {
            dynamicContainer.innerHTML = '<p style="color: #b00020;">Unable to load activities. Please try again later.</p>';
            return;
          }

          const text = await response.text();
          const catalog = window.TOML ? window.TOML.parse(text) : await response.json().catch(() => ({}));
          const userBundles = parseUserBundles();
          const activeBundles = getActiveBundles(catalog, userBundles);
          const expiredBundles = getExpiredBundles(userBundles);

          // Build a map of bundle id -> levelName for upsell display (distinct levels)
          const bundleLevelNameMap = {};
          for (const bundle of catalog.bundles || []) {
            bundleLevelNameMap[bundle.id] = bundle.levelName || bundle.name || bundle.id;
          }

          const buttons = [];

          for (const activity of catalog.activities || []) {
            if (!activity.bundles || !Array.isArray(activity.bundles)) continue;

            const displayRule = activity.display || "on-entitlement";

            // Skip activities with display="never"
            if (displayRule === "never") continue;

            const hasNonExpiredAccess = activity.bundles.some((bundleId) => activeBundles.includes(bundleId));
            const hasExpiredAccess = activity.bundles.some((bundleId) => expiredBundles.includes(bundleId));

            // Get the activity path
            let path = "#";
            if (activity.paths) {
              path = activity.paths.find((p) => p.includes(".html")) || "#";
            } else if (activity.path) {
              path = activity.path;
            }

            if (hasNonExpiredAccess || displayRule === "always") {
              // User has access OR display="always" - show active button
              const tokenCost = activity.tokenCost || 0;
              const isMetered = activity.metered === true;
              const tokenLabel = isMetered ? ` (${tokenCost} token${tokenCost !== 1 ? "s" : ""})` : "";

              // Check if user has insufficient tokens for metered activities
              const insufficientTokens = isMetered && __hasTokenBundles && tokenCost > 0 && __tokensRemaining < tokenCost;
              const noTokensForMetered = isMetered && __hasTokenBundles && tokenCost === 0 && __tokensRemaining === 0;

              if (insufficientTokens) {
                buttons.push(`
                  <div style="margin: 1em 0">
                    <button type="button" class="btn" disabled>
                      Insufficient tokens \u2014 ${activity.name}
                    </button>
                    <p style="font-size: 0.85em; color: #856404; margin: 0.25em 0 0 0;">
                      Insufficient tokens
                    </p>
                  </div>
                `);
              } else if (noTokensForMetered) {
                buttons.push(`
                  <div style="margin: 1em 0">
                    <button type="button" class="btn" disabled>
                      No tokens \u2014 ${activity.name}
                    </button>
                    <p style="font-size: 0.85em; color: #856404; margin: 0.25em 0 0 0;">
                      No tokens available
                    </p>
                  </div>
                `);
              } else {
                buttons.push(`
                  <div style="margin: 1em 0">
                    <button type="button" class="btn" onclick="window.location.href='${path}'">
                      ${activity.name}${tokenLabel}
                    </button>
                  </div>
                `);
              }
            } else if (hasExpiredAccess) {
              // User had access but it expired - show disabled button
              buttons.push(`
                <div style="margin: 1em 0">
                  <button type="button" class="btn" disabled>
                    Expired \u2014 ${activity.name}
                  </button>
                </div>
              `);
            } else if (displayRule === "always-with-upsell") {
              // User doesn't have access - show activity with upsell annotation
              const isLoggedIn = !!localStorage.getItem("cognitoIdToken");
              const distinctLevelNames = [
                ...new Set(activity.bundles.filter((id) => id !== "default").map((id) => bundleLevelNameMap[id] || id)),
              ];
              const requiredBundleNames = distinctLevelNames.join(" or ");

              if (isLoggedIn) {
                // Logged in but missing bundle - link to bundles page
                buttons.push(`
                  <div style="margin: 1em 0">
                    <button type="button" class="btn" onclick="window.location.href='bundles.html'">
                      ${activity.name}
                    </button>
                    <p style="font-size: 0.85em; color: #666; margin: 0.25em 0 0 0;">
                      Requires: ${requiredBundleNames}
                    </p>
                  </div>
                `);
              } else {
                // Not logged in - prompt to log in
                buttons.push(`
                  <div style="margin: 1em 0">
                    <button type="button" class="btn" onclick="window.location.href='auth/login.html'">
                      ${activity.name}
                    </button>
                    <p style="font-size: 0.85em; color: #666; margin: 0.25em 0 0 0;">
                      Login and add bundle to access
                    </p>
                  </div>
                `);
              }
            }
            // For displayRule === "on-entitlement" with no access, don't show anything
          }

          // If no activities to show, display message
          if (buttons.length === 0) {
            dynamicContainer.innerHTML =
              '<p style="color: #666;">No activities available. Request additional bundles to access more features.</p>';
            return;
          }

          dynamicContainer.innerHTML = buttons.join("");
        } catch (error) {
          console.error("Error loading activities:", error);
          dynamicContainer.innerHTML = '<p style="color: #b00020;">Error loading activities. Please refresh the page.</p>';
        }
      }

      sessionStorage.removeItem("currentActivity");
      console.log("Current activity cleared");

      // Waitlist banner logic
      async function initWaitlistBanner() {
        const banner = document.getElementById("waitlistBanner");
        if (!banner) return;

        const isLoggedIn = !!localStorage.getItem("cognitoIdToken");
        const alreadyRegistered = localStorage.getItem("waitlistRegistered") === "true";

        if (!isLoggedIn || alreadyRegistered) return;

        // Check feature flag
        if (window.featureFlags && typeof window.featureFlags.isFeatureEnabled === "function") {
          const enabled = await window.featureFlags.isFeatureEnabled("waitlist");
          if (!enabled) return;
        }

        banner.style.display = "block";

        var joinBtn = document.getElementById("waitlistJoinBtn");
        var dismissBtn = document.getElementById("waitlistDismissBtn");

        if (joinBtn) {
          joinBtn.addEventListener("click", async function () {
            joinBtn.disabled = true;
            joinBtn.textContent = "Registering...";
            try {
              var response = await window.fetchWithIdToken("/api/v1/interest", { method: "POST" });
              if (response.ok) {
                joinBtn.textContent = "You're registered!";
                joinBtn.style.backgroundColor = "#0a8927";
                localStorage.setItem("waitlistRegistered", "true");
              } else {
                joinBtn.textContent = "Try again";
                joinBtn.disabled = false;
              }
            } catch (err) {
              console.error("Waitlist registration failed:", err);
              joinBtn.textContent = "Try again";
              joinBtn.disabled = false;
            }
          });
        }

        if (dismissBtn) {
          dismissBtn.addEventListener("click", function () {
            banner.style.display = "none";
          });
        }
      }

      // Initialize page - wait for submit.js module to be ready
      function initPage() {
        checkAuthStatus();
        initializeBundles();
        initWaitlistBanner();
      }

      if (window.__submitReady__) {
        initPage();
      } else {
        document.addEventListener("submit-ready", initPage, { once: true });
      }
    </script>
  </body>
</html>
