<!-- bundles.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DIY Accounting Submit - Add Bundle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="submit.css" />
    <script src="/config.js"></script>
  </head>
  <body>
    <header>
      <div class="header-nav">
        <div class="hamburger-menu">
          <button class="hamburger-btn" onclick="toggleMenu()">☰</button>
          <div class="menu-dropdown" id="menuDropdown">
            <a href="index.html">Home</a>
            <a href="activities.html">View Activities</a>
            <a href="bundles.html">Add Bundle</a>
            <a href="receipts.html">Receipts</a>
          </div>
        </div>
        <div class="auth-section">
          <span class="login-status">Not logged in</span>
          <a href="login.html" class="login-link">Log in</a>
        </div>
      </div>
      <h1>DIY Accounting Submit</h1>
      <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
    </header>

    <div id="mainContent">
      <div class="form-container" style="text-align: center">
        <h2>Add Bundle</h2>
        <p>Select a service to add to your account:</p>

        <div class="bundles-list">
          <div class="service-item">
            <h3>HMRC Test API Bundle</h3>
            <p class="service-description">Connect to HMRC's test environment for development and testing purposes.</p>
            <button type="button" class="btn service-btn" onclick="requestBundle('HMRC_TEST_API')">
              Add HMRC Test API Bundle
            </button>
          </div>

          <div class="service-item disabled">
            <h3>HMRC Production API Bundle</h3>
            <p class="service-description">Connect to HMRC's production environment for live submissions.</p>
            <button type="button" class="btn service-btn disabled-btn" disabled>Add HMRC Production API Bundle</button>
            <p class="coming-soon-text">Coming soon</p>
          </div>

          <div class="service-item disabled">
            <h3>Companies House API Bundle</h3>
            <p class="service-description">Connect to Companies House for company information and filings.</p>
            <button type="button" class="btn service-btn disabled-btn" disabled>Add Companies House API Bundle</button>
            <p class="coming-soon-text">Coming soon</p>
          </div>
        </div>

        <div style="margin-top: 2em">
          <button
            type="button"
            class="btn"
            onclick="window.location.href='index.html'"
            style="background-color: #6c757d; border-color: #6c757d"
          >
            Back to Home
          </button>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <div class="footer-left">
          <a href="#" id="viewSourceLink" style="display: none">view source</a>
        </div>
        <div class="footer-center">
          <p>&copy; 2025 DIY Accounting Limited</p>
        </div>
      </div>
    </footer>

    <script>
      // Hamburger menu toggle functionality
      function toggleMenu() {
        const dropdown = document.getElementById("menuDropdown");
        dropdown.classList.toggle("show");
      }

      // Load and display view source link
      async function loadViewSourceLink() {
        try {
          const response = await fetch("source.txt");
          if (response.ok) {
            const commitHash = (await response.text()).trim();
            if (commitHash) {
              const currentPage = window.location.pathname.split("/").pop() || "index.html";
              const githubUrl = `https://github.com/antonycc/submit.diyaccounting.co.uk/blob/${commitHash}/web/public/${currentPage}`;
              const viewSourceLink = document.getElementById("viewSourceLink");
              viewSourceLink.href = githubUrl;
              viewSourceLink.textContent = `source: ${currentPage}@${commitHash.substring(0, 7)}`;
              viewSourceLink.style.display = "inline";
            }
          }
        } catch (error) {
          console.log("Could not load source.txt:", error);
        }
      }

      // Authentication and bundle management functions

      // Update login status display
      function updateLoginStatus() {
        const userInfo = localStorage.getItem("userInfo");
        const loginStatusElement = document.querySelector(".login-status");
        const loginLinkElement = document.querySelector(".login-link");

        if (userInfo) {
          const user = JSON.parse(userInfo);
          const userLabel = user.email ? user.email : user.sub;
          console.log("User info:", user);
          console.log("User label:", userLabel);
          loginStatusElement.textContent = `Logged in as ${userLabel}`;
          loginLinkElement.textContent = "Logout";
          loginLinkElement.href = "#";
          loginLinkElement.onclick = logout;
        } else {
          loginStatusElement.textContent = "Not logged in";
          loginLinkElement.textContent = "Log in";
          loginLinkElement.href = "login.html";
          loginLinkElement.onclick = null;
        }
      }

      // Logout function
      function logout() {
        console.log("Logging out user");

        // Clear stored tokens and user info
        localStorage.removeItem("cognitoAccessToken");
        localStorage.removeItem("cognitoIdToken");
        localStorage.removeItem("cognitoRefreshToken");
        localStorage.removeItem("userInfo");
        localStorage.removeItem("authState");

        // Update login status
        updateLoginStatus();

        // Redirect to home page
        window.location.href = "index.html";
      }

      // Request a bundle
      async function requestBundle(bundleId) {
        console.log("Requesting bundle:", bundleId);

        // Check if user is authenticated
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const idToken = localStorage.getItem("cognitoIdToken");

        if (!accessToken || !idToken) {
          alert("Please log in first to request bundles.");
          window.location.href = "login.html";
          return;
        }

        const button = event.target;
        const originalText = button.textContent;

        try {
          // Show loading state
          button.textContent = "Requesting...";
          button.disabled = true;

          // Make request to bundle API
          const response = await fetch("/api/request-bundle", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`,
            },
            body: JSON.stringify({
              bundleId: bundleId,
            }),
          });

          const result = await response.json();

          if (response.ok) {
            // Persist bundles for later pages
            if (result && Array.isArray(result.bundles)) {
              localStorage.setItem("userBundles", JSON.stringify(result.bundles));
            }

            if (result.status === "granted") {
              alert(`Bundle granted successfully! Expires on: ${result.expiryDate}`);
              button.textContent = "Bundle Added ✓";
              button.style.backgroundColor = "#28a745";
              console.log("Bundle granted:", result);
            } else if (result.status === "already_granted") {
              alert("You already have this bundle!");
              button.textContent = "Already Added ✓";
              button.style.backgroundColor = "#28a745";
              console.log("Bundle already granted:", result);
            }

            // Update bundle status display
            updateBundleStatus();
          } else {
            console.error("Bundle request failed:", result);
            alert(`Failed to request bundle: ${result.error || "Unknown error"}`);
            button.textContent = originalText;
            button.disabled = false;
          }
        } catch (error) {
          console.error("Bundle request error:", error);
          alert("Failed to request bundle. Please try again.");

          // Reset button state
          button.textContent = originalText;
          button.disabled = false;
        }
      }

      // Update bundle status display – reflect previously selected bundles in the UI
      async function updateBundleStatus() {
        try {
          // Parse bundles from localStorage (array of strings like "HMRC_TEST_API" or "HMRC_TEST_API|EXPIRY=YYYY-MM-DD")
          const parseUserBundles = () => {
            try {
              const raw = localStorage.getItem("userBundles");
              if (!raw) return [];
              const arr = JSON.parse(raw);
              return Array.isArray(arr) ? arr : [];
            } catch (_e) {
              return [];
            }
          };
          const hasBundle = (bundles, id) =>
            (bundles || []).some((b) => typeof b === "string" && (b === id || b.startsWith(id + "|")));

          const bundles = parseUserBundles();

          // Legacy static UI: mark HMRC_TEST_API as already added
          const legacyBtn = document.querySelector(
            'button.btn.service-btn:not(.disabled-btn)[onclick*="HMRC_TEST_API"]',
          );
          if (legacyBtn) {
            if (hasBundle(bundles, "HMRC_TEST_API")) {
              legacyBtn.textContent = "Already Added ✓";
              legacyBtn.disabled = true;
              legacyBtn.style.backgroundColor = "#28a745";
            }
          }

          // Catalog-driven UI: mark any rendered bundle cards as active
          const dataButtons = document.querySelectorAll("button[data-bundle-id]");
          if (dataButtons && dataButtons.length) {
            for (const btn of dataButtons) {
              const bundleId = btn.getAttribute("data-bundle-id");
              if (bundleId && hasBundle(bundles, bundleId)) {
                btn.textContent = `Already Added ✓`;
                btn.disabled = true;
                btn.style.backgroundColor = "#28a745";
                const card = btn.closest(".service-item");
                const statusEl = card && card.querySelector(".status");
                if (statusEl) {
                  statusEl.textContent = "Active";
                  statusEl.style.color = "#2c7a7b";
                }
              }
            }
          }
        } catch (error) {
          console.error("Error updating bundle status:", error);
        }
      }

      // Check authentication status on page load
      function checkAuthStatus() {
        const accessToken = localStorage.getItem("cognitoAccessToken");
        const userInfo = localStorage.getItem("userInfo");

        if (accessToken && userInfo) {
          console.log("User is authenticated");
          updateLoginStatus();
          updateBundleStatus();
        } else {
          console.log("User is not authenticated");
          updateLoginStatus();
        }
      }

      // Close menu when clicking outside
      window.onclick = function (event) {
        if (!event.target.matches(".hamburger-btn")) {
          const dropdown = document.getElementById("menuDropdown");
          if (dropdown.classList.contains("show")) {
            dropdown.classList.remove("show");
          }
        }
      };

      localStorage.removeItem("currentActivity");
      console.log("Current activity cleared");

      // Load view source link on page load
      loadViewSourceLink();

      // Initialize page
      checkAuthStatus();
    </script>
    <script>
      // Catalog-driven Bundles UI (optional, gated by CATALOG_DRIVEN_UI)
      (async function () {
        try {
          if (!window.CATALOG_DRIVEN_UI) return;
          const main = document.getElementById("mainContent");
          if (!main) return;

          const idToken = localStorage.getItem("cognitoIdToken");
          const headers = idToken ? { Authorization: `Bearer ${idToken}` } : {};
          const res = await fetch("/api/catalog", { headers });
          if (!res.ok) throw new Error("catalog fetch failed");
          const catalog = await res.json();

          function bundleCard(b) {
            const q = b.qualifiers || {};
            const qFields = [];
            if (Object.prototype.hasOwnProperty.call(q, "requiresTransactionId") && q.requiresTransactionId) {
              qFields.push(`<label>Transaction ID <input name="transactionId" /></label>`);
            }
            if (Object.prototype.hasOwnProperty.call(q, "subscriptionTier")) {
              qFields.push(
                `<label>Subscription Tier <input name="subscriptionTier" value="${q.subscriptionTier}" /></label>`,
              );
            }
            const info = [
              `allocation: ${b.allocation}`,
              b.auth ? `auth: ${b.auth}` : "",
              b.cap != null ? `cap: ${b.cap}` : "",
              b.timeout ? `timeout: ${b.timeout}` : "",
            ]
              .filter(Boolean)
              .join(" • ");

            return `
              <div class="service-item" style="text-align:left">
                <h3>${b.name || b.id}</h3>
                <p class="service-description">${info}</p>
                ${qFields.length ? `<div class="qualifiers" style="display:flex; gap:.5em; flex-wrap:wrap">${qFields.join(" ")}</div>` : ""}
                <button type="button" class="btn service-btn" data-bundle-id="${b.id}">Request ${b.id}</button>
                <div class="status" style="font-size:.9em; color:#666; margin-top:.25em"></div>
              </div>`;
          }

          const cards = (catalog.bundles || []).map(bundleCard).join("\n");
          main.innerHTML = `
            <div class="form-container" style="text-align:center">
              <h2>Add Bundle</h2>
              <p>Rendered from product catalog</p>
              <div class="bundles-list">${cards}</div>
              <div style="margin-top:2em">
                <button type="button" class="btn" onclick="window.location.href='index.html'" style="background-color:#6c757d;border-color:#6c757d">Back to Home</button>
              </div>
            </div>`;

          // Wire buttons
          for (const btn of document.querySelectorAll("button[data-bundle-id]")) {
            btn.addEventListener("click", async (e) => {
              const card = e.target.closest(".service-item");
              const statusEl = card.querySelector(".status");
              const bundleId = e.target.getAttribute("data-bundle-id");
              const qualifiers = {};
              const tx = card.querySelector('input[name="transactionId"]');
              if (tx && tx.value) qualifiers.transactionId = tx.value;
              const tier = card.querySelector('input[name="subscriptionTier"]');
              if (tier && tier.value) qualifiers.subscriptionTier = tier.value;
              try {
                const r = await fetch("/api/request-bundle", {
                  method: "POST",
                  headers: { "Content-Type": "application/json", ...(headers || {}) },
                  body: JSON.stringify({ bundleId, qualifiers }),
                });
                const body = await r.json().catch(() => ({}));
                if (r.ok) {
                  statusEl.textContent = `Granted: ${body.status || "ok"} ${body.expiry ? `(expires ${body.expiry})` : ""}`;
                  statusEl.style.color = "#2c7a7b";
                } else {
                  statusEl.textContent = `Error: ${body.error || r.status}`;
                  statusEl.style.color = "#b00020";
                }
              } catch (err) {
                statusEl.textContent = `Error: ${err?.message || err}`;
                statusEl.style.color = "#b00020";
              }
            });
          }

          // Reflect pre-existing selections after rendering
          if (typeof updateBundleStatus === "function") {
            try {
              await updateBundleStatus();
            } catch {
              /* ignore */
            }
          }
        } catch (e) {
          console.log("CATALOG_DRIVEN_UI bundles rendering failed:", e);
        }
      })();
    </script>
  </body>
</html>
