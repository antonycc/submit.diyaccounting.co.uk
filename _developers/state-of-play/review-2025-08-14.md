# Submit.diyaccounting.co.uk – Deep Repo Assessment (Revised with CI/CD Workflows)

*Date:* 2025‑08‑14 (Europe/London)  
*Repo:* `antonycc/submit.diyaccounting.co.uk` (branch: `main`)  
*Primary goal:* HMRC MTD VAT submission for Google‑authenticated UK taxpayers  
*Constraints:* AWS via Java CDK; Node.js 22 (ESM); near‑zero cost at rest; zero downtime; no JS client frameworks  
*Environments:* proxy, ci, prod

---

## A) Repository Synopsis

**Purpose.**  
Static web frontend (S3 + CloudFront) and Lambda URL backends (Node 22) for OAuth (HMRC/Google/mock), token exchange, VAT submission, and receipt logging. Java CDK (`WebStack`) provisions Route53/ACM, CloudFront, S3 origins, Lambda URL origins, optional Cognito + Google IdP, Secrets Manager entries, and optional CloudTrail/X‑Ray. CI/CD (GitHub Actions) builds, tests, synthesizes, deploys, and runs browser/behaviour tests with Playwright and ngrok.

**System diagram (ASCII).**
```
Browser
  │ HTTPS
  ▼
CloudFront ── S3 Origin → / (static web/public)
     └── Lambda URL Origins (CF behaviors)
           ├─ /api/hmrc/auth-url → authUrl.httpGetHmrc
           ├─ /api/google/auth-url → authUrl.httpGetGoogle (Cognito/Google)
           ├─ /api/mock/auth-url → authUrl.httpGetMock
           ├─ /api/hmrc/exchange-token → exchangeToken.httpPostHmrc
           ├─ /api/google/exchange-token → exchangeToken.httpPostGoogle
           ├─ /api/submit-vat → submitVat.httpPost
           ├─ /api/log-receipt → logReceipt.httpPost
           └─ /api/request-bundle → bundle.httpPost
Secrets Manager (HMRC/Google) • Cognito (optional) • S3 receipts • CloudTrail/X‑Ray (configurable)
```
**Key components (with evidence).**
- Infrastructure: Hosted zone, certificate, CloudFront, S3 origins & access logging, Lambda URL origins, receipts bucket, optional Cognito/Google IdP, CloudTrail/X‑Ray flags – all via `WebStack.java` and helpers.
- CI/CD: multi‑workflow pipeline (deploy, deploy‑ci‑only, publish, test‑app/web/infra/behaviour/slowly) with OIDC → AWS roles, Docker Buildx to build a reusable base image, mvn package, dotenv‑driven CDK synth/deploy, and Playwright artefacts.
- Node 22 ESM app with Vitest + Playwright; convenience scripts in `package.json`.

---

## B) Intent Evidence Map (selected highlights)

- **CI deploy to CI env:** `deploy-ci-only.yml` deploys stack `SubmitWebStack-ci`, builds a base Docker image, uses OIDC to assume `submit-github-actions-role` then `submit-deployment-role`, then runs `npx dotenv -e .env.ci -- <deploy>`; runs Playwright behaviour tests against CI and uploads artefacts.
- **Main deploy orchestration:** `deploy.yml` gates prod deploy on *local* behaviour tests, packages with Maven, then (re)builds base image and deploys to `inputs.environment` (default prod). After deploy, runs remote behaviour tests against the chosen env and uploads artefacts.
- **Promotion & versioning:** `publish.yml` runs test suites, builds Maven/CDK, publishes to npm (GPR) and Maven (if present), then rewrites `cdk.json` JAR version and commits.
- **Repository variables sync:** `set-repository-variables.yml` syncs `.github/repository.env` into repo‑scoped GitHub Variables, eliminating manual drift.
- **Workload slicing:** `test-app.yml`, `test-web.yml`, `test-infra.yml`, `test-behaviour.yml`, and `test-slowly.yml` split unit/integration/system/browser/behaviour tests and schedule periodic runs.
- **App scripts:** `package.json` pins Node >=22, provides Vitest/Playwright scripts, CDK synth (`test:cdk`) that docker‑builds a base image and uses `dotenv` to supply CDK context.

---

## C) Findings (revised)

> Severity scale: Critical / High / Medium / Low

1) **Secrets created from plaintext at deploy (High).**  
   *Evidence:* CDK constructs new Secrets from strings provided at deploy time (env/context) then passes those to Lambdas; workflows pass `HMRC_CLIENT_SECRET` & Google secret as GitHub Secrets into CDK via dotenv. *Risk:* plaintext exposure via env/context, drift across stacks.  
   **Fix:** Create Secrets **out‑of‑band** (manually or Terraform/seed job) and reference via `Secret.fromSecretCompleteArn` in CDK. Remove plaintext secret values from deploy inputs; pass only ARNs.

2) **Duplicate Docker base‑image builds across jobs (Medium).**  
   *Evidence:* `deploy.yml` both builds a base image in `build-base-image` job **and** rebuilds it again in `deploy-to-environment`. `deploy-ci-only.yml` also builds its own image.  
   **Fix:** Reuse the tag output (`needs.build-base-image.outputs.base-image-tag`) everywhere; remove per‑job rebuilds; promote to a *reusable workflow* that outputs an image tag.

3) **CloudTrail/X‑Ray default disabled in context (Medium).**  
   *Evidence:* `cdk.json` sets these false by default; workflows do pass repo variables, but default remains off unless overridden.  
   **Fix:** Enable in CI/Prod (repo Variables) and gate via cost‑aware retention (e.g., 3–7 days) and sampling rules.

4) **Single wide deployment role (Medium).**  
   *Evidence:* tests and deployments assume `submit-deployment-role`.  
   **Fix:** Introduce a read‑only “tester” role for Playwright and artifact retrieval; keep deployment role scoped to CDK changes only. Attach S3 GetObject/PutObject to a dedicated bucket prefix for test artefacts.

5) **Behaviour tests coupled to ngrok and env copying (Low).**  
   *Evidence:* jobs authenticate ngrok and sometimes copy `.env.<env>` → `.env.proxy`.  
   **Fix:** Add a small wrapper that resolves env‑specific values without file copying; make ngrok optional behind a flag to cut flakiness.

6) **Receipts bucket lifecycle (Low).**  
   *Evidence:* receipts/log‑forwarding buckets created; lifecycle rules not clearly defined for receipts.  
   **Fix:** Add lifecycle transitions/expiry to keep storage predictable.

7) **CI cache opportunities (Low).**  
   *Evidence:* npm cache used; Maven cache enabled; still running `./mvnw clean package` multiple times.  
   **Fix:** Cache the packaged JAR or enable `dependency:go-offline` where missing; avoid clean between jobs unless necessary.

---

## D) Next‑Best Changes (ranked backlog)

1) **Secrets posture (winner)**
    - *Goal:* Eliminate plaintext secrets from deploy inputs; CDK references ARNs only.
    - *Impact:* Security, compliance.
    - *Effort:* Low–Medium.
    - *AC:* CDK uses `Secret.fromSecretCompleteArn`, workflows accept `*_SECRET_ARN` not the secret value; successful deploy.

2) **Consolidate base‑image build**
    - *Goal:* Build once, reuse tag across jobs/workflows.
    - *Impact:* Speed & cost (CI minutes, Docker IO).
    - *Effort:* Low.
    - *AC:* No per‑job rebuilds; total CI time down (target −20–30%).

3) **Observability defaults**
    - *Goal:* Enable CloudTrail/X‑Ray in CI/Prod with lean retention/sampling.
    - *Impact:* Reliability & forensics.
    - *Effort:* Low.
    - *AC:* Trails + traces visible; retention ≤ 7 days in CI; alarms wired.

4) **Split tester vs deployer IAM**
    - *Goal:* Least‑privilege for tests.
    - *Impact:* Security.
    - *Effort:* Medium.
    - *AC:* Playwright assumes `submit-test-role` only; CDK assumes `submit-deployment-role` only.

5) **Receipts lifecycle**
    - *Goal:* Predictable storage cost.
    - *Effort:* Low.
    - *AC:* Lifecycle policy applied; cost trend flattens.

---

## E) Proposed Diffs (sketches)

**E.1 – Workflow inputs (secrets by ARN)**
- Replace `DIY_SUBMIT_HMRC_CLIENT_SECRET` / `DIY_SUBMIT_GOOGLE_CLIENT_SECRET` in workflow env with `DIY_SUBMIT_*_CLIENT_SECRET_ARN`.
- In `WebStack`, replace secret creation from plaintext with `Secret.fromSecretCompleteArn(...)` and pass only the ARN to Lambdas via env.

**E.2 – Build base image once**
- Extract base‑image build into a *reusable workflow* that outputs `base-image-tag`.
- In `deploy.yml` and `deploy-ci-only.yml`, remove secondary `docker buildx build` steps; consume the output via `needs` (or `workflow_call` outputs).

**E.3 – Observability defaults via repo Variables**
- Set repo Variables: `AWS_CLOUD_TRAIL_ENABLED=true`, `AWS_X_RAY_ENABLED=true`, `AWS_VERBOSE_LOGGING=false` for prod; slightly different for CI.
- Ensure defaults in `cdk.json` are overridden in deploy steps (already wired via env → dotenv).

**E.4 – New IAM role for tests**
- Add `submit-test-role` with `sts:AssumeRole` by GitHub OIDC, scoped to: `s3:GetObject`, `s3:PutObject` for artefacts & receipts read, no CDK permissions. Update test jobs to assume this role only.

**E.5 – Receipts lifecycle**
- Add 90‑day expiration for raw receipts; transition to IA after 30 days if needed; keep logs separate with own lifecycle.

---

## F) Commands + Automation

**Reusable base image workflow (example):**
```yaml
# .github/workflows/build-base-image.yml
name: build-base-image
on:
  workflow_call:
    outputs:
      tag:
        description: built tag
        value: ${{ jobs.build.outputs.tag }}
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.out.outputs.tag }}
    steps:
      - uses: actions/checkout@v5
      - uses: docker/setup-buildx-action@v3
      - id: out
        run: |
          TAG="submit-base:${GITHUB_SHA}"
          docker buildx build --load -t "$TAG" -f Dockerfile .
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
```

**Consume in deploy CI:**
```yaml
# in deploy.yml / deploy-ci-only.yml
jobs:
  base-image:
    uses: ./.github/workflows/build-base-image.yml

  mvn-package:
    needs: [base-image]
    env:
      BASE_IMAGE_TAG: ${{ needs.base-image.outputs.tag }}
```

**CDK deploy (unchanged pattern):**
```bash
npx dotenv -e .env.${ENV_NAME} -- $(jq -r '.deployStacks' cdk.json)
```

---

## G) Rollout + Observability

- **Canary:** DNS flip or versioned CF distribution; start with 5–10% traffic.
- **SLIs/SLOs:** p50/p95 latency per Lambda URL; 4xx/5xx rates; token‑exchange failures; cold starts; receipt write errors.
- **Alerts:** Trail delivery failures; 5xx >1% for 5m; high token‑exchange 4xx; DynamoDB conditional‑check‑failed (if bundle limits adopted).
- **Rollback:** Keep previous distribution; immediate DNS revert; restore old repo Variables if observability causes cost spikes.

---

## H) Open Questions

1. Confirm intended prod auth path (Cognito vs direct Google) to set the correct JWT verification path.
2. Confirm desired retention for receipts and CloudTrail in each env.
3. Are base images intended to be published to a registry (ECR GHCR) for cross‑workflow reuse?
4. Any blockers to introducing a `submit-test-role`?

---

## I) Appendix

**CI/CD summary:**
- *Deploy:* `deploy.yml` orchestrates tests → build → CI deploy → env deploy → env behaviour tests; builds Docker base image, uses OIDC to chain to deployment role.
- *CI‑only deploy:* `deploy-ci-only.yml` allows “CI deploy” and behaviour tests without touching prod.
- *Publish:* `publish.yml` runs tests, publishes npm/maven, and updates `cdk.json` JAR reference.
- *Test splits:* `test-app.yml`, `test-web.yml`, `test-infra.yml`, `test-behaviour.yml`, `test-slowly.yml` cover app/web/infra/behaviour and schedule recurring checks.
- *package.json:* Node ≥22, Vitest/Playwright scripts, CDK synth helper (`test:cdk`), video conversion utility.

**Smallest Beneficial PRs (SBPs):**
1) Secrets‑by‑ARN in CDK & workflows.
2) Reusable base‑image workflow + consumption.
3) Observability defaults & alarms.
4) Test‑only IAM role split.
5) Receipts lifecycle policy.