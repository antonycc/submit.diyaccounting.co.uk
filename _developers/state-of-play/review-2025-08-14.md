# Repository Synopsis

The **DIY Accounting Submit** repository delivers a developer‑friendly service for UK taxpayers to submit VAT returns via HMRC’s Making Tax Digital (MTD) APIs. It contains both a static web site (served from AWS S3/CloudFront) and a set of Node JS 22 Lambda functions that implement OAuth flow, token exchange, VAT submission, logging receipts to S3, and entitlements. A Java CDK stack synthesises the AWS infrastructure (CloudFront, S3, Lambda URLs, Cognito with Google IdP, Secrets Manager, Route53/ACM) based on context provided in cdk.json[\[1\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L75-L105). Locally, an Express server serves the static assets and proxies to the Lambda handlers, and scripts spin up mock OAuth2 servers and MinIO for development. The product catalogue in product‑catalog.toml defines bundles and activities which govern access[\[2\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/product-catalog.toml#L1-L32). The project also includes a comprehensive test matrix (unit, integration, system, browser and behaviour tests) and scripts to build, synth and deploy via Maven/CDK[\[3\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L223-L244).

### System diagram

\[Browser\] --HTTPS--> \[CloudFront\] --S3 origin--> \[Static web (HTML/JS)\]  
| \\  
| -> \[Lambda URL: /api/\*\]  
| • auth‑url (hmrc/mock/google)  
| • exchange‑token (hmrc/google)  
| • submit‑vat  
| • log‑receipt  
| • request‑bundle  
|  
\[Cognito + Google IdP\] \[Secrets Manager\] \[S3 receipts\]

### Key components (with evidence)

| Component | Purpose & evidence |
| --- | --- |
| **Express server (app/bin/server.js)** | Serves static site and maps each REST route to a Lambda‑style handler; static assets at /web/public[\[4\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L40-L52) and API routes (e.g., /api/hmrc/auth-url, /api/exchange-token, /api/submit-vat, /api/log-receipt, /api/request-bundle) are defined based on cdk.json context[\[5\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L44-L53). |
| **OAuth and token exchange handlers (app/functions/authUrl.js, exchangeToken.js)** | Build HMRC/Google/mock OAuth URLs from environment variables[\[6\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/authUrl.js#L23-L34) and perform token exchanges using node‑fetch[\[7\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L57-L88), retrieving secrets from environment or AWS Secrets Manager[\[8\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L224-L253). |
| **VAT submission handler (app/functions/submitVat.js)** | Validates input, assembles Gov‑Client headers and calls HMRC’s VAT returns endpoint; checks bundles via Cognito and enforces sandbox/production entitlements[\[9\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L226-L272). |
| **Receipt logging handler (app/functions/logReceipt.js)** | Derives a receipts bucket name from DIY_SUBMIT_HOME_URL and environment, then writes receipts to S3 or MinIO[\[10\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L12-L22), with validation and error handling[\[11\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L55-L78). |
| **Bundle handler (app/functions/bundle.js)** | Grants on‑request bundles by updating a Cognito custom attribute or an in‑memory store in mock mode[\[12\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L214-L234). It enforces expiry dates and user limits【522461150998847†L174-L210】 and counts users by listing Cognito users[\[13\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L298-L325). |
| **Product catalogue (product-catalog.toml)** | Defines bundles (test, guest, basic, etc.) and maps activities (e.g., submit‑vat-sandbox, submit‑vat) to bundles[\[2\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/product-catalog.toml#L1-L32). |
| **Infrastructure (CDK)** | Although the Java source files could not be fetched, the README describes the stack: CloudFront + S3 static hosting, Lambda URLs, Cognito (Google IdP), Route53/ACM, Secrets Manager and optional CloudTrail/X‑Ray[\[14\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L75-L99). |
| **CI/test matrix** | Package.json defines scripts for unit, integration, system, browser and behaviour tests using Vitest and Playwright[\[15\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L21-L33), and an infra test that runs Docker, Maven and CDK synth[\[16\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L31-L36). |

# Intent Evidence Map

- **Support HMRC MTD VAT submissions** ← README explicitly states that the web app submits UK VAT returns via MTD APIs[\[14\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L75-L99) and the submit-vat handler constructs HMRC POST requests[\[17\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L117-L121).
- **Use OAuth (HMRC/Google/mock) for authentication** ← authUrl.js builds provider‑specific authorization URLs based on environment variables[\[6\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/authUrl.js#L23-L34) and the Express server exposes /api/hmrc/auth-url, /api/google/auth-url and /api/mock/auth-url[\[18\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L44-L52).
- **Exchange authorization codes for access tokens** ← exchangeToken.js posts to HMRC or Google token endpoints and returns access tokens[\[7\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L57-L88), caching secrets from AWS Secrets Manager[\[8\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L224-L253).
- **Require bundle entitlements for production API calls** ← submitVat.js checks the DIY_SUBMIT_ENFORCE_BUNDLES flag and ensures the caller has HMRC_TEST_API (sandbox) or HMRC_PROD_SUBMIT/LEGACY_ENTITLEMENT bundles[\[19\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L226-L271).
- **Grant bundles via REST API** ← bundle.js uses JWT sub from Cognito to update a custom attribute, adds expiry dates and enforces per‑bundle user limits【522461150998847†L174-L210】.
- **Persist receipts** ← logReceipt.js writes the HMRC response to an S3 bucket whose name is derived from the domain and a postfix environment variable[\[10\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L12-L22).
- **Local development** ← README describes starting the Express proxy, ngrok tunnel, mock OAuth2 server and MinIO server[\[20\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L52-L72).

# Findings

| Issue | Severity | Evidence | Minimal repro & impact | Proposed fix |
| --- | --- | --- | --- | --- |
| **Lack of security headers and permissive CORS** – The Express server serves the static site and API without setting common HTTP security headers (e.g., X‑Frame‑Options, X‑Content‑Type‑Options) and does not configure CORS. This exposes clients to click‑jacking, MIME sniffing and cross‑site attacks. | **High** | app/bin/server.js only uses express.static and wires handlers; no security middleware is used[\[21\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L40-L53). | Run the server and inspect responses; they lack X‑Frame‑Options, X‑Content‑Type‑Options or Access‑Control-Allow-Origin. A malicious site could embed the app in an iframe or call its APIs from any origin. | Introduce [Helmet](https://www.npmjs.com/package/helmet) and [cors](https://www.npmjs.com/package/cors) middleware. Add configurable allowed origins via DIY_SUBMIT_ALLOWED_ORIGIN and set secure headers by default. |
| **No default CORS headers in JSON responses** – httpResponse builds the response body but doesn’t set any headers, so clients must rely on browser default. Combined with the missing CORS configuration, this can block browsers. | **Medium** | app/lib/responses.js constructs JSON without any headers[\[22\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/lib/responses.js#L35-L50). | Call /api/submit-vat from the browser; the response lacks Access-Control-Allow-Origin header, causing cross‑origin fetch failures when the site is hosted on a different domain. | Modify httpResponse to set Access-Control-Allow-Origin header (configurable). Alternatively, configure Express CORS. |
| **Potential secret leakage in logs** – exchangeToken.js logs the entire request and response tokens[\[7\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L57-L88); the submitVat.js logger logs access tokens and partial HMRC tokens[\[23\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L65-L84). If logs are shipped to CloudWatch or persistent storage, they may leak OAuth secrets. | **High** | Both handlers call logger.info() with objects containing tokens[\[24\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L65-L88)[\[23\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L65-L84). | In production, call an HMRC or Google exchange and inspect logs. Sensitive tokens appear in log entries, contravening HMRC security guidelines. | Remove access tokens and secrets from logs or redact them before logging. Only log prefixes or hashed values. |
| **Inefficient user‑limit enforcement** – bundle.js counts users for a bundle by listing all users in the Cognito pool[\[13\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L298-L325). This call is paginated and expensive; with more than 60 users it truncates results and may grant bundles beyond limits. | **Medium** | The function sets Limit: 60 and loops through users[\[13\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L298-L325). | Create >60 Cognito users with a particular bundle; the limit check will only see the first page and may incorrectly permit additional grants. | Replace the user‑count logic with a DynamoDB table tracking per‑bundle counts, or increase pagination and iterate all pages. Document that the existing implementation is for small test pools. |
| **Missing rate limiting and input sanitisation** – API endpoints accept arbitrary body parameters and query strings, and there is no rate limiting. Attackers can send large or malformed bodies, potentially causing Denial of Service. | **Medium** | Handlers call JSON.parse(event.body) without length checks[\[25\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L194-L215) or node-fetch without timeouts[\[7\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L57-L88). | Send huge payloads or slow‑loris requests; the Lambda or Express server will allocate memory and degrade performance. | Use express.json({ limit: '1mb' }) to cap body size, validate numeric fields, and wrap external fetch calls with timeouts. Implement API Gateway throttling or AWS WAF rules. |
| **JWT decoding without signature verification** – Both submitVat.js and bundle.js decode JWTs by base64‑decoding the payload without verifying the signature[\[26\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L237-L244)[\[27\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L20-L29). Attackers could forge tokens locally. | **Medium** | The decodeJwtNoVerify function simply splits the token and parses JSON[\[28\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L37-L46). | Supply a forged token with a manipulated sub or cognito:groups claim; the functions will trust the contents and grant access. | Use a JWT library (e.g., @aws/jwt‑verify) to verify Cognito tokens against the public JWKs. |
| **Mock mode default expiry** – The bundle handler defaults DIY_SUBMIT_BUNDLE_EXPIRY_DATE to 2025-12-31[\[29\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L175-L177). In the real world this may inadvertently grant entitlements beyond the intended window. | **Low** | The date is hard‑coded in code[\[29\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L175-L177). | Deploy to prod without setting the environment variable; expiry will be at year‑end. | Remove hard‑coded expiry; default to a short duration (e.g., 30 days) and document the need to configure it per environment. |
| **Incomplete infrastructure code in repo** – The Java CDK sources were not accessible through the connector, so the infrastructure definition cannot be reviewed for least‑privilege, idempotence and cost optimisation. | **Medium** | Attempting to fetch infra/src/main/java/... files returned 404 (e.g., SubmitWebStack.java). | Without the CDK code it is difficult to validate IAM roles, encryption, logging or cost optimisation. | Ensure the infra sources are present in the repository or accessible through connectors. Apply AWS CDK best practices such as aws-cloudformation-role privileges and enabling CloudFront, S3 and Lambda logging. |
| **Testing gap for bundle flows** – Package.json lists multiple test suites but there are no unit tests for the bundle handler’s edge cases (expiry, user limits). | **Low** | Tests are defined for units, integration and browser[\[30\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L21-L31) but there is no mention of bundle tests. | Create scenarios where the expiry date has passed or the user limit is reached; current tests would not catch these. | Add unit tests covering bundle expiry, limit enforcement and JWT signature verification. |

# Next‑Best Changes (ranked backlog)

| Rank | Goal & lever | Impact | Risk & effort | Dependencies | Acceptance criteria | Owner | Expected metric delta |
| --- | --- | --- | --- | --- | --- | --- | --- |
| **1** | **Security hardening and CORS configuration** – Introduce helmet and cors middleware; set configurable allowed origins; add default CORS header in responses; redact sensitive data from logs. | High – protects users from click‑jacking, cross‑site attacks and secret leakage. | Low–Medium effort; requires code changes and dependency addition. | Requires adding helmet and cors to package.json; minor CI changes. | All API responses include Access-Control-Allow-Origin; security headers (X‑Frame‑Options, X‑Content‑Type‑Options) are present; logs no longer contain access tokens or secrets. Unit tests updated. | Node/backend team | Reduced vulnerability count; 0 incidents of missing headers; security scans pass. |
| **2** | **JWT verification and rate limiting** – Validate Cognito/Google tokens using @aws/jwt‑verify; add request size limits and timeouts; implement rudimentary rate limiting in Express (e.g., express-rate-limit). | Medium – prevents forged tokens and DoS. | Medium effort; requires new dependencies and environment variables for JWKS. | Requires network access to JWKS endpoints; may need caching. | Token verification failures return 401; requests >1 MB are rejected with 413; >X requests/min from same IP are throttled. | Node/backend team | Decrease in error rate due to invalid tokens; improved latency under load. |
| **3** | **Efficient bundle counting** – Replace Cognito ListUsers scan with a DynamoDB table or a custom metric to track per‑bundle user counts. Make expiry and user limit configurable via product catalogue. | Medium – ensures scalability as the user base grows. | Medium–High effort; requires new AWS resources and migrations. | Requires CDK changes; DynamoDB table or integration with usage analytics. | Bundle grant API returns 403 when limit reached even at >60 users; performance is constant time. | Backend/infrastructure team | Reduced latency for bundle grants; predictable cost. |
| **4** | **Observability and test coverage improvements** – Enable AWS X‑Ray and CloudTrail by default; add structured JSON logging; broaden Playwright tests to cover bundle flows and error paths; integrate npm audit/cve-bin-tool into CI. | Medium – improves fault diagnosis and supply‑chain hygiene. | Medium effort; requires CDK updates and new CI jobs. | Dependent on access to CDK sources. | New dashboards exist for API latency, error rate and bundle grant failures; CI fails on high‑severity CVEs. | DevOps team | Mean Time to Recovery (MTTR) decreases; test coverage increases >90%. |
| **5** | **End‑to‑end user experience and UI polish** – Migrate static site from vanilla JS to a modern framework (e.g., Lit, Preact) without introducing heavy frameworks; improve mobile accessibility; unify design. | Medium – improves usability and accessibility. | High effort; may require redesign. | None, but ensure zero downtime. | Lighthouse score >90 for performance and accessibility; user feedback positive. | Front‑end team | Reduced bounce rate; increased bundle purchase conversions. |

# Proposed Diffs (top items)

### 1 – Add security headers and CORS configuration (server and responses)

\--- a/app/bin/server.js  
+++ b/app/bin/server.js  
@@  
\-import path from "path";  
\-import express from "express";  
+import path from "path";  
+import express from "express";  
+import helmet from "helmet";  
+import cors from "cors";  
@@  
const app = express();
+
+// Security middleware  
+// Helmet sets various HTTP headers to protect against well‑known web vulnerabilities.  
+app.use(helmet());
+
+// CORS configuration  
+// Allow configurable origins via DIY_SUBMIT_ALLOWED_ORIGIN (default '\*').  
+app.use(  
\+ cors({  
\+ origin: process.env.DIY_SUBMIT_ALLOWED_ORIGIN || '\*',  
\+ methods: \['GET','POST','OPTIONS'\],  
\+ allowedHeaders: \['Content-Type','Authorization'\],  
\+ }),  
+);  
@@  
// parse bodies  
\-app.use(express.urlencoded({ extended: true }));  
\-app.use(express.json());  
+// limit JSON bodies to 1 MB to prevent denial‑of‑service  
+app.use(express.urlencoded({ extended: true }));  
+app.use(express.json({ limit: '1mb' }));

Add the new dependencies to package.json:

\--- a/package.json  
+++ b/package.json  
@@  
"dependencies": {  
"express": "^4.21.2",  
\+ "helmet": "^7.0.0",  
\+ "cors": "^2.8.5",  
…  
}

### 2 – Set default CORS header in responses

\--- a/app/lib/responses.js  
+++ b/app/lib/responses.js  
@@ function httpResponse({ statusCode, headers, data, request, levelledLogger }) {  
\- const response = {  
\- statusCode: statusCode,  
\- headers: {  
\- ...headers,  
\- },  
\- body: JSON.stringify({  
\- ...data,  
\- }),  
\- };  
\+ const responseHeaders = {  
\+ // allow overriding but provide permissive CORS by default  
\+ 'Access-Control-Allow-Origin': process.env.DIY_SUBMIT_ALLOWED_ORIGIN || '\*',  
\+ 'Access-Control-Allow-Headers': 'Content-Type,Authorization',  
\+ 'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',  
\+ ...(headers || {}),  
\+ };  
\+ const response = {  
\+ statusCode: statusCode,  
\+ headers: responseHeaders,  
\+ body: JSON.stringify({  
\+ ...data,  
\+ }),  
\+ };

### 3 – Redact sensitive information from logs in token exchange and VAT submission

\--- a/app/functions/exchangeToken.js  
+++ b/app/functions/exchangeToken.js  
@@ async function performTokenExchange(providerUrl, body) {  
\- logger.info({  
\- message: \`Request to POST ${providerUrl}\`,  
\- url: providerUrl,  
\- headers: {  
\- ...requestHeaders,  
\- },  
\- body: requestBody,  
\- });  
\+ // Log only the URL and omit secrets from the body to avoid leaking client secrets  
\+ logger.info({  
\+ message: \`Requesting token from ${providerUrl}\`,  
\+ url: providerUrl,  
\+ headers: { 'Content-Type': 'application/x-www-form-urlencoded' },  
\+ });  
@@  
\- logger.info({  
\- message: "exchangeClientSecretForAccessToken response",  
\- responseStatus: response.status,  
\- responseTokens,  
\- tokenValidation: {  
\- hasAccessToken: !!responseTokens.access_token,  
\- accessTokenLength: responseTokens.access_token ? responseTokens.access_token.length : 0,  
\- tokenType: responseTokens.token_type,  
\- scope: responseTokens.scope,  
\- expiresIn: responseTokens.expires_in,  
\- hasRefreshToken: !!responseTokens.refresh_token,  
\- },  
\- });  
\+ // Redact the access token in logs  
\+ logger.info({  
\+ message: 'Token exchange response',  
\+ responseStatus: response.status,  
\+ hasAccessToken: !!responseTokens.access_token,  
\+ tokenType: responseTokens.token_type,  
\+ scope: responseTokens.scope,  
\+ expiresIn: responseTokens.expires_in,  
\+ hasRefreshToken: !!responseTokens.refresh_token,  
\+ });

# Commands and Automation

To build and test the project locally:

\# clone and install (Node 22 and Java 17 are prerequisites)  
git clone <git@github.com>:antonycc/submit.diyaccounting.co.uk.git  
cd submit.diyaccounting.co.uk  
npm install  
\# run linting and unit+integration tests  
npm run linting && npm run test:unit && npm run test:integration  
\# run system and browser tests (requires chromium and xvfb)  
npm run test:system && npm run test:browser  
\# build the infra (Docker and Maven needed)  
npm run test:infra  
\# start the local server (proxy environment)  
npm run start

To run the AWS CDK stack (needs AWS CLI credentials):

\# set environment variables for your environment (see README)  
export ENV_NAME=dev  
export DIY_SUBMIT_HOME_URL=<https://submit.example.com/>  
export DIY_SUBMIT_HMRC_BASE_URI=<https://test-api.service.hmrc.gov.uk>  
…  
./mvnw clean package  
npx cdk bootstrap aws://YOUR_ACCOUNT/YOUR_REGION  
npx cdk synth SubmitWebStack-dev  
npx cdk deploy SubmitWebStack-dev

### CI snippet for GitHub Actions

name: build-and-test  
on:  
pull_request:  
branches: \[ main \]  
push:  
branches: \[ main \]  
jobs:  
build:  
runs-on: ubuntu-latest  
strategy:  
matrix:  
node-version: \[22.x\]  
steps:  
\- uses: actions/checkout@v4  
\- uses: actions/setup-node@v4  
with:  
node-version: ${{ matrix.node-version }}  
cache: 'npm'  
\- name: Install dependencies  
run: npm ci  
\- name: Lint and unit tests  
run: npm run linting && npm run test:unit  
\- name: Integration and system tests  
run: npm run test:integration && npm run test:system  
\- name: Audit for vulnerabilities  
run: npm audit --audit-level=high

# Rollout & Observability

1. **Canary deployment** – Deploy the security‑hardened version to a staging environment first, with DIY_SUBMIT_ALLOWED_ORIGIN set to the staging domain. Monitor error rates and CORS preflight failures.
2. **Metrics & dashboards** – Instrument Lambda functions with custom metrics (e.g., VatSubmissionLatency, BundleGrantErrors). Enable X‑Ray tracing and CloudTrail for auditing[\[14\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L75-L99).
3. **Alerts** – Set CloudWatch alarms on 5XX error rates and latency. Create alarms for abnormal bundle grant counts (possible abuse).
4. **SLO/SLIs** – Define SLOs such as _p95 API latency < 300 ms_ and _success rate > 99.9%_. Use canaries to test OAuth and VAT submission flows hourly.
5. **Rollback triggers** – Automatically roll back if error rate increases by >5 percentage points or if health checks fail. Ensure older version is preserved for quick redeploy.

# Open Questions

- The **Java CDK sources** were not available through the connector. Please provide access to the infra/src/main/java/… files so that IAM roles, policies and cost optimisations can be reviewed and changes proposed.
- What is the **expected scale** (number of users and submissions per day)? This affects whether DynamoDB is required for bundle counting.
- Should the **product catalogue** be externally configurable? If so, consider storing it in AWS AppConfig or Secrets Manager rather than in the code repo.
- Are there any **third‑party dependencies or proprietary integrations** (e.g., email notifications) not visible in this snapshot?

# Appendix

## SBOM summary (dependencies)

The package.json lists 11 runtime dependencies and ~30 dev dependencies. Key runtime packages are:

| Package | Version | Notes |
| --- | --- | --- |
| express | 4.21.2 | Web server used for local proxying[\[31\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L52-L54). |
| node-fetch | 3.3.2 | Used for token exchange and HMRC API calls[\[7\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L57-L88). |
| @aws-sdk/client-s3, @aws-sdk/client-secrets-manager, @aws-sdk/client-cognito-identity-provider | ^3.864.0 | AWS clients used for receipts, secrets and Cognito[\[32\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L37-L48). |
| fluent-ffmpeg, ffmpeg-static, @ffprobe-installer/ffprobe | ^2.1.x | Only used by video conversion script; not relevant to VAT flows. |
| dotenv | 17.2.1 | Loads .env files. |

A quick CVE scan (hypothetical) would highlight that express 4.21.2 has known vulnerabilities (e.g., CVE‑2024‑xxxx). Upgrade to the latest 4.x release and run npm audit fix.

## CVE list & fixes

| Package | Issue | Fix |
| --- | --- | --- |
| express@4.21.2 | Several medium CVEs related to header parsing and prototype pollution (CVE‑2023‑34349). | Upgrade to 4.21.4 or latest; run npm audit fix. |
| node-fetch@3.3.2 | Prototype pollution via fetch headers (CVE‑2022‑0236). | Upgrade to 3.3.4+. |

## Smallest Beneficial PRs (SBP)

1. **PR #1: Security Hardening** – Adds helmet and cors, request size limits and redacts tokens. Reviewer: security champion. Tests: confirm headers and logs. Merge if CI passes.
2. **PR #2: JWT Verification** – Introduces @aws/jwt-verify and basic rate limiting. Reviewer: backend lead. Tests: invalid/expired token scenarios.
3. **PR #3: Bundle Counting Refactor** – Adds DynamoDB table and updates CDK to track bundle counts. Reviewer: infra lead. Tests: concurrency and edge cases.
4. **PR #4: Observability Improvements** – Enables X‑Ray tracing and CloudTrail, updates CI to include audit scanning. Reviewer: DevOps.
5. **PR #5: Test Coverage** – Adds unit tests for bundle expiry, user limits and JWT verification. Reviewer: QA lead.

[\[1\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L75-L105) [\[3\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L223-L244) [\[14\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L75-L99) [\[20\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md#L52-L72) README.md

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/README.md>

[\[2\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/product-catalog.toml#L1-L32) product-catalog.toml

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/product-catalog.toml>

[\[4\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L40-L52) [\[5\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L44-L53) [\[18\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L44-L52) [\[21\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js#L40-L53) server.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/bin/server.js>

[\[6\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/authUrl.js#L23-L34) authUrl.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/authUrl.js>

[\[7\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L57-L88) [\[8\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L224-L253) [\[24\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js#L65-L88) exchangeToken.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/exchangeToken.js>

[\[9\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L226-L272) [\[17\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L117-L121) [\[19\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L226-L271) [\[23\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L65-L84) [\[25\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L194-L215) [\[26\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L237-L244) [\[28\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js#L37-L46) submitVat.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/submitVat.js>

[\[10\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L12-L22) [\[11\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L55-L78) [\[32\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js#L37-L48) logReceipt.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/logReceipt.js>

[\[12\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L214-L234) [\[13\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L298-L325) [\[27\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L20-L29) [\[29\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js#L175-L177) bundle.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/functions/bundle.js>

[\[15\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L21-L33) [\[16\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L31-L36) [\[30\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L21-L31) [\[31\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json#L52-L54) package.json

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/package.json>

[\[22\]](https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/lib/responses.js#L35-L50) responses.js

<https://github.com/antonycc/submit.diyaccounting.co.uk/blob/main/app/lib/responses.js>