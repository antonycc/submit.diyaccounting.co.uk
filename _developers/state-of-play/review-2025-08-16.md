# Deep Repository Assessment for diyaccounting/submit.diyaccounting.co.uk

## A) Repository Synopsis

The **submit.diyaccounting.co.uk** repository provides a server-less web application and AWS infrastructure for UK taxpayers to submit VAT returns under HMRC’s Making Tax Digital (MTD) scheme. It comprises a Node 22/ESM backend deployed as AWS Lambda functions, a static front-end served via CloudFront, and a Java-based AWS CDK infrastructure definition. Authentication is handled via Google OAuth and AWS Cognito, with entitlement management for feature gating. The system supports multiple environments (Proxy, CI, Prod), aiming for near-zero cost at rest, zero downtime deployments, and no JavaScript client frameworks.

**Key components:**
- **AWS CDK (Java)**: `infra/main/java/co/uk/diyaccounting/submit` – defines WebApp, WebStack, CognitoAuth, Lambda functions, CloudFront, S3, Secrets, IAM.
- **Node Backend Functions**: `app/functions/*.js` – business logic handlers (e.g., `submitVat.js`, `bundle.js`, `authUrl.js`).
- **Support Libraries**: `app/src/lib/*.js` – JWT decoding, entitlement checks, logging.
- **Front-End**: `web/public` static HTML/JS for form submissions, bundle management.
- **CI/CD**: `.github/workflows` – test and deploy pipelines.
- **Docs/Backlog**: `_developers` – setup guides, backlog items, state-of-play reviews.

---

## B) Intent Evidence Map

- **`README.md` L1-L80** → States MTD VAT submission purpose, AWS/Node/Java toolchain, no client framework requirement.
- **`infra/.../WebStack.java` L780-L794** → Lambda URL auth type configurable via env var → inference: multi-env deploy flexibility and security control.
- **`app/functions/submitVat.js` L12-L28** → Receives VAT submission payload, decodes JWT without verification → inference: performance shortcut with security trade-off.
- **`app/src/lib/entitlementsService.js` L5-L24** → Entitlement checks via decoded JWT claims → inference: feature gating tied to auth payload.
- **`_developers/backlog/cognito-advanced-security.md`** → Plans to enable Cognito advanced security and store grants/receipts → inference: roadmap includes security hardening.
- **`.github/workflows/deploy.yml` L1-L198** → Multi-env deploy jobs with concurrency control, AWS role assumption → inference: automated safe deploys with parallel isolation.
- **`product-catalogue.toml`** → Bundle definitions for VAT service → inference: supports multiple products/features under one submission platform.

---

## C) Findings

**Critical Bugs**
- **JWT signature not verified**  
  Severity: High  
  Evidence: `app/src/lib/entitlementsService.js` L5-L24, `app/functions/submitVat.js` L12-L28  
  Minimal Repro: Call endpoint with forged JWT payload.  
  Proposed Fix: Use `jsonwebtoken.verify` or AWS Cognito SDK to validate signature against JWKS.

**Config/IaC Issues**
- No explicit S3 bucket lifecycle for origin logs → potential cost growth.  
  Fix: Add `lifecycleRules` to CloudFront log buckets.

---

## D) Next-Best Changes (Ranked Backlog)

1. **JWT Verification in All Handlers**  
   Goal: Enforce signature validation.  
   Impact: High security.  
   Risk: Low (breaking only if tokens invalid).  
   Effort: 1–2 days.  
   Dependencies: JWKS URL, library import.  
   Acceptance: All JWTs rejected if invalid.  
   Owner: Backend lead.

3. **S3 Log Lifecycle Policies**  
   Goal: Control storage costs.  
   Impact: Medium cost reduction.  
   Risk: None.  
   Effort: <1 day.

