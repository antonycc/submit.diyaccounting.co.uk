#!/usr/bin/env node

/**
 * Bundle submit.js and its dependencies into a single file for tests
 * This removes ES module syntax so eval() can work in test environments
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.join(__dirname, '..');

// Read all the module files
const jwtUtils = fs.readFileSync(path.join(rootDir, 'web/public/lib/utils/jwt-utils.js'), 'utf-8');
const cryptoUtils = fs.readFileSync(path.join(rootDir, 'web/public/lib/utils/crypto-utils.js'), 'utf-8');
const domUtils = fs.readFileSync(path.join(rootDir, 'web/public/lib/utils/dom-utils.js'), 'utf-8');
const correlationUtils = fs.readFileSync(path.join(rootDir, 'web/public/lib/utils/correlation-utils.js'), 'utf-8');
const storageUtils = fs.readFileSync(path.join(rootDir, 'web/public/lib/utils/storage-utils.js'), 'utf-8');
const authService = fs.readFileSync(path.join(rootDir, 'web/public/lib/services/auth-service.js'), 'utf-8');
const apiClient = fs.readFileSync(path.join(rootDir, 'web/public/lib/services/api-client.js'), 'utf-8');
const submitJs = fs.readFileSync(path.join(rootDir, 'web/public/submit.js'), 'utf-8');

// Function to extract exports from a module
function extractExports(content, isMainSubmitJs = false) {
  // Remove all import statements (including multi-line)
  content = content.replace(/import\s+(?:{[^}]+}|[^;]+)\s+from\s+['"][^'"]+['"];?\s*/g, '');
  // Remove standalone import statements
  content = content.replace(/^import\s+.*?;?\s*$/gm, '');
  
  // If this is submit.js, also remove the re-export const assignments
  if (isMainSubmitJs) {
    content = content.replace(/\/\/ Re-export functions for backward compatibility[\s\S]*?\/\/ Status message handling/m, '// Status message handling');
    // Remove lines like: const checkAuthStatus = _checkAuthStatus;
    content = content.replace(/^\s*\/\/\s*eslint-disable-next-line.*\n/gm, '');
    content = content.replace(/^\s*const\s+(checkAuthStatus|checkTokenExpiry|ensureSession|fetchWithId|authorizedFetch|fetchWithIdToken)\s*=\s*_\1;\s*$/gm, '');
  }
  
  // Remove export keywords
  content = content.replace(/export\s+(function|const|let|var|async\s+function)/g, '$1');
  content = content.replace(/export\s+{[^}]+}/g, '');
  return content.trim();
}

// Bundle all modules
const bundle = `
// Bundled version of submit.js for testing
// This file is auto-generated by scripts/bundle-for-tests.js

(function() {
  'use strict';

  // ===== lib/utils/jwt-utils.js =====
  ${extractExports(jwtUtils)}

  // ===== lib/utils/crypto-utils.js =====
  ${extractExports(cryptoUtils)}

  // ===== lib/utils/dom-utils.js =====
  ${extractExports(domUtils)}

  // ===== lib/utils/storage-utils.js =====
  ${extractExports(storageUtils)}

  // ===== lib/utils/correlation-utils.js =====
  ${extractExports(correlationUtils)}

  // ===== lib/services/auth-service.js =====
  ${extractExports(authService)}

  // ===== lib/services/api-client.js =====
  ${extractExports(apiClient)}

  // ===== submit.js (main) =====
  ${extractExports(submitJs, true)}

  // Initialize correlation interceptor
  if (typeof installCorrelationInterceptor === 'function') {
    installCorrelationInterceptor();
  }

  // Expose correlation utilities on window
  if (typeof window !== 'undefined') {
    window.getTraceparent = getOrCreateTraceparent;
    window.getLastXRequestId = getLastXRequestId;
    window.__correlation = {
      prepareRedirect: prepareRedirectRequestId,
      getTraceparent: getOrCreateTraceparent,
      getLastXRequestId: getLastXRequestId,
      getLastXRequestIdSeenAt: getLastXRequestIdSeenAt,
    };
  }
})();
`;

// Write the bundled file
const outputPath = path.join(rootDir, 'web/public/submit.bundle.js');
fs.writeFileSync(outputPath, bundle, 'utf-8');

console.log(`âœ“ Created test bundle: ${outputPath}`);
