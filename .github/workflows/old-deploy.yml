# .github/workflows/deploy.yml

name: old-deploy
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false
run-name: "deploy [${{ inputs.environment || 'prod' }}] [${{ github.ref_name }}]"

on:
#  pull_request:
#    branches:
#      - main
#    paths:
#      - 'app/functions'
#      - 'app/lib'
#      - 'infra/main'
#      - 'infra/runtimes'
#      - 'web/public/**'
#      - '.env.ci'
#      - '.env.prod'
#      - 'cdk.json'
#      - 'Dockerfile'
#      - 'LICENSE'
#      - 'package.json'
#      - 'package-lock.json'
#      - 'pom.xml'
#      - 'product-catalogue.toml'
#      - '.github/workflows/deploy.yml'
#      - '.github/workflows/deploy-ci-only.yml'
#  push:
#    branches:
#      - main
#    paths:
#      - '.env.prod'
#      - 'app/functions'
#      - 'app/lib'
#      - 'infra/main'
#      - 'infra/runtimes'
#      - 'web/public/**'
#      - '.env.ci'
#      - '.env.prod'
#      - 'cdk.json'
#      - 'Dockerfile'
#      - 'LICENSE'
#      - 'package.json'
#      - 'package-lock.json'
#      - 'pom.xml'
#      - 'product-catalogue.toml'
#      - '.github/workflows/deploy.yml'
#      - '.github/workflows/deploy-ci-only.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        # TODO: Deploy to versioned target environments, e.g. 'ci, prod-<git hash>'.
        # TODO: Create a prod 'actual' domain which routes to a pool of versioned prod deployments.
        # TODO: Promote to prod 'actual' if behaviour tests pass against the versioned environments.
        # TODO: All environments read state from all S3 buckets.
        # TODO: Create jobs to set a stack to draining state which is removed from the DNS pool and all objects synced to a non-draining stack.
        # TODO: Create jobs to prune drained stacks by backing up the the whole stack and then deleting the stack.
        default: 'prod'
        type: choice
        options:
          - prod
      skipDeploy:
        description: 'Skip deployment step'
        type: string
        required: false
        default: 'false'
#  schedule:
#    #- cron: '14 5,11,17,23 * * *'
#    - cron: '14 5 * * *'

env:
  environment: ${{ inputs.environment || 'prod' }}
  skipDeploy: ${{ inputs.skipDeploy || 'false' }}

jobs:
  npm-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: 'npm'

      - run: npm ci || npm install

      - name: test
        id: test
        shell: bash
        run: source .env.${{ env.environment }} && npm test
        env:
          DIY_SUBMIT_HMRC_CLIENT_SECRET: test

  deploy-to-ci:
    uses: 'antonycc/submit.diyaccounting.co.uk/.github/workflows/deploy-ci-only.yml@main'
    with:
      skipDeploy: 'false'
    secrets:
      HMRC_CLIENT_SECRET: ${{ secrets.HMRC_CLIENT_SECRET }}
      DIY_SUBMIT_GOOGLE_CLIENT_SECRET: ${{ secrets.DIY_SUBMIT_GOOGLE_CLIENT_SECRET }}

  upsert-secrets:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'prod' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v5
        if: ${{ env.skipDeploy != 'true' }}

      - name: Configure AWS Credentials
        if: ${{ env.skipDeploy != 'true' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::887764105431:role/submit-github-actions-role
          role-chaining: false
          aws-region: eu-west-2
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Configure AWS Credentials
        if: ${{ env.skipDeploy != 'true' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::887764105431:role/submit-deployment-role
          role-chaining: true
          aws-region: eu-west-2
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Write GitHub secret HMRC_CLIENT_SECRET to temp file (keeps out of logs)
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        env:
          GH_SECRET: ${{ secrets.HMRC_CLIENT_SECRET }}
        run: |
          set -euo pipefail
          umask 077
          printf '%s' "$GH_SECRET" > secret.txt
          echo "::add-mask::$(cat secret.txt)"

      - name: Upsert HMRC_CLIENT_SECRET into AWS Secrets Manager
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        env:
          SECRET_NAME: "diy/${{ env.environment}}/submit/hmrc/client_secret"
        run: |
          set -euo pipefail
          if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" >/dev/null 2>&1; then
            aws secretsmanager put-secret-value \
              --secret-id "$SECRET_NAME" \
              --secret-string file://secret.txt
          else
            aws secretsmanager create-secret \
              --name "$SECRET_NAME" \
              --secret-string file://secret.txt \
              --tags Key=managed-by,Value=github-actions Key=repo,Value=${GITHUB_REPOSITORY}
          fi
          shred -u secret.txt

      - name: Write GitHub secret DIY_SUBMIT_GOOGLE_CLIENT_SECRET to temp file (keeps out of logs)
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        env:
          GH_SECRET: ${{ secrets.DIY_SUBMIT_GOOGLE_CLIENT_SECRET }}
        run: |
          set -euo pipefail
          umask 077
          printf '%s' "$GH_SECRET" > secret.txt
          echo "::add-mask::$(cat secret.txt)"

      - name: Upsert DIY_SUBMIT_GOOGLE_CLIENT_SECRET into AWS Secrets Manager
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        env:
          SECRET_NAME: "diy/${{ env.environment}}/submit/google/client_secret"
        run: |
          set -euo pipefail
          if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" >/dev/null 2>&1; then
            aws secretsmanager put-secret-value \
              --secret-id "$SECRET_NAME" \
              --secret-string file://secret.txt
          else
            aws secretsmanager create-secret \
              --name "$SECRET_NAME" \
              --secret-string file://secret.txt \
              --tags Key=managed-by,Value=github-actions Key=repo,Value=${GITHUB_REPOSITORY}
          fi
          shred -u secret.txt

      #- name: Write GitHub secret DIY_SUBMIT_ANTONYCC_CLIENT_SECRET to temp file (keeps out of logs)\
      #  if: ${{ env.skipDeploy != 'true' }}
      #  shell: bash
      #  env:
      #    GH_SECRET: ${{ secrets.DIY_SUBMIT_ANTONYCC_CLIENT_SECRET }}
      #  run: |
      #    set -euo pipefail
      #    umask 077
      #    printf '%s' "$GH_SECRET" > secret.txt
      #    echo "::add-mask::$(cat secret.txt)"

      #- name: Upsert DIY_SUBMIT_ANTONYCC_CLIENT_SECRET into AWS Secrets Manager
      #  if: ${{ env.skipDeploy != 'true' }}
      #  shell: bash
      #  env:
      #    SECRET_NAME: "diy/${{ env.environment}}/submit/antonycc/client_secret"
      #  run: |
      #    set -euo pipefail
      #    if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" >/dev/null 2>&1; then
      #      aws secretsmanager put-secret-value \
      #        --secret-id "$SECRET_NAME" \
      #        --secret-string file://secret.txt
      #    else
      #      aws secretsmanager create-secret \
      #        --name "$SECRET_NAME" \
      #        --secret-string file://secret.txt \
      #        --tags Key=managed-by,Value=github-actions Key=repo,Value=${GITHUB_REPOSITORY}
      #    fi
      #    shred -u secret.txt

  deploy-to-environment:
    needs:
      - npm-test
      - deploy-to-ci
      - upsert-secrets
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'prod' }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        if: ${{ env.skipDeploy != 'true' }}
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - uses: actions/setup-node@v5
        if: ${{ env.skipDeploy != 'true' }}
        with:
          node-version: 22
          cache: 'npm'

      - run: npm install
        if: ${{ env.skipDeploy != 'true' }}

      - name: Configure AWS Credentials
        if: ${{ env.skipDeploy != 'true' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::887764105431:role/submit-github-actions-role
          role-chaining: false
          aws-region: eu-west-2
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      #- run: aws sts get-caller-identity --region eu-west-2

      - name: Configure AWS Credentials
        if: ${{ env.skipDeploy != 'true' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::887764105431:role/submit-deployment-role
          role-chaining: true
          aws-region: eu-west-2
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      #- run: aws sts get-caller-identity --region eu-west-2

      - uses: actions/setup-java@v5
        if: ${{ env.skipDeploy != 'true' }}
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'maven'

      - name: Package Java classes for CDK
        id: package
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        run: |
          ./mvnw package -Dmaven.compiler.source=17 -Dmaven.compiler.target=17 -DskipTests=true

      - name: set-jar-path
        id: jar-path
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        run: |
          jarPath=$(mvn help:evaluate --quiet --define expression=project.build.directory --define forceStdout)
          jarFilename=$(mvn help:evaluate --quiet --define expression=project.build.finalName --define forceStdout)
          echo "jarFilepath=${jarPath?}/${jarFilename?}.jar" | tee -a "${GITHUB_OUTPUT?}"

      - name: deployObservability
        if: ${{ env.skipDeploy != 'true' }}
        id: deployObservability
        shell: bash
        run: npx dotenv -e .env.${{ inputs.environment || 'prod' }} -- npx cdk deploy SubmitObservabilityStack-${{ inputs.environment || 'prod' }} --exclusively --require-approval never --ci true --verbose --strict --validation
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          ENV_NAME: ${{ inputs.environment || 'prod' }}

      - name: deployDev
        if: ${{ env.skipDeploy != 'true' }}
        id: deployDev
        shell: bash
        run: npx dotenv -e .env.${{ inputs.environment || 'prod' }} -- npx cdk deploy SubmitDevStack-${{ inputs.environment || 'prod' }} --exclusively --require-approval never --ci true --verbose --strict --validation
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          ENV_NAME: ${{ inputs.environment || 'prod' }}

      - name: Setup image tag
        if: ${{ env.skipDeploy != 'true' }}
        id: image-tag
        run: |
          BASE_IMAGE_TAG="submit-base:${{ github.sha }}"
          echo "base-image-tag=$BASE_IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Building/loading base image with tag: $BASE_IMAGE_TAG"

      - name: Set up Docker Buildx
        if: ${{ env.skipDeploy != 'true' }}
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      - name: Build base image
        if: ${{ env.skipDeploy != 'true' }}
        id: build
        run: |
          docker buildx build \
            --load \
            -t "${{ steps.image-tag.outputs.base-image-tag }}" \
            -f Dockerfile .

      - name: Get ECR repository URI
        if: ${{ env.skipDeploy != 'true' }}
        id: ecr-uri
        shell: bash
        run: |
          STACK_NAME="SubmitDevStack-${{ inputs.environment || 'prod' }}"
          ECR_URI=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`EcrRepositoryUri`].OutputValue' \
            --output text)
          echo "ecr-uri=${ECR_URI}" | tee -a "${GITHUB_OUTPUT}"
          echo "ECR Repository URI: $ECR_URI"

      - name: Login to Amazon ECR
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        run: |
          aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin ${{ steps.ecr-uri.outputs.ecr-uri }}

      - name: Tag and push Docker image to ECR
        if: ${{ env.skipDeploy != 'true' }}
        shell: bash
        run: |
          BASE_IMAGE_TAG="${{ steps.image-tag.outputs.base-image-tag }}"
          ECR_URI="${{ steps.ecr-uri.outputs.ecr-uri }}"
          COMMIT_HASH="${{ github.sha }}"

          # Tag with commit hash and latest
          docker tag $BASE_IMAGE_TAG $ECR_URI:$COMMIT_HASH
          docker tag $BASE_IMAGE_TAG $ECR_URI:latest

          # Push both tags
          docker push $ECR_URI:$COMMIT_HASH
          docker push $ECR_URI:latest

          echo "Successfully pushed Docker image to ECR:"
          echo "  $ECR_URI:$COMMIT_HASH"
          echo "  $ECR_URI:latest"

      - name: deployIdentity
        if: ${{ env.skipDeploy != 'true' }}
        id: deployIdentity
        shell: bash
        run: npx dotenv -e .env.${{ inputs.environment || 'prod' }} -- npx cdk deploy SubmitIdentityStack-${{ inputs.environment || 'prod' }} --exclusively --require-approval never --ci true --verbose --strict --validation
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          ENV_NAME: ${{ inputs.environment || 'prod' }}
          BASE_IMAGE_TAG: ${{ steps.ecr-uri.outputs.ecr-uri }}:${{ github.sha }}
          CLOUD_TRAIL_ENABLED: ${{ vars.AWS_CLOUD_TRAIL_ENABLED }}
          X_RAY_ENABLED: ${{ vars.AWS_X_RAY_ENABLED }}
          VERBOSE_LOGGING: ${{ vars.AWS_VERBOSE_LOGGING }}
          HOSTED_ZONE_ID: ${{ vars.AWS_HOSTED_ZONE_ID }}
          HOSTED_ZONE_NAME: ${{ vars.AWS_HOSTED_ZONE_NAME }}
          DIY_SUBMIT_GOOGLE_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:diy/${{ inputs.environment || 'prod' }}/submit/google/client_secret"
          AUTH_CERTIFICATE_ARN: 'arn:aws:acm:us-east-1:887764105431:certificate/59a025f9-3620-43cd-9b2c-522f385ee223'

      - name: deployApplication
        if: ${{ env.skipDeploy != 'true' }}
        id: deployApplication
        shell: bash
        run: npx dotenv -e .env.${{ inputs.environment || 'prod' }} -- npx cdk deploy SubmitApplicationStack-${{ inputs.environment || 'prod' }} --exclusively --require-approval never --ci true --verbose --strict --validation
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          ENV_NAME: ${{ inputs.environment || 'prod' }}
          CLOUD_TRAIL_ENABLED: ${{ vars.AWS_CLOUD_TRAIL_ENABLED }}
          X_RAY_ENABLED: ${{ vars.AWS_X_RAY_ENABLED }}
          VERBOSE_LOGGING: ${{ vars.AWS_VERBOSE_LOGGING }}
          HOSTED_ZONE_ID: ${{ vars.AWS_HOSTED_ZONE_ID }}
          HOSTED_ZONE_NAME: ${{ vars.AWS_HOSTED_ZONE_NAME }}
          DIY_SUBMIT_HMRC_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:diy/${{ inputs.environment || 'prod' }}/submit/hmrc/client_secret"
          DIY_SUBMIT_GOOGLE_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:diy/${{ inputs.environment || 'prod' }}/submit/google/client_secret"
          BASE_IMAGE_TAG: ${{ steps.ecr-uri.outputs.ecr-uri }}:${{ github.sha }}

      - name: deployWeb
        if: ${{ env.skipDeploy != 'true' }}
        id: deployWeb
        shell: bash
        run: npx dotenv -e .env.${{ inputs.environment || 'prod' }} -- npx cdk deploy SubmitWebStack-${{ inputs.environment || 'prod' }} --exclusively --require-approval never --ci true --verbose --strict --validation
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          ENV_NAME: ${{ inputs.environment || 'prod' }}
          LOG_S3_OBJECT_EVENT_HANDLER_SOURCE: ${{ steps.jar-path.outputs.jarFilepath }}
          LOG_GZIPPED_S3_OBJECT_EVENT_HANDLER_SOURCE: ${{ steps.jar-path.outputs.jarFilepath }}
          CERTIFICATE_ARN: ${{ vars.AWS_CERTIFICATE_ARN }}
          CLOUD_TRAIL_ENABLED: ${{ vars.AWS_CLOUD_TRAIL_ENABLED }}
          X_RAY_ENABLED: ${{ vars.AWS_X_RAY_ENABLED }}
          VERBOSE_LOGGING: ${{ vars.AWS_VERBOSE_LOGGING }}
          HOSTED_ZONE_ID: ${{ vars.AWS_HOSTED_ZONE_ID }}
          HOSTED_ZONE_NAME: ${{ vars.AWS_HOSTED_ZONE_NAME }}
          COMMIT_HASH: ${{ github.sha }}
          BASE_IMAGE_TAG: ${{ steps.ecr-uri.outputs.ecr-uri }}:${{ github.sha }}

  npm-behaviour-test:
    needs:
      - deploy-to-environment
    name: 'npm behaviour test'
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.timestamp }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v5

      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y-%m-%d-%H%M%S')" >> $GITHUB_OUTPUT

      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: 'npm'

      - run: npm ci || npm install

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}

      - run: npx playwright install chromium --with-deps

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::887764105431:role/submit-github-actions-role
          role-chaining: false
          aws-region: eu-west-2
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume user provisioning role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::403027849202:role/oidc-external-user-provisioning-role
          role-chaining: true
          aws-region: us-east-1
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Create test username and a test password
        id: uuid
        run: |
          TEST_USERNAME=$(uuidgen | tr '[:upper:]' '[:lower:]')
          TEST_PASSWORD=$(uuidgen | tr '[:upper:]' '[:lower:]')
          echo "TEST_USERNAME=${TEST_USERNAME?}"
          echo "TEST_PASSWORD=${TEST_PASSWORD?}"
          echo "TEST_USERNAME=${TEST_USERNAME?}" >> "$GITHUB_OUTPUT"
          echo "TEST_PASSWORD=${TEST_PASSWORD?}" >> "$GITHUB_OUTPUT"

      - name: Provision test user
        run: |
          npm run users:provision 'oidc-antonycc-com-prod-users' "${TEST_USERNAME?}" "${TEST_PASSWORD?}"
        env:
          TEST_USERNAME: ${{ steps.uuid.outputs.TEST_USERNAME }}
          TEST_PASSWORD: ${{ steps.uuid.outputs.TEST_PASSWORD }}

      - run: cp '.env.${{ inputs.environment || 'prod' }}' '.env.proxy' ; npx dotenv -e '.env.${{ inputs.environment || 'prod' }}' -- npm run test:behaviour
        env:
          DIY_SUBMIT_TEST_AUTH_USERNAME: ${{ steps.uuid.outputs.TEST_USERNAME }}
          DIY_SUBMIT_TEST_AUTH_PASSWORD: ${{ steps.uuid.outputs.TEST_PASSWORD }}

      - name: Convert Playwright video to MP4
        if: ${{ !cancelled() }}
        run: |
          set -euo pipefail
          root="target/behaviour-test-results"

          # Recursively transcode all .webm files, placing output next to source with 'converted' prefix
          pids=()
          while IFS= read -r -d '' f; do
            dir=$(dirname "$f")
            base="${f##*/}"
            name="${base%.webm}"
            out="${dir}/converted${name}.mp4"
            echo "Transcoding $f -> $out"
            npm run convert:video -- --in "$f" --out "$out" &
            pids+=($!)
          done < <(find "$root" -type f -name '*.webm' -print0)

          # Wait for all transcodes to complete
          fail=0
          for pid in "${pids[@]:-}"; do
            if ! wait "$pid"; then
              fail=1
            fi
          done

          exit $fail

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-results-behaviour
          path: "target/behaviour-test-results/"
          retention-days: 30

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: test-reports-behaviour
          path: "target/test-reports/"
          retention-days: 30

