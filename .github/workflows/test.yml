name: test
run-name: "test from ${{ github.ref_name }}"

on:
  workflow_dispatch:
    inputs:
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - '(auto)'
          - 'ci'
          - 'prod'
        default: '(auto)'
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''
      runProxyBehaviourTests:
        description: 'Run proxy behaviour tests (uses ngrok and Docker)'
        type: choice
        options:
          - 'true'
          - 'false'
        required: false
        default: 'false'
  workflow_call:
    inputs:
      environment-name:
        type: string
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: true
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: true
      runProxyBehaviourTests:
        type: string
        description: 'Run proxy behaviour tests (uses ngrok and Docker)'
        required: false
        default: 'false'
    secrets:
      HMRC_SANDBOX_CLIENT_SECRET:
        required: false
      NGROK_AUTHTOKEN:
        required: false

  push:
    branches:
      - '**'
      - '!gh_pages'
    paths:
      - 'app/**'
      - 'infra/**'
      - 'tests/**'
      - 'behaviour-tests/**'
      - 'web/**'
      - '.env.ci'
      - '.env.prod'
      - '**/cdk.json'
      - 'Dockerfile'
      - 'LICENSE'
      - 'package.json'
      - 'package-lock.json'
      - 'pom.xml'
      - 'web/public/submit.catalogue.toml'
      - '.github/actions/get-names'
      - '.github/workflows/test.yml'
      - '.prettierignore'
      - '.prettierrc'
      - 'eslint.config.js'
      - 'jsconfig.json'
      - 'mock-oauth2-config.json'
      - 'playwright.config.js'
      - 'vitest.config.js'
  schedule:
    - cron: '23 4 * * *'

permissions:
  contents: read
  packages: read
  id-token: write

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '22'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'
  AWS_ACCOUNT_ID: '887764105431'
  AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'
  BASE_IMAGE_TAG_PREFIX: 'submit-base'
  loadTestDuration: '30s'
  GITHUB_ACTOR: ${{ github.actor }}
  SELF_DESTRUCT_DELAY_HOURS: '1'
  BASE_IMAGE_TAG: ${{ github.sha }}
  FORCE_ALL_STACK_DEPLOYMENT: 'false'
  COMMIT_HASH: ${{ github.sha }}
  BUILD_NUMBER: ${{ github.run_number }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_REF_TO_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}

jobs:

  lint-workflows:
    name: 'validate workflow syntax'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install actionlint
        run: |
          # Download and install actionlint
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          echo "$PWD" >> $GITHUB_PATH

      - name: Validate workflows
        run: |
          # Run actionlint with relaxed checking
          # - Ignore shellcheck info/style warnings that don't affect execution
          # - Ignore type mismatch false positives for quoted 'true'/'false' strings
          # - Only fail on actual syntax errors that prevent workflows from running
          ./actionlint \
            -ignore 'SC2001' \
            -ignore 'SC2002' \
            -ignore 'SC2015' \
            -ignore 'SC2016' \
            -ignore 'SC2076' \
            -ignore 'SC2086' \
            -ignore 'SC2129' \
            -ignore 'SC2155' \
            -ignore 'SC2207' \
            -ignore 'bool value cannot be assigned' \
            .github/workflows/*.yml

  params:
    runs-on: ubuntu-24.04
    steps:
      - name: "github.event_name=[${{ github.event_name }}]"
        run: ":"
      - name: "github.ref=[${{ github.ref }}]"
        run: ":"
      - name: "inputs.environment-name=[${{ inputs.environment-name }}]"
        run: ":"
      - name: "inputs.deployment-name=[${{ inputs.deployment-name }}]"
        run: ":"
      - name: "inputs.runProxyBehaviourTests=[${{ inputs.runProxyBehaviourTests }}]"
        run: ":"
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          # Convert '(auto)' to empty string for downstream processing
          ENV_NAME='${{ inputs.environment-name }}'; [[ "$ENV_NAME" == "(auto)" ]] && ENV_NAME=""
          echo "environment-name=${ENV_NAME}" | tee -a "$GITHUB_OUTPUT"
          echo 'deployment-name=${{ inputs.deployment-name }}' | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.runProxyBehaviourTests }}' ; echo "runProxyBehaviourTests=${X:-false}" | tee -a "$GITHUB_OUTPUT"
    outputs:
      environment-name: ${{ steps.normalise.outputs.environment-name }}
      deployment-name: ${{ steps.normalise.outputs.deployment-name }}
      runProxyBehaviourTests: ${{ steps.normalise.outputs.runProxyBehaviourTests }}

  names:
    needs:
      - params
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute deployment name and environment
        id: deployment-config
        uses: ./.github/actions/get-names
        with:
          environment-name: ${{ needs.params.outputs.environment-name }}
          deployment-name: ${{ needs.params.outputs.deployment-name }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  npm-test:
    name: 'npm test'
    runs-on: ubuntu-24.04
    needs:
      - names
    permissions:
      contents: read
      packages: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm test

  npm-unit-test:
    name: 'npm unit test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm run test:coverage

  npm-system-test:
    name: 'npm system test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm run test:system

  npm-test-web-unit:
    name: 'npm unit test with coverage'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci || npm install

      - name: Build bundle for tests
        run: npm run bundle

      - run: npm run test:web-unit

  npm-browser-test:
    name: 'npm browser test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npx playwright install chromium --with-deps

      - run: npm run test:browser

  mvn-test:
    name: 'maven test'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: test
        id: test
        shell: bash
        run: |
          ./mvnw clean test

  npm-test-cdk-ci:
    name: 'npm test cdk-ci'
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: verify
        id: mvn-verify
        shell: bash
        run: |
          ./mvnw clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }}

      - name: Self Destruct Start Datetime (ISO 8601) now plus SELF_DESTRUCT_DELAY_HOURS
        id: self-destruct-start
        shell: bash
        run: |
          SELF_DESTRUCT_START_DATETIME=$(date -u -d "+${{ env.SELF_DESTRUCT_DELAY_HOURS }} hours" +"%Y-%m-%dT%H:%M:%SZ")
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME"
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME" >> $GITHUB_OUTPUT

      - name: test cdk
        id: test-cdk
        shell: bash
        run: npm run cdk-ci
        env:
          ENVIRONMENT_NAME: 'ci'
          DEPLOYMENT_NAME: 'ci'
          SELF_DESTRUCT_HANDLER_SOURCE: "../${{ steps.mvn-verify.outputs.SELF_DESTRUCT_HANDLER_SOURCE }}"
          SELF_DESTRUCT_START_DATETIME: ${{ steps.self-destruct-start.outputs.SELF_DESTRUCT_START_DATETIME }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  npm-test-cdk-prod:
    name: 'npm test cdk prod'
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: verify
        id: mvn-verify
        shell: bash
        run: |
          ./mvnw clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }}

      - name: Self Destruct Start Datetime (ISO 8601) now plus SELF_DESTRUCT_DELAY_HOURS
        id: self-destruct-start
        shell: bash
        run: |
          SELF_DESTRUCT_START_DATETIME=$(date -u -d "+${{ env.SELF_DESTRUCT_DELAY_HOURS }} hours" +"%Y-%m-%dT%H:%M:%SZ")
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME"
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME" >> $GITHUB_OUTPUT

      - name: test cdk
        id: test-cdk
        shell: bash
        run: npm run cdk
        env:
          ENVIRONMENT_NAME: 'prod'
          DEPLOYMENT_NAME: 'prod'
          SELF_DESTRUCT_START_DATETIME: ${{ steps.self-destruct-start.outputs.SELF_DESTRUCT_START_DATETIME }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  # Simulator behaviour tests - run in parallel without ngrok/Docker/HMRC
  # Uses Playwright official container for faster builds (browsers pre-installed)
  behaviour-test-simulator-submit-vat:
    name: 'simulator - submitVatBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:submitVatBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-submit-vat
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-post-vat-return:
    name: 'simulator - postVatReturnBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:postVatReturnBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-post-vat-return
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-get-vat-return:
    name: 'simulator - getVatReturnBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:getVatReturnBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-get-vat-return
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-get-vat-obligations:
    name: 'simulator - getVatObligationsBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:getVatObligationsBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-get-vat-obligations
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-fraud-prevention-headers:
    name: 'simulator - fraudPreventionHeadersBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:postVatReturnFraudPreventionHeadersBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-fraud-prevention-headers
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-compliance:
    name: 'simulator - complianceBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:complianceBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-compliance
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-vat-validation:
    name: 'simulator - vatValidationBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:vatValidationBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-vat-validation
          retention-days: 7
          path: target/behaviour-test-results/

  behaviour-test-simulator-vat-schemes:
    name: 'simulator - vatSchemesBehaviour'
    runs-on: ubuntu-24.04
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    needs:
      - names
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour test
        run: npm run test:vatSchemesBehaviour-simulator

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-simulator-vat-schemes
          retention-days: 7
          path: target/behaviour-test-results/

  # Proxy behaviour test - requires Docker, ngrok, and HMRC sandbox secrets
  # Uses manual Playwright install (not container) because Docker is needed for mock-oauth2-server
  behaviour-test-proxy-submit-vat:
    if: ${{ !cancelled() && needs.params.outputs.runProxyBehaviourTests == 'true' }}
    name: 'proxy - submitVatBehaviour'
    needs:
      - params
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Run behaviour tests - submit vat
        run: |
          npm run test:submitVatBehaviour-proxy || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-proxy-submit-vat-results
          retention-days: 7
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-proxy-submit-vat-reports
          retention-days: 7
          path: |
            target/test-reports/

      - name: Upload artifacts (dynamodb exports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-proxy-submit-vat-dynamodb
          retention-days: 7
          path: |
            target/behaviour-test-results/**/*.jsonl
