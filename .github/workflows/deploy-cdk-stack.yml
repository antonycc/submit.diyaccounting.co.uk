name: deploy-cdk-stack
run-name: "deploy cdk stack from ${{ github.ref_name }}"

on:
  workflow_dispatch:
    inputs:
      stackName:
        description: 'Stack name to deploy. e.g. ci-reports-app-DevStack'
        required: true
      force-stack-deployment:
        description: 'Force re-deploy of all stacks even if they already exist or pass comparison checks'
        type: choice
        options:
          - 'true'
          - 'false'
        required: false
        default: 'false'
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - '(auto)'
          - 'ci'
          - 'prod'
        default: '(auto)'
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''
      cdk-application:
        type: choice
        description: 'CDK application name'
        required: false
        options:
          - '(auto)'
          - 'application'
          - 'environment'
        default: 'application'
      base-image-tag:
        description: 'Base image tag to use. e.g. github.sha'
        required: false
        default: '' # ${{ github.sha }}
      self-destruct-start-datetime:
        description: 'Self-destruct start datetime'
        required: false
        default: ''
      http-api-url:
        description: 'HTTP API URL (manual override, ignored when lookup-api-gateway is true)'
        required: false
        default: ''
      lookup-api-gateway:
        description: 'Look up API Gateway URL from deployment custom domain instead of using http-api-url input'
        type: choice
        options:
          - 'true'
          - 'false'
        required: false
        default: 'false'
      website-hash:
        description: 'Website hash to use'
        required: false
        default: ''
  workflow_call:
    inputs:
      stackName:
        type: string
        required: true
      force-stack-deployment:
        type: string
        required: true
      environment-name:
        type: string
        required: true
      deployment-name:
        type: string
        required: true
      cdk-application:
        type: string
        required: false
        default: 'application'
      base-image-tag:
        type: string
        required: false
        default: '' # ${{ github.sha }}
      self-destruct-start-datetime:
        type: string
        required: false
        default: ''
      lookup-api-gateway:
        type: string
        required: false
        default: 'false'
      website-hash:
        type: string
        required: false
        default: ''

permissions:
  id-token: write
  contents: read
  pull-requests: read
  pages: write

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '22'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'
  AWS_ACCOUNT_ID: '887764105431'
  AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'
  GITHUB_ACTOR: ${{ github.actor }}
  BASE_IMAGE_TAG: ${{ github.sha }}
  BUILD_NUMBER: ${{ github.run_number }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_REF_TO_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}

jobs:

  params:
    runs-on: ubuntu-24.04
    steps:
      - name: "github.event_name=[${{ github.event_name }}]"
        run: ":"
      - name: "inputs.stackName=[${{ inputs.stackName }}]"
        run: ":"
      - name: "inputs.force-stack-deployment=[${{ inputs.force-stack-deployment }}]"
        run: ":"
      - name: "inputs.environment-name=[${{ inputs.environment-name }}]"
        run: ":"
      - name: "inputs.deployment-name=[${{ inputs.deployment-name }}]"
        run: ":"
      - name: "inputs.cdk-application=[${{ inputs.cdk-application }}]"
        run: ":"
      - name: "inputs.base-image-tag=[${{ inputs['base-image-tag'] }}]"
        run: ":"
      - name: "inputs.self-destruct-start-datetime=[${{ inputs['self-destruct-start-datetime'] }}]"
        run: ":"
      - name: "inputs.lookup-api-gateway=[${{ inputs['lookup-api-gateway'] }}]"
        run: ":"
      - name: "inputs.website-hash=[${{ inputs['website-hash'] }}]"
        run: ":"
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          echo 'stackName=${{ inputs.stackName }}' | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.force-stack-deployment }}' ; echo "force-stack-deployment=${X:-false}" | tee -a "$GITHUB_OUTPUT"
          # Convert '(auto)' to empty string for downstream processing
          ENV_NAME='${{ inputs.environment-name }}'; [[ "$ENV_NAME" == "(auto)" ]] && ENV_NAME=""
          echo "environment-name=${ENV_NAME}" | tee -a "$GITHUB_OUTPUT"
          echo 'deployment-name=${{ inputs.deployment-name }}' | tee -a "$GITHUB_OUTPUT"
          CDK_APP='${{ inputs.cdk-application }}'; [[ "$CDK_APP" == "(auto)" ]] && CDK_APP=""
          echo "cdk-application=${CDK_APP:-application}" | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.base-image-tag }}' ; echo "base-image-tag=${X:-${{ github.sha }}}" | tee -a "$GITHUB_OUTPUT"
          echo "self-destruct-start-datetime=${{ inputs['self-destruct-start-datetime'] }}" | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.lookup-api-gateway }}' ; echo "lookup-api-gateway=${X:-false}" | tee -a "$GITHUB_OUTPUT"
          # Manual override for http-api-url (workflow_dispatch only)
          echo "http-api-url=${{ inputs['http-api-url'] }}" | tee -a "$GITHUB_OUTPUT"
          echo "website-hash=${{ inputs['website-hash'] }}" | tee -a "$GITHUB_OUTPUT"
    outputs:
      stackName: ${{ steps.normalise.outputs.stackName }}
      force-stack-deployment: ${{ steps.normalise.outputs.force-stack-deployment }}
      environment-name: ${{ steps.normalise.outputs.environment-name }}
      deployment-name: ${{ steps.normalise.outputs.deployment-name }}
      cdk-application: ${{ steps.normalise.outputs.cdk-application }}
      base-image-tag: ${{ steps.normalise.outputs['base-image-tag'] }}
      self-destruct-start-datetime: ${{ steps.normalise.outputs['self-destruct-start-datetime'] }}
      lookup-api-gateway: ${{ steps.normalise.outputs['lookup-api-gateway'] }}
      http-api-url: ${{ steps.normalise.outputs['http-api-url'] }}
      website-hash: ${{ steps.normalise.outputs['website-hash'] }}

  names:
    needs:
      - params
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: If main, read back last known good prod deployment from SSM Parameter Store
        if: ${{ needs.params.outputs['deployment-name'] == '' && github.ref == 'refs/heads/main' }}
        run: |
          PARAMETER_NAME="/submit/prod/last-known-good-deployment"
          aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text | tee /tmp/last_known_good_deployment.txt
          echo "Last known good deployment: $(cat /tmp/last_known_good_deployment.txt)"

      - name: If not main, read back last known good ci deployment from SSM Parameter Store
        if: ${{ needs.params.outputs['deployment-name'] == '' && github.ref != 'refs/heads/main' }}
        run: |
          PARAMETER_NAME="/submit/ci/last-known-good-deployment"
          aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text | tee /tmp/last_known_good_deployment.txt
          echo "Last known good deployment: $(cat /tmp/last_known_good_deployment.txt)"

      - name: If last-known-good-deployment set use that otherwise use current deployment name
        id: deployment-name
        run: |
            if [ -s /tmp/last_known_good_deployment.txt ]; then
                echo "Using last known good deployment from SSM Parameter Store"
                echo "deployment-name=$(cat /tmp/last_known_good_deployment.txt)" | tee -a "$GITHUB_OUTPUT"
            else
                echo "No last known good deployment found, using current deployment name"
                echo "deployment-name=${{ needs.params.outputs['deployment-name'] }}" | tee -a "$GITHUB_OUTPUT"
            fi

      - name: Compute deployment name and environment
        id: deployment-config
        uses: './.github/actions/get-names'
        with:
          environment-name: ${{ needs.params.outputs['environment-name'] }}
          deployment-name: ${{ steps.deployment-name.outputs['deployment-name'] }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-name.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  deploy-stack:
    name: 'deploy ${{ needs.params.outputs.stackName }}'
    needs:
      - params
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Check if ${{ needs.params.outputs.stackName }} exists
        id: static-skip
        shell: bash
        run: |
          STACK_NAME="${{ needs.names.outputs.deployment-name }}-app-${{ needs.params.outputs.stackName }}"
          echo "Checking for existing COMPLETE stack: $STACK_NAME"
          COUNT=$(aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query "length(StackSummaries[?StackName=='${STACK_NAME}'])" \
            --output text)
          if [ "$COUNT" -ge 1 ]; then
            echo "skipStaticStackDeployment=true" >> "$GITHUB_OUTPUT"
          else
            echo "skipStaticStackDeployment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: ${{ needs.names.outputs.environment-name == 'prod' || needs.params.outputs.force-stack-deployment == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/checkout@v6

      - name: Lookup resources from domain convention
        if: ${{ needs.names.outputs.environment-name == 'prod' || needs.params.outputs.force-stack-deployment == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        id: lookup
        uses: './.github/actions/lookup-resources'
        with:
          environment-name: ${{ needs.names.outputs.environment-name }}
          deployment-name: ${{ needs.names.outputs.deployment-name }}
          lookup-cognito: 'true'
          lookup-api-gateway: ${{ needs.params.outputs.lookup-api-gateway }}

      - name: Setup Node
        if: ${{ needs.names.outputs.environment-name == 'prod' || needs.params.outputs.force-stack-deployment == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ needs.names.outputs.environment-name == 'prod' || needs.params.outputs.force-stack-deployment == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: npm ci

      - uses: actions/setup-java@v5
        if: ${{ needs.names.outputs.environment-name == 'prod' || needs.params.outputs.force-stack-deployment == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy ${{ needs.params.outputs.stackName }} Stack (CDK)
        if: ${{ needs.names.outputs.environment-name == 'prod' || needs.params.outputs.force-stack-deployment == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-${{ needs.params.outputs.cdk-application }} \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.params.outputs.stackName }} \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-${{ needs.params.outputs.cdk-application }}.out/cdk-outputs-${{ needs.params.outputs.stackName }}.json \
            && cd .. \
          ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          # Looked up from Cognito domain convention
          COGNITO_USER_POOL_ARN: ${{ steps.lookup.outputs.cognito-user-pool-arn }}
          COGNITO_CLIENT_ID: ${{ steps.lookup.outputs.cognito-client-id }}
          BASE_IMAGE_TAG: ${{ needs.params.outputs['base-image-tag'] }}
          SELF_DESTRUCT_START_DATETIME: ${{ needs.params.outputs['self-destruct-start-datetime'] }}
          HMRC_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:${{ needs.names.outputs.environment-name }}/submit/hmrc/client_secret"
          HMRC_SANDBOX_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:${{ needs.names.outputs.environment-name }}/submit/hmrc/sandbox_client_secret"
          # Looked up from API Gateway custom domain, or manual override from http-api-url input
          HTTP_API_URL: ${{ steps.lookup.outputs.http-api-url || needs.params.outputs['http-api-url'] }}
          WEBSITE_HASH: ${{ needs.params.outputs['website-hash'] }}
          DIY_SUBMIT_APEX_URL: ${{ needs.names.outputs.apex-url }}

      - run: cat cdk-submit-${{ needs.params.outputs.cdk-application }}.out/cdk-outputs-${{ needs.params.outputs.stackName }}.json | jq '.'
