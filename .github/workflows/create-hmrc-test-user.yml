name: create-hmrc-test-user
run-name: "Create HMRC Sandbox test user"
# SPDX-FileCopyrightText: 2025-2026 DIY Accounting Limited
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# Creates an HMRC Sandbox test user with MTD-VAT access.
# The credentials can be used for manual testing against the HMRC Sandbox environment.
#
# IMPORTANT: These are SANDBOX/TEST credentials only.
# They have NO access to real HMRC data or production systems.
# The credentials are safe to copy from GitHub Actions logs.

on:
  workflow_dispatch:
    inputs:
      service-names:
        type: choice
        description: 'HMRC services to enable for the test user'
        required: false
        options:
          - 'mtd-vat'
          - 'mtd-vat,mtd-income-tax'
        default: 'mtd-vat'

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '24'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'
  # HMRC_SANDBOX_CLIENT_ID is a test application credential - not a production secret
  HMRC_SANDBOX_CLIENT_ID: 'uqMHA6RsDGGa7h8EG2VqfqAmv4tV'

jobs:
  create-test-user:
    name: 'Create HMRC Sandbox Test User'
    runs-on: ubuntu-24.04
    environment: ci
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create HMRC Sandbox Test User
        id: create-user
        run: |
          echo ""
          echo "========================================================================"
          echo "CREATING HMRC SANDBOX TEST USER"
          echo "========================================================================"
          echo ""
          echo "NOTE: These are SANDBOX/TEST credentials only."
          echo "      They have NO access to real HMRC data or production systems."
          echo "      It is safe to copy these from the GitHub Actions logs."
          echo ""
          node scripts/create-hmrc-test-user.js
        env:
          HMRC_SANDBOX_CLIENT_ID: ${{ env.HMRC_SANDBOX_CLIENT_ID }}
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}

      - name: Write Job Summary with Credentials
        if: success()
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## ðŸ”‘ HMRC Sandbox Test Credentials

          > **âš ï¸ SANDBOX/TEST CREDENTIALS ONLY** - These have NO access to real HMRC data or production systems.

          ### Credentials (copy these)

          | Field | Value |
          |-------|-------|
          | **User ID** | `${{ steps.create-user.outputs.hmrc-user-id }}` |
          | **Password** | `${{ steps.create-user.outputs.hmrc-password }}` |
          | **VAT Number (VRN)** | `${{ steps.create-user.outputs.hmrc-vat-number }}` |
          | **Organisation** | ${{ steps.create-user.outputs.hmrc-org-name }} |

          ### How to Use

          1. Go to your app and initiate HMRC OAuth (sandbox mode)
          2. When redirected to HMRC login, enter the **User ID** and **Password** above
          3. Grant access to your application
          4. Use the **VAT Number (VRN)** in your submission forms

          ---
          *These credentials are also available in the `hmrc-test-user-credentials` artifact.*
          EOF

      - name: Upload credentials artifact
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: hmrc-test-user-credentials
          retention-days: 7
          path: hmrc-test-user.json

      - name: Write Failure Summary
        if: failure()
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## âŒ Failed to Create HMRC Test User

          Check the logs above for error details.

          ### Common Issues

          - `HMRC_SANDBOX_CLIENT_SECRET` not configured in GitHub Secrets
          - HMRC Sandbox API temporarily unavailable
          - Network connectivity issues

          ### Troubleshooting

          1. Verify the `HMRC_SANDBOX_CLIENT_SECRET` secret exists in the `ci` environment
          2. Check HMRC API status at https://developer.service.hmrc.gov.uk/api-documentation
          3. Try running the workflow again
          EOF
