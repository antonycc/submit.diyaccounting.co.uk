# deploy-environment: public-url fix for synthetic test (bump)
name: deploy environment
run-name: "deploy environment from ${{ github.ref_name }}"
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

# bump12

on:
  workflow_dispatch:
    inputs:
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - '(auto)'
          - 'ci'
          - 'prod'
        default: '(auto)'
      force-identity-refresh:
        type: boolean
        description: 'Force refresh of Cognito Identity Provider (use after rotating GOOGLE_CLIENT_SECRET)'
        required: false
        default: false

  push:
    branches:
      - '**'
      - '!gh_pages'
      - '!dependabot/**'
      #- '!copilot/**'
    paths:
      - '.env.ci'
      - '.env.prod'
      - 'cdk-environment/cdk.json'
      - '.github/actions/get-names'
      - '.github/actions/set-origins'
      - '.github/workflows/deploy-environment.yml'
      # Environment stacks
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/ObservabilityStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/ObservabilityUE1Stack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/DataStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/BackupStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/ApexStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/IdentityStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/ActivityStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/SimulatorStack.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/stacks/EcrStack.java'
      # Simulator source code
      - 'web/public-simulator/**'
      # Shared utilities and entry point
      - 'infra/main/java/co/uk/diyaccounting/submit/utils/**'
      - 'infra/main/java/co/uk/diyaccounting/submit/SubmitEnvironment.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/SubmitSharedNames.java'
      - 'infra/main/java/co/uk/diyaccounting/submit/SubmitStackProps.java'
  schedule:
    - cron: '51 3 * * *'

# bump

env:
  JAVA_VERSION: '25'
  NODE_VERSION: '24'
  AWS_REGION: 'eu-west-2'
  GITHUB_ACTOR: ${{ github.actor }}

jobs:

  params:
    runs-on: ubuntu-24.04
    permissions: {}
    steps:
      - name: "github.event_name=[${{ github.event_name }}]"
        run: ":"
      - name: "github.ref=[${{ github.ref }}]"
        run: ":"
      - name: "inputs.environment-name=[${{ inputs.environment-name }}]"
        run: ":"
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          # Convert '(auto)' to empty string for downstream processing
          ENV_NAME='${{ inputs.environment-name }}'; [[ "$ENV_NAME" == "(auto)" ]] && ENV_NAME=""
          echo "environment-name=${ENV_NAME}" | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.force-identity-refresh }}' ; echo "force-identity-refresh=${X:-false}" | tee -a "$GITHUB_OUTPUT"
          # Resolve GitHub Actions environment from explicit input or branch
          GH_ENV="${ENV_NAME}"
          if [ -z "$GH_ENV" ]; then
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then GH_ENV="prod"; else GH_ENV="ci"; fi
          fi
          echo "github-environment=${GH_ENV}" | tee -a "$GITHUB_OUTPUT"
    outputs:
      environment-name: ${{ steps.normalise.outputs.environment-name }}
      force-identity-refresh: ${{ steps.normalise.outputs.force-identity-refresh }}
      github-environment: ${{ steps.normalise.outputs.github-environment }}

  names:
    needs:
      - params
    runs-on: ubuntu-24.04
    environment: ${{ needs.params.outputs.github-environment }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute deployment name and environment
        id: deployment-config
        uses: ./.github/actions/get-names
        with:
          environment-name: ${{ needs.params.outputs.environment-name }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  create-secrets:
    name: create secrets
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Create secret in AWS from secrets.GOOGLE_CLIENT_SECRET
        run: |
          if ! aws secretsmanager describe-secret --secret-id $GOOGLE_CLIENT_SECRET_ARN ; then
            echo "Creating secret $GOOGLE_CLIENT_SECRET_ARN"
            aws secretsmanager create-secret --name "${{ needs.names.outputs.environment-name }}/submit/google/client_secret" --secret-string "${{ secrets.GOOGLE_CLIENT_SECRET }}" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $GOOGLE_CLIENT_SECRET_ARN already exists, updating"
            aws secretsmanager update-secret --secret-id $GOOGLE_CLIENT_SECRET_ARN --secret-string "${{ secrets.GOOGLE_CLIENT_SECRET }}" --region ${{ env.AWS_REGION }}
          fi
        env:
          GOOGLE_CLIENT_SECRET_ARN: arn:aws:secretsmanager:${{ env.AWS_REGION }}:${{ vars.SUBMIT_ACCOUNT_ID }}:secret:${{ needs.names.outputs.environment-name }}/submit/google/client_secret

      - name: Create secret in AWS from secrets.HMRC_CLIENT_SECRET
        run: |
          if ! aws secretsmanager describe-secret --secret-id $HMRC_CLIENT_SECRET_ARN ; then
            echo "Creating secret $HMRC_CLIENT_SECRET_ARN"
            aws secretsmanager create-secret --name "${{ needs.names.outputs.environment-name }}/submit/hmrc/client_secret" --secret-string "${{ secrets.HMRC_CLIENT_SECRET }}" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $HMRC_CLIENT_SECRET_ARN already exists, updating"
            aws secretsmanager update-secret --secret-id $HMRC_CLIENT_SECRET_ARN --secret-string "${{ secrets.HMRC_CLIENT_SECRET }}" --region ${{ env.AWS_REGION }}
          fi
        env:
          HMRC_CLIENT_SECRET_ARN: arn:aws:secretsmanager:${{ env.AWS_REGION }}:${{ vars.SUBMIT_ACCOUNT_ID }}:secret:${{ needs.names.outputs.environment-name }}/submit/hmrc/client_secret

      - name: Create secret in AWS from secrets.HMRC_SANDBOX_CLIENT_SECRET
        run: |
          if ! aws secretsmanager describe-secret --secret-id $HMRC_SANDBOX_CLIENT_SECRET_ARN ; then
            echo "Creating secret $HMRC_SANDBOX_CLIENT_SECRET_ARN"
            aws secretsmanager create-secret --name "${{ needs.names.outputs.environment-name }}/submit/hmrc/sandbox_client_secret" --secret-string "${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $HMRC_SANDBOX_CLIENT_SECRET_ARN already exists, updating"
            aws secretsmanager update-secret --secret-id $HMRC_SANDBOX_CLIENT_SECRET_ARN --secret-string "${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}" --region ${{ env.AWS_REGION }}
          fi
        env:
          HMRC_SANDBOX_CLIENT_SECRET_ARN: arn:aws:secretsmanager:${{ env.AWS_REGION }}:${{ vars.SUBMIT_ACCOUNT_ID }}:secret:${{ needs.names.outputs.environment-name }}/submit/hmrc/sandbox_client_secret

      - name: Create secret in AWS from secrets.STRIPE_SECRET_KEY
        run: |
          SECRET_NAME="${{ needs.names.outputs.environment-name }}/submit/stripe/secret_key"
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating secret $SECRET_NAME"
            aws secretsmanager create-secret --name "$SECRET_NAME" --secret-string "${{ secrets.STRIPE_SECRET_KEY }}" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $SECRET_NAME already exists, updating"
            aws secretsmanager update-secret --secret-id "$SECRET_NAME" --secret-string "${{ secrets.STRIPE_SECRET_KEY }}" --region ${{ env.AWS_REGION }}
          fi

      - name: Create secret in AWS from secrets.STRIPE_TEST_SECRET_KEY
        run: |
          SECRET_NAME="${{ needs.names.outputs.environment-name }}/submit/stripe/test_secret_key"
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating secret $SECRET_NAME"
            aws secretsmanager create-secret --name "$SECRET_NAME" --secret-string "${{ secrets.STRIPE_TEST_SECRET_KEY }}" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $SECRET_NAME already exists, updating"
            aws secretsmanager update-secret --secret-id "$SECRET_NAME" --secret-string "${{ secrets.STRIPE_TEST_SECRET_KEY }}" --region ${{ env.AWS_REGION }}
          fi

      - name: Create Stripe webhook secret (live mode) from environment secret
        run: |
          SECRET_NAME="${{ needs.names.outputs.environment-name }}/submit/stripe/webhook_secret"
          SECRET_VALUE="${{ secrets.STRIPE_WEBHOOK_SECRET }}"
          if [ -z "$SECRET_VALUE" ]; then
            echo "No STRIPE_WEBHOOK_SECRET in ${{ needs.names.outputs.environment-name }} environment, skipping"
            exit 0
          fi
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating secret $SECRET_NAME"
            aws secretsmanager create-secret --name "$SECRET_NAME" --secret-string "$SECRET_VALUE" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $SECRET_NAME already exists, updating"
            aws secretsmanager update-secret --secret-id "$SECRET_NAME" --secret-string "$SECRET_VALUE" --region ${{ env.AWS_REGION }}
          fi

      - name: Create Stripe test webhook secret from environment secret
        run: |
          SECRET_NAME="${{ needs.names.outputs.environment-name }}/submit/stripe/test_webhook_secret"
          SECRET_VALUE="${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}"
          if [ -z "$SECRET_VALUE" ]; then
            echo "No STRIPE_TEST_WEBHOOK_SECRET in ${{ needs.names.outputs.environment-name }} environment, skipping"
            exit 0
          fi
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating secret $SECRET_NAME"
            aws secretsmanager create-secret --name "$SECRET_NAME" --secret-string "$SECRET_VALUE" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $SECRET_NAME already exists, updating"
            aws secretsmanager update-secret --secret-id "$SECRET_NAME" --secret-string "$SECRET_VALUE" --region ${{ env.AWS_REGION }}
          fi

      - name: Create secret in AWS from secrets.TELEGRAM_BOT_TOKEN
        run: |
          SECRET_NAME="${{ needs.names.outputs.environment-name }}/submit/telegram/bot_token"
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating secret $SECRET_NAME"
            aws secretsmanager create-secret --name "$SECRET_NAME" --secret-string "${{ secrets.TELEGRAM_BOT_TOKEN }}" --region ${{ env.AWS_REGION }}
          else
            echo "Secret $SECRET_NAME already exists, updating"
            aws secretsmanager update-secret --secret-id "$SECRET_NAME" --secret-string "${{ secrets.TELEGRAM_BOT_TOKEN }}" --region ${{ env.AWS_REGION }}
          fi

      - name: Create user sub hash salt (if not exists)
        run: |
          SECRET_NAME="${{ needs.names.outputs.environment-name }}/submit/user-sub-hash-salt"
          if ! aws secretsmanager describe-secret --secret-id "$SECRET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Creating new salt secret: $SECRET_NAME"
            # Generate 32-byte cryptographically secure random salt, base64 encoded
            SALT=$(openssl rand -base64 32)
            # Store as JSON registry format for multi-version salt support
            REGISTRY=$(jq -n --arg salt "$SALT" '{"current":"v1","versions":{"v1":$salt}}')
            aws secretsmanager create-secret \
              --name "$SECRET_NAME" \
              --description "Salt registry for hashing user subs - DO NOT DELETE (required for data recovery)" \
              --secret-string "$REGISTRY" \
              --region ${{ env.AWS_REGION }} \
              --tags Key=Purpose,Value=user-sub-hashing Key=Critical,Value=true Key=BackupRequired,Value=true
            echo "Salt secret created in registry format (current: v1)"
          else
            echo "Salt secret $SECRET_NAME already exists - preserving existing value"
          fi

  deploy-observability:
    name: 'deploy observability'
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-ObservabilityStack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-observability-us-east-1:
    name: 'deploy observability us-east-1'
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-ObservabilityUE1Stack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-data:
    name: 'deploy data'
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-DataStack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-backup:
    name: 'deploy backup'
    needs:
      - names
      - create-secrets
      - deploy-data
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-BackupStack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-activity:
    name: 'deploy activity'
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-ActivityStack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-ecr:
    name: 'deploy ecr'
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-EcrStack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-ecr-us-east-1:
    name: 'deploy ecr us-east-1'
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-EcrUE1Stack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  deploy-apex:
    name: deploy apex
    needs:
      - names
      - create-secrets
    uses: ./.github/workflows/deploy-cdk-stack.yml
    permissions:
      contents: read
      packages: read
      id-token: write
      pages: write
      pull-requests: read
    with:
      stackName: ${{ needs.names.outputs.environment-name }}-env-ApexStack
      force-stack-deployment: 'true'
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.environment-name }}
      cdk-application: 'environment'

  verify-certificate:
    name: 'verify certificate'
    needs:
      - names
      - create-secrets
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: us-east-1
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Verify certificate covers Cognito domain
        run: |
          CERT_ARN="${{ vars.SUBMIT_CERTIFICATE_ARN }}"
          COGNITO_DOMAIN="${{ needs.names.outputs.environment-name }}-auth.submit.diyaccounting.co.uk"

          echo "Verifying certificate $CERT_ARN covers $COGNITO_DOMAIN"

          # Try to describe certificate - may fail if IAM role lacks acm:DescribeCertificate
          if ! SANS=$(aws acm describe-certificate \
            --certificate-arn "$CERT_ARN" \
            --query 'Certificate.SubjectAlternativeNames' \
            --output text 2>&1); then
            echo "WARNING: Could not verify certificate coverage (IAM permission issue)"
            echo "Error: $SANS"
            echo ""
            echo "Since ci-auth.submit.diyaccounting.co.uk works, the certificate likely has"
            echo "wildcard *.submit.diyaccounting.co.uk coverage, so proceeding anyway."
            echo ""
            echo "To enable verification, add acm:DescribeCertificate to the deployment role."
            exit 0
          fi

          echo "Certificate SANs: $SANS"

          # Check for exact match or wildcard coverage
          if echo "$SANS" | grep -qE "(^|[[:space:]])(\*\.submit\.diyaccounting\.co\.uk|${COGNITO_DOMAIN})($|[[:space:]])"; then
            echo "Certificate covers $COGNITO_DOMAIN"
          else
            echo "WARNING: Certificate may not cover $COGNITO_DOMAIN"
            echo "Expected one of:"
            echo "  - *.submit.diyaccounting.co.uk (wildcard)"
            echo "  - $COGNITO_DOMAIN (explicit)"
            echo ""
            echo "Since ci-auth.submit.diyaccounting.co.uk works, proceeding anyway."
          fi

  # TODO: Switch to deploy-cdk-stack.yml
  deploy-identity:
    name: 'deploy identity'
    needs:
      - params
      - names
      - create-secrets
      - deploy-apex
      - verify-certificate
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy Identity stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-environment \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.environment-name }}-env-IdentityStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --no-notices \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-environment.out/cdk-outputs-identity.json \
              && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.environment-name }}

      - name: Resolve stack outputs
        id: identity-outputs
        run: |
          COGNITO_USER_POOL_ARN=$(jq -r '.["${{ needs.names.outputs.environment-name }}-env-IdentityStack"].UserPoolArn' cdk-submit-environment.out/cdk-outputs-identity.json)
          COGNITO_USER_POOL_ID=$(jq -r '.["${{ needs.names.outputs.environment-name }}-env-IdentityStack"].UserPoolId' cdk-submit-environment.out/cdk-outputs-identity.json)
          COGNITO_CLIENT_ID=$(jq -r '.["${{ needs.names.outputs.environment-name }}-env-IdentityStack"].UserPoolClientId' cdk-submit-environment.out/cdk-outputs-identity.json)
          echo "COGNITO_USER_POOL_ARN=$COGNITO_USER_POOL_ARN"
          echo "COGNITO_USER_POOL_ID=$COGNITO_USER_POOL_ID"
          echo "COGNITO_CLIENT_ID=$COGNITO_CLIENT_ID"
          echo "COGNITO_USER_POOL_ARN=$COGNITO_USER_POOL_ARN" >> $GITHUB_OUTPUT
          echo "COGNITO_USER_POOL_ID=$COGNITO_USER_POOL_ID" >> $GITHUB_OUTPUT
          echo "COGNITO_CLIENT_ID=$COGNITO_CLIENT_ID" >> $GITHUB_OUTPUT
        shell: bash

      - name: Force refresh Google Identity Provider (after secret rotation)
        if: ${{ needs.params.outputs.force-identity-refresh == 'true' }}
        run: |
          echo "Force refreshing Google Identity Provider to pick up rotated secret..."
          COGNITO_USER_POOL_ID=$(jq -r '.["${{ needs.names.outputs.environment-name }}-env-IdentityStack"].UserPoolId' cdk-submit-environment.out/cdk-outputs-identity.json)

          # Get current Google IdP configuration
          CURRENT_CONFIG=$(aws cognito-idp describe-identity-provider \
            --user-pool-id "$COGNITO_USER_POOL_ID" \
            --provider-name Google \
            --query 'IdentityProvider.ProviderDetails' \
            --output json)

          # Get current attribute mapping
          CURRENT_ATTRS=$(aws cognito-idp describe-identity-provider \
            --user-pool-id "$COGNITO_USER_POOL_ID" \
            --provider-name Google \
            --query 'IdentityProvider.AttributeMapping' \
            --output json)

          # Fetch the new secret value from Secrets Manager
          NEW_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "${{ needs.names.outputs.environment-name }}/submit/google/client_secret" \
            --query 'SecretString' \
            --output text)

          # Update the IdP with the new secret - this forces Cognito to use the new value
          # We need to re-specify all provider details including the updated client_secret
          CLIENT_ID=$(echo "$CURRENT_CONFIG" | jq -r '.client_id')

          aws cognito-idp update-identity-provider \
            --user-pool-id "$COGNITO_USER_POOL_ID" \
            --provider-name Google \
            --provider-details "client_id=$CLIENT_ID,client_secret=$NEW_SECRET,authorize_scopes=email openid profile" \
            --attribute-mapping "$CURRENT_ATTRS"

          echo "Google Identity Provider updated with new secret"

  deploy-simulator:
    name: 'deploy simulator'
    needs:
      - names
      - create-secrets
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - name: Build simulator
        run: npm run build:simulator

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy Simulator stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-environment \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.environment-name }}-env-SimulatorStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --no-notices \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-environment.out/cdk-outputs-simulator.json \
            && cd .. \
          ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.environment-name }}
