name: deploy root DNS
run-name: "deploy root DNS from ${{ github.ref_name }}"

on:
  workflow_dispatch:
    inputs:
      ci-gateway-cloudfront-domain:
        type: string
        description: 'Override CI gateway CloudFront domain. Default: auto-lookup from ci-gateway-GatewayStack.'
        required: false
        default: '(auto)'
      prod-gateway-cloudfront-domain:
        type: string
        description: 'Override prod gateway CloudFront domain. Default: auto-lookup from prod-gateway-GatewayStack.'
        required: false
        default: '(auto)'
      ci-spreadsheets-cloudfront-domain:
        type: string
        description: 'Override CI spreadsheets CloudFront domain. Default: auto-lookup from ci-spreadsheets-SpreadsheetsStack.'
        required: false
        default: '(auto)'
      prod-spreadsheets-cloudfront-domain:
        type: string
        description: 'Override prod spreadsheets CloudFront domain. Default: auto-lookup from prod-spreadsheets-SpreadsheetsStack.'
        required: false
        default: '(auto)'
      apex-cloudfront-domain:
        type: string
        description: 'Override apex (diyaccounting.co.uk) CloudFront domain. Default: auto-lookup from prod-gateway-GatewayStack.'
        required: false
        default: '(auto)'
      www-cloudfront-domain:
        type: string
        description: 'Override www.diyaccounting.co.uk CloudFront domain. Default: auto-lookup from prod-gateway-GatewayStack.'
        required: false
        default: '(auto)'
      spreadsheets-cloudfront-domain:
        type: string
        description: 'Override spreadsheets.diyaccounting.co.uk CloudFront domain. Default: auto-lookup from prod-spreadsheets-SpreadsheetsStack.'
        required: false
        default: '(auto)'

permissions:
  id-token: write
  contents: read

env:
  JAVA_VERSION: '25'
  NODE_VERSION: '24'
  AWS_REGION: 'us-east-1'

jobs:

  params:
    runs-on: ubuntu-24.04
    permissions: {}
    steps:
      - name: "github.event_name=[${{ github.event_name }}]"
        run: ":"
      - name: "github.ref=[${{ github.ref }}]"
        run: ":"
      - name: "inputs.ci-gateway-cloudfront-domain=[${{ inputs.ci-gateway-cloudfront-domain }}]"
        run: ":"
      - name: "inputs.prod-gateway-cloudfront-domain=[${{ inputs.prod-gateway-cloudfront-domain }}]"
        run: ":"
      - name: "inputs.ci-spreadsheets-cloudfront-domain=[${{ inputs.ci-spreadsheets-cloudfront-domain }}]"
        run: ":"
      - name: "inputs.prod-spreadsheets-cloudfront-domain=[${{ inputs.prod-spreadsheets-cloudfront-domain }}]"
        run: ":"
      - name: "inputs.apex-cloudfront-domain=[${{ inputs.apex-cloudfront-domain }}]"
        run: ":"
      - name: "inputs.www-cloudfront-domain=[${{ inputs.www-cloudfront-domain }}]"
        run: ":"
      - name: "inputs.spreadsheets-cloudfront-domain=[${{ inputs.spreadsheets-cloudfront-domain }}]"
        run: ":"
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          CI_GW="${{ inputs.ci-gateway-cloudfront-domain }}"
          PROD_GW="${{ inputs.prod-gateway-cloudfront-domain }}"
          CI_SS="${{ inputs.ci-spreadsheets-cloudfront-domain }}"
          PROD_SS="${{ inputs.prod-spreadsheets-cloudfront-domain }}"
          APEX="${{ inputs.apex-cloudfront-domain }}"
          WWW="${{ inputs.www-cloudfront-domain }}"
          SS="${{ inputs.spreadsheets-cloudfront-domain }}"
          # Convert (auto) to empty string â€” actual lookup happens in deploy job
          [[ "$CI_GW" == "(auto)" ]] && CI_GW=""
          [[ "$PROD_GW" == "(auto)" ]] && PROD_GW=""
          [[ "$CI_SS" == "(auto)" ]] && CI_SS=""
          [[ "$PROD_SS" == "(auto)" ]] && PROD_SS=""
          [[ "$APEX" == "(auto)" ]] && APEX=""
          [[ "$WWW" == "(auto)" ]] && WWW=""
          [[ "$SS" == "(auto)" ]] && SS=""
          echo "ci-gateway-cloudfront-domain=${CI_GW}" | tee -a "$GITHUB_OUTPUT"
          echo "prod-gateway-cloudfront-domain=${PROD_GW}" | tee -a "$GITHUB_OUTPUT"
          echo "ci-spreadsheets-cloudfront-domain=${CI_SS}" | tee -a "$GITHUB_OUTPUT"
          echo "prod-spreadsheets-cloudfront-domain=${PROD_SS}" | tee -a "$GITHUB_OUTPUT"
          echo "apex-cloudfront-domain=${APEX}" | tee -a "$GITHUB_OUTPUT"
          echo "www-cloudfront-domain=${WWW}" | tee -a "$GITHUB_OUTPUT"
          echo "spreadsheets-cloudfront-domain=${SS}" | tee -a "$GITHUB_OUTPUT"
          echo "ci-gw-auto=$( [[ '${{ inputs.ci-gateway-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
          echo "prod-gw-auto=$( [[ '${{ inputs.prod-gateway-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
          echo "ci-ss-auto=$( [[ '${{ inputs.ci-spreadsheets-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
          echo "prod-ss-auto=$( [[ '${{ inputs.prod-spreadsheets-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
          echo "apex-auto=$( [[ '${{ inputs.apex-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
          echo "www-auto=$( [[ '${{ inputs.www-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
          echo "ss-auto=$( [[ '${{ inputs.spreadsheets-cloudfront-domain }}' == '(auto)' ]] && echo true || echo false )" | tee -a "$GITHUB_OUTPUT"
    outputs:
      ci-gateway-cloudfront-domain: ${{ steps.normalise.outputs.ci-gateway-cloudfront-domain }}
      prod-gateway-cloudfront-domain: ${{ steps.normalise.outputs.prod-gateway-cloudfront-domain }}
      ci-spreadsheets-cloudfront-domain: ${{ steps.normalise.outputs.ci-spreadsheets-cloudfront-domain }}
      prod-spreadsheets-cloudfront-domain: ${{ steps.normalise.outputs.prod-spreadsheets-cloudfront-domain }}
      apex-cloudfront-domain: ${{ steps.normalise.outputs.apex-cloudfront-domain }}
      www-cloudfront-domain: ${{ steps.normalise.outputs.www-cloudfront-domain }}
      spreadsheets-cloudfront-domain: ${{ steps.normalise.outputs.spreadsheets-cloudfront-domain }}
      ci-gw-auto: ${{ steps.normalise.outputs.ci-gw-auto }}
      prod-gw-auto: ${{ steps.normalise.outputs.prod-gw-auto }}
      ci-ss-auto: ${{ steps.normalise.outputs.ci-ss-auto }}
      prod-ss-auto: ${{ steps.normalise.outputs.prod-ss-auto }}
      apex-auto: ${{ steps.normalise.outputs.apex-auto }}
      www-auto: ${{ steps.normalise.outputs.www-auto }}
      ss-auto: ${{ steps.normalise.outputs.ss-auto }}

  names:
    needs:
      - params
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute deployment name and environment
        id: deployment-config
        uses: ./.github/actions/get-names
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  deploy-root-dns:
    name: 'deploy root DNS records'
    needs:
      - params
      - names
    runs-on: ubuntu-24.04
    environment: prod
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.ROOT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.ROOT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Build CDK JARs
        run: ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }}

      - name: Lookup CloudFront domains
        id: lookup
        shell: bash
        run: |
          # Auto-lookup CI gateway CloudFront domain from stack output
          CI_GW="${{ needs.params.outputs.ci-gateway-cloudfront-domain }}"
          if [[ -z "$CI_GW" && "${{ needs.params.outputs.ci-gw-auto }}" == "true" ]]; then
            echo "Looking up ci-gateway-GatewayStack DistributionDomainName..."
            CI_GW=$(aws cloudformation describe-stacks \
              --stack-name ci-gateway-GatewayStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "CI gateway: ${CI_GW:-not found}"
          fi

          # Auto-lookup prod gateway CloudFront domain from stack output
          PROD_GW="${{ needs.params.outputs.prod-gateway-cloudfront-domain }}"
          if [[ -z "$PROD_GW" && "${{ needs.params.outputs.prod-gw-auto }}" == "true" ]]; then
            echo "Looking up prod-gateway-GatewayStack DistributionDomainName..."
            PROD_GW=$(aws cloudformation describe-stacks \
              --stack-name prod-gateway-GatewayStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "Prod gateway: ${PROD_GW:-not found}"
          fi

          # Auto-lookup CI spreadsheets CloudFront domain from stack output
          CI_SS="${{ needs.params.outputs.ci-spreadsheets-cloudfront-domain }}"
          if [[ -z "$CI_SS" && "${{ needs.params.outputs.ci-ss-auto }}" == "true" ]]; then
            echo "Looking up ci-spreadsheets-SpreadsheetsStack DistributionDomainName..."
            CI_SS=$(aws cloudformation describe-stacks \
              --stack-name ci-spreadsheets-SpreadsheetsStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "CI spreadsheets: ${CI_SS:-not found}"
          fi

          # Auto-lookup prod spreadsheets CloudFront domain from stack output
          PROD_SS="${{ needs.params.outputs.prod-spreadsheets-cloudfront-domain }}"
          if [[ -z "$PROD_SS" && "${{ needs.params.outputs.prod-ss-auto }}" == "true" ]]; then
            echo "Looking up prod-spreadsheets-SpreadsheetsStack DistributionDomainName..."
            PROD_SS=$(aws cloudformation describe-stacks \
              --stack-name prod-spreadsheets-SpreadsheetsStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "Prod spreadsheets: ${PROD_SS:-not found}"
          fi

          # Auto-lookup apex CloudFront domain (same as prod gateway)
          APEX="${{ needs.params.outputs.apex-cloudfront-domain }}"
          if [[ -z "$APEX" && "${{ needs.params.outputs.apex-auto }}" == "true" ]]; then
            echo "Looking up prod-gateway-GatewayStack for apex domain..."
            APEX=$(aws cloudformation describe-stacks \
              --stack-name prod-gateway-GatewayStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "Apex: ${APEX:-not found}"
          fi

          # Auto-lookup www CloudFront domain (same as prod gateway)
          WWW="${{ needs.params.outputs.www-cloudfront-domain }}"
          if [[ -z "$WWW" && "${{ needs.params.outputs.www-auto }}" == "true" ]]; then
            echo "Looking up prod-gateway-GatewayStack for www domain..."
            WWW=$(aws cloudformation describe-stacks \
              --stack-name prod-gateway-GatewayStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "Www: ${WWW:-not found}"
          fi

          # Auto-lookup spreadsheets CloudFront domain (same as prod spreadsheets)
          SS="${{ needs.params.outputs.spreadsheets-cloudfront-domain }}"
          if [[ -z "$SS" && "${{ needs.params.outputs.ss-auto }}" == "true" ]]; then
            echo "Looking up prod-spreadsheets-SpreadsheetsStack for spreadsheets domain..."
            SS=$(aws cloudformation describe-stacks \
              --stack-name prod-spreadsheets-SpreadsheetsStack \
              --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
              --output text 2>/dev/null || echo "")
            echo "Spreadsheets: ${SS:-not found}"
          fi

          echo "ci-gateway-cloudfront-domain=${CI_GW}" | tee -a "$GITHUB_OUTPUT"
          echo "prod-gateway-cloudfront-domain=${PROD_GW}" | tee -a "$GITHUB_OUTPUT"
          echo "ci-spreadsheets-cloudfront-domain=${CI_SS}" | tee -a "$GITHUB_OUTPUT"
          echo "prod-spreadsheets-cloudfront-domain=${PROD_SS}" | tee -a "$GITHUB_OUTPUT"
          echo "apex-cloudfront-domain=${APEX}" | tee -a "$GITHUB_OUTPUT"
          echo "www-cloudfront-domain=${WWW}" | tee -a "$GITHUB_OUTPUT"
          echo "spreadsheets-cloudfront-domain=${SS}" | tee -a "$GITHUB_OUTPUT"

      - name: Deploy RootDnsStack (CDK)
        run: |
          echo "Deploying stack: root-RootDnsStack"
          echo "CI gateway domain: $CI_GATEWAY_CLOUDFRONT_DOMAIN"
          echo "Prod gateway domain: $PROD_GATEWAY_CLOUDFRONT_DOMAIN"
          echo "CI spreadsheets domain: $CI_SPREADSHEETS_CLOUDFRONT_DOMAIN"
          echo "Prod spreadsheets domain: $PROD_SPREADSHEETS_CLOUDFRONT_DOMAIN"
          echo "Apex domain: $APEX_CLOUDFRONT_DOMAIN"
          echo "Www domain: $WWW_CLOUDFRONT_DOMAIN"
          echo "Spreadsheets domain: $SPREADSHEETS_CLOUDFRONT_DOMAIN"
          cd cdk-root \
            && npx cdk deploy \
              root-RootDnsStack \
              --require-approval never \
              --ci true \
              --no-notices \
              --outputs-file ../cdk-submit-root.out/cdk-outputs-root-dns.json \
          ;
        env:
          CI_GATEWAY_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.ci-gateway-cloudfront-domain }}
          PROD_GATEWAY_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.prod-gateway-cloudfront-domain }}
          CI_SPREADSHEETS_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.ci-spreadsheets-cloudfront-domain }}
          PROD_SPREADSHEETS_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.prod-spreadsheets-cloudfront-domain }}
          APEX_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.apex-cloudfront-domain }}
          WWW_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.www-cloudfront-domain }}
          SPREADSHEETS_CLOUDFRONT_DOMAIN: ${{ steps.lookup.outputs.spreadsheets-cloudfront-domain }}

      - name: Show stack outputs
        run: |
          echo "=== Root DNS Stack Outputs ==="
          cat cdk-submit-root.out/cdk-outputs-root-dns.json | jq '.'
