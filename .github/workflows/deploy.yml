name: deploy
run-name: "deploy from ${{ github.ref_name }}"
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

# Bump16

on:
  workflow_dispatch:
    inputs:
      forceAllStackDeployment:
        description: 'Force re-deploy of all stacks even if they already exist or pass comparison checks'
        type: choice
        options:
          - 'true'
          - 'false'
        required: false
        default: 'false'
      skipDeploy:
        description: 'Skip deploy (run tests only, no deployment)'
        type: choice
        options:
            - 'true'
            - 'false'
        required: false
        default: 'false'
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - ''
          - 'ci'
          - 'prod'
        default: ''
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''
      loadTestDuration:
        description: 'Duration for load test (e.g. 30s, 10m, 1h)'
        required: false
        default: '30s'
      selfDestructDelayHours:
        description: 'Hours before self-destruct triggers for non-prod environments'
        required: false
        default: '8'
      skipTestScenarios:
        description: 'Skip test scenarios for behaviour tests'
        type: choice
        options:
          - 'true'
          - 'false'
        required: false
        default: 'false'
      convertTestVideo:
        description: 'Convert test video to mp4 format'
        type: choice
        options:
          - 'true'
          - 'false'
        required: false
        default: 'false'
  push:
    branches:
      - '**'
      - '!gh_pages'
      - '!dependabot/**'
    paths:
      - 'app/data/**'
      - 'app/functions/**'
      - 'app/lib/**'
      - 'app/services/**'
      - 'infra/main/**'
      - 'web/public/**'
      - '.env.ci'
      - '.env.prod'
      - '**/cdk.json'
      - 'Dockerfile'
      - 'LICENSE'
      - 'package.json'
      - 'pom.xml'
      - 'product-catalogue.toml'
      - '.github/actions/get-names'
      - '.github/actions/set-origins'
      - '.github/workflows/deploy.yml'
  schedule:
    - cron: '11 4 * * *'

permissions:
  id-token: write
  contents: read
  pull-requests: read
  pages: write

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '22'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'
  AWS_ACCOUNT_ID: '887764105431'
  AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'
  BASE_IMAGE_TAG_PREFIX: 'submit-base'
  loadTestDuration: ${{ inputs.loadTestDuration || '30s' }}
  GITHUB_ACTOR: ${{ github.actor }}
  SELF_DESTRUCT_DELAY_HOURS: ${{ inputs.selfDestructDelayHours || '8' }}
  BASE_IMAGE_TAG: ${{ github.sha }}
  FORCE_ALL_STACK_DEPLOYMENT: ${{ inputs.forceAllStackDeployment || 'false' }}
  COMMIT_HASH: ${{ github.sha }}
  BUILD_NUMBER: ${{ github.run_number }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_REF_TO_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}

jobs:

  names:
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute deployment name and environment
        id: deployment-config
        uses: './.github/actions/get-names'
        with:
          environment-name: ${{ github.event.inputs.environment-name || '' }}
          deployment-name: ${{ github.event.inputs.deployment-name || '' }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  test:
    name: 'delegate to test workflow'
    needs:
      - names
    uses: ./.github/workflows/test.yml
    permissions:
      contents: read
      packages: read
      id-token: write
    with:
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.names.outputs.deployment-name }}

  npm-unit-test-coverage:
    name: 'npm unit test with coverage'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - run: npm run test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v6
        if: ${{ !cancelled() }}
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

  mvn-package:
    name: 'maven package'
    runs-on: ubuntu-latest
    needs:
      - names
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: package
        id: package
        shell: bash
        run: |
          ./mvnw clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }}

      - name: Self Destruct Start Datetime (ISO 8601) now plus SELF_DESTRUCT_DELAY_HOURS
        id: self-destruct-start
        shell: bash
        run: |
          SELF_DESTRUCT_START_DATETIME=$(date -u -d "+${{ env.SELF_DESTRUCT_DELAY_HOURS }} hours" +"%Y-%m-%dT%H:%M:%SZ")
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME"
          echo "SELF_DESTRUCT_START_DATETIME=$SELF_DESTRUCT_START_DATETIME" >> $GITHUB_OUTPUT

    outputs:
      self-destruct-start-datetime: ${{ steps.self-destruct-start.outputs.SELF_DESTRUCT_START_DATETIME }}

  behaviour-test-bundle:
    name: 'behaviour test - bundle (proxy)'
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
           npm install
           npx playwright install chromium --with-deps

      - name: Run behaviour tests - bundle
        run: |
          npm run test:bundleBehaviour-proxy || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-artifacts-bundle
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-reports-bundle
          retention-days: 30
          path: |
            target/test-reports/

      - name: Upload artifacts (dynamodb exports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-dynamodb-bundle
          retention-days: 30
          path: |
            target/behaviour-test-results/**/*.jsonl

  behaviour-test-submit-vat:
    name: 'behaviour test - submit vat (proxy)'
    needs:
      - names
      - behaviour-test-bundle
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Run behaviour tests - submit vat
        run: |
          npm run test:submitVatBehaviour-proxy || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-artifacts-submit-vat
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-reports-submit-vat
          retention-days: 30
          path: |
            target/test-reports/

      - name: Upload artifacts (dynamodb exports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-dynamodb-submit-vat
          retention-days: 30
          path: |
            target/behaviour-test-results/**/*.jsonl

  behaviour-test-obligation:
    name: 'behaviour test - obligation (proxy)'
    if: ${{ inputs.skipTestScenarios != 'true' }}
    needs:
      - names
      - behaviour-test-submit-vat
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Run behaviour tests - obligation
        run: |
          npm run test:obligationBehaviour-proxy || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-artifacts-obligation
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-reports-obligation
          retention-days: 30
          path: |
            target/test-reports/

      - name: Upload artifacts (dynamodb exports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-dynamodb-obligation
          retention-days: 30
          path: |
            target/behaviour-test-results/**/*.jsonl

  behaviour-test-post-vat-return:
    name: 'behaviour test - post vat return (proxy)'
    if: ${{ inputs.skipTestScenarios != 'true' }}
    needs:
      - names
      - behaviour-test-obligation
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Run behaviour tests - post-vat-return
        run: |
          npm run test:postVatReturnBehaviour-proxy || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-artifacts-post-vat-return
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-reports-post-vat-return
          retention-days: 30
          path: |
            target/test-reports/

      - name: Upload artifacts (dynamodb exports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-dynamodb-post-vat-return
          retention-days: 30
          path: |
            target/behaviour-test-results/**/*.jsonl

  behaviour-test-get-vat-return:
    name: 'behaviour test - get vat return (proxy)'
    if: ${{ inputs.skipTestScenarios != 'true' }}
    needs:
      - names
      - behaviour-test-post-vat-return
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium --with-deps

      - name: Run behaviour tests - get-vat-return
        run: |
          npm run test:getVatReturnBehaviour-proxy || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-artifacts-get-vat-return
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-reports-get-vat-return
          retention-days: 30
          path: |
            target/test-reports/

      - name: Upload artifacts (dynamodb exports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: behaviour-test-dynamodb-get-vat-return
          retention-days: 30
          path: |
            target/behaviour-test-results/**/*.jsonl

  test-aws-credentials:
    name: 'test aws credentials'
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: CDK stacks in eu-west-2 and us-east-1
        run: |
          aws cloudformation describe-stacks --region eu-west-2 --query "Stacks[].StackName" --output text | tr '\t' '\n' | sort
          aws cloudformation describe-stacks --region us-east-1 --query "Stacks[].StackName" --output text | tr '\t' '\n' | sort

  skip-deploy-check:
    name: 'skip deploy check'
    if: ${{ inputs.skipDeploy != 'true' }}
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Check if skipDeploy is set
        id: check
        run: |
          inputsSkipDeploy="${{ inputs.skipDeploy }}"
          skipDeploy="${{ (inputs.skipDeploy != 'true') && (github.event_name != 'push' || !contains(github.event.head_commit.message, 'skip:')) }}"
          echo "inputsSkipDeploy=$inputsSkipDeploy"
          echo "inputsSkipDeploy=$inputsSkipDeploy" >> "$GITHUB_OUTPUT"
          echo "skipDeploy=$skipDeploy"
          echo "skipDeploy=$skipDeploy" >> "$GITHUB_OUTPUT"

    outputs:
      inputsSkipDeploy: ${{ steps.check.outputs.inputsSkipDeploy }}
      skipDeploy: ${{ steps.check.outputs.skipDeploy }}

  docker-build:
    name: 'docker build'
    needs:
      - skip-deploy-check
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - name: Build base image
        run: |
          docker build \
            -t "${{ env.BASE_IMAGE_TAG_PREFIX }}:${{ github.sha }}" \
            -f Dockerfile .

      - name: Save image artifact
        run: |
          mkdir docker-image
          docker save -o docker-image/image.tar "${{ env.BASE_IMAGE_TAG_PREFIX }}:${{ github.sha }}"

      - name: Upload image artifact
        uses: actions/upload-artifact@v6
        with:
          name: docker-image
          path: docker-image/image.tar
          if-no-files-found: error

  deploy-dev:
    name: 'deploy dev'
    needs:
      - names
      - skip-deploy-check
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Check if DevStack exists
        id: static-skip
        shell: bash
        run: |
          STACK_NAME="${{ needs.names.outputs.deployment-name }}-app-DevStack"
          echo "Checking for existing COMPLETE stack: $STACK_NAME"
          COUNT=$(aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query "length(StackSummaries[?StackName=='${STACK_NAME}'])" \
            --output text)
          if [ "$COUNT" -ge 1 ]; then
            echo "skipStaticStackDeployment=true" >> "$GITHUB_OUTPUT"
          else
            echo "skipStaticStackDeployment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/checkout@v6

      - name: Setup Node
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: npm ci

      - uses: actions/setup-java@v5
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy Dev Stack (CDK)
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-DevStack \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-dev.json \
            && cd .. \
          ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  deploy-dev-us-east-1:
    name: 'deploy dev us-east-1'
    needs:
      - names
      - skip-deploy-check
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Check if DevStack exists
        id: static-skip
        shell: bash
        run: |
          STACK_NAME="${{ needs.names.outputs.deployment-name }}-app-DevStack"
          echo "Checking for existing COMPLETE stack: $STACK_NAME"
          COUNT=$(aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query "length(StackSummaries[?StackName=='${STACK_NAME}'])" \
            --output text)
          if [ "$COUNT" -ge 1 ]; then
            echo "skipStaticStackDeployment=true" >> "$GITHUB_OUTPUT"
          else
            echo "skipStaticStackDeployment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/checkout@v6

      - name: Setup Node
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: npm ci

      - uses: actions/setup-java@v5
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy Dev us-east-1 Stack (CDK)
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-DevUE1Stack \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-dev-ue1.json \
            && cd .. \
          ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  push-images:
    name: 'push images'
    needs:
      - names
      - skip-deploy-check
      - deploy-dev
      - docker-build
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Login to Amazon ECR
        shell: bash
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login \
                --username AWS \
                --password-stdin "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}" \
            ;
        env:
          ECR_REPOSITORY_BASE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          ECR_REPOSITORY_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-ecr

      - name: Check if image already exists in ECR
        id: image-exists
        shell: bash
        run: |
          REPO_URI="${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}"
          REPO_NAME="${REPO_URI##*/}"
          echo "Checking if image with tag ${{ github.sha }} exists in $REPO_NAME"
          if aws ecr describe-images --repository-name "$REPO_NAME" --image-ids imageTag="${{ github.sha }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          ECR_REPOSITORY_BASE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          ECR_REPOSITORY_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-ecr

      - name: Checkout
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        uses: actions/checkout@v6

      - name: Setup Node
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        run: npm ci

      - name: Download image artifact
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        uses: actions/download-artifact@v7
        with:
          name: docker-image
          path: docker-image/

      - name: Load Docker image
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        run: docker load -i docker-image/image.tar

      - name: Tag and push Docker image to ECR
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        shell: bash
        run: |
          docker tag "${{ env.BASE_IMAGE_TAG_PREFIX }}:${{ github.sha }}" "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:${{ github.sha }}"
          docker tag "${{ env.BASE_IMAGE_TAG_PREFIX }}:${{ github.sha }}" "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:latest"
          docker push "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:${{ github.sha }}"
          docker push "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:latest"
        env:
          ECR_REPOSITORY_BASE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          ECR_REPOSITORY_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-ecr
    outputs:
      base-image-tag: ${{ github.sha }}

  push-images-us-east-1:
    name: 'push images us-east-1'
    needs:
      - names
      - skip-deploy-check
      - deploy-dev-us-east-1
      - docker-build
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: us-east-1
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: us-east-1
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Login to Amazon ECR in us-east-1
        shell: bash
        run: |
          aws ecr get-login-password --region us-east-1 \
            | docker login \
                --username AWS \
                --password-stdin "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}" \
            ;
        env:
          ECR_REPOSITORY_BASE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
          ECR_REPOSITORY_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-ecr-us-east-1

      - name: Check if image already exists in ECR
        id: image-exists
        shell: bash
        run: |
          REPO_URI="${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}"
          REPO_NAME="${REPO_URI##*/}"
          echo "Checking if image with tag ${{ github.sha }} exists in $REPO_NAME"
          if aws ecr describe-images --region us-east-1 --repository-name "$REPO_NAME" --image-ids imageTag="${{ github.sha }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          ECR_REPOSITORY_BASE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
          ECR_REPOSITORY_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-ecr-us-east-1

      - name: Checkout
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        uses: actions/checkout@v6

      - name: Setup Node
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        run: npm ci

      - name: Download image artifact
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        uses: actions/download-artifact@v7
        with:
          name: docker-image
          path: docker-image/

      - name: Load Docker image
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        run: docker load -i docker-image/image.tar

      - name: Tag and push Docker image to ECR
        if: ${{ steps.image-exists.outputs.exists != 'true' }}
        shell: bash
        run: |
          docker tag "${{ env.BASE_IMAGE_TAG_PREFIX }}:${{ github.sha }}" "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:${{ github.sha }}"
          docker tag "${{ env.BASE_IMAGE_TAG_PREFIX }}:${{ github.sha }}" "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:latest"
          docker push "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:${{ github.sha }}"
          docker push "${ECR_REPOSITORY_BASE_URL?}/${ECR_REPOSITORY_NAME?}:latest"
        env:
          ECR_REPOSITORY_BASE_URL: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
          ECR_REPOSITORY_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-ecr-us-east-1
    outputs:
      base-image-tag: ${{ github.sha }}

  deploy-application-self-destruct:
    name: 'deploy application self-destruct'
    if: ${{ inputs.skipDeploy != 'true' && github.ref != 'refs/heads/main' && needs.names.outputs.environment-name != 'prod' }}
    needs:
      - names
      - skip-deploy-check
      - mvn-package
      - push-images
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy SelfDestruct Stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-SelfDestructStack \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-self-destruct.json \
          && cd .. \
          ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          SELF_DESTRUCT_START_DATETIME: ${{ needs.mvn-package.outputs.self-destruct-start-datetime }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  deploy-auth:
    name: 'deploy auth'
    needs:
      - names
      - skip-deploy-check
      - deploy-dev
      - push-images
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Deploy Auth stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-AuthStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-auth.json \
            && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

      - run: cat cdk-submit-application.out/cdk-outputs-auth.json | jq '.'

  deploy-hmrc:
    name: 'deploy hmrc'
    needs:
      - names
      - skip-deploy-check
      - deploy-dev
      - docker-build
      - push-images
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Deploy HMRC stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-HmrcStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-hmrc.json \
            && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

      - run: cat cdk-submit-application.out/cdk-outputs-hmrc.json | jq '.'

  deploy-account:
    name: 'deploy account'
    needs:
      - names
      - skip-deploy-check
      - deploy-dev
      - docker-build
      - push-images
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Deploy Account stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-AccountStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-account.json \
            && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          HMRC_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:${{ needs.names.outputs.environment-name }}/submit/hmrc/client_secret"
          HMRC_SANDBOX_CLIENT_SECRET_ARN: "arn:aws:secretsmanager:eu-west-2:887764105431:secret:${{ needs.names.outputs.environment-name }}/submit/hmrc/sandbox_client_secret"
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

      - run: cat cdk-submit-application.out/cdk-outputs-account.json | jq '.'

  deploy-api:
    name: 'deploy api'
    needs:
      - names
      - skip-deploy-check
      - deploy-auth
      - deploy-hmrc
      - deploy-account
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Deploy API stack (CDK)
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-ApiStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-api.json \
            && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

      - run: cat cdk-submit-application.out/cdk-outputs-api.json | jq '.'

      - name: Resolve stack outputs
        id: api-outputs
        run: |
          HTTP_API_URL=$(jq -r '.["${{ needs.names.outputs.deployment-name }}-app-ApiStack"].HttpApiUrl' cdk-submit-application.out/cdk-outputs-api.json)
          echo "HTTP_API_URL=$HTTP_API_URL"
          echo "HTTP_API_URL=$HTTP_API_URL" >> $GITHUB_OUTPUT
        shell: bash
    outputs:
      httpApiUrl: ${{ steps.api-outputs.outputs.HTTP_API_URL }}

  deploy-edge:
    name: 'deploy edge'
    needs:
      - names
      - skip-deploy-check
      - mvn-package
      - push-images
      - deploy-auth
      - deploy-hmrc
      - deploy-account
      - deploy-api
    runs-on: ubuntu-24.04
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
      url: ${{ steps.edge-outputs.outputs.DIY_SUBMIT_BASE_URL }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Check if EdgeStack exists
        id: static-skip
        shell: bash
        run: |
          STACK_NAME="${{ needs.names.outputs.deployment-name }}-app-EdgeStack"
          echo "Checking for existing COMPLETE stack: $STACK_NAME"
          COUNT=$(aws cloudformation list-stacks \
            --region "us-east-1" \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query "length(StackSummaries[?StackName=='${STACK_NAME}'])" \
            --output text)
          if [ "$COUNT" -ge 1 ]; then
            echo "skipStaticStackDeployment=true" >> "$GITHUB_OUTPUT"
          else
            echo "skipStaticStackDeployment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/checkout@v6

      - name: Setup Node
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: npm ci

      - uses: actions/setup-java@v5
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Build CDK and synthesize and deploy the EdgeStack in the Application
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-EdgeStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-edge.json \
              && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          WEBSITE_HASH: "placeholder"
          HTTP_API_URL: ${{ needs.deploy-api.outputs.httpApiUrl }}
          DIY_SUBMIT_APEX_URL: ${{ needs.names.outputs.apex-url }}
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

      - run: cat cdk-submit-application.out/cdk-outputs-edge.json | jq '.'
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}

      - name: Resolve stack outputs
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.static-skip.outputs.skipStaticStackDeployment != 'true' }}
        id: edge-outputs
        run: |
          ORIGIN_BUCKET_NAME=$(jq -r '.["${{ needs.names.outputs.deployment-name }}-app-EdgeStack"].OriginBucketName' cdk-submit-application.out/cdk-outputs-edge.json)
          echo "ORIGIN_BUCKET_NAME=$ORIGIN_BUCKET_NAME"
          echo "ORIGIN_BUCKET_NAME=$ORIGIN_BUCKET_NAME" >> $GITHUB_OUTPUT
        shell: bash
    outputs:
      originBucketName: ${{ steps.edge-outputs.outputs.ORIGIN_BUCKET_NAME }}

  deploy-publish:
    name: 'deploy publish'
    needs:
      - names
      - skip-deploy-check
      - mvn-package
      - push-images
      - deploy-edge
      - deploy-api
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS role via GitHub OIDC (for RUM outputs)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role (for RUM outputs)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Resolve RUM config from ObservabilityStack
        id: rum-config
        shell: bash
        run: |
          set -euo pipefail
          STACK_NAME="${{ needs.names.outputs.environment-name }}-env-ObservabilityStack"
          echo "Resolving RUM outputs from $STACK_NAME in region ${{ env.AWS_REGION }}"
          JSON=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "${{ env.AWS_REGION }}")
          RUM_APP_MONITOR_ID=$(echo "$JSON" | jq -r '.Stacks[0].Outputs[] | select(.OutputKey=="RumAppMonitorId") | .OutputValue')
          RUM_IDENTITY_POOL_ID=$(echo "$JSON" | jq -r '.Stacks[0].Outputs[] | select(.OutputKey=="RumIdentityPoolId") | .OutputValue')
          RUM_GUEST_ROLE_ARN=$(echo "$JSON" | jq -r '.Stacks[0].Outputs[] | select(.OutputKey=="RumGuestRoleArn") | .OutputValue')
          RUM_REGION=$(echo "$JSON" | jq -r '.Stacks[0].Outputs[] | select(.OutputKey=="RumRegion") | .OutputValue' 2>/dev/null || echo "${{ env.AWS_REGION }}")
          echo "RUM_APP_MONITOR_ID=$RUM_APP_MONITOR_ID"
          echo "RUM_IDENTITY_POOL_ID=$RUM_IDENTITY_POOL_ID"
          echo "RUM_GUEST_ROLE_ARN=$RUM_GUEST_ROLE_ARN"
          echo "RUM_REGION=$RUM_REGION"
          echo "RUM_APP_MONITOR_ID=$RUM_APP_MONITOR_ID" >> $GITHUB_OUTPUT
          echo "RUM_IDENTITY_POOL_ID=$RUM_IDENTITY_POOL_ID" >> $GITHUB_OUTPUT
          echo "RUM_GUEST_ROLE_ARN=$RUM_GUEST_ROLE_ARN" >> $GITHUB_OUTPUT
          echo "RUM_REGION=$RUM_REGION" >> $GITHUB_OUTPUT

      - name: Inject RUM placeholders into HTML files
        shell: bash
        env:
          RUM_APP_MONITOR_ID: ${{ steps.rum-config.outputs.RUM_APP_MONITOR_ID }}
          RUM_IDENTITY_POOL_ID: ${{ steps.rum-config.outputs.RUM_IDENTITY_POOL_ID }}
          RUM_GUEST_ROLE_ARN: ${{ steps.rum-config.outputs.RUM_GUEST_ROLE_ARN }}
          AWS_REGION: ${{ steps.rum-config.outputs.RUM_REGION || env.AWS_REGION }}
        run: |
          set -euo pipefail

          echo 'Injecting RUM config into HTML files under web/public'
          echo '----------------------------------------------------'

          # Fail early if required variables are missing
            : "${RUM_APP_MONITOR_ID:?Missing RUM_APP_MONITOR_ID}"
            : "${RUM_IDENTITY_POOL_ID:?Missing RUM_IDENTITY_POOL_ID}"
            : "${RUM_GUEST_ROLE_ARN:?Missing RUM_GUEST_ROLE_ARN}"
            : "${AWS_REGION:?Missing AWS_REGION}"

          # Escape sed replacement strings safely
            escape_sed_replacement() {
            printf '%s' "$1" | sed -e 's/[\/&]/\\&/g'
          }

          RUM_APP_MONITOR_ID_ESCAPED="$(escape_sed_replacement "${RUM_APP_MONITOR_ID}")"
          RUM_IDENTITY_POOL_ID_ESCAPED="$(escape_sed_replacement "${RUM_IDENTITY_POOL_ID}")"
          RUM_GUEST_ROLE_ARN_ESCAPED="$(escape_sed_replacement "${RUM_GUEST_ROLE_ARN}")"
          AWS_REGION_ESCAPED="$(escape_sed_replacement "${AWS_REGION}")"

          # Find and process HTML files safely (null-delimited)
          find web/public -type f -name '*.html' -print0 |
          while IFS= read -r -d '' html_file; do
            echo "Processing ${html_file}"

            # Perform in-place replacements (case-insensitive placeholders)
            sed -i \
            -e "s|\${RUM_APP_MONITOR_ID}|${RUM_APP_MONITOR_ID_ESCAPED}|gI" \
            -e "s|\${RUM_IDENTITY_POOL_ID}|${RUM_IDENTITY_POOL_ID_ESCAPED}|gI" \
            -e "s|\${RUM_GUEST_ROLE_ARN}|${RUM_GUEST_ROLE_ARN_ESCAPED}|gI" \
            -e "s|\${AWS_REGION}|${AWS_REGION_ESCAPED}|gI" \
            "${html_file}"
          done

          echo 'RUM placeholder injection complete'

      - name: Compute hash of static website content
        id: publish-hash
        shell: bash
        run: |
          WEBSITE_HASH=$(find 'web/public' -type f -exec sha256sum {} + | sort -k 2 | sha256sum | awk '{print $1}')
          echo "WEBSITE_HASH=$WEBSITE_HASH"
          echo "WEBSITE_HASH=$WEBSITE_HASH" >> $GITHUB_OUTPUT

      - name: Compare current submit.hash with computed hash
        id: publish-compare
        shell: bash
        run: |
          EDGE_HASH_URL="${{ needs.names.outputs.base-url }}/submit.hash"
          echo "Fetching existing hash from $EDGE_HASH_URL"
          EXISTING_HASH=$(curl --fail --silent --show-error --location "$EDGE_HASH_URL" || echo "")
          echo "EXISTING_HASH=$EXISTING_HASH"
          echo "EXISTING_HASH=$EXISTING_HASH" >> $GITHUB_OUTPUT
          if [ "$EXISTING_HASH" == "${{ steps.publish-hash.outputs.WEBSITE_HASH }}" ]; then
            echo "skipPublishStackDeployment=true" >> "$GITHUB_OUTPUT"
          else
            echo "skipPublishStackDeployment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        run: npm ci

      - uses: actions/setup-java@v5
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Configure AWS role via GitHub OIDC
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Build CDK and synthesize and deploy the PublishStack in the Application
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-PublishStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-publish.json \
              && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          WEBSITE_HASH: ${{ steps.publish-hash.outputs.WEBSITE_HASH }}
          HTTP_API_URL: ${{ needs.deploy-api.outputs.httpApiUrl }}
          DIY_SUBMIT_APEX_URL: ${{ needs.names.outputs.apex-url }}
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  deploy-ops:
    name: 'deploy ops with dashboard'
    needs:
      - names
      - skip-deploy-check
      - mvn-package
      - push-images
      - deploy-api
      - deploy-edge
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Check if OpsStack exists
        id: static-skip
        shell: bash
        run: |
          STACK_NAME="${{ needs.names.outputs.deployment-name }}-app-OpsStack"
          echo "Checking existence of $STACK_NAME"
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" >/dev/null 2>&1; then
            echo "skipStaticStackDeployment=true" >> "$GITHUB_OUTPUT"
          else
            echo "skipStaticStackDeployment=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        uses: actions/checkout@v6

      - name: Setup Node
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        run: npm ci

      - uses: actions/setup-java@v5
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Deploy Ops Stack (CDK)
        if: ${{ needs.names.outputs.environment-name == 'prod' || env.FORCE_ALL_STACK_DEPLOYMENT == 'true' || steps.publish-compare.outputs.skipPublishStackDeployment != 'true' }}
        run: |
          ./mvnw --errors clean verify -DskipTests -Dmaven.compiler.source=${{ env.JAVA_VERSION }} -Dmaven.compiler.target=${{ env.JAVA_VERSION }} \
            && cd cdk-application \
            && cat ../.env.${{ needs.names.outputs.environment-name }} \
            && npx dotenv -e ../.env.${{ needs.names.outputs.environment-name }} -- \
              npx cdk deploy \
                ${{ needs.names.outputs.deployment-name }}-app-OpsStack \
                --exclusively \
                --require-approval never \
                --ci true \
                --concurrency 4 \
                --asset-parallelism \
                --outputs-file ../cdk-submit-application.out/cdk-outputs-publish.json \
              && cd .. \
            ;
        env:
          ENVIRONMENT_NAME: ${{ needs.names.outputs.environment-name }}
          DEPLOYMENT_NAME: ${{ needs.names.outputs.deployment-name }}
          BASE_IMAGE_TAG: ${{ needs.push-images.outputs.base-image-tag }}
          # Set by deploy-environment.yml after the environment's AuthStack is deployed
          COGNITO_USER_POOL_ARN: ${{ vars.COGNITO_USER_POOL_ARN }}
          COGNITO_CLIENT_ID: ${{ vars.COGNITO_CLIENT_ID }}

  set-origins:
    name: 'set origins'
    #if: ${{ needs.names.outputs.environment-name != 'prod' || needs.origin-test.outputs.result == 'success' }}
    needs:
      - names
      - skip-deploy-check
      - deploy-auth
      - deploy-hmrc
      - deploy-account
      - deploy-edge
      #- deploy-publish
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Get CloudFront distribution ID
        id: get-distribution-id
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name "${{ needs.names.outputs.deployment-name }}-app-EdgeStack" \
            --region "us-east-1" \
            --query "Stacks[0].Outputs[?OutputKey=='DistributionId'].OutputValue" \
            --output text)
          echo "DISTRIBUTION_ID=$DISTRIBUTION_ID"
          echo "DISTRIBUTION_ID=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
        shell: bash

      - name: Alias apex domain to base domain
        id: set-origins
        uses: './.github/actions/set-origins'
        with:
          origin-domain: ${{ needs.names.outputs.base-domain }}
          apex-domain: ${{ needs.names.outputs.apex-domain }}
          aws-account-id: ${{ env.AWS_ACCOUNT_ID }}
          hosted-zone-id: ${{ env.AWS_HOSTED_ZONE_ID }}
          cloudfront-distribution-id: ${{ steps.get-distribution-id.outputs.DISTRIBUTION_ID }}
    outputs:
      existing-deployment-name: ${{ steps.set-origins.outputs.existing-deployment-name }}

  web-test-bundle:
    if: ${{ !cancelled() }}
    name: 'web test bundle'
    needs:
      - names
      - set-origins
      - deploy-publish
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - bundleBehaviour
        run: |
          npm run 'test:bundleBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          #TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
          #TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
          #TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName bundle \
            --testFile 'behaviour-tests/bundles.behaviour.test.js' \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-bundle
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-bundle
          retention-days: 30
          path: |
            target/test-reports/

  web-test-submit-vat-sandbox:
    if: ${{ !cancelled() }}
    name: 'web test submit vat sandbox'
    needs:
      - names
      - set-origins
      - web-test-bundle
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - submitVatBehaviour
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:submitVatBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; cp ./hmrc-test-user.json ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          #TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
          #TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
          #TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName submit-vat-sandbox \
            --testFile 'behaviour-tests/submitVat.behaviour.test.js' \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-submit-vat-sandbox
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-submit-vat-sandbox
          retention-days: 30
          path: |
            target/test-reports/

  web-test-submit-vat:
    if: ${{ !cancelled() && github.ref != 'refs/heads/main' && needs.names.outputs.environment-name != 'prod' }}
    name: 'web test submit vat'
    needs:
      - names
      - set-origins
      - web-test-bundle
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - submitVatBehaviour
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:submitVatBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          # TODO: Change to HMRC_SYTH_PRODUCTION_USERNAME when available
          TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
          TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
          TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName submit-vat-sandbox \
            --testFile 'behaviour-tests/submitVat.behaviour.test.js' \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-submit-vat
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-submit-vat
          retention-days: 30
          path: |
            target/test-reports/

  web-test-post-vat-return-sandbox:
    if: ${{ !cancelled() && inputs.skipTestScenarios != 'true' }}
    name: 'web test post vat return sandbox'
    needs:
      - names
      - set-origins
      - web-test-bundle
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - postVatReturnBehaviour
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:postVatReturnBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; cp ./hmrc-test-user.json ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          #TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
          #TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
          #TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName post-vat-return-sandbox \
            --testFile 'behaviour-tests/postVatReturn.behaviour.test.js' \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-post-vat-return-sandbox
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-post-vat-return-sandbox
          retention-days: 30
          path: |
            target/test-reports/

  web-test-get-vat-return-sandbox:
    if: ${{ !cancelled() && inputs.skipTestScenarios != 'true' }}
    name: 'web test get vat return sandbox'
    needs:
      - names
      - set-origins
      - web-test-bundle
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - getVatReturnBehaviour
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:getVatReturnBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; cp ./hmrc-test-user.json ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          #TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
          #TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
          #TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName get-vat-return-sandbox \
            --testFile 'behaviour-tests/getVatReturn.behaviour.test.js' \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-get-vat-return-sandbox
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-get-vat-return-sandbox
          retention-days: 30
          path: |
            target/test-reports/

  web-test-obligation-sandbox:
    if: ${{ !cancelled() && inputs.skipTestScenarios != 'true' }}
    name: 'web test obligation sandbox'
    needs:
      - names
      - set-origins
      - web-test-bundle
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - obligationBehaviour
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:obligationBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; cp ./hmrc-test-user.json ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          #TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
          #TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
          #TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName obligation-sandbox \
            --testFile 'behaviour-tests/vatObligations.behaviour.test.js' \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-obligation-sandbox
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-obligation-sandbox
          retention-days: 30
          path: |
            target/test-reports/

  upload-web-test-results:
    if: ${{ !cancelled() }}
    name: 'upload web test results'
    needs:
      - names
      - deploy-publish
      - web-test-bundle
      - web-test-submit-vat-sandbox
      - web-test-submit-vat
      - web-test-post-vat-return-sandbox
      - web-test-get-vat-return-sandbox
      - web-test-obligation-sandbox
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download artifacts - bundle
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-artifacts-bundle
          path: |
            target/behaviour-test-results/bundle/

      - name: Download artifacts - postVatReturn sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-artifacts-post-vat-return-sandbox
          path: |
            target/behaviour-test-results/post-vat-return-sandbox/

      - name: Download artifacts - getVatReturn sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-artifacts-get-vat-return-sandbox
          path: |
            target/behaviour-test-results/get-vat-return-sandbox/

      - name: Download artifacts - obligation sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-artifacts-obligation-sandbox
          path: |
            target/behaviour-test-results/obligation-sandbox/

      - name: Download artifacts - submit vat
        if: ${{ !cancelled() && github.ref != 'refs/heads/main' && needs.names.outputs.environment-name != 'prod' }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-artifacts-submit-vat
          path: |
            target/behaviour-test-results/submit-vat/

      - name: Download artifacts - submit vat sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-artifacts-submit-vat-sandbox
          path: |
            target/behaviour-test-results/submit-vat-sandbox/

      - name: List downloaded artefacts
        if: ${{ !cancelled() }}
        shell: bash
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;

      - name: Download reports - bundle
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-reports-bundle
          path: |
            target/test-reports/bundle/

      - name: Download reports - postVatReturn sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-reports-post-vat-return-sandbox
          path: |
            target/test-reports/post-vat-return-sandbox/

      - name: Download reports - getVatReturn sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-reports-get-vat-return-sandbox
          path: |
            target/test-reports/get-vat-return-sandbox/

      - name: Download reports - obligation sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-reports-obligation-sandbox
          path: |
            target/test-reports/obligation-sandbox/

      - name: Download reports - submit vat
        if: ${{ !cancelled() && github.ref != 'refs/heads/main' && needs.names.outputs.environment-name != 'prod' }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-reports-submit-vat
          path: |
            target/test-reports/submit-vat/

      - name: Download reports - submit vat sandbox
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: web-test-reports-submit-vat-sandbox
          path: |
            target/test-reports/submit-vat-sandbox/

      - name: List downloaded reports
        if: ${{ !cancelled() }}
        shell: bash
        run: |
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Copy screenshots to S3 origin bucket
        if: ${{ !cancelled() }}
        env:
          BUCKET_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-origin-us-east-1
        shell: bash
        run: |
          for filePath in target/behaviour-test-results/*/screenshots/*/*.png; do
            echo "Uploading screenshot file: ${filePath?}"
            testName=$(echo "${filePath?}" | sed -n 's|target/behaviour-test-results/\([^/]*\)/screenshots/.*|\1|p')
            fileName=$(basename "${filePath?}")
            echo "Test name: ${testName?}, File name: ${fileName?}, Uploading to s3://${BUCKET_NAME?}/tests/${testName?}/${fileName?}"
            mkdir -p "screenshots/${testName?}"
            cp "${filePath?}" "screenshots/${testName?}/${fileName?}"
          done
          aws s3 cp "screenshots" "s3://${BUCKET_NAME?}/tests/behaviour-test-results/" --recursive

      - name: Copy Playwright test reports to S3 origin bucket
        if: ${{ !cancelled() }}
        env:
          BUCKET_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-origin-us-east-1
        shell: bash
        run: |
          echo "Uploading test reports to S3 bucket: ${BUCKET_NAME?}"
          aws s3 cp target/test-reports/ s3://${BUCKET_NAME?}/tests/ --recursive

      - name: Copy test artifacts to S3 origin bucket
        if: ${{ !cancelled() }}
        env:
          BUCKET_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-origin-us-east-1
        shell: bash
        run: |
          echo "Uploading behaviour test artifacts to S3 bucket: ${BUCKET_NAME?}"
          aws s3 cp target/behaviour-test-results/ s3://${BUCKET_NAME?}/tests/behaviour-test-results/ --recursive

      - name: Copy test reports to S3 origin bucket
        if: ${{ !cancelled() }}
        env:
          BUCKET_NAME: ${{ needs.names.outputs.deployment-name }}-submit-app-origin-us-east-1
        shell: bash
        run: |
          echo "Uploading test report JSON files and index pages to S3 bucket: ${BUCKET_NAME?}"
          aws s3 cp target/behaviour-test-results/ s3://${BUCKET_NAME?}/tests/ --recursive --exclude "*" --include "test-report*.json" --include "*.txt" --include "*.html"
          find target/behaviour-test-results -name 'test-report-*.json' -exec aws s3 cp {} s3://${BUCKET_NAME?}/tests/ \;
          find target/behaviour-test-results -name 'test-report-*.json' -exec basename {} \; > target/behaviour-test-results/test-reports-index.txt

          echo "Creating an uploading test reports index:"
          cat target/behaviour-test-results/test-reports-index.txt
          aws s3 cp target/behaviour-test-results/test-reports-index.txt s3://${BUCKET_NAME?}/tests/

  convert-video:
    name: 'convert web test video to mp4'
    if: ${{ inputs.convertTestVideo == 'true' }}
    needs:
      - names
      - upload-web-test-results
    runs-on: ubuntu-24.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Node dependencies
        run: npm ci

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download all test artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/
        continue-on-error: true

      - name: Convert Playwright video to MP4
        if: ${{ !cancelled() }}
        run: |
          set -euo pipefail
          root="artifacts/web-test-artifacts"

          # Recursively transcode all .webm files, placing output next to source with 'converted' prefix
          pids=()
          while IFS= read -r -d '' f; do
            dir=$(dirname "$f")
            base="${f##*/}"
            name="${base%.webm}"
            out="${dir}/converted${name}.mp4"
            echo "Transcoding $f -> $out"
            npm run convert:video -- --in "$f" --out "$out" &
            pids+=($!)
          done < <(find "$root" -type f -name '*.webm' -print0)

          # Wait for all transcodes to complete
          fail=0
          for pid in "${pids[@]:-}"; do
            if ! wait "$pid"; then
              fail=1
            fi
          done

          exit $fail

      - name: Upload artifacts (converted videos)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-converted
          retention-days: 30
          path: |
            artifacts/web-test-artifacts

  # Set the deployment name as the last known good deployment for this environment in a parameter store parameter
  set-last-known-good-deployment:
    name: 'set last known good deployment'
    needs:
      - names
      - web-test-bundle
      - web-test-submit-vat
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    steps:
      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Set last known good deployment in SSM Parameter Store
        run: |
          PARAMETER_NAME="/submit/${{ needs.names.outputs.environment-name }}/last-known-good-deployment"
          echo "Setting SSM Parameter Store parameter $PARAMETER_NAME to value '${{ needs.names.outputs.deployment-name }}'"
          aws ssm put-parameter \
            --name "$PARAMETER_NAME" \
            --type String \
            --value "${{ needs.names.outputs.deployment-name }}" \
            --overwrite

      - name: CDK stacks in eu-west-2 and us-east-1
        run: |
          aws cloudformation describe-stacks --region eu-west-2 --query "Stacks[].StackName" --output text | tr '\t' '\n' | sort
          aws cloudformation describe-stacks --region us-east-1 --query "Stacks[].StackName" --output text | tr '\t' '\n' | sort

  # Run workflow: .github/workflows/destroy.yml to destroy previous prod deployments but not the holding page (`-holding`)
  destroy-previous:
    if: ${{ needs.names.outputs.environment-name == 'prod' && needs.set-origins.outputs.existing-deployment-name != '' && !contains(needs.set-origins.outputs.existing-deployment-name, '-holding') }}
    name: 'destroy previous'
    needs:
      - names
      - skip-deploy-check
      - set-origins
      - upload-web-test-results
      - set-last-known-good-deployment
    uses: './.github/workflows/destroy.yml'
    with:
      environment-name: ${{ needs.names.outputs.environment-name }}
      deployment-name: ${{ needs.set-origins.outputs.existing-deployment-name }}

 # TODO: If set-origins passed but web-test failed, look up the last deployment from a parameter store and set-origin back to that deployment

  invalidate-cloudfront:
    name: 'invalidate CloudFront paths (test/** and docs/**)'
    if: ${{ !cancelled() }}
    needs:
      - names
      - upload-web-test-results
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    steps:
      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Invalidate CloudFront paths
        env:
          STACK_NAME: ${{ needs.names.outputs.deployment-name }}-app-EdgeStack
        shell: bash
        run: |
          set -euo pipefail
          echo "Looking up CloudFront DistributionId from stack: ${STACK_NAME?} (us-east-1)"
          DIST_ID=$(aws cloudformation describe-stacks --region us-east-1 --stack-name "${STACK_NAME?}" \
            --query "Stacks[0].Outputs[?OutputKey==\`DistributionId\`].OutputValue" --output text)
          if [ -z "${DIST_ID}" ] || [ "${DIST_ID}" = "None" ]; then
            echo "ERROR: Could not resolve DistributionId output from stack ${STACK_NAME}" >&2
            exit 1
          fi
          echo "Found DistributionId: ${DIST_ID}"
          CALLER_REF="${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date -u +%s)"
          echo "Creating invalidation for paths: /tests/*, /docs/* with caller-ref ${CALLER_REF}"
          aws cloudfront create-invalidation --region us-east-1 \
            --distribution-id "${DIST_ID}" \
            --paths "/tests/*" "/docs/*" \
          ;
