name: compliance-test
run-name: "compliance test of ${{ github.ref_name }}"
# SPDX-FileCopyrightText: 2025 DIY Accounting Limited
# SPDX-License-Identifier: AGPL-3.0-or-later

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6am UTC
  workflow_dispatch:
    inputs:
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - ''
          - 'ci'
          - 'prod'
        default: ''
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''
  workflow_call:
    inputs:
      environment-name:
        type: string
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: true
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: true

concurrency:
  group: compliance-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '22'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'

jobs:
  params:
    runs-on: ubuntu-24.04
    steps:
      - name: "github.event_name=[${{ github.event_name }}]"
        run: ":"
      - name: "inputs.environment-name=[${{ inputs.environment-name }}]"
        run: ":"
      - name: "inputs.deployment-name=[${{ inputs.deployment-name }}]"
        run: ":"
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          echo 'environment-name=${{ inputs.environment-name }}' | tee -a "$GITHUB_OUTPUT"
          echo 'deployment-name=${{ inputs.deployment-name }}' | tee -a "$GITHUB_OUTPUT"
    outputs:
      environment-name: ${{ steps.normalise.outputs.environment-name }}
      deployment-name: ${{ steps.normalise.outputs.deployment-name }}

  names:
    needs: params
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: If main, read back last known good prod deployment from SSM Parameter Store
        if: ${{ needs.params.outputs.deployment-name == '' && github.ref == 'refs/heads/main' }}
        run: |
          PARAMETER_NAME="/submit/prod/last-known-good-deployment"
          aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text | tee /tmp/last_known_good_deployment.txt
          echo "Last known good deployment: $(cat /tmp/last_known_good_deployment.txt)"

      - name: If not main, read back last known good ci deployment from SSM Parameter Store
        if: ${{ needs.params.outputs.deployment-name == '' && github.ref != 'refs/heads/main' }}
        run: |
          PARAMETER_NAME="/submit/ci/last-known-good-deployment"
          aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text | tee /tmp/last_known_good_deployment.txt
          echo "Last known good deployment: $(cat /tmp/last_known_good_deployment.txt)"

      - name: If last-known-good-deployment set use that otherwise use current deployment name
        id: deployment-name
        run: |
          if [ -s /tmp/last_known_good_deployment.txt ]; then
            echo "Using last known good deployment from SSM Parameter Store"
            echo "deployment-name=$(cat /tmp/last_known_good_deployment.txt)" | tee -a "$GITHUB_OUTPUT"
          else
            echo "No last known good deployment found, using current deployment name"
            echo "deployment-name=${{ needs.params.outputs.deployment-name }}" | tee -a "$GITHUB_OUTPUT"
          fi

      - name: Compute environment name and apex URL
        id: deployment-config
        uses: './.github/actions/get-names'
        with:
          environment-name: ${{ needs.params.outputs.environment-name }}
          deployment-name: ${{ steps.deployment-name.outputs.deployment-name }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}

  # Accessibility checks (run in parallel)
  accessibility-pa11y:
    name: Pa11y (WCAG AA)
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run accessibility:pa11y-${{ needs.names.outputs.environment-name }}
        run: npm run accessibility:pa11y-${{ needs.names.outputs.environment-name }}
        continue-on-error: true

  accessibility-axe:
    name: axe-core (WCAG 2.1 AA)
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run accessibility:axe-${{ needs.names.outputs.environment-name }}
        run: npm run accessibility:axe-${{ needs.names.outputs.environment-name }}
        continue-on-error: true

  accessibility-axe-wcag22:
    name: axe-core (WCAG 2.2 AA)
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run accessibility:axe-wcag22-${{ needs.names.outputs.environment-name }}
        run: npm run accessibility:axe-wcag22-${{ needs.names.outputs.environment-name }}
        continue-on-error: true

  accessibility-lighthouse:
    name: Lighthouse
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run accessibility:lighthouse-${{ needs.names.outputs.environment-name }}
        run: npm run accessibility:lighthouse-${{ needs.names.outputs.environment-name }}
        continue-on-error: true

  # Penetration checks (run in parallel)
  penetration-eslint:
    name: ESLint Security
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run penetration:eslint
        run: npm run penetration:eslint
        continue-on-error: true

  penetration-audit:
    name: npm audit
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run penetration:audit
        run: npm run penetration:audit
        continue-on-error: true

  penetration-retire:
    name: retire.js
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run penetration:retire
        run: npm run penetration:retire
        continue-on-error: true

  penetration-zap:
    name: OWASP ZAP
    needs: [names]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: Run penetration:zap-${{ needs.names.outputs.environment-name }}
        run: npm run penetration:zap-${{ needs.names.outputs.environment-name }}
        continue-on-error: true

  # Final compliance report (runs after all checks complete)
  compliance-report:
    name: Generate Compliance Report
    needs: [names]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run compliance:${{ needs.names.outputs.environment-name }}-report-md
        run: npm run compliance:${{ needs.names.outputs.environment-name }}-report-md
        continue-on-error: true

      - name: List generated reports
        run: |
          echo "Penetration reports:"
          ls -la target/penetration/ || echo "No penetration reports"
          echo "Accessibility reports:"
          ls -la target/accessibility/ || echo "No accessibility reports"
          echo "Compliance report:"
          ls -la COMPLIANCE_REPORT.md || echo "No compliance report"

      - name: Upload compliance reports
        uses: actions/upload-artifact@v6
        with:
          name: compliance-reports
          path: |
            target/penetration/
            target/accessibility/
            COMPLIANCE_REPORT.md
          retention-days: 90

      - name: Generate GitHub summary
        run: |
          echo "# Compliance Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.names.outputs.environment-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target**: ${{ needs.names.outputs.apex-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f target/penetration/npm-audit.json ]; then
            echo "## npm Audit Summary" >> $GITHUB_STEP_SUMMARY
            AUDIT=$(cat target/penetration/npm-audit.json)
            echo "- Critical: $(echo "$AUDIT" | jq -r '.metadata.vulnerabilities.critical // 0')" >> $GITHUB_STEP_SUMMARY
            echo "- High: $(echo "$AUDIT" | jq -r '.metadata.vulnerabilities.high // 0')" >> $GITHUB_STEP_SUMMARY
            echo "- Moderate: $(echo "$AUDIT" | jq -r '.metadata.vulnerabilities.moderate // 0')" >> $GITHUB_STEP_SUMMARY
            echo "- Low: $(echo "$AUDIT" | jq -r '.metadata.vulnerabilities.low // 0')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f target/accessibility/axe-results.json ]; then
            echo "## axe-core Summary" >> $GITHUB_STEP_SUMMARY
            VIOLATIONS=$(jq '[.[].violations | length] | add // 0' target/accessibility/axe-results.json)
            PASSES=$(jq '[.[].passes | length] | add // 0' target/accessibility/axe-results.json)
            echo "- Violations: $VIOLATIONS" >> $GITHUB_STEP_SUMMARY
            echo "- Passes: $PASSES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f target/penetration/zap-report.json ]; then
            echo "## ZAP Scan Summary" >> $GITHUB_STEP_SUMMARY
            echo "ZAP report generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Reports Generated" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint security, npm audit, retire.js" >> $GITHUB_STEP_SUMMARY
          echo "- Pa11y, axe-core (WCAG 2.1 + 2.2), Lighthouse accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP ZAP baseline scan" >> $GITHUB_STEP_SUMMARY
          echo "- Consolidated COMPLIANCE_REPORT.md" >> $GITHUB_STEP_SUMMARY
