name: set origins

on:
  workflow_dispatch:
    inputs:
      domain-source:
        type: choice
        description: 'Source of domain to set origins for e.g. branch-based or the holding page'
        required: false
        options:
          - 'branch'
          - 'holding'
        default: 'branch'
      hosted-zone-id:
        type: string
        description: 'AWS Route 53 Hosted Zone ID for the apex domain'
        required: false
        default: 'Z0315522208PWZSSBI9AL'
      cloudfront-distribution-id:
        type: string
        description: 'CloudFront Distribution ID to update aliases on'
        required: false
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - '(auto)'
          - 'ci'
          - 'prod'
        default: '(auto)'
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''

permissions:
  id-token: write
  contents: read
  pages: write

env:
  JAVA_VERSION: '25'
  NODE_VERSION: '24'
  AWS_REGION: 'eu-west-2'
  GITHUB_ACTOR: ${{ github.actor }}
  COMMIT_HASH: ${{ github.sha }}

jobs:

  params:
    runs-on: ubuntu-24.04
    steps:
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          # Convert '(auto)' to empty string for downstream processing
          ENV_NAME='${{ inputs.environment-name }}'; [[ "$ENV_NAME" == "(auto)" ]] && ENV_NAME=""
          echo "environment-name=${ENV_NAME}" | tee -a "$GITHUB_OUTPUT"
          # Resolve GitHub Actions environment from explicit input or branch
          GH_ENV="${ENV_NAME}"
          if [ -z "$GH_ENV" ]; then
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then GH_ENV="prod"; else GH_ENV="ci"; fi
          fi
          echo "github-environment=${GH_ENV}" | tee -a "$GITHUB_OUTPUT"
    outputs:
      environment-name: ${{ steps.normalise.outputs.environment-name }}
      github-environment: ${{ steps.normalise.outputs.github-environment }}

  names:
    needs: params
    runs-on: ubuntu-24.04
    environment: ${{ needs.params.outputs.github-environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute deployment name and environment
        id: deployment-config
        uses: ./.github/actions/get-names
        with:
          environment-name: ${{ needs.params.outputs.environment-name }}
          deployment-name: ${{ github.event.inputs.deployment-name || '' }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      base-domain: ${{ steps.deployment-config.outputs.base-domain }}
      base-url:      ${{ steps.deployment-config.outputs.base-url }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      holding-domain: ${{ steps.deployment-config.outputs.holding-domain }}
      holding-url: ${{ steps.deployment-config.outputs.holding-url }}

  set-origins:
    name: 'set origins'
    needs:
      - names
    runs-on: ubuntu-24.04
    environment: ${{ needs.names.outputs.environment-name }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Look up the CloudFront distribution ID if not provided based on the ORIGIN_DOMAIN matching the tag named "OriginFor"
        id: lookup-cf
        env:
          ORIGIN_DOMAIN: ${{ inputs.domain-source == 'holding' && needs.names.outputs.holding-domain || needs.names.outputs.base-domain }}
          INPUT_CLOUDFRONT_DISTRIBUTION_ID: ${{ github.event.inputs.cloudfront-distribution-id || '' }}
        run: |
          CLOUDFRONT_DISTRIBUTION_ID="${INPUT_CLOUDFRONT_DISTRIBUTION_ID}"
          if [ -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            echo "CloudFront Distribution ID not provided, looking up based on the ORIGIN_DOMAIN ${ORIGIN_DOMAIN?} matching the tag named OriginFor"
            CLOUDFRONT_DISTRIBUTION_ARN=$(aws resourcegroupstaggingapi get-resources \
              --resource-type-filters cloudfront:distribution \
              --region us-east-1 \
              --tag-filters Key=OriginFor,Values="${ORIGIN_DOMAIN}" \
              --query 'ResourceTagMappingList[0].ResourceARN' \
              --output text)
            if [ -z "$CLOUDFRONT_DISTRIBUTION_ARN" ] || [ "$CLOUDFRONT_DISTRIBUTION_ARN" = "None" ]; then
              echo "Error: No CloudFront distribution found with tag OriginFor=${ORIGIN_DOMAIN}" >&2
              exit 1
            fi
            CLOUDFRONT_DISTRIBUTION_ID="${CLOUDFRONT_DISTRIBUTION_ARN##*/}"
            echo "Found CloudFront Distribution ID: ${CLOUDFRONT_DISTRIBUTION_ID?}"
          else
            echo "Using provided CloudFront Distribution ID: ${CLOUDFRONT_DISTRIBUTION_ID?}"
          fi
          echo "CLOUDFRONT_DISTRIBUTION_ID=$CLOUDFRONT_DISTRIBUTION_ID" | tee -a "$GITHUB_OUTPUT"

      - name: Alias apex domain to holding or base domain
        uses: ./.github/actions/set-origins
        with:
          origin-domain: ${{ inputs.domain-source == 'holding' && needs.names.outputs.holding-domain || needs.names.outputs.base-domain }}
          apex-domain: ${{ needs.names.outputs.apex-domain }}
          aws-account-id: ${{ vars.SUBMIT_ACCOUNT_ID }}
          hosted-zone-id: ${{ github.event.inputs.hosted-zone-id }}
          cloudfront-distribution-id: ${{ steps.lookup-cf.outputs.CLOUDFRONT_DISTRIBUTION_ID }}
