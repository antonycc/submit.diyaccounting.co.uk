name: synthetic-test
run-name: "synthetic test of ${{ github.ref_name }}"
concurrency:
  group: synthetic-test-${{ github.ref_name }}
  cancel-in-progress: false

# bump 00

on:
  workflow_dispatch:
    inputs:
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - ''
          - 'ci'
          - 'prod'
        default: ''
  push:
    branches:
      - '**'
      - '!gh_pages'
      - '!dependabot/**'
    paths:
      - 'behaviour-tests/bundles.behaviour.test.js'
      - 'behaviour-tests/submitVat.behaviour.test.js'
      - '.github/workflows/synthetic-test.yml'
  schedule:
    # Check for cold starts over the hour using CloudWatch Logs Insights query:
    #   fields @timestamp, @message
    #   | sort @timestamp desc
    #   | filter @message like /REPORT/
    #   | filter @message like /Init Duration/
    # Runs at 32 to be 5+15 minutes after 12 past to settle after .github/workflows/scale-to.yml
    #- cron: '32,39,46 */2 * * *'
    - cron: '*/21 * * * *'

permissions:
  id-token: write
  contents: read

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '22'
  ACTIONS_ROLE_ARN: 'arn:aws:iam::887764105431:role/submit-github-actions-role'
  DEPLOY_ROLE_ARN:  'arn:aws:iam::887764105431:role/submit-deployment-role'
  AWS_REGION: 'eu-west-2'
  AWS_ACCOUNT_ID: '887764105431'
  AWS_HOSTED_ZONE_ID: 'Z0315522208PWZSSBI9AL'

jobs:

  names:
    runs-on: ubuntu-24.04
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Compute environment name and apex URL
        id: deployment-config
        uses: './.github/actions/get-names'
        with:
          environment-name: ${{ github.event.inputs.environment-name || '' }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}

#  web-test-bundle:
#    name: 'web test bundle'
#    needs:
#      - names
#    runs-on: ubuntu-24.04
#    container: mcr.microsoft.com/playwright:v1.57.0-jammy
#    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
#    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
#    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v6
#
#      - name: Setup Node
#        uses: actions/setup-node@v6
#        with:
#          node-version: ${{ env.NODE_VERSION }}
#          cache: 'npm'
#
#      - name: Install dependencies
#        run: |
#          npm ci --ignore-scripts
#        env:
#          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
#
#      - name: Run behaviour tests - bundleBehaviour
#        run: |
#          npm run 'test:bundleBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
#          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
#          ; exit ${exit_code:-0} \
#          ;
#        env:
#          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
#          #TEST_HMRC_USERNAME: ${{ vars.TEST_HMRC_USERNAME }}
#          #TEST_HMRC_PASSWORD: ${{ secrets.TEST_HMRC_PASSWORD }}
#          #TEST_HMRC_VAT_NUMBER: ${{ vars.TEST_HMRC_VAT_NUMBER }}
#
#      - name: Configure AWS role via GitHub OIDC
#        if: ${{ !cancelled() }}
#        uses: aws-actions/configure-aws-credentials@v5
#        with:
#          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
#          aws-region: ${{ env.AWS_REGION }}
#          role-chaining: false
#          audience: sts.amazonaws.com
#          role-skip-session-tagging: true
#          output-credentials: true
#          retry-max-attempts: 3
#
#      - name: Assume AWS deployment role
#        if: ${{ !cancelled() }}
#        uses: aws-actions/configure-aws-credentials@v5
#        with:
#          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
#          aws-region: ${{ env.AWS_REGION }}
#          role-chaining: true
#          audience: sts.amazonaws.com
#          role-skip-session-tagging: true
#          output-credentials: true
#          retry-max-attempts: 3
#
#      - name: Export DynamoDB data for test users
#        if: ${{ !cancelled() }}
#        run: |
#          chmod +x scripts/export-test-dynamodb.sh
#          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
#        env:
#          AWS_REGION: ${{ env.AWS_REGION }}
#          RESULTS_DIR: target/behaviour-test-results
#
#      - name: Generate test report JSON files
#        if: ${{ !cancelled() }}
#        run: |
#          echo "Generating test report JSON files from behaviour test results..."
#          node scripts/generate-test-reports.js \
#            --testName bundle \
#            --testFile 'behaviour-tests/bundles.behaviour.test.js' \
#            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
#          ;
#        shell: bash
#
#      - name: List artefacts
#        if: ${{ !cancelled() }}
#        run: |
#          echo "Behaviour test results files:"
#          find target/behaviour-test-results/ -type f -exec ls -l {} \;
#          echo "Test report files:"
#          find target/test-reports/ -type f -exec ls -l {} \;
#        shell: bash
#
#      - name: Upload artifacts (results)
#        if: ${{ !cancelled() }}
#        uses: actions/upload-artifact@v6
#        with:
#          name: web-test-artifacts-bundle
#          retention-days: 30
#          path: |
#            target/behaviour-test-results/
#
#      - name: Upload artifacts (reports)
#        if: ${{ !cancelled() }}
#        uses: actions/upload-artifact@v6
#        with:
#          name: web-test-reports-bundle
#          retention-days: 30
#          path: |
#            target/test-reports/


  web-test-submit-vat-sandbox:
    name: 'web test submit vat sandbox'
    needs:
      - names
      #- web-test-bundle
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.57.0-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'ci' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Run behaviour tests - submitVatBehaviour
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:submitVatBehaviour-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; cp ./hmrc-test-user.json ./target/behaviour-test-results/ || true \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.apex-url }}
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ env.DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      # TODO: Write the result to a metric available to CloudWatch Alarms

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'submit-diyaccounting-co-uk' || format('{0}-submit-diyaccounting-co-uk', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-artifacts-submit-vat-sandbox
          retention-days: 30
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: web-test-reports-submit-vat-sandbox
          retention-days: 30
          path: |
            target/test-reports/
