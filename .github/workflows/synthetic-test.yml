name: synthetic-test
run-name: "synthetic test of ${{ github.ref_name }}"
# SPDX-FileCopyrightText: 2025 DIY Accounting Limited
# SPDX-License-Identifier: AGPL-3.0-or-later
#concurrency:
#  group: synthetic-test-${{ inputs.behaviour-test-suite }}-${{ inputs.environment-name || (github.ref == 'refs/heads/main' && 'prod' || 'ci') }}
#  cancel-in-progress: false

# bump 00

on:
  workflow_dispatch:
    inputs:
      environment-name:
        type: choice
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: false
        options:
          - '(auto)'
          - 'ci'
          - 'prod'
        default: '(auto)'
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: false
        default: ''
      behaviour-test-suite:
        type: choice
        description: 'Behaviour test to run'
        required: false
        options:
          - 'bundleBehaviour'
          - 'passRedemptionBehaviour'
          - 'tokenEnforcementBehaviour'
          - 'postVatReturnBehaviour'
          - 'getVatObligationsBehaviour'
          - 'getVatReturnBehaviour'
          - 'postVatReturnFraudPreventionHeadersBehaviour'
          - 'submitVatBehaviour'
          - 'authBehaviour'
          - 'complianceBehaviour'
          - 'helpBehaviour'
          - 'vatValidationBehaviour'
          - 'vatSchemesBehaviour'
          - 'simulatorBehaviour'
          - 'generatePassActivityBehaviour'
          - 'paymentBehaviour'
          - 'allBehaviour'
        default: 'submitVatBehaviour'
      generate-test-reports:
        type: boolean
        description: 'Generate test reports, e.g. true (default) or false'
        required: false
        default: true
      skip-cleanup:
        type: boolean
        description: 'Keep test user and native auth enabled after test (for manual debugging)'
        required: false
        default: false
      skip-native-auth-disable:
        type: boolean
        description: 'Skip disabling native auth after test (caller manages cleanup)'
        required: false
        default: false
  workflow_call:
    inputs:
      environment-name:
        type: string
        description: 'Environment name to use instead of computing from branch, e.g. ci or prod'
        required: true
      deployment-name:
        type: string
        description: 'Deployment name to use instead of computing from branch, e.g. ci-lambdas6 or prod-ea373de'
        required: true
      behaviour-test-suite:
        type: string
        description: 'Behaviour test to run, e.g. submitVatBehaviour'
        required: true
      generate-test-reports:
        type: string
        description: 'Generate test reports, e.g. "true" or "false"'
        required: true
      skip-cleanup:
        type: string
        description: 'Keep test user and native auth enabled after test (for manual debugging)'
        required: false
      skip-native-auth-disable:
        type: string
        description: 'Skip disabling native auth after test (caller manages cleanup)'
        required: false
      test-auth-username:
        type: string
        description: 'Pre-created test user username (skips user creation if provided)'
        required: false
      test-auth-password:
        type: string
        description: 'Pre-created test user password (skips user creation if provided)'
        required: false
    secrets:
      HMRC_SANDBOX_CLIENT_SECRET:
        required: true
  schedule:
    # Check for cold starts over the hour using CloudWatch Logs Insights query:
    #   fields @timestamp, @message
    #   | sort @timestamp desc
    #   | filter @message like /REPORT/
    #   | filter @message like /Init Duration/
    - cron: '57 * * * *'

permissions:
  id-token: write
  contents: read

env:
  JAVA_VERSION: '25'
  NODE_VERSION: '24'
  AWS_REGION: 'eu-west-2'

jobs:

  params:
    runs-on: ubuntu-24.04
    steps:
      - name: "github.event_name=[${{ github.event_name }}]"
        run: ":"
      - name: "inputs.behaviour-test-suite=[${{ inputs.behaviour-test-suite }}]"
        run: ":"
      - name: "inputs.generate-test-reports=[${{ inputs.generate-test-reports }}]"
        run: ":"
      - name: "inputs.environment-name=[${{ inputs.environment-name }}]"
        run: ":"
      - name: "inputs.deployment-name=[${{ inputs.deployment-name }}]"
        run: ":"
      - name: "inputs.skip-cleanup=[${{ inputs.skip-cleanup }}]"
        run: ":"
      - name: "inputs.skip-native-auth-disable=[${{ inputs.skip-native-auth-disable }}]"
        run: ":"
      - name: "inputs.test-auth-username=[${{ inputs.test-auth-username }}]"
        run: ":"
      - name: "inputs.test-auth-password=[***]"
        run: ":"
      - name: Normalise Params
        id: normalise
        shell: bash
        run: |
          X='${{ inputs.behaviour-test-suite }}' ; echo "behaviour-test-suite=${X:-submitVatBehaviour}" | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.generate-test-reports }}' ; echo "generate-test-reports=${X:-true}" | tee -a "$GITHUB_OUTPUT"
          # Convert '(auto)' to empty string for downstream processing
          ENV_NAME='${{ inputs.environment-name }}'; [[ "$ENV_NAME" == "(auto)" ]] && ENV_NAME=""
          echo "environment-name=${ENV_NAME}" | tee -a "$GITHUB_OUTPUT"
          # Resolve GitHub Actions environment from explicit input or branch
          GH_ENV="${ENV_NAME}"
          if [ -z "$GH_ENV" ]; then
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then GH_ENV="prod"; else GH_ENV="ci"; fi
          fi
          echo "github-environment=${GH_ENV}" | tee -a "$GITHUB_OUTPUT"
          echo 'deployment-name=${{ inputs.deployment-name }}' | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.skip-cleanup }}' ; echo "skip-cleanup=${X:-false}" | tee -a "$GITHUB_OUTPUT"
          X='${{ inputs.skip-native-auth-disable }}' ; echo "skip-native-auth-disable=${X:-false}" | tee -a "$GITHUB_OUTPUT"
          echo 'test-auth-username=${{ inputs.test-auth-username }}' | tee -a "$GITHUB_OUTPUT"
          echo 'test-auth-password=${{ inputs.test-auth-password }}' | tee -a "$GITHUB_OUTPUT"
    outputs:
      behaviour-test-suite: ${{ steps.normalise.outputs.behaviour-test-suite }}
      generate-test-reports: ${{ steps.normalise.outputs.generate-test-reports }}
      environment-name: ${{ steps.normalise.outputs.environment-name }}
      deployment-name: ${{ steps.normalise.outputs.deployment-name }}
      skip-cleanup: ${{ steps.normalise.outputs.skip-cleanup }}
      skip-native-auth-disable: ${{ steps.normalise.outputs.skip-native-auth-disable }}
      test-auth-username: ${{ steps.normalise.outputs.test-auth-username }}
      test-auth-password: ${{ steps.normalise.outputs.test-auth-password }}
      github-environment: ${{ steps.normalise.outputs.github-environment }}

  names:
    needs:
      params
    runs-on: ubuntu-24.04
    environment: ${{ needs.params.outputs.github-environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: If main, read back last known good prod deployment from SSM Parameter Store
        if: ${{ needs.params.outputs.deployment-name == '' && github.ref == 'refs/heads/main' }}
        run: |
          PARAMETER_NAME="/submit/prod/last-known-good-deployment"
          aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text | tee /tmp/last_known_good_deployment.txt
          echo "Last known good deployment: $(cat /tmp/last_known_good_deployment.txt)"

      - name: If not main, read back last known good ci deployment from SSM Parameter Store
        if: ${{ needs.params.outputs.deployment-name == '' && github.ref != 'refs/heads/main' }}
        run: |
          PARAMETER_NAME="/submit/ci/last-known-good-deployment"
          aws ssm get-parameter --name "$PARAMETER_NAME" --query "Parameter.Value" --output text | tee /tmp/last_known_good_deployment.txt
          echo "Last known good deployment: $(cat /tmp/last_known_good_deployment.txt)"

      - name: If last-known-good-deployment set use that otherwise use current deployment name
        id: deployment-name
        run: |
            if [ -s /tmp/last_known_good_deployment.txt ]; then
                echo "Using last known good deployment from SSM Parameter Store"
                echo "deployment-name=$(cat /tmp/last_known_good_deployment.txt)" | tee -a "$GITHUB_OUTPUT"
            else
                echo "No last known good deployment found, using current deployment name"
                echo "deployment-name=${{ needs.params.outputs.deployment-name }}" | tee -a "$GITHUB_OUTPUT"
            fi

      - name: Compute environment name and apex URL
        id: deployment-config
        uses: './.github/actions/get-names'
        with:
          environment-name: ${{ needs.params.outputs.environment-name }}
          deployment-name: ${{ steps.deployment-name.outputs.deployment-name }}
    outputs:
      environment-name: ${{ steps.deployment-config.outputs.environment-name }}
      deployment-name: ${{ steps.deployment-config.outputs.deployment-name }}
      apex-domain: ${{ steps.deployment-config.outputs.apex-domain }}
      apex-url: ${{ steps.deployment-config.outputs.apex-url }}
      public-url: ${{ steps.deployment-config.outputs.public-url }}

  behaviour-test:
    name: 'behaviour test ${{ needs.params.outputs.behaviour-test-suite }}-${{ needs.names.outputs.environment-name }}'
    needs:
      - params
      - names
    runs-on: ubuntu-24.04
    container: mcr.microsoft.com/playwright:v1.58.1-jammy
    # Match version number with @playwright/test in package.json with: https://mcr.microsoft.com/en-us/artifact/mar/playwright/tags
    # and extension with ubuntu distribution e.g. https://releases.ubuntu.com/jammy/
    environment: ${{ needs.params.outputs.github-environment }}
    steps:
      - name: Running behaviour test - ${{ needs.params.outputs.behaviour-test-suite }}
        run: ":"

      - name: "Show needs.params.outputs.generate-test-reports=[${{ needs.params.outputs.generate-test-reports }}]"
        run: ":"

      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

      - name: Configure AWS role via GitHub OIDC (for test user creation)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role (for test user creation)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Enable native auth on Cognito Hosted UI
        shell: bash
        run: |
          ENV_FILE=".env.${{ needs.names.outputs.environment-name }}"
          PROVIDER=$(grep -E '^TEST_AUTH_PROVIDER=' "$ENV_FILE" | tail -n1 | cut -d'=' -f2)
          if [ "$PROVIDER" = "cognito-native" ]; then
            node scripts/toggle-cognito-native-auth.js enable "${{ needs.names.outputs.environment-name }}"
          else
            echo "Skipping native auth toggle (TEST_AUTH_PROVIDER=${PROVIDER:-unset})"
          fi

      - name: Create Cognito test user
        id: cognito-test-user
        shell: bash
        run: |
          # If credentials were passed in, use them instead of creating a new user
          if [ -n "${{ needs.params.outputs.test-auth-username }}" ] && [ -n "${{ needs.params.outputs.test-auth-password }}" ]; then
            echo "Using provided test credentials (skipping user creation)"
            # Test system password - intentionally not masked so it appears in job summary
            echo "test-auth-username=${{ needs.params.outputs.test-auth-username }}" >> "$GITHUB_OUTPUT"
            echo "test-auth-password=${{ needs.params.outputs.test-auth-password }}" >> "$GITHUB_OUTPUT"
            echo "user-created-here=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ENV_FILE=".env.${{ needs.names.outputs.environment-name }}"
          PROVIDER=$(grep -E '^TEST_AUTH_PROVIDER=' "$ENV_FILE" | tail -n1 | cut -d'=' -f2)
          if [ "$PROVIDER" = "cognito-native" ]; then
            # The script writes test-auth-username and test-auth-password to $GITHUB_OUTPUT directly
            node 'scripts/create-cognito-test-user.js' "${{ needs.names.outputs.environment-name }}"
            echo "user-created-here=true" >> "$GITHUB_OUTPUT"
          else
            echo "Skipping Cognito test user creation (TEST_AUTH_PROVIDER=${PROVIDER:-unset})"
            echo "user-created-here=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 'Run behaviour test ${{ needs.params.outputs.behaviour-test-suite }}-${{ needs.names.outputs.environment-name }}'
        id: behaviour-test
        if: ${{ !cancelled() }}
        run: |
          npm run 'test:${{ needs.params.outputs.behaviour-test-suite }}-${{ needs.names.outputs.environment-name }}' || exit_code=$? \
          ; RESULT=${exit_code:-0} \
          ; echo "RESULT=$RESULT" | tee -a "$GITHUB_OUTPUT" \
          ; cp ./target/submit*.log ./target/behaviour-test-results/ || true \
          ; [ -f ./hmrc-test-user.json ] && cp ./hmrc-test-user.json ./target/behaviour-test-results || : \
          ; exit ${exit_code:-0} \
          ;
        env:
          DIY_SUBMIT_BASE_URL: ${{ needs.names.outputs.public-url }}
          HMRC_ACCOUNT: sandbox
          HMRC_SANDBOX_CLIENT_SECRET: ${{ secrets.HMRC_SANDBOX_CLIENT_SECRET }}
          TEST_AUTH_USERNAME: ${{ steps.cognito-test-user.outputs.test-auth-username }}
          TEST_AUTH_PASSWORD: ${{ steps.cognito-test-user.outputs.test-auth-password }}

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Delete Cognito test user
        if: ${{ !cancelled() && needs.params.outputs.skip-cleanup != 'true' && steps.cognito-test-user.outputs.test-auth-username != '' && steps.cognito-test-user.outputs.user-created-here == 'true' }}
        shell: bash
        run: |
          echo "Deleting test user created by this workflow..."
          node scripts/delete-cognito-test-user.js "${{ needs.names.outputs.environment-name }}" "${{ steps.cognito-test-user.outputs.test-auth-username }}"

      - name: Disable native auth on Cognito Hosted UI
        if: ${{ !cancelled() && needs.params.outputs.skip-native-auth-disable != 'true' && needs.params.outputs.skip-cleanup != 'true' }}
        shell: bash
        run: |
          ENV_FILE=".env.${{ needs.names.outputs.environment-name }}"
          PROVIDER=$(grep -E '^TEST_AUTH_PROVIDER=' "$ENV_FILE" | tail -n1 | cut -d'=' -f2)
          if [ "$PROVIDER" = "cognito-native" ]; then
            node scripts/toggle-cognito-native-auth.js disable "${{ needs.names.outputs.environment-name }}"
          else
            echo "Skipping native auth toggle (TEST_AUTH_PROVIDER=${PROVIDER:-unset})"
          fi

      - name: Export DynamoDB data for test users
        if: ${{ !cancelled() && needs.params.outputs.generate-test-reports == 'true' }}
        run: |
          chmod +x scripts/export-test-dynamodb.sh
          scripts/export-test-dynamodb.sh ${{ needs.names.outputs.environment-name == 'prod' && 'prod-env' || format('{0}-env', needs.names.outputs.environment-name) }}
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          RESULTS_DIR: target/behaviour-test-results

      - name: Generate test report JSON files
        if: ${{ !cancelled() && needs.params.outputs.generate-test-reports != 'false' }}
        run: |
          echo "Generating test report JSON files from behaviour test results..."
          node scripts/generate-test-reports.js \
            --testName ${{ needs.params.outputs.behaviour-test-suite }} \
            --envFile '.env.${{ needs.names.outputs.environment-name }}' \
          ;
        shell: bash

      - name: List artefacts
        if: ${{ !cancelled() && needs.params.outputs.generate-test-reports == 'true' }}
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;
        shell: bash

      - name: Upload artifacts (results)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.params.outputs.behaviour-test-suite }}-artifacts
          retention-days: 7
          path: |
            target/behaviour-test-results/

      - name: Upload artifacts (reports)
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.params.outputs.behaviour-test-suite }}-reports
          retention-days: 7
          path: |
            target/test-reports/
    outputs:
      result: ${{ steps.behaviour-test.outputs.RESULT }}

  publish-cloudwatch-metric:
    if: ${{ !cancelled() }}
    name: 'publish cloudwatch metric'
    needs:
      - params
      - names
      - behaviour-test
    runs-on: ubuntu-24.04
    environment: ${{ needs.params.outputs.github-environment }}
    steps:
      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: publish cloudwatch metric
        run: |
          aws cloudwatch put-metric-data \
            --namespace "${{ needs.names.outputs.apex-domain }}" \
            --metric-name "behaviour-test" \
            --dimensions deployment-name=${{ needs.names.outputs.deployment-name }},test=${{ needs.params.outputs.behaviour-test-suite }} \
            --value ${{ needs.behaviour-test.outputs.result }} \
            --region ${{ env.AWS_REGION }}

  upload-web-test-results:
    if: ${{ !cancelled() && needs.params.outputs.generate-test-reports == 'true' }}
    name: 'upload web test results'
    needs:
      - params
      - names
      - behaviour-test
    runs-on: ubuntu-24.04
    environment: ${{ needs.params.outputs.github-environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download artifacts - ${{ needs.params.outputs.behaviour-test-suite }}
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.params.outputs.behaviour-test-suite }}-artifacts
          path: |
            target/behaviour-test-results/${{ needs.params.outputs.behaviour-test-suite }}/

      - name: List downloaded artefacts
        if: ${{ !cancelled() }}
        shell: bash
        run: |
          echo "Behaviour test results files:"
          find target/behaviour-test-results/ -type f -exec ls -l {} \;

      - name: Download reports - ${{ needs.params.outputs.behaviour-test-suite }}
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.params.outputs.behaviour-test-suite }}-reports
          path: |
            target/test-reports/${{ needs.params.outputs.behaviour-test-suite }}/

      - name: List downloaded reports
        if: ${{ !cancelled() }}
        shell: bash
        run: |
          echo "Test report files:"
          find target/test-reports/ -type f -exec ls -l {} \;

      - name: Configure AWS role via GitHub OIDC
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Lookup origin bucket name from EdgeStack
        if: ${{ !cancelled() }}
        id: lookup-bucket
        shell: bash
        run: |
          EDGE_STACK="${{ needs.names.outputs.deployment-name }}-app-EdgeStack"
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name "${EDGE_STACK}" --region us-east-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`OriginBucketName`].OutputValue' \
            --output text 2>/dev/null || echo "")
          if [ -z "$BUCKET_NAME" ] || [ "$BUCKET_NAME" = "None" ]; then
            echo "WARNING: Could not find OriginBucketName from stack ${EDGE_STACK}, skipping upload"
            echo "BUCKET_NAME=" >> "$GITHUB_OUTPUT"
          else
            echo "Found origin bucket: ${BUCKET_NAME}"
            echo "BUCKET_NAME=${BUCKET_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish test results to local directory and upload to S3
        if: ${{ !cancelled() && steps.lookup-bucket.outputs.BUCKET_NAME != '' }}
        env:
          BUCKET_NAME: ${{ steps.lookup-bucket.outputs.BUCKET_NAME }}
        shell: bash
        run: |
          chmod +x ./scripts/publish-web-test-local.sh
          ./scripts/publish-web-test-local.sh "target/behaviour-test-results/${{ needs.params.outputs.behaviour-test-suite }}/test-report-${{ needs.params.outputs.behaviour-test-suite }}.json" web-test

          # Copy the following files to S3:
          # web/public/tests/test-report-web-test.json
          # web/public/tests/test-reports/web-test/html-report/*
          # web/public/tests/behaviour-test-results/web-test/*

          echo "Uploading test report JSON file to S3 bucket: ${BUCKET_NAME?}"
          ls -l web/public/tests/test-report-web-test.json
          aws s3 cp web/public/tests/test-report-web-test.json s3://${BUCKET_NAME?}/tests/test-report-web-test.json

          echo "Uploading test reports to S3 bucket: ${BUCKET_NAME?}"
          find web/public/tests/test-reports/web-test/html-report/ -type f
          aws s3 cp web/public/tests/test-reports/web-test/html-report/ s3://${BUCKET_NAME?}/tests/test-reports/web-test/html-report/ --recursive

          echo "Uploading behaviour test artifacts to S3 bucket: ${BUCKET_NAME?}"
          find web/public/tests/behaviour-test-results/web-test/ -type f
          aws s3 cp web/public/tests/behaviour-test-results/web-test/ s3://${BUCKET_NAME?}/tests/behaviour-test-results/web-test/ --recursive
