---
# .github/workflows/format.yml

name: format
concurrency:
  group: 'auto-format-lint-${{ github.ref_name }}'
  cancel-in-progress: true
run-name: >
  Auto Format and Lint [${{ github.ref_name }}]
  [${{ github.event.head_commit.message }}]

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes made)'
        required: false
        default: false
        type: boolean
      target_branch:
        description: 'Target branch to create PR against'
        required: false
        default: 'main'
        type: string
  schedule:
    # Run nightly at 4:07 AM UTC (optimal time for GitHub Actions)
    - cron: '7 4 * * *'

env:
  # Use the target branch from input, or 'main' if not specified
  TARGET_BRANCH: ${{ inputs.target_branch || 'main' }}
  DRY_RUN: ${{ inputs.dry_run || 'false' }}

jobs:
  setup-environment:
    name: 'Setup Environment'
    uses: ./.github/workflows/reusable-setup-environment.yml
    with:
      install_copilot: true

  auto-format-lint:
    name: 'Auto Format and Lint'
    needs: setup-environment
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        uses: âˆž-reusable-setup-environment.yml
        with:
          install_copilot: false

      - name: Check current state
        run: |
          echo "Checking current formatting and linting state..."
          echo "::group::Prettier Check"
          npm run formatting:js || echo "Prettier issues found"
          echo "::endgroup::"

          echo "::group::Java Formatting Check"
          npm run formatting:java || echo "Java formatting issues found"
          echo "::endgroup::"

          echo "::group::ESLint Check"
          npm run linting || echo "ESLint issues found"
          echo "::endgroup::"

      - name: Apply formatting fixes
        run: |
          echo "Applying formatting fixes..."

          echo "::group::Prettier Fix"
          npm run formatting:js-fix || echo "Prettier fix completed"
          echo "::endgroup::"

          echo "::group::Java Formatting Fix"
          npm run formatting:java-fix || echo "Java formatting fix completed"
          echo "::endgroup::"

      - name: Apply linting fixes
        run: |
          echo "Applying ESLint auto-fixes..."
          npm run linting-fix || echo "ESLint auto-fix completed"

  generate-linting-suggestions:
    name: 'Generate Linting Suggestions'
    needs: auto-format-lint
    uses: ./.github/workflows/reusable-copilot-suggestions.yml
    with:
      suggestion_type: 'linting'

  create-format-lint-pr:
    name: 'Create Format/Lint PR'
    needs: [auto-format-lint, generate-linting-suggestions]
    uses: ./.github/workflows/reusable-create-pr.yml
    with:
      branch_prefix: 'auto-format-lint'
      pr_title: 'Auto-format and lint fixes $(date +%Y-%m-%d)'
      pr_body: |
        ## Automated Formatting and Linting Fixes

        This PR contains automated formatting and linting fixes applied by the auto-format-lint workflow.

        ### Changes Applied
        - âœ… Prettier formatting for JavaScript, HTML, CSS, and JSON files
        - âœ… Java formatting with Google Java Format via Spotless
        - âœ… ESLint auto-fixes where possible

        ### AI Assistance
        - ðŸ¤– GitHub Copilot has analyzed remaining linting issues
        - ðŸ“‹ Suggestions available in workflow artifacts
        - ðŸ”§ Manual review recommended for complex issues

        ### Workflow Information
        - **Triggered by**: ${{ github.event_name }}
        - **Branch**: ${{ env.TARGET_BRANCH }}
        - **Timestamp**: $(date -u)
        - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ### Related Workflows
        For TODO resolution, use the **TODO-inator** workflow.
        For incremental improvements, use the **Iterator** workflow.

        ---
        *This PR was automatically created by the Auto Format and Lint workflow*
      target_branch: ${{ env.TARGET_BRANCH }}
      labels: 'automated,formatting,linting'
      dry_run: ${{ env.DRY_RUN }}
