# .github/workflows/format.yml

name: format
concurrency:
  group: 'auto-format-lint-${{ github.ref_name }}'
  cancel-in-progress: true
run-name: >
  Auto Format and Lint [${{ github.ref_name }}]
  [${{ github.event.head_commit.message }}]

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no changes made)'
        required: false
        default: false
        type: boolean
      target_branch:
        description: 'Target branch to create PR against'
        required: false
        default: 'main'
        type: string
  schedule:
    # Run nightly at 4:07 AM UTC (optimal time for GitHub Actions)
    - cron: '7 4 * * *'

jobs:
  setup-environment:
    name: 'Setup Environment'
    uses: ./.github/workflows/∞-reusable-setup-environment.yml
    with:
      install_copilot: true

  auto-format-lint:
    name: 'Auto Format and Lint'
    needs: setup-environment
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        uses: ∞-reusable-setup-environment.yml
        with:
          install_copilot: false

      - name: Check current state
        run: |
          echo "Checking current formatting and linting state..."
          echo "::group::Prettier Check"
          npm run formatting:js || echo "Prettier issues found"
          echo "::endgroup::"

          echo "::group::Java Formatting Check"
          npm run formatting:java || echo "Java formatting issues found"
          echo "::endgroup::"

          echo "::group::ESLint Check"
          npm run linting || echo "ESLint issues found"
          echo "::endgroup::"

      - name: Apply formatting fixes
        run: |
          echo "Applying formatting fixes..."

          echo "::group::Prettier Fix"
          npm run formatting:js-fix || echo "Prettier fix completed"
          echo "::endgroup::"

          echo "::group::Java Formatting Fix"
          npm run formatting:java-fix || echo "Java formatting fix completed"
          echo "::endgroup::"

      - name: Apply linting fixes
        run: |
          echo "Applying ESLint auto-fixes..."
          npm run linting-fix || echo "ESLint auto-fix completed"

  generate-linting-suggestions:
    name: 'Generate Linting Suggestions'
    needs: auto-format-lint
    uses: ./.github/workflows/∞-reusable-copilot-suggestions.yml
    with:
      suggestion_type: 'linting'

  create-format-lint-pr:
    name: 'Create Format/Lint PR'
    needs: [auto-format-lint, generate-linting-suggestions]
    uses: ./.github/workflows/∞-reusable-create-pr.yml
    with:
      branch_prefix: 'auto-format-lint'
      pr_title: 'Auto-format and lint fixes $(date +%Y-%m-%d)'
      pr_body: 'This PR was automatically created by the Auto Format and Lint workflow'
      target_branch: ${{ inputs.target_branch || 'main' }}
      labels: 'automated,formatting,linting'
      dry_run: 'false'
