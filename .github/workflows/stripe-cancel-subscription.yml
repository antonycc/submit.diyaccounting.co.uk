name: Cancel Stripe Subscription
run-name: "cancel subscription ${{ inputs.subscription-id }} (${{ inputs.mode }}) in ${{ inputs.environment-name }}"
# SPDX-FileCopyrightText: 2026 DIY Accounting Limited
# SPDX-License-Identifier: AGPL-3.0-or-later

on:
  workflow_dispatch:
    inputs:
      subscription-id:
        description: 'Stripe subscription ID (sub_xxx)'
        required: true
        type: string
      mode:
        description: 'Cancellation mode'
        required: true
        type: choice
        options:
          - at-period-end
          - immediate
        default: at-period-end
      environment-name:
        description: 'Environment name'
        required: true
        type: choice
        options:
          - ci
          - prod

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '24'
  AWS_REGION: 'eu-west-2'

jobs:
  cancel-subscription:
    runs-on: ubuntu-24.04
    environment: ${{ inputs.environment-name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS role via GitHub OIDC
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: false
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Assume AWS deployment role
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ vars.SUBMIT_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-chaining: true
          audience: sts.amazonaws.com
          role-skip-session-tagging: true
          output-credentials: true
          retry-max-attempts: 3

      - name: Resolve Stripe secret and table names
        id: resolve
        run: |
          # Get deployment name from SSM
          DEPLOYMENT=$(aws ssm get-parameter \
            --name "/submit/${{ inputs.environment-name }}/last-known-good-deployment" \
            --query "Parameter.Value" --output text)
          echo "deployment-name=${DEPLOYMENT}" >> "$GITHUB_OUTPUT"
          echo "Deployment: ${DEPLOYMENT}"

          # Get Stripe secret key from Secrets Manager
          STRIPE_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name "${DEPLOYMENT}-app-BillingStack" \
            --query "Stacks[0].Outputs[?contains(OutputKey,'StripeSecretKey')].OutputValue" \
            --output text 2>/dev/null || echo "")

          if [ -z "${STRIPE_SECRET_ARN}" ]; then
            # Fall back to environment-level secret
            STRIPE_SECRET_ARN=$(aws secretsmanager list-secrets \
              --filter Key=name,Values="/submit/${{ inputs.environment-name }}/stripe-secret-key" \
              --query "SecretList[0].ARN" --output text 2>/dev/null || echo "")
          fi

          if [ -n "${STRIPE_SECRET_ARN}" ] && [ "${STRIPE_SECRET_ARN}" != "None" ]; then
            STRIPE_KEY=$(aws secretsmanager get-secret-value \
              --secret-id "${STRIPE_SECRET_ARN}" \
              --query "SecretString" --output text)
            echo "::add-mask::${STRIPE_KEY}"
            echo "stripe-key=${STRIPE_KEY}" >> "$GITHUB_OUTPUT"
          else
            echo "WARNING: Could not resolve Stripe secret key from Secrets Manager"
          fi

          # Get table names from CloudFormation
          SUB_TABLE=$(aws cloudformation describe-stacks \
            --stack-name "${{ inputs.environment-name }}-env-DataStack" \
            --query "Stacks[0].Outputs[?contains(OutputKey,'SubscriptionsTable')].OutputValue" \
            --output text 2>/dev/null || echo "")
          echo "subscriptions-table=${SUB_TABLE}" >> "$GITHUB_OUTPUT"

      - name: Cancel subscription
        env:
          STRIPE_SECRET_KEY: ${{ steps.resolve.outputs.stripe-key }}
          SUBSCRIPTIONS_DYNAMODB_TABLE_NAME: ${{ steps.resolve.outputs.subscriptions-table }}
        run: |
          MODE_FLAG=""
          if [ "${{ inputs.mode }}" = "immediate" ]; then
            MODE_FLAG="--immediate"
          else
            MODE_FLAG="--at-period-end"
          fi

          node scripts/stripe-cancel-subscription.js \
            "${{ inputs.subscription-id }}" \
            ${MODE_FLAG} \
            --yes 2>&1 | tee cancellation-result.txt

      - name: Generate step summary
        if: always()
        run: |
          echo "# Subscription Cancellation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Subscription**: \`${{ inputs.subscription-id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment-name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment**: ${{ steps.resolve.outputs.deployment-name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f cancellation-result.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat cancellation-result.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
