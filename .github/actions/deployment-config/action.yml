name: "Deployment Config"
description: "Compute ENVIRONMENT_NAME, DEPLOYMENT_NAME and BASE_URL consistently from branch name and optional input."

inputs:
  deploymentName:
    description: "Explicit deployment name (e.g. ci or custom). Leave empty to derive from branch."
    required: false
    default: ""
  prodBranchName:
    description: "Branch name that maps to prod."
    required: false
    default: "main"

outputs:
  ENVIRONMENT_NAME:
    description: "Computed environment name"
    value: ${{ steps.compute.outputs.ENVIRONMENT_NAME }}
  DEPLOYMENT_NAME:
    description: "Computed deployment name"
    value: ${{ steps.compute.outputs.DEPLOYMENT_NAME }}
  BASE_URL:
    description: "Computed base URL for the deployment"
    value: ${{ steps.compute.outputs.BASE_URL }}

runs:
  using: "composite"
  steps:
    - id: compute
      name: Compute deployment config
      shell: bash
      run: |
        set -euo pipefail
        REF_NAME="${GITHUB_REF_NAME:-${GITHUB_HEAD_REF:-${GITHUB_REF##*/}}}"
        INPUT_DEPLOYMENT_NAME="${{ inputs.deploymentName }}"
        PROD_BRANCH="${{ inputs.prodBranchName }}"
        COMMIT_SHA="${{ github.sha }}"

        # Clean branch name: lowercase, replace non-alphanumeric with hyphens, collapse consecutive hyphens
        CLEANED=$(echo "$REF_NAME" | tr '[:upper:]' '[:lower:]' | sed -e 's/[^a-z0-9]/-/g' -e 's/-\{2,\}/-/g' -e 's/^-//' -e 's/-$//')

        if [ "${GITHUB_REF:-}" = "refs/heads/${PROD_BRANCH}" ] || [ "$REF_NAME" = "$PROD_BRANCH" ]; then
          ENVIRONMENT_NAME="prod"
          DEPLOYMENT_NAME="prod"
        elif [ "$INPUT_DEPLOYMENT_NAME" = "ci" ]; then
          ENVIRONMENT_NAME="ci"
          DEPLOYMENT_NAME="ci"
        elif [ -n "$INPUT_DEPLOYMENT_NAME" ]; then
          ENVIRONMENT_NAME="ci"
          DEPLOYMENT_NAME="$INPUT_DEPLOYMENT_NAME"
        else
          ENVIRONMENT_NAME="ci"
          # Truncate to 8 chars for branch-based deployments to match prior logic (ci-xxxxxxxx)
          DEPLOYMENT_NAME="ci-${CLEANED:0:8}"
        fi

        if [ "$DEPLOYMENT_NAME" = "prod" ]; then
          BASE_URL="https://prod-${COMMIT_SHA?}.submit.diyaccounting.co.uk"
        else
          BASE_URL="https://${DEPLOYMENT_NAME?}.submit.diyaccounting.co.uk"
        fi

        echo "ENVIRONMENT_NAME=$ENVIRONMENT_NAME" | tee -a "$GITHUB_OUTPUT"
        echo "DEPLOYMENT_NAME=$DEPLOYMENT_NAME" | tee -a "$GITHUB_OUTPUT"
        echo "BASE_URL=$BASE_URL" | tee -a "$GITHUB_OUTPUT"
