<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Submit UK VAT returns to HMRC under Making Tax Digital (MTD) - DIY Accounting Submit" />
    <title>DIY Accounting Submit</title>
    <style>
        /* Reset & Typography */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: Arial, sans-serif; background: #f9f9f9; color: #333; }
        body { display: flex; flex-direction: column; align-items: center; padding: 1rem; }
        h1 { font-size: 2rem; color: #2c5aa0; margin-bottom: 0.5rem; }
        h2 { font-size: 1.5rem; color: #2c5aa0; margin-bottom: 1rem; }
        .subtitle { font-size: 1rem; color: #666; margin-bottom: 2rem; text-align: center; }

        /* Containers */
        #main { width: 100%; max-width: 600px; flex: 1; display: flex; flex-direction: column; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 2rem; }

        /* Form */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.5rem; }
        input[type="text"], input[type="number"] {
            width: 100%; padding: 0.75rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;
            transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: #2c5aa0; }
        .help { font-size: 0.9rem; color: #666; margin-top: 0.25rem; }

        /* Buttons */
        .btn { display: inline-block; width: 100%; background: #2c5aa0; color: #fff; border: none;
            padding: 0.75rem; font-size: 1rem; border-radius: 4px; cursor: pointer; transition: background 0.3s;
        }
        .btn:hover:not(:disabled) { background: #1e3f73; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Status & Spinner */
        .status { display: none; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .status-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .status-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .spinner { display: none; width: 40px; height: 40px; margin: 1rem auto;
            border: 4px solid #f3f3f3; border-top: 4px solid #2c5aa0; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Receipt */
        #receipt { display: none; }
        .receipt-header { color: #28a745; font-size: 1.25rem; margin-bottom: 1rem; }
        .receipt-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .receipt-item:last-child { border-bottom: none; }
        .receipt-note { font-size: 0.9rem; color: #666; margin-top: 1rem; }

        /* Footer */
        footer { text-align: center; font-size: 0.8rem; color: #777; margin-top: auto; padding-top: 1rem; }

        @media (max-width: 480px) {
            .card { padding: 1rem; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
<header>
    <h1>DIY Accounting Submit</h1>
    <p class="subtitle">Submit UK VAT returns to HMRC under Making Tax Digital (MTD)</p>
</header>

<div id="main">
    <!-- Status Message -->
    <div id="status" class="status"></div>
    <!-- Loading Spinner -->
    <div id="spinner" class="spinner"></div>

    <!-- VAT Submission Form -->
    <div id="formCard" class="card">
        <h2>Submit a VAT Return</h2>
        <form id="vatForm">
            <div class="form-group">
                <label for="vrn">VAT Registration Number (VRN)</label>
                <input type="text" id="vrn" name="vrn" required maxlength="9" pattern="\d{9}" placeholder="e.g., 123456789" />
                <div class="help">Enter your 9-digit VAT registration number</div>
            </div>
            <div class="form-group">
                <label for="periodKey">Period Key</label>
                <input type="text" id="periodKey" name="periodKey" required maxlength="4" placeholder="e.g., 24A1" />
                <div class="help">Identifier for the VAT period (e.g., 24A1)</div>
            </div>
            <div class="form-group">
                <label for="vatDue">Total VAT Due (£)</label>
                <input type="number" id="vatDue" name="vatDue" required step="0.01" min="0" placeholder="e.g., 2400.00" />
                <div class="help">Enter the total VAT amount due</div>
            </div>
            <button type="submit" id="submitBtn" class="btn">Submit VAT Return</button>
        </form>
    </div>

    <!-- Receipt Display -->
    <div id="receipt" class="card">
        <div class="receipt-header">✅ VAT Return Submitted Successfully!</div>
        <div class="receipt-item"><strong>Processing Date:</strong><span id="rcDate"></span></div>
        <div class="receipt-item"><strong>Form Bundle No.:</strong><span id="rcBundle"></span></div>
        <div class="receipt-item"><strong>Charge Ref No.:</strong><span id="rcCharge"></span></div>
        <p class="receipt-note">Please keep this receipt for your records.</p>
    </div>
</div>

<footer>&copy; 2025 DIY Accounting Limited. Licensed under GPL v3.0</footer>

<script>
    // Elements
    const form = document.getElementById('vatForm');
    const statusEl = document.getElementById('status');
    const spinner = document.getElementById('spinner');
    const formCard = document.getElementById('formCard');
    const receiptCard = document.getElementById('receipt');
    const btn = document.getElementById('submitBtn');

    // Utility
    function showStatus(msg, type='info') {
        statusEl.textContent = msg;
        statusEl.className = 'status status-' + (type==='error' ? 'error' : 'info');
        statusEl.style.display = 'block';
        if (type==='info') setTimeout(() => statusEl.style.display='none', 5000);
    }
    function hideStatus() { statusEl.style.display='none'; }
    function showSpinner() { spinner.style.display='block'; btn.disabled=true; }
    function hideSpinner() { spinner.style.display='none'; btn.disabled=false; }

    // OAuth and Submission Flow
    function generateState() { return Math.random().toString(36).substr(2); }

    async function getAuthUrl(state) {
        const res = await fetch(`/api/auth-url?state=${encodeURIComponent(state)}`);
        if (!res.ok) throw new Error(res.statusText);
        return res.json();
    }
    async function exchangeToken(code) {
        const res = await fetch('/api/exchange-token', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code }) });
        if (!res.ok) throw new Error(res.statusText);
        return res.json();
    }
    async function submitVAT(vrn, periodKey, vatDue, token) {
        const res = await fetch('/api/submit-vat', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ vatNumber: vrn, periodKey, vatDue, accessToken: token })
        });
        if (!res.ok) throw new Error(res.statusText);
        return res.json();
    }
    async function logReceipt(data) {
        const res = await fetch('/api/log-receipt', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(res.statusText);
        return res.json();
    }

    async function continueFlow(code, state) {
        const stored = sessionStorage.getItem('submission');
        if (!stored || sessionStorage.getItem('oauth_state') !== state) {
            showStatus('Invalid state or missing submission data.', 'error'); return;
        }
        const { vrn, periodKey, vatDue } = JSON.parse(stored);
        try {
            showSpinner(); showStatus('Exchanging code for token...');
            const { accessToken } = await exchangeToken(code);
            showStatus('Submitting VAT return...');
            const receipt = await submitVAT(vrn, periodKey, vatDue, accessToken);
            showStatus('Logging receipt...');
            await logReceipt(receipt);
            displayReceipt(receipt);
        } catch (err) {
            showStatus(err.message, 'error');
        } finally { hideSpinner(); }
    }

    function displayReceipt({ processingDate, formBundleNumber, chargeRefNumber }) {
        formCard.style.display='none';
        receiptCard.style.display='block';
        document.getElementById('rcDate').textContent = new Date(processingDate).toLocaleString('en-GB', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });
        document.getElementById('rcBundle').textContent = formBundleNumber;
        document.getElementById('rcCharge').textContent = chargeRefNumber;
    }

    function handleCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        if (code && state) {
            // clean URL
            window.history.replaceState({}, '', window.location.pathname);
            continueFlow(code, state);
        }
    }

    // Form Submit
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const vrn = form.vrn.value.trim();
        const periodKey = form.periodKey.value.trim().toUpperCase();
        const vatDue = form.vatDue.value;
        if (!/^[0-9]{9}$/.test(vrn)) return showStatus('VRN must be 9 digits.', 'error');
        if (!periodKey) return showStatus('Enter a period key.', 'error');
        if (!vatDue || parseFloat(vatDue) < 0) return showStatus('VAT due must be non-negative.', 'error');
        try {
            showSpinner(); showStatus('Initiating HMRC authentication...');
            const state = generateState();
            sessionStorage.setItem('oauth_state', state);
            sessionStorage.setItem('submission', JSON.stringify({ vrn, periodKey, vatDue }));
            const { authUrl } = await getAuthUrl(state);
            showStatus('Redirecting to HMRC...');
            window.location.href = authUrl;
        } catch (err) {
            showStatus(err.message, 'error'); hideSpinner();
        }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        handleCallback();
        // input constraints
        form.vrn.addEventListener('input', e => e.target.value = e.target.value.replace(/\D/g, ''));
    });
</script>
</body>
</html>
